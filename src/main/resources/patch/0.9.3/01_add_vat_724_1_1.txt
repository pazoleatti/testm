import com.aplana.sbrf.taxaccounting.model.Column
import com.aplana.sbrf.taxaccounting.model.ColumnType
import com.aplana.sbrf.taxaccounting.model.FormStyle
import com.aplana.sbrf.taxaccounting.model.FormTemplate
import com.aplana.sbrf.taxaccounting.model.FormType
import org.apache.commons.io.IOUtils

/**
 Создает макет НФ, кроме таблицы для хранения данных
 # Инструкция:
 Вставить текст данного скрипта на странице, соответствующей ссылке с окончанием:
 .../gwtapp/#!scriptExecution
 Нажать "Выполнить".

 */

boolean createType = true
boolean createTemplate = true
boolean addColumns = true
boolean addStyles = true
boolean addDataRows = true
boolean addDataHeaders = true
boolean addScript = true

try {
    // id типа формы, имя типа формы, вид налога(I, T, V, D, P, E), включать в ИФРС(флаг), имя ИФРС
    FormType formType = new FormType()
    formType.setId(848)
    formType.setName('(724.1.1) Корректировка сумм НДС и налоговых вычетов за прошедшие налоговые периоды')
    formType.setTaxType(TaxType.VAT)
    formType.setIsIfrs(false)
    formType.setIfrsName('')
    formType.setCode('724.1.1')
    // id шаблона формы, имя шаблона короткое, имя шаблона полное, год версии, ежемесячность(флаг), код
    FormTemplate formTemplate = new FormTemplate()
    formTemplate.setId(848)
    formTemplate.setFixedRows(false)
    formTemplate.setName('(724.1.1) Корректировка сумм НДС и налоговых вычетов за прошедшие налоговые периоды')
    formTemplate.setFullName('(724.1.1) Корректировка сумм НДС и налоговых вычетов за прошедшие налоговые периоды')
    formTemplate.setVersion(Date.parse('dd.MM.yyyy', '01.01.2015'))
    formTemplate.setMonthly(false)
    formTemplate.setHeader('724.1.1')
    formTemplate.setComparative(false)
    formTemplate.setAccruing(false)
    formTemplate.setUpdating(false)

    def form_type_id = formType.id
    def form_template_id = formTemplate.id

    def rs = namedParameterJdbcTemplate.queryForObject("SELECT count(id) from FORM_TYPE where id = $form_type_id", [:], Integer.class)
    if (rs == 1) {
        logger.info("Макет НФ с данным id = $form_type_id уже существует в системе!")
        if (createType) {
            return
        }
    }

    rs = namedParameterJdbcTemplate.queryForObject("SELECT count(id) from FORM_TEMPLATE where id = $form_template_id", [:], Integer.class)
    if (rs == 1) {
        logger.info("Версия макета НФ с данным id = $form_template_id уже существует в системе!")
        if (createTemplate) {
            return
        }
    }

    addTypeTemplate(formType, formTemplate, createType, createTemplate)

    List<Column> formColumns = new ArrayList<>()
	def referenceColumnMap = [:]

    //Добавление колонок
    // NAME, ALIAS, TYPE, WIDTH, PRECISION, MAX_LENGTH, CHECKING, ATTRIBUTE_ID, FORMAT, FILTER, PARENT_COLUMN_ID, ATTRIBUTE_ID2, NUMERATION_ROW
    if (addColumns) {
        def Column formColumn = new AutoNumerationColumn()
        formColumn.setOrder(1)
        formColumn.setName('№ пп')
        formColumn.setAlias('rowNum')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Автонумеруемая графа')})
        formColumn.setWidth(5)
        formColumn.setChecking(false)
        formColumn.setNumerationType(NumerationType.getById(1))
        formColumns.add(formColumn)

        formColumn = new StringColumn()
        formColumn.setOrder(2)
        formColumn.setName('fix')
        formColumn.setAlias('fix')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Строка')})
        formColumn.setWidth(0)
        formColumn.setChecking(false)
        formColumn.setMaxLength(2000)
        formColumn.setPrevLength(0)
        formColumns.add(formColumn)

        formColumn = new RefBookColumn()
        formColumn.setOrder(3)
        formColumn.setName('Данные бухгалтерского учёта. Величина корректировки налоговой базы. Налоговый период, за который вносится корректировка')
        formColumn.setAlias('period')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Справочник')})
        formColumn.setWidth(10)
        formColumn.setChecking(false)
        formColumn.setRefBookAttributeId(26)
        formColumn.setRefBookAttributeId2(null)
        formColumn.setNameAttributeId(26)
        formColumn.setFilter("NAME = 'первый квартал' OR NAME = 'второй квартал' OR NAME = 'третий квартал' OR NAME = 'четвёртый квартал'" ?: null)
        formColumns.add(formColumn)

        formColumn = new RefBookColumn()
        formColumn.setOrder(4)
        formColumn.setName('Данные бухгалтерского учёта. Величина корректировки налоговой базы. Номер балансового счёта')
        formColumn.setAlias('number')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Справочник')})
        formColumn.setWidth(10)
        formColumn.setChecking(false)
        formColumn.setRefBookAttributeId(900)
        formColumn.setRefBookAttributeId2(null)
        formColumn.setNameAttributeId(900)
        formColumn.setFilter("" ?: null)
        formColumns.add(formColumn)

        formColumn = new NumericColumn()
        formColumn.setOrder(5)
        formColumn.setName('Данные бухгалтерского учёта. Величина корректировки налоговой базы. Сумма корректировки (+)')
        formColumn.setAlias('sumPlus')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Число')})
        formColumn.setWidth(11)
        formColumn.setChecking(false)
        formColumn.setPrecision(2)
        formColumn.setMaxLength(16)
        formColumns.add(formColumn)

        formColumn = new NumericColumn()
        formColumn.setOrder(6)
        formColumn.setName('Данные бухгалтерского учёта. Величина корректировки налоговой базы. Сумма корректировки (-)')
        formColumn.setAlias('sumMinus')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Число')})
        formColumn.setWidth(11)
        formColumn.setChecking(false)
        formColumn.setPrecision(2)
        formColumn.setMaxLength(16)
        formColumns.add(formColumn)

        formColumn = new RefBookColumn()
        formColumn.setOrder(7)
        formColumn.setName('Данные бухгалтерского учёта. Величина корректировки НДС. Номер балансового счёта')
        formColumn.setAlias('numberNds')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Справочник')})
        formColumn.setWidth(10)
        formColumn.setChecking(false)
        formColumn.setRefBookAttributeId(900)
        formColumn.setRefBookAttributeId2(null)
        formColumn.setNameAttributeId(900)
        formColumn.setFilter("" ?: null)
        formColumns.add(formColumn)

        formColumn = new NumericColumn()
        formColumn.setOrder(8)
        formColumn.setName('Данные бухгалтерского учёта. Величина корректировки НДС. Сумма корректировки (+)')
        formColumn.setAlias('sumNdsPlus')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Число')})
        formColumn.setWidth(11)
        formColumn.setChecking(false)
        formColumn.setPrecision(2)
        formColumn.setMaxLength(16)
        formColumns.add(formColumn)

        formColumn = new NumericColumn()
        formColumn.setOrder(9)
        formColumn.setName('Данные бухгалтерского учёта. Величина корректировки НДС. Сумма корректировки (-)')
        formColumn.setAlias('sumNdsMinus')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Число')})
        formColumn.setWidth(11)
        formColumn.setChecking(false)
        formColumn.setPrecision(2)
        formColumn.setMaxLength(16)
        formColumns.add(formColumn)

        formColumn = new StringColumn()
        formColumn.setOrder(10)
        formColumn.setName('Ставка НДС')
        formColumn.setAlias('rateNds')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Строка')})
        formColumn.setWidth(10)
        formColumn.setChecking(false)
        formColumn.setMaxLength(6)
        formColumn.setPrevLength(0)
        formColumns.add(formColumn)

        formColumn = new NumericColumn()
        formColumn.setOrder(11)
        formColumn.setName('Сумма НДС по дополнительным листам книги продаж (разделы 1-7)/книги покупок (разделы 8-9)')
        formColumn.setAlias('sum')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Число')})
        formColumn.setWidth(11)
        formColumn.setChecking(false)
        formColumn.setPrecision(2)
        formColumn.setMaxLength(16)
        formColumns.add(formColumn)


        formTemplate.getColumns().addAll(formColumns)
        columnDaoImpl.createFormColumns(formColumns, formTemplate)

	  	referenceColumnMap.each { alias, parentAlias ->
			def column = formColumns.find{ it.alias == alias }
			if (column != null) {
				column.setParentAlias(parentAlias)
			} else {
				logger.error("Родительская колонка с псевдонимом $parentAlias не обнаружена!")
			}
		}

        if (!referenceColumnMap.isEmpty()) {
            columnDaoImpl.updateFormColumns(formColumns, formTemplate)
        }

        logger.info("К версии макета добавлены колонки")
    }

    List<FormStyle> formStyles = new ArrayList<>()

    if (addStyles) {
        def FormStyle formStyle = new FormStyle()
        formStyle.setAlias('Контрольные суммы')
        formStyle.setBackColor(Color.getById(2))
        formStyle.setBold(true)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Автозаполняемая')
        formStyle.setBackColor(Color.getById(4))
        formStyle.setBold(true)
        formStyle.setFontColor(Color.getById(13))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Редактируемая')
        formStyle.setBackColor(Color.getById(3))
        formStyle.setBold(false)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Заголовок')
        formStyle.setBackColor(Color.getById(6))
        formStyle.setBold(true)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Корректировка-добавлено')
        formStyle.setBackColor(Color.getById(12))
        formStyle.setBold(false)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Корректировка-удалено')
        formStyle.setBackColor(Color.getById(8))
        formStyle.setBold(false)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Корректировка-без изменений')
        formStyle.setBackColor(Color.getById(6))
        formStyle.setBold(false)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Корректировка-изменено')
        formStyle.setBackColor(Color.getById(4))
        formStyle.setBold(true)
        formStyle.setFontColor(Color.getById(10))
        formStyle.setItalic(false)
        formStyles.add(formStyle)


        formTemplate.getStyles().addAll(formStyles)
        formStyleDaoImpl.saveFormStyles(formTemplate)
        logger.info("К версии макета добавлены стили")
    }

    String longString = ''

    if (addDataRows) {
        longString += 'PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48cm93cz4NCiAgPHJvdyBhbGlhcz0iaGVhZF8xIj4NCiAgICA8Y2VsbCBhbGlhcz0icm93TnVtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiBzdHlsZUFsaWFzPSLQl9Cw0LPQvtC70L7QstC+0LoiLz4NCiAgICA8Y2VsbCBhbGlhcz0iZml4IiBjb2xTcGFuPSIxMCIgcm93U3Bhbj0iMSIgc3RyaW5nVmFsdWU9IjEuINCh0YPQvNC80YssINC/0L7Qu9GD0YfQtdC90L3Ri9C1INC+0YIg0YDQtdCw0LvQuNC30LDRhtC40Lgg0YLQvtCy0LDRgNC+0LIgKNGD0YHQu9GD0LMsINC40LzRg9GJ0LXRgdGC0LLQtdC90L3Ri9GFINC/0YDQsNCyKSDQv9C+INGB0YLQsNCy0LrQtSAxOCUiIHN0eWxlQWxpYXM9ItCX0LDQs9C+0LvQvtCy0L7QuiIvPg0KICAgIDxjZWxsIGFsaWFzPSJwZXJpb2QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bVBsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc1BsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0icmF0ZU5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgPC9yb3c+DQogIDxyb3cgYWxpYXM9ImhlYWRfMiI+DQogICAgPGNlbGwgYWxpYXM9InJvd051bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgc3R5bGVBbGlhcz0i0JfQsNCz0L7Qu9C+0LLQvtC6Ii8+DQogICAgPGNlbGwgYWxpYXM9ImZpeCIgY29sU3Bhbj0iMTAiIHJvd1NwYW49IjEiIHN0cmluZ1ZhbHVlPSIyLiDQodGD0LzQvNGLLCDQv9C+0LvRg9GH0LXQvdC90YvQtSDQvtGCINGA0LXQsNC70LjQt9Cw0YbQuNC4INGC0L7QstCw0YDQvtCyICjRg9GB0LvRg9CzLCDQuNC80YPRidC10YHRgtCy0LXQvdC90YvRhSDQv9GA0LDQsikg0L/QviDRgdGC0LDQstC60LUgMTAlIiBzdHlsZUFsaWFzPSLQl9Cw0LPQvtC70L7QstC+0LoiLz4NCiAgICA8Y2VsbCBhbGlhcz0icGVyaW9kIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9Im51bWJlciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1QbHVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU1pbnVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9Im51bWJlck5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1OZHNQbHVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc01pbnVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InJhdGVOZHMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogIDwvcm93Pg0KICA8cm93IGFsaWFzPSJoZWFkXzMiPg0KICAgIDxjZWxsIGFsaWFzPSJyb3dOdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHN0eWxlQWxpYXM9ItCX0LDQs9C+0LvQvtCy0L7QuiIvPg0KICAgIDxjZWxsIGFsaWFzPSJmaXgiIGNvbFNwYW49IjEwIiByb3dTcGFuPSIxIiBzdHJpbmdWYWx1ZT0iMy4g0KHRg9C80LzRiywg0L/QvtC70YPRh9C10L3QvdGL0LUg0L7RgiDRgNC10LDQu9C40LfQsNGG0LjQuCDRgtC+0LLQsNGA0L7QsiAo0YPRgdC70YPQsywg0LjQvNGD0YnQtdGB0YLQstC10L3QvdGL0YUg0L/RgNCw0LIpINC/0L4g0YDQsNGB0YfRkdGC0L3QvtC5INGB0YLQsNCy0LrQtSDQuNGB0YfQuNGB0LvQtdC90LjRjyDQvdCw0LvQvtCz0LAg0L7RgiDRgdGD0LzQvNGLINC/0L7Qu9GD0YfQtdC90L3QvtCz0L4g0LTQvtGF0L7QtNCwIDE4LzExOCIgc3R5bGVBbGlhcz0i0JfQsNCz0L7Qu9C+0LLQvtC6Ii8+DQogICAgPGNlbGwgYWxpYXM9InBlcmlvZCIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJudW1iZXIiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtUGx1cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1NaW51cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJudW1iZXJOZHMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzUGx1cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1OZHNNaW51cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJyYXRlTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICA8L3Jvdz4NCiAgPHJvdyBhbGlhcz0iaGVhZF80Ij4NCiAgICA8Y2VsbCBhbGlhcz0icm93TnVtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiBzdHlsZUFsaWFzPSLQl9Cw0LPQvtC70L7QstC+0LoiLz4NCiAgICA8Y2VsbCBhbGlhcz0iZml4IiBjb2xTcGFuPSIxMCIgcm93U3Bhbj0iMSIgc3RyaW5nVmFsdWU9IjQuINCh0YPQvNC80YssINC/0L7Qu9GD0YfQtdC90L3Ri9C1INC+0YIg0YDQtdCw0LvQuNC30LDRhtC40Lgg0YLQvtCy0LDRgNC+0LIgKNGD0YHQu9GD0LMsINC40LzRg9GJ0LXRgdGC0LLQtdC90L3Ri9GFINC/0YDQsNCyKSDQv9C+INGA0LDRgdGH0ZHRgtC90L7QuSDRgdGC0LDQstC60LUg0LjRgdGH0LjRgdC70LXQvdC40Y8g0L3QsNC70L7Qs9CwINC+0YIg0YHRg9C80LzRiyDQv9C+0LvRg9GH0LXQvdC90L7Qs9C+INC00L7RhdC+0LTQsCAxMC8xMTAiIHN0eWxlQWxpYXM9ItCX0LDQs9C+0LvQvtCy0L7QuiIvPg0KICAgIDxjZWxsIGFsaWFzPSJwZXJpb2QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bVBsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc1BsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0icmF0ZU5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgPC9yb3c+DQogIDxyb3cgYWxpYXM9ImhlYWRfNSI+DQogICAgPGNlbGwgYWxpYXM9InJvd051bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgc3R5bGVBbGlhcz0i0JfQsNCz0L7Qu9C+0LLQvtC6Ii8+DQogICAgPGNlbGwgYWxpYXM9ImZpeCIgY29sU3Bhbj0iMTAiIHJvd1NwYW49IjEiIHN0cmluZ1ZhbHVlPSI1LiDQodGD0LzQvNGLINC/0L7Qu9GD0YfQtdC90L3QvtC5INC+0L/Qu9Cw0YLRiyAo0YfQsNGB0YLQuNGH0L3QvtC5INC+0L/Qu9Cw0YLRiykg0LIg0YHRh9GR0YIg0L/RgNC10LTRgdGC0L7Rj9GJ0LXQs9C+INC+0LrQsNC30LDQvdC40Y8g0YPRgdC70YPQsyDQv9C+INGA0LDRgdGH0ZHRgtC90L7QuSDRgdGC0LDQstC60LUg0LjRgdGH0LjRgdC70LXQvdC40Y8g0L3QsNC70L7Qs9CwINC+0YIg0YHRg9C80LzRiyDQv9C+0LvRg9GH0LXQvdC90L7Qs9C+INC00L7RhdC+0LTQsCAxOC8xMTgiIHN0eWxlQWxpYXM9ItCX0LDQs9C+0LvQvtCy0L7QuiIvPg0KICAgIDxjZWxsIGFsaWFzPSJwZXJpb2QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bVBsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc1BsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0icmF0ZU5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgPC9yb3c+DQogIDxyb3cgYWxpYXM9ImhlYWRfNiI+DQogICAgPGNlbGwgYWxpYXM9InJvd051bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgc3R5bGVBbGlhcz0i0JfQsNCz0L7Qu9C+0LLQvtC6Ii8+DQogICAgPGNlbGwgYWxpYXM9ImZpeCIgY29sU3Bhbj0iMTAiIHJvd1NwYW49IjEiIHN0cmluZ1ZhbHVlPSI2LiDQodGD0LzQvNGLLCDQv9C+0LvRg9GH0LXQvdC90YvQtSDQsiDQstC40LTQtSDRiNGC0YDQsNGE0L7Qsiwg0L/QtdC90LgsINC90LXRg9GB0YLQvtC10Log0L/QviDRgNCw0YHRh9GR0YLQvdC+0Lkg0YHRgtCw0LLQutC1INC40YHRh9C40YHQu9C10L3QuNGPINC90LDQu9C+0LPQsCDQvtGCINC+0LHRidC10Lkg0YHRg9C80LzRiyDQv9C+0LvRg9GH0LXQvdC90L7Qs9C+INC00L7RhdC+0LTQsCAxOC8xMTgiIHN0eWxlQWxpYXM9ItCX0LDQs9C+0LvQvtCy0L7QuiIvPg0KICAgIDxjZWxsIGFsaWFzPSJwZXJpb2QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bVBsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc1BsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0icmF0ZU5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgPC9yb3c+DQogIDxyb3cgYWxpYXM9Im1lZ2FfdG90YWwiPg0KICAgIDxjZWxsIGFsaWFzPSJyb3dOdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHN0eWxlQWxpYXM9ItCa0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiyIvPg0KICAgIDxjZWxsIGFsaWFzPSJmaXgiIGNvbFNwYW49IjIiIHJvd1NwYW49IjEiIHN0cmluZ1ZhbHVlPSLQktCh0JXQk9CeINC/0L4g0YDQsNC30LTQtdC70LDQvCAxLTYiIHN0eWxlQWxpYXM9ItCa0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiyIvPg0KICAgIDxjZWxsIGFsaWFzPSJwZXJpb2QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHN0eWxlQWxpYXM9ItCa0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiyIvPg0KICAgIDxjZWxsIGFsaWFzPSJudW1iZXIiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHN0eWxlQWxpYXM9ItCa0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiyIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1QbHVzIiBjb2xTcGFuPSIyIiByb3dTcGFuPSIxIiBzdHlsZUFsaWFzPSLQmtC+0L3RgtGA0L7Qu9GM0L3Ri9C1INGB0YPQvNC80YsiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHN0eWxlQWxpYXM9ItCa0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiyIvPg0KICAgIDxjZWxsIGFsaWFzPSJudW1iZXJOZHMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHN0eWxlQWxpYXM9ItCa0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiyIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1OZHNQbHVzIiBjb2xTcGFuPSIyIiByb3dTcGFuPSIxIiBzdHlsZUFsaWFzPSLQmtC+0L3RgtGA0L7Qu9GM0L3Ri9C1INGB0YPQvNC80YsiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHN0eWxlQWxpYXM9ItCa0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiyIvPg0KICAgIDxjZWxsIGFsaWFzPSJyYXRlTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiBzdHlsZUFsaWFzPSLQmtC+0L3RgtGA0L7Qu9GM0L3Ri9C1INGB0YPQvNC80YsiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiBzdHlsZUFsaWFzPSLQmtC+0L3RgtGA0L7Qu9GM0L3Ri9C1INGB0YPQvNC80YsiLz4NCiAgPC9yb3c+DQogIDxyb3cgYWxpYXM9ImhlYWRfNyI+DQogICAgPGNlbGwgYWxpYXM9InJvd051bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgc3R5bGVBbGlhcz0i0JfQsNCz0L7Qu9C+0LLQvtC6Ii8+DQogICAgPGNlbGwgYWxpYXM9ImZpeCIgY29sU3Bhbj0iMTAiIHJvd1NwYW49IjEiIHN0cmluZ1ZhbHVlPSI3LiDQodGD0LzQvNGLINC90LDQu9C+0LPQsCwg0L/QtdGA0LXRh9C40YHQu9C10L3QvdGL0LUg0L3QsNC70L7Qs9C+0LLRi9C8INCw0LPQtdC90YLQvtC8IiBzdHlsZUFsaWFzPSLQl9Cw0LPQvtC70L7QstC+0LoiLz4NCiAgICA8Y2VsbCBhbGlhcz0icGVyaW9kIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9Im51bWJlciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1QbHVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU1pbnVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9Im51bWJlck5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1OZHNQbHVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc01pbnVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InJhdGVOZHMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogIDwvcm93Pg0KICA8cm93IGFsaWFzPSJoZWFkXzgiPg0KICAgIDxjZWxsIGFsaWFzPSJyb3dOdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHN0eWxlQWxpYXM9ItCX0LDQs9C+0LvQvtCy0L7QuiIvPg0KICAgIDxjZWxsIGFsaWFzPSJmaXgiIGNvbFNwYW49IjEwIiByb3dTcGFuPSIxIiBzdHJpbmdWYWx1ZT0iOC4g0J3QsNC70L7Qs9C+0LLRi9C1INCy0YvRh9C10YLRiyDQv9C+INCx0LDQvdC60L7QstGB0LrQuNC8INC+0L/QtdGA0LDRhtC40Y/QvCAo0LDQstCw0L3RgdGLKSIgc3R5bGVBbGlhcz0i0JfQsNCz0L7Qu9C+0LLQvtC6Ii8+DQogICAgPGNlbGwgYWxpYXM9InBlcmlvZCIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJudW1iZXIiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtUGx1cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1NaW51cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJudW1iZXJOZHMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzUGx1cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1OZHNNaW51cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJyYXRlTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICA8L3Jvdz4NCiAgPHJvdyBhbGlhcz0iaGVhZF85Ij4NCiAgICA8Y2VsbCBhbGlhcz0icm93TnVtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiBzdHlsZUFsaWFzPSLQl9Cw0LPQvtC70L7QstC+0LoiLz4NCiAgICA8Y2VsbCBhbGlhcz0iZml4IiBjb2xTcGFuPSIxMCIgcm93U3Bhbj0iMSIgc3RyaW5nVmFsdWU9IjkuINCd0LDQu9C+0LPQvtCy0YvQtSDQstGL0YfQtdGC0Ysg0L/QviDQsdCw0L3QutC+0LLRgdC60LjQvCDQvtC/0LXRgNCw0YbQuNGP0LwgKNCy0L7Qt9Cy0YDQsNGC0YssINGD0LzQtdC90YzRiNC10L3QuNC1INC+0LHRitC10LzQsCwg0YHRgtC+0LjQvNC+0YHRgtC4INGD0YHQu9GD0LMpIiBzdHlsZUFsaWFzPSLQl9Cw0LPQvtC70L7QstC+0LoiLz4NCiAgICA8Y2VsbCBhbGlhcz0icGVyaW9kIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9Im51bWJlciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1QbHVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU1pbnVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9Im51bWJlck5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1OZHNQbHVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc01pbnVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9InJhdGVOZHMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIi8+DQogIDwvcm93Pg0KPC9yb3dzPg=='

        addLongText(form_template_id, longString, 'DATA_ROWS')
        logger.info("К версии макета добавлены фиксированные строки")
    }

    longString = ''
    if (addDataHeaders) {
        longString += 'PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48cm93cz4NCiAgPHJvdyBhbGlhcz0iIj4NCiAgICA8Y2VsbCBhbGlhcz0icm93TnVtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIzIiB2YWx1ZT0i4oSWINC/0L8iLz4NCiAgICA8Y2VsbCBhbGlhcz0iZml4IiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0iIi8+DQogICAgPGNlbGwgYWxpYXM9InBlcmlvZCIgY29sU3Bhbj0iNyIgcm93U3Bhbj0iMSIgdmFsdWU9ItCU0LDQvdC90YvQtSDQsdGD0YXQs9Cw0LvRgtC10YDRgdC60L7Qs9C+INGD0YfRkdGC0LAiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0JTQsNC90L3Ri9C1INCx0YPRhdCz0LDQu9GC0LXRgNGB0LrQvtCz0L4g0YPRh9GR0YLQsC4g0JLQtdC70LjRh9C40L3QsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCDQvdCw0LvQvtCz0L7QstC+0Lkg0LHQsNC30YsuINCd0L7QvNC10YAg0LHQsNC70LDQvdGB0L7QstC+0LPQviDRgdGH0ZHRgtCwIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bVBsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQlNCw0L3QvdGL0LUg0LHRg9GF0LPQsNC70YLQtdGA0YHQutC+0LPQviDRg9GH0ZHRgtCwLiDQktC10LvQuNGH0LjQvdCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4INC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiy4g0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoKykiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQlNCw0L3QvdGL0LUg0LHRg9GF0LPQsNC70YLQtdGA0YHQutC+0LPQviDRg9GH0ZHRgtCwLiDQktC10LvQuNGH0LjQvdCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4INC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiy4g0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoLSkiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0JTQsNC90L3Ri9C1INCx0YPRhdCz0LDQu9GC0LXRgNGB0LrQvtCz0L4g0YPRh9GR0YLQsC4g0JLQtdC70LjRh9C40L3QsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCDQndCU0KEuINCd0L7QvNC10YAg0LHQsNC70LDQvdGB0L7QstC+0LPQviDRgdGH0ZHRgtCwIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc1BsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQlNCw0L3QvdGL0LUg0LHRg9GF0LPQsNC70YLQtdGA0YHQutC+0LPQviDRg9GH0ZHRgtCwLiDQktC10LvQuNGH0LjQvdCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4INCd0JTQoS4g0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoKykiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQlNCw0L3QvdGL0LUg0LHRg9GF0LPQsNC70YLQtdGA0YHQutC+0LPQviDRg9GH0ZHRgtCwLiDQktC10LvQuNGH0LjQvdCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4INCd0JTQoS4g0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoLSkiLz4NCiAgICA8Y2VsbCBhbGlhcz0icmF0ZU5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMyIgdmFsdWU9ItCh0YLQsNCy0LrQsCDQndCU0KEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIzIiB2YWx1ZT0i0KHRg9C80LzQsCDQndCU0KEg0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3Ri9C8INC70LjRgdGC0LDQvCDQutC90LjQs9C4INC/0YDQvtC00LDQtiAo0YDQsNC30LTQtdC70YsgMS03KS/QutC90LjQs9C4INC/0L7QutGD0L/QvtC6ICjRgNCw0LfQtNC10LvRiyA4LTkpIi8+DQogIDwvcm93Pg0KICA8cm93IGFsaWFzPSIiPg0KICAgIDxjZWxsIGFsaWFzPSJyb3dOdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLihJYg0L/QvyIvPg0KICAgIDxjZWxsIGFsaWFzPSJmaXgiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSIiLz4NCiAgICA8Y2VsbCBhbGlhcz0icGVyaW9kIiBjb2xTcGFuPSI0IiByb3dTcGFuPSIxIiB2YWx1ZT0i0JLQtdC70LjRh9C40L3QsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCDQvdCw0LvQvtCz0L7QstC+0Lkg0LHQsNC30YsiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0JTQsNC90L3Ri9C1INCx0YPRhdCz0LDQu9GC0LXRgNGB0LrQvtCz0L4g0YPRh9GR0YLQsC4g0JLQtdC70LjRh9C40L3QsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCDQvdCw0LvQvtCz0L7QstC+0Lkg0LHQsNC30YsuINCd0L7QvNC10YAg0LHQsNC70LDQvdGB0L7QstC+0LPQviDRgdGH0ZHRgtCwIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bVBsdXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQlNCw0L3QvdGL0LUg0LHRg9GF0LPQsNC70YLQtdGA0YHQutC+0LPQviDRg9GH0ZHRgtCwLiDQktC10LvQuNGH0LjQvdCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4INC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiy4g0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoKykiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQlNCw0L3QvdGL0LUg0LHRg9GF0LPQsNC70YLQtdGA0YHQutC+0LPQviDRg9GH0ZHRgtCwLiDQktC10LvQuNGH0LjQvdCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4INC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiy4g0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoLSkiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyTmRzIiBjb2xTcGFuPSIzIiByb3dTcGFuPSIxIiB2YWx1ZT0i0JLQtdC70LjRh9C40L3QsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCDQndCU0KEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzUGx1cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCU0LDQvdC90YvQtSDQsdGD0YXQs9Cw0LvRgtC10YDRgdC60L7Qs9C+INGD0YfRkdGC0LAuINCS0LXQu9C40YfQuNC90LAg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60Lgg0J3QlNChLiDQodGD0LzQvNCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4ICgrKSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW1OZHNNaW51cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCU0LDQvdC90YvQtSDQsdGD0YXQs9Cw0LvRgtC10YDRgdC60L7Qs9C+INGD0YfRkdGC0LAuINCS0LXQu9C40YfQuNC90LAg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60Lgg0J3QlNChLiDQodGD0LzQvNCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4ICgtKSIvPg0KICAgIDxjZWxsIGFsaWFzPSJyYXRlTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHRgtCw0LLQutCwINCd0JTQoSIvPg0KICAgIDxjZWxsIGFsaWFzPSJzdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQodGD0LzQvNCwINCd0JTQoSDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdGL0Lwg0LvQuNGB0YLQsNC8INC60L3QuNCz0Lgg0L/RgNC+0LTQsNC2ICjRgNCw0LfQtNC10LvRiyAxLTcpL9C60L3QuNCz0Lgg0L/QvtC60YPQv9C+0LogKNGA0LDQt9C00LXQu9GLIDgtOSkiLz4NCiAgPC9yb3c+DQogIDxyb3cgYWxpYXM9IiI+DQogICAgPGNlbGwgYWxpYXM9InJvd051bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IuKEliDQv9C/Ii8+DQogICAgPGNlbGwgYWxpYXM9ImZpeCIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IiIvPg0KICAgIDxjZWxsIGFsaWFzPSJwZXJpb2QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQndCw0LvQvtCz0L7QstGL0Lkg0L/QtdGA0LjQvtC0LCDQt9CwINC60L7RgtC+0YDRi9C5INCy0L3QvtGB0LjRgtGB0Y8g0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LAiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0L3QvtC80LXRgCDQsdCw0LvQsNC90YHQvtCy0L7Qs9C+INGB0YfRkdGC0LAiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtUGx1cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCh0YPQvNC80LAg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU1pbnVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoLSkiLz4NCiAgICA8Y2VsbCBhbGlhcz0ibnVtYmVyTmRzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0L3QvtC80LXRgCDQsdCw0LvQsNC90YHQvtCy0L7Qs9C+INGB0YfRkdGC0LAiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzUGx1cyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCh0YPQvNC80LAg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspIi8+DQogICAgPGNlbGwgYWxpYXM9InN1bU5kc01pbnVzIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoLSkiLz4NCiAgICA8Y2VsbCBhbGlhcz0icmF0ZU5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCh0YLQsNCy0LrQsCDQndCU0KEiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHRg9C80LzQsCDQndCU0KEg0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3Ri9C8INC70LjRgdGC0LDQvCDQutC90LjQs9C4INC/0YDQvtC00LDQtiAo0YDQsNC30LTQtdC70YsgMS03KS/QutC90LjQs9C4INC/0L7QutGD0L/QvtC6ICjRgNCw0LfQtNC10LvRiyA4LTkpIi8+DQogIDwvcm93Pg0KICA8cm93IGFsaWFzPSIiPg0KICAgIDxjZWxsIGFsaWFzPSJyb3dOdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSIxIi8+DQogICAgPGNlbGwgYWxpYXM9ImZpeCIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IiIvPg0KICAgIDxjZWxsIGFsaWFzPSJwZXJpb2QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSIyIi8+DQogICAgPGNlbGwgYWxpYXM9Im51bWJlciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IjMiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtUGx1cyIgY29sU3Bhbj0iMiIgcm93U3Bhbj0iMSIgdmFsdWU9IjQiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSI1Ii8+DQogICAgPGNlbGwgYWxpYXM9Im51bWJlck5kcyIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IjUiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzUGx1cyIgY29sU3Bhbj0iMiIgcm93U3Bhbj0iMSIgdmFsdWU9IjYiLz4NCiAgICA8Y2VsbCBhbGlhcz0ic3VtTmRzTWludXMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSI4Ii8+DQogICAgPGNlbGwgYWxpYXM9InJhdGVOZHMiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSI3Ii8+DQogICAgPGNlbGwgYWxpYXM9InN1bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IjgiLz4NCiAgPC9yb3c+DQo8L3Jvd3M+'

        addLongText(form_template_id, longString, 'DATA_HEADERS')
        logger.info("К версии макета добавлен заголовок")
    }

    longString = ''
    if (addScript) {
        longString += 'cGFja2FnZSBmb3JtX3RlbXBsYXRlLnZhdC52YXRfNzI0XzFfMS52MjAxNQ0KDQppbXBvcnQgY29tLmFwbGFuYS5zYnJmLnRheGFjY291bnRpbmcubW9kZWwuRm9ybURhdGFFdmVudA0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLldvcmtmbG93U3RhdGUNCmltcG9ydCBjb20uYXBsYW5hLnNicmYudGF4YWNjb3VudGluZy5tb2RlbC5leGNlcHRpb24uU2VydmljZUV4Y2VwdGlvbg0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLmxvZy5Mb2dMZXZlbA0KaW1wb3J0IGdyb292eS50cmFuc2Zvcm0uRmllbGQNCg0KLyoqDQogKiAoNzI0LjEuMSkg0JrQvtGA0YDQtdC60YLQuNGA0L7QstC60LAg0YHRg9C80Lwg0J3QlNChINC4INC90LDQu9C+0LPQvtCy0YvRhSDQstGL0YfQtdGC0L7QsiDQt9CwINC/0YDQvtGI0LXQtNGI0LjQtSDQvdCw0LvQvtCz0L7QstGL0LUg0L/QtdGA0LjQvtC00YsNCiAqDQogKiBmb3JtVGVtcGxhdGVJZD04NDgNCiAqLw0KDQovLyDQs9GA0LDRhNCwIDEgIC0gcm93TnVtDQovLyDQs9GA0LDRhNCwICAgIC0gZml4DQovLyDQs9GA0LDRhNCwIDIgIC0gcGVyaW9kDQovLyDQs9GA0LDRhNCwIDMgIC0gbnVtYmVyDQovLyDQs9GA0LDRhNCwIDQgIC0gc3VtUGx1cw0KLy8g0LPRgNCw0YTQsCA1ICAtIHN1bU1pbnVzDQovLyDQs9GA0LDRhNCwIDYgIC0gbnVtYmVyTmRzDQovLyDQs9GA0LDRhNCwIDcgIC0gc3VtTmRzUGx1cw0KLy8g0LPRgNCw0YTQsCA4ICAtIHN1bU5kc01pbnVzDQovLyDQs9GA0LDRhNCwIDkgIC0gcmF0ZU5kcw0KLy8g0LPRgNCw0YTQsCAxMCAtIHN1bQ0KDQpzd2l0Y2ggKGZvcm1EYXRhRXZlbnQpIHsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ1JFQVRFOg0KICAgICAgICBmb3JtRGF0YVNlcnZpY2UuY2hlY2tVbmlxdWUoZm9ybURhdGEsIGxvZ2dlcikNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ0FMQ1VMQVRFOg0KICAgICAgICBjYWxjKCkNCiAgICAgICAgbG9naWNDaGVjaygpDQogICAgICAgIGZvcm1EYXRhU2VydmljZS5zYXZlQ2FjaGVkRGF0YVJvd3MoZm9ybURhdGEsIGxvZ2dlcikNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ0hFQ0s6DQogICAgICAgIGxvZ2ljQ2hlY2soKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5BRERfUk9XOg0KICAgICAgICBhZGRSb3coKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5ERUxFVEVfUk9XOg0KICAgICAgICBpZiAoY3VycmVudERhdGFSb3cgIT0gbnVsbCAmJiBjdXJyZW50RGF0YVJvdy5nZXRBbGlhcygpID09IG51bGwpIHsNCiAgICAgICAgICAgIGZvcm1EYXRhU2VydmljZS5nZXREYXRhUm93SGVscGVyKGZvcm1EYXRhKT8uZGVsZXRlKGN1cnJlbnREYXRhUm93KQ0KICAgICAgICB9DQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfQ1JFQVRFRF9UT19QUkVQQVJFRDogIC8vINCf0L7QtNCz0L7RgtC+0LLQuNGC0Ywg0LjQtyAi0KHQvtC30LTQsNC90LAiDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfQ1JFQVRFRF9UT19BUFBST1ZFRDogIC8vINCj0YLQstC10YDQtNC40YLRjCDQuNC3ICLQodC+0LfQtNCw0L3QsCINCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuTU9WRV9DUkVBVEVEX1RPX0FDQ0VQVEVEOiAgLy8g0J/RgNC40L3Rj9GC0Ywg0LjQtyAi0KHQvtC30LTQsNC90LAiDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfUFJFUEFSRURfVE9fQVBQUk9WRUQ6IC8vINCj0YLQstC10YDQtNC40YLRjCDQuNC3ICLQn9C+0LTQs9C+0YLQvtCy0LvQtdC90LAiDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfUFJFUEFSRURfVE9fQUNDRVBURUQ6IC8vINCf0YDQuNC90Y/RgtGMINC40LcgItCf0L7QtNCz0L7RgtC+0LLQu9C10L3QsCINCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuTU9WRV9BUFBST1ZFRF9UT19BQ0NFUFRFRDogLy8g0J/RgNC40L3Rj9GC0Ywg0LjQtyAi0KPRgtCy0LXRgNC20LTQtdC90LAiDQogICAgICAgIGxvZ2ljQ2hlY2soKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5DT01QT1NFOg0KICAgICAgICBjb25zb2xpZGF0aW9uKCkNCiAgICAgICAgY2FsYygpDQogICAgICAgIGxvZ2ljQ2hlY2soKQ0KICAgICAgICBmb3JtRGF0YVNlcnZpY2Uuc2F2ZUNhY2hlZERhdGFSb3dzKGZvcm1EYXRhLCBsb2dnZXIpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LklNUE9SVDoNCiAgICAgICAgaW1wb3J0RGF0YSgpDQogICAgICAgIGZvcm1EYXRhU2VydmljZS5zYXZlQ2FjaGVkRGF0YVJvd3MoZm9ybURhdGEsIGxvZ2dlcikNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuU09SVF9ST1dTOg0KICAgICAgICBzb3J0Rm9ybURhdGFSb3dzKCkNCiAgICAgICAgYnJlYWsNCn0NCg0KLy8vLyDQmtGN0YjQuCDQuCDQutC+0L3RgdGC0LDQvdGC0YsNCkBGaWVsZA0KZGVmIHByb3ZpZGVyQ2FjaGUgPSBbOl0NCkBGaWVsZA0KZGVmIHJlY29yZENhY2hlID0gWzpdDQpARmllbGQNCmRlZiByZWZCb29rQ2FjaGUgPSBbOl0NCg0KLy8g0LLRgdC1INCw0YLRgNC40LHRg9GC0YsNCkBGaWVsZA0KZGVmIGFsbENvbHVtbnMgPSBbJ3Jvd051bScsICdmaXgnLCAncGVyaW9kJywgJ251bWJlcicsICdzdW1QbHVzJywgJ3N1bU1pbnVzJywgJ251bWJlck5kcycsICdzdW1OZHNQbHVzJywgJ3N1bU5kc01pbnVzJywgJ3JhdGVOZHMnLCAnc3VtJ10NCg0KLy8g0KDQtdC00LDQutGC0LjRgNGD0LXQvNGL0LUg0LDRgtGA0LjQsdGD0YLRiyAo0LPRgNCw0YTQsCAyLDMsNi04KSDQvdC1INC00LvRjyDRgNCw0LfQtNC10LvQvtCyIDEtNg0KQEZpZWxkDQpkZWYgZWRpdGFibGVDb2x1bW5zID0gWydwZXJpb2QnLCAnbnVtYmVyJywgJ3N1bVBsdXMnLCAnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cyddDQoNCi8vINCg0LXQtNCw0LrRgtC40YDRg9C10LzRi9C1INCw0YLRgNC40LHRg9GC0YsgKNCz0YDQsNGE0LAgMi04KSDQtNC70Y8g0YDQsNC30LTQtdC70L7QsiAxLTYNCkBGaWVsZA0KZGVmIGVkaXRhYmxlQ29sdW1uc18xXzYgPSBbJ3BlcmlvZCcsICdudW1iZXInLCAnc3VtUGx1cycsICdzdW1NaW51cycsICdudW1iZXJOZHMnLCAnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cyddDQoNCi8vINCf0YDQvtCy0LXRgNGP0LXQvNGL0LUg0L3QsCDQv9GD0YHRgtGL0LUg0LfQvdCw0YfQtdC90LjRjyDQsNGC0YDQuNCx0YPRgtGLICjQs9GA0LDRhNCwIDIsIDMsIDksIDEwKQ0KQEZpZWxkDQpkZWYgbm9uRW1wdHlDb2x1bW5zID0gWydwZXJpb2QnLCAnbnVtYmVyJywgJ3JhdGVOZHMnLCAnc3VtJ10NCg0KQEZpZWxkDQpkZWYgZW1wdHlDb2x1bW5zXzdfOSA9IFsnc3VtUGx1cycsICdzdW1NaW51cyddDQoNCi8vINCQ0YLRgNC40LHRg9GC0Ysg0LjRgtC+0LPQvtCy0YvRhSDRgdGC0YDQvtC6INC00LvRjyDQutC+0YLQvtGA0YvRhSDQstGL0YfQuNGB0LvRj9GO0YLRgdGPINGB0YPQvNC80YsNCi8vINC00LvRjyDQs9GA0YPQv9C/IDEgLSA2LCAi0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/RgNC+0LTQsNC2Li4uIiAo0LPRgNCw0YTQsCA0LCA1LCA3LCA4LCAxMCkNCkBGaWVsZA0KZGVmIHRvdGFsQ29sdW1uczFfNl9TYWxlID0gWydzdW1QbHVzJywgJ3N1bU1pbnVzJywgJ3N1bU5kc1BsdXMnLCAnc3VtTmRzTWludXMnLCAnc3VtJ10NCg0KLy8g0LTQu9GPINCz0YDRg9C/0L/RiyAi0JLQodCV0JPQniDQv9C+INGA0LDQt9C00LXQu9Cw0LwgMS02IiAo0LPRgNCw0YTQsCA3LCA4KQ0KQEZpZWxkDQpkZWYgdG90YWxDb2x1bW5zTWVnYSA9IFsnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cyddDQoNCi8vINC00LvRjyDQs9GA0YPQv9C/0YsgNywgOCwgOSwgItCS0KHQldCT0J4g0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3QvtC80YMg0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0L7QutGD0L/QvtC6Li4uIiAo0LPRgNCw0YTQsCA3LCA4LCAxMCkNCkBGaWVsZA0KZGVmIHRvdGFsQ29sdW1uczdfOV9QdXJjaGFzZSA9IFsnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cycsICdzdW0nXQ0KDQpARmllbGQNCmRlZiBza2lwQ29sdW1ucyA9IFsnc3VtTWludXMnLCAnc3VtTmRzTWludXMnXQ0KDQovLyDQk9GA0YPQv9C/0LjRgNGD0LXQvNGL0LUg0LDRgtGA0LjQsdGD0YLRiyAo0LPRgNCw0YTQsCAyKQ0KQEZpZWxkDQpkZWYgZ3JvdXBDb2x1bW5zID0gWydwZXJpb2QnXQ0KDQovLyDQodC+0YDRgtC40YDRg9C10LzRi9C1INCw0YLRgNC40LHRg9GC0YsgKNCz0YDQsNGE0LAgMiwgNiwgMykNCkBGaWVsZA0KZGVmIHNvcnRDb2x1bW5zID0gWydwZXJpb2QnLCAnbnVtYmVyTmRzJywgJ251bWJlciddDQoNCi8vINGB0L/QuNGB0L7QuiDQsNC70LjQsNGB0L7QsiDQv9C+0LTRgNCw0LfQtNC10LvQvtCyDQpARmllbGQNCmRlZiBzZWN0aW9ucyA9IFsnMScsICcyJywgJzMnLCAnNCcsICc1JywgJzYnLCAnNycsICc4JywgJzknXQ0KDQpARmllbGQNCmRlZiByYXRlTWFwID0gWw0KICAgICAgICAnMScgOiBbJzE4JywgJzEnXSwNCiAgICAgICAgJzInIDogWycxMCcsICcyJ10sDQogICAgICAgICczJyA6IFsnMTgvMTE4JywgJzMsIDUtOSddLA0KICAgICAgICAnNCcgOiBbJzEwLzExMCcsICc0J10sDQogICAgICAgICc1JyA6IFsnMTgvMTE4JywgJzMsIDUtOSddLA0KICAgICAgICAnNicgOiBbJzE4LzExOCcsICczLCA1LTknXSwNCiAgICAgICAgJzcnIDogWycxOC8xMTgnLCAnMywgNS05J10sDQogICAgICAgICc4JyA6IFsnMTgvMTE4JywgJzMsIDUtOSddLA0KICAgICAgICAnOScgOiBbJzE4LzExOCcsICczLCA1LTknXQ0KXQ0KDQpARmllbGQNCmRlZiBudW1iZXJNYXAgPSBbICcxJyA6IFtbJzYwMzA5MDEnXSwgJzEtNCddLA0KICAgICAgICAgICAgICAgICAgJzInIDogW1snNjAzMDkwMSddLCAnMS00J10sDQogICAgICAgICAgICAgICAgICAnMycgOiBbWyc2MDMwOTAxJ10sICcxLTQnXSwNCiAgICAgICAgICAgICAgICAgICc0JyA6IFtbJzYwMzA5MDEnXSwgJzEtNCddLA0KICAgICAgICAgICAgICAgICAgJzUnIDogW1snNjAzMDkwNCddLCAnNSddLA0KICAgICAgICAgICAgICAgICAgJzYnIDogW1snNjAzMDkwNSddLCAnNiddLA0KICAgICAgICAgICAgICAgICAgJzcnIDogW1snNjAzMDkwMyddLCAnNywgOSddLA0KICAgICAgICAgICAgICAgICAgJzgnIDogW1snNjAzMDkwMScsICc2MDMwOTA0JywgJzYwMzA5MDUnXSwgJzgnXSwNCiAgICAgICAgICAgICAgICAgICc5JyA6IFtbJzYwMzA5MDMnXSwgJzcsIDknXQ0KXQ0KDQpARmllbGQNCmRlZiBzZWN0aW9uc0xhYmVscyA9IFsnc2FsZV8xOCcgOiAi0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/RgNC+0LTQsNC2INC30LAgJXMg0L/QviDRgdGC0LDQstC60LUgMTglJSIsDQogICAgICAgICAgICAgICAgICAgICAgJ3NhbGVfMTAnIDogItCS0KHQldCT0J4g0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3QvtC80YMg0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0YDQvtC00LDQtiDQt9CwICVzINC/0L4g0YHRgtCw0LLQutC1IDEwJSUiLA0KICAgICAgICAgICAgICAgICAgICAgICdwdXJjaGFzZScgOiAi0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/QvtC60YPQv9C+0Log0LfQsCAlcyDQv9C+INGB0YLQsNCy0LrQtSAxOCUlIl0NCg0KQEZpZWxkDQpkZWYgc3RhcnREYXRlID0gbnVsbA0KDQpARmllbGQNCmRlZiBlbmREYXRlID0gbnVsbA0KDQpkZWYgZ2V0UmVwb3J0UGVyaW9kU3RhcnREYXRlKCkgew0KICAgIGlmIChzdGFydERhdGUgPT0gbnVsbCkgew0KICAgICAgICBzdGFydERhdGUgPSByZXBvcnRQZXJpb2RTZXJ2aWNlLmdldENhbGVuZGFyU3RhcnREYXRlKGZvcm1EYXRhLnJlcG9ydFBlcmlvZElkKS50aW1lDQogICAgfQ0KICAgIHJldHVybiBzdGFydERhdGUNCn0NCg0KZGVmIGdldFJlcG9ydFBlcmlvZEVuZERhdGUoKSB7DQogICAgaWYgKGVuZERhdGUgPT0gbnVsbCkgew0KICAgICAgICBlbmREYXRlID0gcmVwb3J0UGVyaW9kU2VydmljZS5nZXRFbmREYXRlKGZvcm1EYXRhLnJlcG9ydFBlcmlvZElkKS50aW1lDQogICAgfQ0KICAgIHJldHVybiBlbmREYXRlDQp9DQoNCi8vINCf0L7QuNGB0Log0LfQsNC/0LjRgdC4INCyINGB0L/RgNCw0LLQvtGH0L3QuNC60LUg0L/QviDQt9C90LDRh9C10L3QuNGOICjQtNC70Y8g0YDQsNGB0YfQtdGC0L7QsikgKyDQv9C+INC00LDRgtC1DQpkZWYgZ2V0UmVmQm9va1JlY29yZChkZWYgTG9uZyByZWZCb29rSWQsIGRlZiBTdHJpbmcgYWxpYXMsIGRlZiBTdHJpbmcgdmFsdWUsIGRlZiBEYXRlIGRheSwgZGVmIGludCByb3dJbmRleCwgZGVmIFN0cmluZyBjZWxsTmFtZSwNCiAgICAgICAgICAgICAgICAgICAgIGJvb2xlYW4gcmVxdWlyZWQpIHsNCiAgICByZXR1cm4gZm9ybURhdGFTZXJ2aWNlLmdldFJlZkJvb2tSZWNvcmQocmVmQm9va0lkLCByZWNvcmRDYWNoZSwgcHJvdmlkZXJDYWNoZSwgcmVmQm9va0NhY2hlLCBhbGlhcywgdmFsdWUsDQogICAgICAgICAgICBkYXksIHJvd0luZGV4LCBjZWxsTmFtZSwgbG9nZ2VyLCByZXF1aXJlZCkNCn0NCg0KLy8g0J/QvtC40YHQuiDQt9Cw0L/QuNGB0Lgg0LIg0YHQv9GA0LDQstC+0YfQvdC40LrQtSDQv9C+INC30L3QsNGH0LXQvdC40Y4gKNC00LvRjyDQuNC80L/QvtGA0YLQsCkNCmRlZiBnZXRSZWNvcmRJZEltcG9ydChkZWYgTG9uZyByZWZCb29rSWQsIGRlZiBTdHJpbmcgYWxpYXMsIGRlZiBTdHJpbmcgdmFsdWUsIGRlZiBpbnQgcm93SW5kZXgsIGRlZiBpbnQgY29sSW5kZXgsDQogICAgICAgICAgICAgICAgICAgICAgZGVmIGJvb2xlYW4gcmVxdWlyZWQgPSBmYWxzZSkgew0KICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlLnRyaW0oKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgcmV0dXJuIG51bGwNCiAgICB9DQogICAgcmV0dXJuIGZvcm1EYXRhU2VydmljZS5nZXRSZWZCb29rUmVjb3JkSWRJbXBvcnQocmVmQm9va0lkLCByZWNvcmRDYWNoZSwgcHJvdmlkZXJDYWNoZSwgYWxpYXMsIHZhbHVlLA0KICAgICAgICAgICAgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpLCByb3dJbmRleCwgY29sSW5kZXgsIGxvZ2dlciwgcmVxdWlyZWQpDQp9DQoNCi8vINCg0LDQt9GL0LzQtdC90L7QstCw0L3QuNC1INC30LDQv9C40YHQuCDRgdC/0YDQsNCy0L7Rh9C90LjQutCwDQpkZWYgZ2V0UmVmQm9va1ZhbHVlKGRlZiBsb25nIHJlZkJvb2tJZCwgZGVmIExvbmcgcmVjb3JkSWQpIHsNCiAgICByZXR1cm4gZm9ybURhdGFTZXJ2aWNlLmdldFJlZkJvb2tWYWx1ZShyZWZCb29rSWQsIHJlY29yZElkLCByZWZCb29rQ2FjaGUpDQp9DQoNCi8vINCf0L7Qu9GD0YfQtdC90LjQtSDRh9C40YHQu9CwINC40Lcg0YHRgtGA0L7QutC4INC/0YDQuCDQuNC80L/QvtGA0YLQtQ0KZGVmIGdldE51bWJlcihkZWYgdmFsdWUsIGRlZiBpbmRleFJvdywgZGVmIGluZGV4Q29sKSB7DQogICAgcmV0dXJuIHBhcnNlTnVtYmVyKHZhbHVlLCBpbmRleFJvdywgaW5kZXhDb2wsIGxvZ2dlciwgdHJ1ZSkNCn0NCg0KLy8vLyDQmtCw0YHRgtC+0LzQvdGL0LUg0LzQtdGC0L7QtNGLDQpkZWYgYWRkUm93KCkgew0KICAgIGRlZiBkYXRhUm93SGVscGVyID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpDQogICAgZGVmIGRhdGFSb3dzID0gZGF0YVJvd0hlbHBlci5hbGxDYWNoZWQNCiAgICBkZWYgaW5kZXgNCiAgICBib29sZWFuIGlzR3JvdXBfMV82ID0gZmFsc2UNCiAgICBpZiAoY3VycmVudERhdGFSb3cgIT0gbnVsbCkgew0KICAgICAgICBkZWYgYWxpYXMgPSBjdXJyZW50RGF0YVJvdy5nZXRBbGlhcygpDQogICAgICAgIGluZGV4ID0gY3VycmVudERhdGFSb3cuZ2V0SW5kZXgoKQ0KICAgICAgICBpZiAoYWxpYXMgPT0gbnVsbCB8fCBhbGlhcy5zdGFydHNXaXRoKCdoZWFkJykpIHsNCiAgICAgICAgICAgIGluZGV4KysNCiAgICAgICAgfQ0KICAgICAgICBpZiAoYWxpYXMgIT0gbnVsbCAmJiBhbGlhcyA9PSAibWVnYV90b3RhbCIpIHsNCiAgICAgICAgICAgIGluZGV4ICs9IDINCiAgICAgICAgfQ0KICAgICAgICBpc0dyb3VwXzFfNiA9IGdldERhdGFSb3coZGF0YVJvd3MsICdtZWdhX3RvdGFsJykuZ2V0SW5kZXgoKSA+IGN1cnJlbnREYXRhUm93LmdldEluZGV4KCkNCiAgICB9IGVsc2Ugew0KICAgICAgICBpbmRleCA9IGRhdGFSb3dzLnNpemUoKSArIDENCiAgICB9DQogICAgZGF0YVJvd0hlbHBlci5pbnNlcnQoZ2V0TmV3Um93KGlzR3JvdXBfMV82KSwgaW5kZXgpDQp9DQoNCi8qKiDQn9C+0LvRg9GH0LjRgtGMINC90L7QstGD0Y4g0YHRgtGA0L7QutGDINGBINC30LDQtNCw0L3QvdGL0LzQuCDRgdGC0LjQu9GP0LzQuC4gKi8NCmRlZiBnZXROZXdSb3coYm9vbGVhbiBpc0dyb3VwXzFfNikgew0KICAgIGRlZiBuZXdSb3cgPSAoZm9ybURhdGFFdmVudCBpbiBbRm9ybURhdGFFdmVudC5JTVBPUlQsIEZvcm1EYXRhRXZlbnQuSU1QT1JUX1RSQU5TUE9SVF9GSUxFXSkgPyBmb3JtRGF0YS5jcmVhdGVTdG9yZU1lc3NhZ2luZ0RhdGFSb3coKSA6IGZvcm1EYXRhLmNyZWF0ZURhdGFSb3coKQ0KICAgIGRlZiBjb2x1bW5zID0gaXNHcm91cF8xXzYgPyBlZGl0YWJsZUNvbHVtbnNfMV82IDogZWRpdGFibGVDb2x1bW5zDQogICAgY29sdW1ucy5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLmVkaXRhYmxlID0gdHJ1ZQ0KICAgICAgICBuZXdSb3cuZ2V0Q2VsbChpdCkuc3R5bGVBbGlhcyA9ICfQoNC10LTQsNC60YLQuNGA0YPQtdC80LDRjycNCiAgICB9DQogICAgKGFsbENvbHVtbnMgLSBjb2x1bW5zKS5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLnN0eWxlQWxpYXMgPSAn0JDQstGC0L7Qt9Cw0L/QvtC70L3Rj9C10LzQsNGPJw0KICAgIH0NCiAgICByZXR1cm4gbmV3Um93DQp9DQoNCi8vINCQ0LvQs9C+0YDQuNGC0LzRiyDQt9Cw0L/QvtC70L3QtdC90LjRjyDQv9C+0LvQtdC5INGE0L7RgNC80YsNCnZvaWQgY2FsYygpIHsNCiAgICBkZWYgZGF0YVJvd3MgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSkuYWxsQ2FjaGVkDQoNCiAgICAvLyDRg9C00LDQu9GP0LXQvCDRgNCw0YHRgdGH0LjRgtGL0LLQsNC10LzRi9C1INC40YLQvtCz0LgNCiAgICBkYXRhUm93cy5yZW1vdmVBbGwgeyByb3cgLT4NCiAgICAgICAgcm93LmdldEFsaWFzKCkgIT0gbnVsbCAmJiByb3cuZ2V0QWxpYXMoKSAhPSAoJ21lZ2FfdG90YWwnKSAmJiAhcm93LmdldEFsaWFzKCkuc3RhcnRzV2l0aCgnaGVhZF8nKQ0KICAgIH0NCg0KICAgIHVwZGF0ZUluZGV4ZXMoZGF0YVJvd3MpDQoNCiAgICAvLyDRgNCw0YHQv9GA0LXQtNC10LvRj9C10Lwg0YHRgtGA0L7QutC4INC/0L4g0LPRgNGD0L/Qv9Cw0LwNCiAgICBkZWYgc2VjdGlvbk1hcCA9IGFycmFuZ2VSb3dzKGRhdGFSb3dzKQ0KDQogICAgLy8g0YDQsNGB0YfQtdGC0YsNCiAgICBzZWN0aW9uTWFwLmtleVNldCgpLmVhY2ggeyBzZWN0aW9uIC0+DQogICAgICAgIGZvciAocm93IGluIHNlY3Rpb25NYXBbc2VjdGlvbl0pIHsNCiAgICAgICAgICAgIGlmIChyb3cuZ2V0QWxpYXMoKSAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJvdy5yYXRlTmRzID0gcmF0ZU1hcFtzZWN0aW9uXVswXQ0KICAgICAgICB9DQogICAgfQ0KDQogICAgZm9yIChyb3cgaW4gZGF0YVJvd3MpIHsNCiAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpICE9IG51bGwpIHsNCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgcm93LnN1bSA9IGNhbGNDaGVjazEwKHJvdywgbnVsbCkNCiAgICB9DQoNCiAgICAvLyDQtNC+0LHQsNCy0LjQvCDRgdGC0YDQvtC60Lgg0LzQsNC60LXRgtCwDQogICAgZGF0YVJvd3MuY2xlYXIoKQ0KICAgIGRhdGFSb3dzLmFkZEFsbChmb3JtRGF0YVNlcnZpY2UuZ2V0Rm9ybVRlbXBsYXRlKGZvcm1EYXRhLmZvcm1UeXBlLmlkLCBmb3JtRGF0YS5yZXBvcnRQZXJpb2RJZCkucm93cykNCiAgICB1cGRhdGVJbmRleGVzKGRhdGFSb3dzKQ0KDQogICAgLy8g0KHQvtGA0YLQuNGA0L7QstC60LAg0Lgg0LTQvtCx0LDQstC70LXQvdC40LUg0L3QtdGE0LjQutGB0LjRgNC+0LLQsNC90L3Ri9GFINGB0YLRgNC+0LoNCiAgICBzZWN0aW9uTWFwLmVhY2ggeyBrZXksIHJvd3MgLT4NCiAgICAgICAgcm93cy5zb3J0IHsgcm93IC0+DQogICAgICAgICAgICBnZXRSZWZCb29rVmFsdWUoOCwgcm93LnBlcmlvZCk/LkNPREU/LnN0cmluZ1ZhbHVlID86ICcwMCcNCiAgICAgICAgfQ0KICAgICAgICBkYXRhUm93cy5hZGRBbGwoZ2V0RGF0YVJvdyhkYXRhUm93cywgJ2hlYWRfJyArIGtleSkuZ2V0SW5kZXgoKSwgcm93cykNCiAgICAgICAgdXBkYXRlSW5kZXhlcyhkYXRhUm93cykNCiAgICB9DQoNCiAgICAvLyDRgdC+0LfQtNCw0LXRgiDRgNCw0YHRgdGH0LjRgtGL0LLQsNC10LzRi9C1INC40YLQvtCz0LgNCiAgICBjYWxjVG90YWxzKGRhdGFSb3dzKQ0KICAgIHVwZGF0ZUluZGV4ZXMoZGF0YVJvd3MpDQp9DQoNCmRlZiBjYWxjQ2hlY2sxMChkZWYgcm93LCBkZWYgc3VtKSB7DQogICAgZGVmIGluZGV4ID0gcm93LmdldEluZGV4KCkNCiAgICAvLyDQldCh0JvQmCDCq9CT0YDQsNGE0LAgN8K7INC30LDQv9C+0LvQvdC10L3QsCDQmCDCq9CT0YDQsNGE0LAgOMK7INC90LUg0LfQsNC/0L7Qu9C90LXQvdCwLCDQotCeIMKr0JPRgNCw0YTQsCAxMMK7ID0gwqvQk9GA0LDRhNCwIDfCuw0KICAgIGlmIChyb3cuc3VtTmRzUGx1cyAhPSBudWxsICYmIHJvdy5zdW1OZHNNaW51cyA9PSBudWxsKSB7DQogICAgICAgIGlmIChzdW0gIT0gbnVsbCAmJiBzdW0gIT0gcm93LnN1bU5kc1BsdXMpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDCqyR7Z2V0Q29sdW1uTmFtZShyb3csJ3N1bScpfcK7INC00L7Qu9C20L3QsCDQsdGL0YLRjCDQt9Cw0L/QvtC70L3QtdC90LAg0LfQvdCw0YfQtdC90LjQtdC8INCz0YDQsNGE0Ysg0YEg0YHRg9C80LzQvtC5INC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4ICgtKSDQndCU0KEhIikNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcm93LnN1bU5kc1BsdXMNCiAgICB9DQogICAgLy8g0JXQodCb0JggwqvQk9GA0LDRhNCwIDfCuyDQvdC1INC30LDQv9C+0LvQvdC10L3QsCDQmCDCq9CT0YDQsNGE0LAgOMK7INC30LDQv9C+0LvQvdC10L3QsCwg0KLQniDCq9CT0YDQsNGE0LAgMTDCuyA9IMKr0JPRgNCw0YTQsCA4wrsNCiAgICBpZiAocm93LnN1bU5kc1BsdXMgPT0gbnVsbCAmJiByb3cuc3VtTmRzTWludXMgIT0gbnVsbCkgew0KICAgICAgICBpZiAoc3VtICE9IG51bGwgJiYgc3VtICE9IHJvdy5zdW1OZHNNaW51cykgew0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQk9GA0LDRhNCwIMKrJHtnZXRDb2x1bW5OYW1lKHJvdywnc3VtJyl9wrsg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LPRgNCw0YTRiyDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspINCd0JTQoSEiKQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiByb3cuc3VtTmRzTWludXMNCiAgICB9DQogICAgLy8g0JXQodCb0JggwqvQk9GA0LDRhNCwIDfCuyDQt9Cw0L/QvtC70L3QtdC90LAg0JggwqvQk9GA0LDRhNCwIDjCuyDQt9Cw0L/QvtC70L3QtdC90LAsINCi0J4gwqvQk9GA0LDRhNCwIDEwwrsgPSDCq9CT0YDQsNGE0LAgN8K7ICsgwqvQk9GA0LDRhNCwIDjCuw0KICAgIGlmIChyb3cuc3VtTmRzUGx1cyAhPSBudWxsICYmIHJvdy5zdW1OZHNNaW51cyAhPSBudWxsKSB7DQogICAgICAgIGlmIChzdW0gIT0gbnVsbCAmJiBzdW0gIT0gcm93LnN1bU5kc1BsdXMgKyByb3cuc3VtTmRzTWludXMpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDCqyR7Z2V0Q29sdW1uTmFtZShyb3csJ3N1bScpfcK7INC00L7Qu9C20L3QsCDQsdGL0YLRjCDQt9Cw0L/QvtC70L3QtdC90LAg0YHRg9C80LzQvtC5INC30L3QsNGH0LXQvdC40Lkg0LPRgNCw0YTRiyDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspINC4INCz0YDQsNGE0Ysg0YEg0YHRg9C80LzQvtC5INC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4ICgtKSDQndCU0KEhIikNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcm93LnN1bU5kc1BsdXMgKyByb3cuc3VtTmRzTWludXMNCiAgICB9DQogICAgcmV0dXJuIG51bGwNCn0NCg0KZGVmIGNhbGNUb3RhbHMoZGVmIGRhdGFSb3dzKSB7DQogICAgLy8g0JTQvtCx0LDQstC70LXQvdC40LUg0L/QvtC00LjRgtC+0LPQvtCyICjQmNGC0L7Qs9C+INC30LAg0L3QsNC70L7Qs9C+0LLRi9C5INC/0LXRgNC40L7QtCkNCiAgICBjYWxjUGVyaW9kVG90YWxzKGRhdGFSb3dzKQ0KDQogICAgLy8g0JjRgtC+0LPQviDQv9C+INGA0LDQt9C00LXQu9Cw0LwgMS02DQogICAgZGVmIG1lZ2FUb3RhbCA9IGdldERhdGFSb3coZGF0YVJvd3MsICJtZWdhX3RvdGFsIikNCiAgICBjYWxjTWVnYVRvdGFsKG1lZ2FUb3RhbCwgZGF0YVJvd3MpDQoNCiAgICAvLyDQodGH0LjRgtCw0LXQvCDRgtGA0Lgg0LPRgNGD0L/Qv9GLINGB0YPQv9C10YAt0LjRgtC+0LPQvtCyDQogICAgZGVmIHN1cGVyUm93cyA9IGNhbGNTdXBlclRvdGFscyhkYXRhUm93cykNCiAgICBpZiAoIXN1cGVyUm93cy5pc0VtcHR5KCkpIHsNCiAgICAgICAgZGF0YVJvd3MuYWRkQWxsKGRhdGFSb3dzLmluZGV4T2YoZ2V0RGF0YVJvdyhkYXRhUm93cywgJ2hlYWRfOCcpKSwgc3VwZXJSb3dzKQ0KICAgIH0NCn0NCg0Kdm9pZCBjYWxjTWVnYVRvdGFsKGRlZiBtZWdhVG90YWwsIGRlZiBkYXRhUm93cykgew0KICAgIG1lZ2FUb3RhbC5zdW1OZHNQbHVzID0gQmlnRGVjaW1hbC5aRVJPDQogICAgZGF0YVJvd3MuZWFjaCB7IHJvdyAtPg0KICAgICAgICBpZiAocm93LmdldEFsaWFzKCkgIT0gbnVsbCAmJiByb3cuZ2V0QWxpYXMoKSA9PX4gL3RvdGFsX1sxLTZdXy4qLykgew0KICAgICAgICAgICAgLy8g0YHRg9C80LzQuNGA0YPQtdC8INC/0L4gNC3QuSDQs9GA0LDRhNC1ICg1LdGPINC/0YPRgdGC0LDRjykNCiAgICAgICAgICAgIG1lZ2FUb3RhbC5zdW1OZHNQbHVzICs9IChyb3cuc3VtTmRzUGx1cyA/OiBCaWdEZWNpbWFsLlpFUk8pDQogICAgICAgIH0NCiAgICB9DQp9DQoNCmRlZiBjYWxjU3VwZXJUb3RhbHMoZGVmIGRhdGFSb3dzKSB7DQogICAgZGVmIHNlY3Rpb25zU3VwZXIgPSBbJ3NhbGVfMTgnIDogWycxJywgJzMnLCAnNScsICc2JywgJzcnXSwgJ3NhbGVfMTAnIDogWycyJywgJzQnXSwgJ3B1cmNoYXNlJyA6IFsnOCcsICc5J11dDQogICAgZGVmIHRvdGFsQ29sdW1uc1N1cGVyID0gWydzYWxlXzE4JyA6IHRvdGFsQ29sdW1uczFfNl9TYWxlLCAnc2FsZV8xMCcgOiB0b3RhbENvbHVtbnMxXzZfU2FsZSwgJ3B1cmNoYXNlJyA6IHRvdGFsQ29sdW1uczdfOV9QdXJjaGFzZV0NCg0KICAgIGRlZiBzdXBlclJvd3MgPSBbXQ0KICAgIHNlY3Rpb25zU3VwZXIua2V5U2V0KCkuZWFjaCB7IGtleSAtPg0KICAgICAgICBkZWYgc3ViU2VjdGlvbnMgPSBzZWN0aW9uc1N1cGVyW2tleV0NCiAgICAgICAgZGVmIGNvbHVtbnMgPSB0b3RhbENvbHVtbnNTdXBlcltrZXldIC0gc2tpcENvbHVtbnMNCiAgICAgICAgLy8g0YTQuNC60YHQuNGA0L7QstCw0L3QvdGL0LUg0YHRgtGA0L7QutC4ICjQmNGC0L7Qs9C+INC30LAgKQ0KICAgICAgICBkZWYgcm93cyA9IGRhdGFSb3dzPy5maW5kQWxsIHsgcm93IC0+DQogICAgICAgICAgICByb3cuZ2V0QWxpYXMoKSAhPSBudWxsICYmIHJvdy5nZXRBbGlhcygpID09fiAvdG90YWxfWyR7c3ViU2VjdGlvbnMuam9pbignJyl9XV8uKi8NCiAgICAgICAgfQ0KICAgICAgICBkZWYgc3VtTWFwID0gWzpdDQogICAgICAgIHJvd3MuZWFjaCB7IHJvdyAtPg0KICAgICAgICAgICAgZGVmIHBlcmlvZE5hbWUgPSByb3cuZml4Py5yZXBsYWNlQWxsKCfQmNGC0L7Qs9C+INC30LAgJywgJycpDQogICAgICAgICAgICBkZWYgcGVyaW9kSWQgPSBnZXRSZWZCb29rUmVjb3JkKDgsICdOQU1FJywgcGVyaW9kTmFtZSwgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpLCAtMSwgbnVsbCwgZmFsc2UpPy5yZWNvcmRfaWQ/LnZhbHVlDQogICAgICAgICAgICBpZiAoc3VtTWFwW3BlcmlvZElkXSA9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgc3VtTWFwW3BlcmlvZElkXSA9IFtdDQogICAgICAgICAgICB9DQogICAgICAgICAgICBzdW1NYXBbcGVyaW9kSWRdLmFkZChyb3cpDQogICAgICAgIH0NCiAgICAgICAgc3VtTWFwLmtleVNldCgpLmVhY2ggeyBwZXJpb2RJZCAtPg0KICAgICAgICAgICAgZGVmIHN1cGVyUm93ID0gZ2V0U3VwZXJUb3RhbFJvdyhrZXksIHBlcmlvZElkIGFzIExvbmcpDQogICAgICAgICAgICBjb2x1bW5zLmVhY2ggeyBhbGlhcyAtPg0KICAgICAgICAgICAgICAgIHN1cGVyUm93W2FsaWFzXSA9IEJpZ0RlY2ltYWwuWkVSTw0KICAgICAgICAgICAgICAgIHN1bU1hcFtwZXJpb2RJZF0uZWFjaCB7IHJvdyAtPg0KICAgICAgICAgICAgICAgICAgICBzdXBlclJvd1thbGlhc10gKz0gKHJvd1thbGlhc10gPzogQmlnRGVjaW1hbC5aRVJPKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHN1cGVyUm93cy5hZGQoc3VwZXJSb3cpDQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHN1cGVyUm93cw0KfQ0KDQovKiog0YHRh9C40YLQsNC10YIg0LjRgtC+0LPQuCwg0YHQv9C10YbQuNGE0LjRh9C90L4sINGCLtC6LiDQtdGB0YLRjCDQvtCx0YrQtdC00LjQvdC10L3QuNGPINC/0L4g0LPRgNCw0YTQsNC8IDQsNSDQuCA3LDggKi8NCnZvaWQgY2FsY1NwZWNpZmljVG90YWxzKGRlZiBkYXRhUm93cywgZGVmIHRvdGFsUm93LCBkZWYgY29sdW1ucykgew0KICAgIGlmIChjb2x1bW5zID09IG51bGwpDQogICAgICAgIHJldHVybg0KICAgIGRlZiB0ZW1wUm93ID0gZm9ybURhdGEuY3JlYXRlRGF0YVJvdygpDQogICAgY2FsY1RvdGFsU3VtKGRhdGFSb3dzLCB0ZW1wUm93LCBjb2x1bW5zKQ0KICAgIGRlZiBzcGVjaWFsQ29sdW1ucyA9IFsnc3VtUGx1cycsICdzdW1NaW51cycsICdzdW1OZHNQbHVzJywgJ3N1bU5kc01pbnVzJ10NCiAgICBjb2x1bW5zLmVhY2ggeyBhbGlhcyAtPg0KICAgICAgICBpZiAoIXNwZWNpYWxDb2x1bW5zLmNvbnRhaW5zKGFsaWFzKSkgew0KICAgICAgICAgICAgdG90YWxSb3dbYWxpYXNdID0gdGVtcFJvd1thbGlhc10NCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoY29sdW1ucy5jb250YWlucygnc3VtUGx1cycpKSB7DQogICAgICAgIHRvdGFsUm93LnN1bVBsdXMgPSB0ZW1wUm93LnN1bVBsdXMgKyB0ZW1wUm93LnN1bU1pbnVzDQogICAgfQ0KICAgIGlmIChjb2x1bW5zLmNvbnRhaW5zKCdzdW1OZHNQbHVzJykpIHsNCiAgICAgICAgdG90YWxSb3cuc3VtTmRzUGx1cyA9IHRlbXBSb3cuc3VtTmRzUGx1cyArIHRlbXBSb3cuc3VtTmRzTWludXMNCiAgICB9DQp9DQoNCnZvaWQgY2FsY1BlcmlvZFRvdGFscyhMaXN0PERhdGFSb3c8Q2VsbD4+IGRhdGFSb3dzKSB7DQogICAgZGVmIHNlY3Rpb24gPSBudWxsDQogICAgZm9yIChpbnQgaSA9IDA7IGkgPCBkYXRhUm93cy5zaXplKCk7IGkrKykgew0KICAgICAgICBEYXRhUm93PENlbGw+IHJvdyA9IGRhdGFSb3dzLmdldChpKTsNCiAgICAgICAgRGF0YVJvdzxDZWxsPiBuZXh0Um93ID0gbnVsbDsNCiAgICAgICAgaWYgKGkgPCBkYXRhUm93cy5zaXplKCkgLSAxKSB7DQogICAgICAgICAgICBuZXh0Um93ID0gZGF0YVJvd3MuZ2V0KGkgKyAxKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAocm93LmdldEFsaWFzKCkgIT0gbnVsbCkgew0KICAgICAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpLnN0YXJ0c1dpdGgoImhlYWRfIikpIHsNCiAgICAgICAgICAgICAgICBzZWN0aW9uID0gcm93LmdldEFsaWFzKCkucmVwbGFjZUFsbCgiaGVhZF8iLCAnJykNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIGlmIChuZXh0Um93ID09IG51bGwgfHwgaXNEaWZmUm93KHJvdywgbmV4dFJvdywgZ3JvdXBDb2x1bW5zKSkgew0KICAgICAgICAgICAgRGF0YVJvdzxDZWxsPiBhbGlhc2VkUm93ID0gY2FsY0l0b2coaSwgZGF0YVJvd3MsIHNlY3Rpb24sIHJvdy5wZXJpb2QpOw0KICAgICAgICAgICAgZGF0YVJvd3MuYWRkKCsraSwgYWxpYXNlZFJvdyk7DQogICAgICAgIH0NCiAgICB9DQp9DQoNCi8vINCg0LDRgdGH0LXRgiDQv9C+0LTQuNGC0L7Qs9C+0LLQvtCz0L4g0LfQvdCw0YfQtdC90LjRjw0KRGF0YVJvdzxDZWxsPiBjYWxjSXRvZyhkZWYgaW50IGksIGRlZiBMaXN0PERhdGFSb3c8Q2VsbD4+IGRhdGFSb3dzLCBkZWYgc2VjdGlvbiwgZGVmIHBlcmlvZElkKSB7DQogICAgZGVmIG5ld1JvdyA9IGdldFBlcmlvZFRvdGFsUm93KHNlY3Rpb24sIHBlcmlvZElkKQ0KDQogICAgLy8g0KDQsNGB0YfQtdGC0Ysg0L/QvtC00LjRgtC+0LPQvtCy0YvRhSDQt9C90LDRh9C10L3QuNC5DQogICAgZGVmIHJvd3MgPSBbXQ0KICAgIGZvciAoaW50IGogPSBpOyBqID49IDAgJiYgZGF0YVJvd3MuZ2V0KGopLmdldEFsaWFzKCkgPT0gbnVsbDsgai0tKSB7DQogICAgICAgIHJvd3MuYWRkKGRhdGFSb3dzLmdldChqKSkNCiAgICB9DQogICAgZGVmIGNvbHVtbnMNCiAgICBpZiAoc2VjdGlvbiAhPSBudWxsICYmIEludGVnZXIudmFsdWVPZihzZWN0aW9uKSA8IDcpIHsNCiAgICAgICAgY29sdW1ucyA9IHRvdGFsQ29sdW1uczFfNl9TYWxlDQogICAgfSBlbHNlIGlmIChzZWN0aW9uICE9IG51bGwgJiYgSW50ZWdlci52YWx1ZU9mKHNlY3Rpb24pID4gNikgew0KICAgICAgICBjb2x1bW5zID0gdG90YWxDb2x1bW5zN185X1B1cmNoYXNlDQogICAgfQ0KICAgIGNhbGNTcGVjaWZpY1RvdGFscyhyb3dzLCBuZXdSb3csIGNvbHVtbnMpDQogICAgcmV0dXJuIG5ld1Jvdw0KfQ0KDQovKiog0J/QvtC70YPRh9C40YLRjCDQvdC+0LLRg9GOINC40YLQvtCz0L7QstGD0Y4g0YHRgtGA0L7QutGDINGBINC30LDQtNCw0L3QvdGL0LzQuCDRgdGC0LjQu9GP0LzQuC4gKi8NCmRlZiBnZXRTdXBlclRvdGFsUm93KGRlZiBrZXksIGRlZiBwZXJpb2RJZCkgew0KICAgIGRlZiBuZXdSb3cgPSAoZm9ybURhdGFFdmVudCBpbiBbRm9ybURhdGFFdmVudC5JTVBPUlQsIEZvcm1EYXRhRXZlbnQuSU1QT1JUX1RSQU5TUE9SVF9GSUxFXSkgPyBmb3JtRGF0YS5jcmVhdGVTdG9yZU1lc3NhZ2luZ0RhdGFSb3coKSA6IGZvcm1EYXRhLmNyZWF0ZURhdGFSb3coKQ0KICAgIGRlZiByZWZCb29rVmFsdWUgPSBnZXRSZWZCb29rVmFsdWUoOCwgcGVyaW9kSWQpDQogICAgbmV3Um93LmZpeCA9IFN0cmluZy5mb3JtYXQoc2VjdGlvbnNMYWJlbHNba2V5XSwgcmVmQm9va1ZhbHVlPy5OQU1FPy5zdHJpbmdWYWx1ZSA/OiAi0LPRgNCw0YTQsCAyINC90LUg0LfQsNC00LDQvdCwIikNCiAgICBuZXdSb3cuZ2V0Q2VsbCgnZml4JykuY29sU3BhbiA9IDINCiAgICBuZXdSb3cuZ2V0Q2VsbCgnc3VtUGx1cycpLmNvbFNwYW4gPSAyDQogICAgbmV3Um93LmdldENlbGwoJ3N1bU5kc1BsdXMnKS5jb2xTcGFuID0gMg0KICAgIG5ld1Jvdy5zZXRBbGlhcygnc3VwZXJfJyArIGtleSArICdfJyArIHJlZkJvb2tWYWx1ZT8uQ09ERT8uc3RyaW5nVmFsdWUpDQogICAgYWxsQ29sdW1ucy5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLnN0eWxlQWxpYXMgPSAn0JrQvtC90YLRgNC+0LvRjNC90YvQtSDRgdGD0LzQvNGLJw0KICAgIH0NCiAgICByZXR1cm4gbmV3Um93DQp9DQoNCnZvaWQgbG9naWNDaGVjaygpIHsNCiAgICBkZWYgZGF0YVJvd3MgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSkuYWxsQ2FjaGVkDQogICAgZGVmIGlzQWZ0ZXJTZWN0aW9uNiA9IGZhbHNlDQogICAgZGVmIHNlY3Rpb24gPSBudWxsDQogICAgZm9yIChkZWYgcm93IDogZGF0YVJvd3MpIHsNCiAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpICE9IG51bGwpIHsNCiAgICAgICAgICAgIGlmIChyb3cuZ2V0QWxpYXMoKS5zdGFydHNXaXRoKCdoZWFkXycpKXsNCiAgICAgICAgICAgICAgICBzZWN0aW9uID0gcm93LmdldEFsaWFzKCkucmVwbGFjZUFsbCgnaGVhZF8nLCAnJykNCiAgICAgICAgICAgICAgICBpZiAoc2VjdGlvbiA9PSAnNycpIHsNCiAgICAgICAgICAgICAgICAgICAgaXNBZnRlclNlY3Rpb242ID0gdHJ1ZQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgZGVmIGluZGV4ID0gcm93LmdldEluZGV4KCkNCg0KICAgICAgICAvLyAxLiDQn9GA0L7QstC10YDQutCwINC30LDQv9C+0LvQvdC10L3QuNGPINCz0YDQsNGEDQogICAgICAgIGNoZWNrTm9uRW1wdHlDb2x1bW5zKHJvdywgaW5kZXgsIG5vbkVtcHR5Q29sdW1ucywgbG9nZ2VyLCB0cnVlKQ0KDQogICAgICAgIC8vIDIuINCf0YDQvtCy0LXRgNC60LAg0L3QtdC30LDQv9C+0LvQvdC10L3QvdC+0YHRgtC4INCz0YDQsNGEINGBINGB0YPQvNC80L7QuSDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuA0KICAgICAgICBpZiAoaXNBZnRl'
        longString += 'clNlY3Rpb242ICYmIGVtcHR5Q29sdW1uc183XzkuZmluZCB7IHJvd1tpdF0gIT0gbnVsbCB9ICE9IG51bGwpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTRiyDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCssIC0pINC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyAo0YDQsNC30LTQtdC7IDctOSkg0L3QtSDQtNC+0LvQttC90Ysg0LHRi9GC0Ywg0LfQsNC/0L7Qu9C90LXQvdGLISIpDQogICAgICAgIH0NCg0KICAgICAgICAvLyAzLiDQn9GA0L7QstC10YDQutCwINC90LAg0LfQsNC/0L7Qu9C90LXQvdC40LUg0YXQvtGC0Y8g0LHRiyDQvtC00L3QvtC5INC40Lcg0LPRgNCw0YQgwqsrwrssIMKrLcK7INGBINGB0YPQvNC80L7QuSDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuA0KICAgICAgICAvLyA0LiDQn9GA0L7QstC10YDQutCwINC/0L7Qu9C+0LbQuNGC0LXQu9GM0L3QvtGB0YLQuCDRgdGD0LzQvNGLINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4DQogICAgICAgIC8vIDUuINCf0YDQvtCy0LXRgNC60LAg0L7RgtGA0LjRhtCw0YLQtdC70YzQvdC+0YHRgtC4INGB0YPQvNC80Ysg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LgNCiAgICAgICAgaWYgKCFpc0FmdGVyU2VjdGlvbjYpIHsNCiAgICAgICAgICAgIGlmIChyb3cuc3VtUGx1cyA9PSBudWxsICYmIHJvdy5zdW1NaW51cyA9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQlNC+0LvQttC90LAg0LHRi9GC0Ywg0LfQsNC/0L7Qu9C90LXQvdCwINGF0L7RgtGPINCx0Ysg0L7QtNC90LAg0LjQtyDQs9GA0LDRhCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCssIC0pINC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyAo0YDQsNC30LTQtdC7IDEtNikhIikNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChyb3cuc3VtUGx1cyAhPSBudWxsICYmICEocm93LnN1bVBsdXMgPiAwKSkgew0KICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspINC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyAo0YDQsNC30LTQtdC7IDEtNikg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LHQvtC70YzRiNC1IMKrMMK7ISIpDQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAocm93LnN1bU1pbnVzICE9IG51bGwgJiYgIShyb3cuc3VtTWludXMgPCAwKSkgew0KICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKC0pINC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyAo0YDQsNC30LTQtdC7IDEtNikg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LzQtdC90YzRiNC1IMKrMMK7ISIpDQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBpZiAocm93LnN1bU5kc1BsdXMgPT0gbnVsbCAmJiByb3cuc3VtTmRzTWludXMgPT0gbnVsbCkgew0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQlNC+0LvQttC90LAg0LHRi9GC0Ywg0LfQsNC/0L7Qu9C90LXQvdCwINGF0L7RgtGPINCx0Ysg0L7QtNC90LAg0LjQtyDQs9GA0LDRhCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCssIC0pINCd0JTQoSAo0YDQsNC30LTQtdC7IDEtOSkhIikNCiAgICAgICAgfQ0KICAgICAgICBpZiAocm93LnN1bU5kc1BsdXMgIT0gbnVsbCAmJiAhKHJvdy5zdW1OZHNQbHVzID4gMCkpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspINCd0JTQoSAo0YDQsNC30LTQtdC7IDEtOSkg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LHQvtC70YzRiNC1IMKrMMK7ISIpDQogICAgICAgIH0NCiAgICAgICAgaWYgKHJvdy5zdW1OZHNNaW51cyAhPSBudWxsICYmICEocm93LnN1bU5kc01pbnVzIDwgMCkpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKC0pINCd0JTQoSAo0YDQsNC30LTQtdC7IDEtOSkg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LzQtdC90YzRiNC1IMKrMMK7ISIpDQogICAgICAgIH0NCg0KICAgICAgICAvLyA2LiDQn9GA0L7QstC10YDQutCwINC90L7QvNC10YDQsCDQsdCw0LvQsNC90YHQvtCy0L7Qs9C+INGB0YfQtdGC0LANCiAgICAgICAgaWYgKHJvdy5udW1iZXJOZHMgIT0gbnVsbCkgew0KICAgICAgICAgICAgZGVmIG51bWJlck5kcyA9IGdldFJlZkJvb2tWYWx1ZSgxMDEsIHJvdy5udW1iZXJOZHMpLkFDQ09VTlQudmFsdWUNCiAgICAgICAgICAgIGRlZiB2YWxpZE51bWJlcnMgPSBudW1iZXJNYXBbc2VjdGlvbl1bMF0NCiAgICAgICAgICAgIGlmIChzZWN0aW9uICE9IG51bGwgJiYgIXZhbGlkTnVtYmVycy5jb250YWlucyhudW1iZXJOZHMpKSB7DQogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQk9GA0LDRhNCwIMKrJHtnZXRDb2x1bW5OYW1lKHJvdywnbnVtYmVyTmRzJyl9wrsg0LfQsNC/0L7Qu9C90LXQvdCwINC90LXQstC10YDQvdC+ISDQktC+0LfQvNC+0LbQvdGL0LUg0LfQvdCw0YfQtdC90LjRjyAo0YDQsNC30LTQtdC7ICR7bnVtYmVyTWFwW3NlY3Rpb25dWzFdfSk6INC/0YPRgdGC0L7QtSDQt9C90LDRh9C10L3QuNC1LCDCqyR7dmFsaWROdW1iZXJzLmpvaW4oJ8K7LCDCqycpfcK7LiIpDQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvLyA3LiDQn9GA0L7QstC10YDQutCwINGB0YLQsNCy0LrQuCDQndCU0KENCiAgICAgICAgZGVmIHZhbGlkUmF0ZSA9IHJhdGVNYXBbc2VjdGlvbl1bMF0NCiAgICAgICAgaWYgKHJvdy5yYXRlTmRzICYmIHZhbGlkUmF0ZSAhPSByb3cucmF0ZU5kcykgew0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQk9GA0LDRhNCwIMKrJHtnZXRDb2x1bW5OYW1lKHJvdywncmF0ZU5kcycpfcK7INC30LDQv9C+0LvQvdC10L3QsCDQvdC10LLQtdGA0L3QviEg0JLQvtC30LzQvtC20L3Ri9C1INC30L3QsNGH0LXQvdC40Y8gKNGA0LDQt9C00LXQuyAke3JhdGVNYXBbc2VjdGlvbl1bMV19KTogwqskdmFsaWRSYXRlwrsuIikNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIDguINCf0YDQvtCy0LXRgNC60LAg0YHRg9C80LzRiyDQndCU0KEg0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3Ri9C8INC70LjRgdGC0LDQvCDQutC90LjQs9C4INC/0L7QutGD0L/QvtC6INC4INC/0YDQvtC00LDQtg0KICAgICAgICBpZiAocm93LnN1bSAhPSBudWxsKSB7DQogICAgICAgICAgICBjYWxjQ2hlY2sxMChyb3csIHJvdy5zdW0pDQogICAgICAgIH0NCiAgICB9DQogICAgY29tcGFyZVNwZWNpZmljVG90YWxWYWx1ZXMoZGF0YVJvd3MsIGFycmFuZ2VSb3dzKGRhdGFSb3dzKSkNCn0NCg0Kdm9pZCBjb25zb2xpZGF0aW9uKCkgew0KICAgIGRlZiBkYXRhUm93SGVscGVyID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpDQogICAgZGVmIGRhdGFSb3dzID0gZm9ybURhdGFTZXJ2aWNlLmdldEZvcm1UZW1wbGF0ZShmb3JtRGF0YS5mb3JtVHlwZS5pZCwgZm9ybURhdGEucmVwb3J0UGVyaW9kSWQpLnJvd3MNCiAgICB1cGRhdGVJbmRleGVzKGRhdGFSb3dzKQ0KDQogICAgLy8g0YHQvtCx0YDQsNGC0Ywg0LjQtyDQuNGB0YLQvtGH0L3QuNC60L7QsiDRgdGC0YDQvtC60Lgg0Lgg0YDQsNC30LzQtdGB0YLQuNGC0Ywg0YHQvtC+0YLQstC10YLRgdGC0LLRg9GO0YnQuNC8INGA0LDQt9C00LXQu9Cw0LwNCiAgICBkZXBhcnRtZW50Rm9ybVR5cGVTZXJ2aWNlLmdldEZvcm1Tb3VyY2VzKGZvcm1EYXRhRGVwYXJ0bWVudC5pZCwgZm9ybURhdGEuZm9ybVR5cGUuaWQsIGZvcm1EYXRhLmtpbmQsDQogICAgICAgICAgICBnZXRSZXBvcnRQZXJpb2RTdGFydERhdGUoKSwgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpKS5lYWNoIHsNCiAgICAgICAgaWYgKGl0LmZvcm1UeXBlSWQgPT0gZm9ybURhdGEuZm9ybVR5cGUuaWQpIHsNCiAgICAgICAgICAgIGRlZiBzb3VyY2UgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0TGFzdChpdC5mb3JtVHlwZUlkLCBpdC5raW5kLCBpdC5kZXBhcnRtZW50SWQsIGZvcm1EYXRhLnJlcG9ydFBlcmlvZElkLCBmb3JtRGF0YS5wZXJpb2RPcmRlciwgZm9ybURhdGEuY29tcGFyYXRpdmVQZXJpb2RJZCwgZm9ybURhdGEuYWNjcnVpbmcpDQogICAgICAgICAgICBpZiAoc291cmNlICE9IG51bGwgJiYgc291cmNlLnN0YXRlID09IFdvcmtmbG93U3RhdGUuQUNDRVBURUQpIHsNCiAgICAgICAgICAgICAgICBkZWYgc291cmNlRGF0YVJvd3MgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihzb3VyY2UpLmFsbENhY2hlZA0KICAgICAgICAgICAgICAgIC8vINC60L7Qv9C40YDQvtCy0LDQvdC40LUg0LTQsNC90L3Ri9GFINC/0L4g0YDQsNC30LTQtdC70LDQvA0KICAgICAgICAgICAgICAgIHNlY3Rpb25zLmVhY2ggeyBzZWN0aW9uIC0+DQogICAgICAgICAgICAgICAgICAgIGNvcHlSb3dzKHNvdXJjZURhdGFSb3dzLCBkYXRhUm93cywgJ2hlYWRfJyArIHNlY3Rpb24sICdoZWFkXycgKyAoSW50ZWdlci52YWx1ZU9mKHNlY3Rpb24pICsgMSkpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIGRhdGFSb3dIZWxwZXIuc2V0QWxsQ2FjaGVkKGRhdGFSb3dzKQ0KfQ0KDQovKioNCiAqINCa0L7Qv9C40YDQvtCy0LDRgtGMINC30LDQtNCw0L3QvdGL0Lkg0LTQuNCw0L/QvtC30L7QvSDRgdGC0YDQvtC6INC40Lcg0LjRgdGC0L7Rh9C90LjQutCwINCyINC/0YDQuNC10LzQvdC40LouDQogKg0KICogQHBhcmFtIHNvdXJjZURhdGFSb3dzINGB0YLRgNC+0LrQuCDQuNGB0YLQvtGH0L3QuNC60LANCiAqIEBwYXJhbSBkZXN0aW5hdGlvbkRhdGFSb3dzINGB0YLRgNC+0LrQuCDQv9GA0LjQtdC80L3QuNC60LANCiAqIEBwYXJhbSBmcm9tQWxpYXMg0L/RgdC10LLQtNC+0L3QuNC8INGB0YLRgNC+0LrQuCDRgSDQutC+0YLQvtGA0L7QuSDQutC+0L/QuNGA0L7QstCw0YLRjCDRgdGC0YDQvtC60LggKNCd0JUg0LLQutC70Y7Rh9C40YLQtdC70YzQvdC+KQ0KICogQHBhcmFtIHRvQWxpYXMg0L/RgdC10LLQtNC+0L3QuNC8INGB0YLRgNC+0LrQuCDQtNC+INC60L7RgtC+0YDQvtC5INC60L7Qv9C40YDQvtCy0LDRgtGMINGB0YLRgNC+0LrQuCAo0J3QlSDQstC60LvRjtGH0LjRgtC10LvRjNC90L4pLA0KICogICAgICDQsiDQv9GA0LjQtdC80L3QuNC6INGB0YLRgNC+0LrQuCDQstGB0YLQsNCy0LvRj9GO0YLRgdGPINC/0LXRgNC10LQg0YHRgtGA0L7QutC+0Lkg0YEg0Y3RgtC40Lwg0L/RgdC10LLQtNC+0L3QuNC80L7QvA0KICovDQp2b2lkIGNvcHlSb3dzKGRlZiBzb3VyY2VEYXRhUm93cywgZGVmIGRlc3RpbmF0aW9uRGF0YVJvd3MsIGRlZiBmcm9tQWxpYXMsIGRlZiB0b0FsaWFzKSB7DQogICAgaWYgKHRvQWxpYXMgPT0gJ2hlYWRfNycpIHsNCiAgICAgICAgdG9BbGlhcyA9ICdtZWdhX3RvdGFsJw0KICAgIH0NCiAgICBkZWYgZnJvbSA9IGdldERhdGFSb3coc291cmNlRGF0YVJvd3MsIGZyb21BbGlhcykuZ2V0SW5kZXgoKQ0KICAgIGRlZiB0byA9ICh0b0FsaWFzICE9ICdoZWFkXzEwJykgPyAoZ2V0RGF0YVJvdyhzb3VyY2VEYXRhUm93cywgdG9BbGlhcykuZ2V0SW5kZXgoKSAtIDEpIDogc291cmNlRGF0YVJvd3Muc2l6ZSgpDQogICAgaWYgKGZyb20gPj0gdG8pIHsNCiAgICAgICAgcmV0dXJuDQogICAgfQ0KICAgIGRlZiBjb3B5Um93cyA9IHNvdXJjZURhdGFSb3dzLnN1Ykxpc3QoZnJvbSwgdG8pDQogICAgaWYgKHRvQWxpYXMgIT0gJ2hlYWRfMTAnKSB7DQogICAgICAgIGRlc3RpbmF0aW9uRGF0YVJvd3MuYWRkQWxsKGdldERhdGFSb3coZGVzdGluYXRpb25EYXRhUm93cywgdG9BbGlhcykuZ2V0SW5kZXgoKSAtIDEsIGNvcHlSb3dzKQ0KICAgIH0gZWxzZSB7DQogICAgICAgIGRlc3RpbmF0aW9uRGF0YVJvd3MuYWRkQWxsKGNvcHlSb3dzKQ0KICAgIH0NCiAgICAvLyDQv9C+0L/RgNCw0LLQuNGC0Ywg0LjQvdC00LXQutGB0YssINC/0L7RgtC+0LzRgyDRh9GC0L4g0L7QvdC4INC/0L7RgdC70LUg0LLRgdGC0LDQstC60Lgg0L3QtSDQv9C10YDQtdGB0YfQuNGC0YvQstCw0Y7RgtGB0Y8NCiAgICB1cGRhdGVJbmRleGVzKGRlc3RpbmF0aW9uRGF0YVJvd3MpDQp9DQoNCkRhdGFSb3c8Q2VsbD4gZ2V0UGVyaW9kVG90YWxSb3coZGVmIHNlY3Rpb24sIGRlZiBwZXJpb2RJZCkgew0KICAgIGRlZiBuZXdSb3cgPSAoZm9ybURhdGFFdmVudCBpbiBbRm9ybURhdGFFdmVudC5JTVBPUlQsIEZvcm1EYXRhRXZlbnQuSU1QT1JUX1RSQU5TUE9SVF9GSUxFXSkgPyBmb3JtRGF0YS5jcmVhdGVTdG9yZU1lc3NhZ2luZ0RhdGFSb3coKSA6IGZvcm1EYXRhLmNyZWF0ZURhdGFSb3coKQ0KICAgIGRlZiByZWZCb29rVmFsdWUgPSBnZXRSZWZCb29rVmFsdWUoOCwgcGVyaW9kSWQpDQogICAgbmV3Um93LmZpeCA9ICfQmNGC0L7Qs9C+INC30LAgJyArIChyZWZCb29rVmFsdWU/Lk5BTUU/LnN0cmluZ1ZhbHVlID86ICLQs9GA0LDRhNCwIDIg0L3QtSDQt9Cw0LTQsNC90LAiKQ0KICAgIG5ld1Jvdy5zZXRBbGlhcygndG90YWxfJyArIHNlY3Rpb24gKyAnXycgKyByZWZCb29rVmFsdWU/LkNPREU/LnN0cmluZ1ZhbHVlKQ0KICAgIG5ld1Jvdy5nZXRDZWxsKCdmaXgnKS5jb2xTcGFuID0gMg0KICAgIG5ld1Jvdy5nZXRDZWxsKCdzdW1QbHVzJykuY29sU3BhbiA9IDINCiAgICBuZXdSb3cuZ2V0Q2VsbCgnc3VtTmRzUGx1cycpLmNvbFNwYW4gPSAyDQogICAgYWxsQ29sdW1ucy5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLnNldFN0eWxlQWxpYXMoJ9Ca0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiycpDQogICAgfQ0KICAgIHJldHVybiBuZXdSb3cNCn0NCg0KZGVmIGFycmFuZ2VSb3dzKGRhdGFSb3dzKSB7DQogICAgZGVmIHNlY3Rpb25NYXAgPSBbOl0NCiAgICBzZWN0aW9ucy5lYWNoIHsgc2VjdGlvbiAtPg0KICAgICAgICBkZWYgZnJvbUFsaWFzID0gJ2hlYWRfJyArIHNlY3Rpb24NCiAgICAgICAgZGVmIHRvQWxpYXMgPSAnaGVhZF8nICsgKEludGVnZXIudmFsdWVPZihzZWN0aW9uKSArIDEpDQogICAgICAgIGlmICh0b0FsaWFzID09ICdoZWFkXzcnKSB7DQogICAgICAgICAgICB0b0FsaWFzID0gJ21lZ2FfdG90YWwnDQogICAgICAgIH0NCiAgICAgICAgZGVmIGZyb20gPSBnZXREYXRhUm93KGRhdGFSb3dzLCBmcm9tQWxpYXMpLmdldEluZGV4KCkNCiAgICAgICAgZGVmIHRvID0gKHRvQWxpYXMgIT0gJ2hlYWRfMTAnKSA/IChnZXREYXRhUm93KGRhdGFSb3dzLCB0b0FsaWFzKS5nZXRJbmRleCgpIC0gMSkgOiBkYXRhUm93cy5zaXplKCkNCiAgICAgICAgaWYgKGZyb20gPCB0bykgew0KICAgICAgICAgICAgaWYgKHNlY3Rpb25NYXBbc2VjdGlvbl0gPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIHNlY3Rpb25NYXBbc2VjdGlvbl0gPSBbXQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgc2VjdGlvbk1hcFtzZWN0aW9uXS5hZGRBbGwoZGF0YVJvd3Muc3ViTGlzdChmcm9tLCB0bykpDQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHNlY3Rpb25NYXANCn0NCg0KLy8g0KHQvtGA0YLQuNGA0L7QstC60LAg0LPRgNGD0L/QvyDQuCDRgdGC0YDQvtC6DQp2b2lkIHNvcnRGb3JtRGF0YVJvd3MoZGVmIHNhdmVJbkRCID0gdHJ1ZSkgew0KICAgIGRlZiBkYXRhUm93SGVscGVyID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpDQogICAgZGVmIGRhdGFSb3dzID0gZGF0YVJvd0hlbHBlci5hbGxDYWNoZWQNCiAgICBkZWYgY29sdW1ucyA9IHNvcnRDb2x1bW5zICsgKGFsbENvbHVtbnMgLSBzb3J0Q29sdW1ucykNCiAgICAvLyDQodC+0YDRgtC40YDQvtCy0LrQsCAo0LLQvdGD0YLRgNC4INCz0YDRg9C/0L8pDQogICAgcmVmQm9va1NlcnZpY2UuZGF0YVJvd3NEZXJlZmVyZW5jZShsb2dnZXIsIGRhdGFSb3dzLCBmb3JtRGF0YS5nZXRGb3JtQ29sdW1ucygpLmZpbmRBbGwgeyBjb2x1bW5zLmNvbnRhaW5zKGl0LmdldEFsaWFzKCkpfSkNCiAgICBkZWYgbmV3Um93cyA9IFtdDQogICAgZGVmIHRlbXBSb3dzID0gW10NCiAgICBmb3IgKGRlZiByb3cgOiBkYXRhUm93cykgew0KICAgICAgICBpZiAocm93LmdldEFsaWFzKCkgIT0gbnVsbCkgew0KICAgICAgICAgICAgaWYgKCF0ZW1wUm93cy5pc0VtcHR5KCkpIHsNCiAgICAgICAgICAgICAgICBzb3J0Um93cyh0ZW1wUm93cywgY29sdW1ucykNCiAgICAgICAgICAgICAgICBuZXdSb3dzLmFkZEFsbCh0ZW1wUm93cykNCiAgICAgICAgICAgICAgICB0ZW1wUm93cyA9IFtdDQogICAgICAgICAgICB9DQogICAgICAgICAgICBuZXdSb3dzLmFkZChyb3cpDQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICB9DQogICAgICAgIHRlbXBSb3dzLmFkZChyb3cpDQogICAgfQ0KICAgIGlmICghdGVtcFJvd3MuaXNFbXB0eSgpKSB7DQogICAgICAgIHNvcnRSb3dzKHRlbXBSb3dzLCBjb2x1bW5zKQ0KICAgICAgICBuZXdSb3dzLmFkZEFsbCh0ZW1wUm93cykNCiAgICB9DQogICAgZGF0YVJvd0hlbHBlci5zZXRBbGxDYWNoZWQobmV3Um93cykNCg0KICAgIGlmIChzYXZlSW5EQikgew0KICAgICAgICBkYXRhUm93SGVscGVyLnNhdmVTb3J0KCkNCiAgICB9IGVsc2Ugew0KICAgICAgICB1cGRhdGVJbmRleGVzKGRhdGFSb3dzKQ0KICAgIH0NCn0NCg0KQEZpZWxkDQpkZWYgbWVnYVRvdGFsc1BhdHRlcm5zID0gWydzYWxlXzE4JyA6IC/QktCh0JXQk9CeINC/0L4g0LTQvtC/0L7Qu9C90LjRgtC10LvRjNC90L7QvNGDINC70LjRgdGC0YMg0LrQvdC40LPQuCDQv9GA0L7QtNCw0LYg0LfQsCAoLiopINC/0L4g0YHRgtCw0LLQutC1IDE4JS8sDQogICAgICAgICAgICAgICAgICAgICAgICAgICdzYWxlXzEwJyA6IC/QktCh0JXQk9CeINC/0L4g0LTQvtC/0L7Qu9C90LjRgtC10LvRjNC90L7QvNGDINC70LjRgdGC0YMg0LrQvdC40LPQuCDQv9GA0L7QtNCw0LYg0LfQsCAoLiopINC/0L4g0YHRgtCw0LLQutC1IDEwJS8sDQogICAgICAgICAgICAgICAgICAgICAgICAgICdwdXJjaGFzZScgOiAv0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/QvtC60YPQv9C+0Log0LfQsCAoLiopINC/0L4g0YHRgtCw0LLQutC1IDE4JS9dDQoNCnZvaWQgaW1wb3J0RGF0YSgpIHsNCiAgICBkZWYgdG1wUm93ID0gZm9ybURhdGEuY3JlYXRlRGF0YVJvdygpDQogICAgaW50IENPTFVNTl9DT1VOVCA9IDEwDQogICAgaW50IEhFQURFUl9ST1dfQ09VTlQgPSA0DQogICAgU3RyaW5nIFRBQkxFX1NUQVJUX1ZBTFVFID0gZ2V0Q29sdW1uTmFtZSh0bXBSb3csICdyb3dOdW0nKQ0KICAgIFN0cmluZyBUQUJMRV9FTkRfVkFMVUUgPSBudWxsDQogICAgaW50IElOREVYX0ZPUl9TS0lQID0gMQ0KDQogICAgZGVmIGFsbFZhbHVlcyA9IFtdICAgICAgLy8g0LfQvdCw0YfQtdC90LjRjyDRhNC+0YDQvNGLDQogICAgZGVmIGhlYWRlclZhbHVlcyA9IFtdICAgLy8g0LfQvdCw0YfQtdC90LjRjyDRiNCw0L/QutC4DQogICAgZGVmIHBhcmFtc01hcCA9IFsncm93T2Zmc2V0JzogMCwgJ2NvbE9mZnNldCc6IDBdICAvLyDQvNCw0L/QsCDRgSDQv9Cw0YDQsNC80LXRgtGA0LDQvNC4ICjQvtGC0YHRgtGD0L/RiyDRgdCy0LXRgNGF0YMg0Lgg0YHQu9C10LLQsCkNCg0KICAgIGNoZWNrQW5kUmVhZEZpbGUoSW1wb3J0SW5wdXRTdHJlYW0sIFVwbG9hZEZpbGVOYW1lLCBhbGxWYWx1ZXMsIGhlYWRlclZhbHVlcywgVEFCTEVfU1RBUlRfVkFMVUUsIFRBQkxFX0VORF9WQUxVRSwgSEVBREVSX1JPV19DT1VOVCwgcGFyYW1zTWFwKQ0KDQogICAgLy8g0L/RgNC+0LLQtdGA0LrQsCDRiNCw0L/QutC4DQogICAgY2hlY2tIZWFkZXJYbHMoaGVhZGVyVmFsdWVzLCBDT0xVTU5fQ09VTlQsIEhFQURFUl9ST1dfQ09VTlQsIHRtcFJvdykNCiAgICBpZiAobG9nZ2VyLmNvbnRhaW5zTGV2ZWwoTG9nTGV2ZWwuRVJST1IpKSB7DQogICAgICAgIHJldHVybg0KICAgIH0NCiAgICAvLyDQvtGB0LLQvtCx0L7QttC00LXQvdC40LUg0YDQtdGB0YPRgNGB0L7QsiDQtNC70Y8g0Y3QutC+0L3QvtC80LjQuCDQv9Cw0LzRj9GC0LgNCiAgICBoZWFkZXJWYWx1ZXMuY2xlYXIoKQ0KICAgIGhlYWRlclZhbHVlcyA9IG51bGwNCg0KICAgIGRlZiBmaWxlUm93SW5kZXggPSBwYXJhbXNNYXAucm93T2Zmc2V0DQogICAgZGVmIGNvbE9mZnNldCA9IHBhcmFtc01hcC5jb2xPZmZzZXQNCiAgICBwYXJhbXNNYXAuY2xlYXIoKQ0KICAgIHBhcmFtc01hcCA9IG51bGwNCg0KICAgIC8vINC/0L7Qu9GD0YfQuNGC0Ywg0YHRgtGA0L7QutC4INC40Lcg0YjQsNCx0LvQvtC90LANCiAgICBkZWYgZm9ybVRlbXBsYXRlID0gZm9ybURhdGFTZXJ2aWNlLmdldEZvcm1UZW1wbGF0ZShmb3JtRGF0YS5mb3JtVHlwZS5pZCwgZm9ybURhdGEucmVwb3J0UGVyaW9kSWQpDQogICAgZGVmIHRlbXBsYXRlUm93cyA9IGZvcm1UZW1wbGF0ZS5yb3dzDQogICAgZGVmIHZhbHVlc1RvdGFsID0gWyBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfMScpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfMicpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfMycpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfNCcpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfNScpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfNicpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfNycpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfOCcpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfOScpPy5maXgNCiAgICBdDQoNCiAgICBkZWYgcm93SW5kZXggPSAwDQogICAgZGVmIGFsbFZhbHVlc0NvdW50ID0gYWxsVmFsdWVzLnNpemUoKQ0KICAgIGRlZiBzZWN0aW9uTWFwID0gWzpdDQogICAgZGVmIHJvd3MgPSBbXQ0KICAgIGRlZiBzZWN0aW9uSW5kZXggPSBudWxsDQoNCiAgICAvLyDRhNC+0YDQvNC40YDQstCw0L3QuNC1INGB0YLRgNC+0Log0L3RhA0KICAgIGZvciAoZGVmIGkgPSAwOyBpIDwgYWxsVmFsdWVzQ291bnQ7IGkrKykgew0KICAgICAgICByb3dWYWx1ZXMgPSBhbGxWYWx1ZXNbMF0NCiAgICAgICAgZmlsZVJvd0luZGV4KysNCg0KICAgICAgICAvLyDQstGB0LUg0YHRgtGA0L7QutC4INC/0YPRgdGC0YvQtSAtINCy0YvRhdC+0LQNCiAgICAgICAgaWYgKCFyb3dWYWx1ZXMpIHsNCiAgICAgICAgICAgIGFsbFZhbHVlcy5yZW1vdmUocm93VmFsdWVzKQ0KICAgICAgICAgICAgcm93VmFsdWVzLmNsZWFyKCkNCiAgICAgICAgICAgIGJyZWFrDQogICAgICAgIH0NCg0KICAgICAgICAvLyDQn9GA0L7Qv9GD0YHQuiDQuNGC0L7Qs9C+0LLRi9GFINGB0YLRgNC+0LoNCiAgICAgICAgLy8g0LXRgdC70Lgg0Y3RgtC+INC90LDRh9Cw0LvQviDRgNCw0LfQtNC10LvQsCwg0YLQviDQt9Cw0L/QvtC80L3QuNGC0Ywg0LXQs9C+INC90LDQt9Cy0LDQvdC40LUg0Lgg0L7QsdGA0LDQsdCw0YLRi9Cy0LDRgtGMINGB0LvQtdC00YPRjtGJ0YPRjiDRgdGC0YDQvtC60YMNCiAgICAgICAgU3RyaW5nIGZpcnN0VmFsdWUgPSByb3dWYWx1ZXNbSU5ERVhfRk9SX1NLSVBdDQogICAgICAgIGlmICh2YWx1ZXNUb3RhbC5jb250YWlucyhmaXJzdFZhbHVlKSkgew0KICAgICAgICAgICAgZGVmIHByZXZTZWN0aW9uSW5kZXggPSBzZWN0aW9uSW5kZXgNCiAgICAgICAgICAgIHNlY3Rpb25JbmRleCA9IGZpcnN0VmFsdWVbMF0NCiAgICAgICAgICAgIGlmIChwcmV2U2VjdGlvbkluZGV4ICE9IG51bGwgJiYgKEludGVnZXIudmFsdWVPZihwcmV2U2VjdGlvbkluZGV4KSArIDEgIT0gSW50ZWdlci52YWx1ZU9mKHNlY3Rpb25JbmRleCkpKSB7DQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFNlcnZpY2VFeGNlcHRpb24oItCh0YLRgNC+0LrQsCAlZDog0KHRgtGA0YPQutGC0YPRgNCwINGE0LDQudC70LAg0L3QtSDRgdC+0L7RgtCy0LXRgtGB0YLQstGD0LXRgiDQvNCw0LrQtdGC0YMg0L3QsNC70L7Qs9C+0LLQvtC5INGE0L7RgNC80YsiLCBmaWxlUm93SW5kZXgpDQogICAgICAgICAgICB9DQogICAgICAgICAgICBzZWN0aW9uTWFwLnB1dChzZWN0aW9uSW5kZXgsIFtdKQ0KICAgICAgICAgICAgcm93cy5hZGQoZ2V0RGF0YVJvdyh0ZW1wbGF0ZVJvd3MsICdoZWFkXycgKyBzZWN0aW9uSW5kZXgpKQ0KICAgICAgICAgICAgYWxsVmFsdWVzLnJlbW92ZShyb3dWYWx1ZXMpDQogICAgICAgICAgICByb3dWYWx1ZXMuY2xlYXIoKQ0KICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgfSBlbHNlIGlmIChmaXJzdFZhbHVlLmNvbnRhaW5zKCfQmNGC0L7Qs9C+INC30LAgJykpIHsNCiAgICAgICAgICAgIHJvd0luZGV4KysNCiAgICAgICAgICAgIGRlZiBwZXJpb2ROYW1lID0gZmlyc3RWYWx1ZS5yZXBsYWNlQWxsKCfQmNGC0L7Qs9C+INC30LAgJywgJycpDQogICAgICAgICAgICBkZWYgcGVyaW9kSWQgPSBnZXRSZWNvcmRJZEltcG9ydCg4LCAnTkFNRScsIHBlcmlvZE5hbWUsIGZpbGVSb3dJbmRleCwgMiArIGNvbE9mZnNldCkNCiAgICAgICAgICAgIGRlZiB0b3RhbFBlcmlvZCA9IGdldFBlcmlvZFRvdGFsUm93KHNlY3Rpb25JbmRleCwgcGVyaW9kSWQpDQogICAgICAgICAgICBmaWxsVG90YWxSb3dGcm9tWGxzKHRvdGFsUGVyaW9kLCByb3dWYWx1ZXMsIGNvbE9mZnNldCwgZmlsZVJvd0luZGV4LCByb3dJbmRleCkNCiAgICAgICAgICAgIHJvd3MuYWRkKHRvdGFsUGVyaW9kKQ0KICAgICAgICAgICAgYWxsVmFsdWVzLnJlbW92ZShyb3dWYWx1ZXMpDQogICAgICAgICAgICByb3dWYWx1ZXMuY2xlYXIoKQ0KICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgfSBlbHNlIGlmIChmaXJzdFZhbHVlID09ICfQktCh0JXQk9CeINC/0L4g0YDQsNC30LTQtdC70LDQvCAxLTYnKSB7DQogICAgICAgICAgICBpZiAoc2VjdGlvbkluZGV4ICE9ICc2Jykgew0KICAgICAgICAgICAgICAgIHRocm93IG5ldyBTZXJ2aWNlRXhjZXB0aW9uKCLQodGC0YDQvtC60LAgJWQ6INCh0YLRgNGD0LrRgtGD0YDQsCDRhNCw0LnQu9CwINC90LUg0YHQvtC+0YLQstC10YLRgdGC0LLRg9C10YIg0LzQsNC60LXRgtGDINC90LDQu9C+0LPQvtCy0L7QuSDRhNC+0YDQvNGLIiwgZmlsZVJvd0luZGV4KQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZGVmIHRvdGFsU2VjdGlvbnNfMV82ID0gZ2V0RGF0YVJvdyh0ZW1wbGF0ZVJvd3MsICdtZWdhX3RvdGFsJykNCiAgICAgICAgICAgIGZpbGxUb3RhbFJvd0Zyb21YbHModG90YWxTZWN0aW9uc18xXzYsIHJvd1ZhbHVlcywgY29sT2Zmc2V0LCBmaWxlUm93SW5kZXgsIHJvd0luZGV4KQ0KICAgICAgICAgICAgc2VjdGlvbk1hcFtzZWN0aW9uSW5kZXhdLmFkZCh0b3RhbFNlY3Rpb25zXzFfNikNCiAgICAgICAgICAgIHJvd3MuYWRkKHRvdGFsU2VjdGlvbnNfMV82KQ0KICAgICAgICAgICAgYWxsVmFsdWVzLnJlbW92ZShyb3dWYWx1ZXMpDQogICAgICAgICAgICByb3dWYWx1ZXMuY2xlYXIoKQ0KICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgfSBlbHNlIGlmIChmaXJzdFZhbHVlLnN0YXJ0c1dpdGgoItCS0KHQldCT0J4g0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3QvtC80YMg0LvQuNGB0YLRgyIpKSB7DQogICAgICAgICAgICBpZiAoc2VjdGlvbkluZGV4ICE9ICc3Jykgew0KICAgICAgICAgICAgICAgIHRocm93IG5ldyBTZXJ2aWNlRXhjZXB0aW9uKCLQodGC0YDQvtC60LAgJWQ6INCh0YLRgNGD0LrRgtGD0YDQsCDRhNCw0LnQu9CwINC90LUg0YHQvtC+0YLQstC10YLRgdGC0LLRg9C10YIg0LzQsNC60LXRgtGDINC90LDQu9C+0LPQvtCy0L7QuSDRhNC+0YDQvNGLIiwgZmlsZVJvd0luZGV4KQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZGVmIGVudHJ5ID0gbWVnYVRvdGFsc1BhdHRlcm5zLmZpbmQgeyBrZXksIHBhdHRlcm4gLT4gZmlyc3RWYWx1ZSA9PX4gcGF0dGVybn0NCiAgICAgICAgICAgIGlmIChlbnRyeSAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgZGVmIHBlcmlvZE5hbWUgPSBmaXJzdFZhbHVlLnJlcGxhY2VBbGwoZW50cnkudmFsdWUsICJcJDEiKQ0KICAgICAgICAgICAgICAgIGRlZiBwZXJpb2RJZCA9IGdldFJlY29yZElkSW1wb3J0KDgsICdOQU1FJywgcGVyaW9kTmFtZSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCiAgICAgICAgICAgICAgICBkZWYgdG90YWxQZXJpb2QgPSBnZXRTdXBlclRvdGFsUm93KGVudHJ5LmtleSwgcGVyaW9kSWQpDQogICAgICAgICAgICAgICAgZmlsbFRvdGFsUm93RnJvbVhscyh0b3RhbFBlcmlvZCwgcm93VmFsdWVzLCBjb2xPZmZzZXQsIGZpbGVSb3dJbmRleCwgcm93SW5kZXgpDQogICAgICAgICAgICAgICAgcm93cy5hZGQodG90YWxQZXJpb2QpDQogICAgICAgICAgICB9DQogICAgICAgICAgICBhbGxWYWx1ZXMucmVtb3ZlKHJvd1ZhbHVlcykNCiAgICAgICAgICAgIHJvd1ZhbHVlcy5jbGVhcigpDQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHNlY3Rpb25JbmRleCA9PSBudWxsKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgU2VydmljZUV4Y2VwdGlvbigi0KHRgtGA0L7QutCwICVkOiDQodGC0YDRg9C60YLRg9GA0LAg0YTQsNC50LvQsCDQvdC1INGB0L7QvtGC0LLQtdGC0YHRgtCy0YPQtdGCINC80LDQutC10YLRgyDQvdCw0LvQvtCz0L7QstC+0Lkg0YTQvtGA0LzRiyIsIGZpbGVSb3dJbmRleCkNCiAgICAgICAgfQ0KDQogICAgICAgIC8vINC/0YDQvtGB0YLQsNGPINGB0YLRgNC+0LrQsA0KICAgICAgICByb3dJbmRleCsrDQogICAgICAgIGRlZiBuZXdSb3cgPSBnZXROZXdSb3dGcm9tWGxzKHJvd1ZhbHVlcywgY29sT2Zmc2V0LCBmaWxlUm93SW5kZXgsIHJvd0luZGV4LCBJbnRlZ2VyLnZhbHVlT2Yoc2VjdGlvbkluZGV4KSA8IDcpDQogICAgICAgIHNlY3Rpb25NYXBbc2VjdGlvbkluZGV4XS5hZGQobmV3Um93KQ0KICAgICAgICByb3dzLmFkZChuZXdSb3cpDQoNCiAgICAgICAgLy8g0L7RgdCy0L7QsdC+0LTQuNGC0Ywg0L3QtdC90YPQttC90YvQtSDQtNCw0L3QvdGL0LUgLSDQuNC90LDRh9C1INC90LUg0YXQstCw0YLQuNGCINC/0LDQvNGP0YLQuA0KICAgICAgICBhbGxWYWx1ZXMucmVtb3ZlKHJvd1ZhbHVlcykNCiAgICAgICAgcm93VmFsdWVzLmNsZWFyKCkNCiAgICB9DQoNCiAgICBkZWYgbmV3Um93cyA9IChzZWN0aW9uTWFwLnZhbHVlcygpLnN1bSB7IGl0IH0gPzogW10pDQogICAgc2hvd01lc3NhZ2VzKHJvd3MsIGxvZ2dlcikNCiAgICBpZiAobG9nZ2VyLmNvbnRhaW5zTGV2ZWwoTG9nTGV2ZWwuRVJST1IpIHx8IG5ld1Jvd3MgPT0gbnVsbCB8fCBuZXdSb3dzLmlzRW1wdHkoKSkgew0KICAgICAgICByZXR1cm4NCiAgICB9DQoNCiAgICB1cGRhdGVJbmRleGVzKHJvd3MpDQoNCiAgICAvLyDRgdGA0LDQstC90LXQvdC40LUg0LjRgtC+0LPQvtCyDQogICAgY29tcGFyZVNwZWNpZmljVG90YWxWYWx1ZXMocm93cywgc2VjdGlvbk1hcCkNCg0KICAgIGlmICghbG9nZ2VyLmNvbnRhaW5zTGV2ZWwoTG9nTGV2ZWwuRVJST1IpKSB7DQogICAgICAgIGZvcm1EYXRhU2VydmljZS5nZXREYXRhUm93SGVscGVyKGZvcm1EYXRhKS5hbGxDYWNoZWQgPSByb3dzDQogICAgfQ0KfQ0KDQovKioNCiAqINCf0YDQvtCy0LXRgNC40YLRjCDRiNCw0L/QutGDINGC0LDQsdC70LjRhtGLDQogKg0KICogQHBhcmFtIGhlYWRlclJvd3Mg0YHRgtGA0L7QutC4INGI0LDQv9C60LgNCiAqIEBwYXJhbSBjb2xDb3VudCDQutC+0LvQuNGH0LXRgdGC0LLQviDQutC+0LvQvtC90L7QuiDQsiDRgtCw0LHQu9C40YbQtQ0KICogQHBhcmFtIHJvd0NvdW50INC60L7Qu9C40YfQtdGB0YLQstC+INGB0YLRgNC+0Log0LIg0YLQsNCx0LvQuNGG0LUNCiAqIEBwYXJhbSB0bXBSb3cg0LLRgdC/0L7QvNC+0LPQsNGC0LXQu9GM0L3QsNGPINGB0YLRgNC+0LrQsCDQtNC70Y8g0L/QvtC70YPRh9C10L3QuNGPINC90LDQt9Cy0LDQvdC40Lgg0LPRgNCw0YTQvtCyDQogKi8NCnZvaWQgY2hlY2tIZWFkZXJYbHMoZGVmIGhlYWRlclJvd3MsIGRlZiBjb2xDb3VudCwgcm93Q291bnQsIGRlZiB0bXBSb3cpIHsNCiAgICBpZiAoaGVhZGVyUm93cy5pc0VtcHR5KCkpIHsNCiAgICAgICAgdGhyb3cgbmV3IFNlcnZpY2VFeGNlcHRpb24oV1JPTkdfSEVBREVSX1JPV19TSVpFKQ0KICAgIH0NCiAgICBjaGVja0hlYWRlclNpemUoaGVhZGVyUm93c1swXS5zaXplKCksIGhlYWRlclJvd3Muc2l6ZSgpLCBjb2xDb3VudCwgcm93Q291bnQpDQogICAgZGVmIGhlYWRlck1hcHBpbmcgPSBbDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzBdWzBdKTogZ2V0Q29sdW1uTmFtZSh0bXBSb3csICdyb3dOdW0nKV0pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1swXVsyXSk6ICfQlNCw0L3QvdGL0LUg0LHRg9GF0LPQsNC70YLQtdGA0YHQutC+0LPQviDRg9GH0ZHRgtCwJ10pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1swXVs5XSk6IGdldENvbHVtbk5hbWUodG1wUm93LCAncmF0ZU5kcycpXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzBdWzEwXSk6IGdldENvbHVtbk5hbWUodG1wUm93LCAnc3VtJyldKSwNCg0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1sxXVsyXSk6ICfQktC10LvQuNGH0LjQvdCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4INC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMV1bNl0pOiAn0JLQtdC70LjRh9C40L3QsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCDQndCU0KEnXSksDQoNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMl1bMl0pOiAn0J3QsNC70L7Qs9C+0LLRi9C5INC/0LXRgNC40L7QtCwg0LfQsCDQutC+0YLQvtGA0YvQuSDQstC90L7RgdC40YLRgdGPINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutCwJ10pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1syXVszXSk6ICfQvdC+0LzQtdGAINCx0LDQu9Cw0L3RgdC+0LLQvtCz0L4g0YHRh9GR0YLQsCddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMl1bNF0pOiAn0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoKyknXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzJdWzVdKTogJ9Ch0YPQvNC80LAg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKC0pJ10pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1syXVs2XSk6ICfQvdC+0LzQtdGAINCx0LDQu9Cw0L3RgdC+0LLQvtCz0L4g0YHRh9GR0YLQsCddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMl1bN10pOiAn0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoKyknXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzJdWzhdKTogJ9Ch0YPQvNC80LAg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKC0pJ10pLA0KDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzNdWzBdKTogJzEnXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzNdWzJdKTogJzInXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzNdWzNdKTogJzMnXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzNdWzRdKTogJzQnXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzNdWzZdKTogJzUnXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzNdWzddKTogJzYnXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzNdWzldKTogJzcnXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzNdWzEwXSk6ICc4J10pDQogICAgXQ0KICAgIGNoZWNrSGVhZGVyRXF1YWxzKGhlYWRlck1hcHBpbmcsIGxvZ2dlcikNCn0NCg0KLyoqDQogKiDQn9C+0LvRg9GH0LjRgtGMINC90L7QstGD0Y4g0YHRgtGA0L7QutGDINC90YQg0L/QviDQt9C90LDRh9C10L3QuNGP0Lwg0LjQtyDRjdC60YHQtdC70Y8uDQogKg0KICogQHBhcmFtIHZhbHVlcyDRgdC/0LjRgdC+0Log0YHRgtGA0L7QuiDRgdC+INC30L3QsNGH0LXQvdC40Y/QvNC4DQogKiBAcGFyYW0gY29sT2Zmc2V0INC+0YLRgdGC0YPQvyDQsiDQutC+0LvQvtC90LrQsNGFDQogKiBAcGFyYW0gZmlsZVJvd0luZGV4INC90L7QvNC10YAg0YHRgtGA0L7QutC4INCyINGC0YQNCiAqIEBwYXJh'
        longString += 'bSByb3dJbmRleCDRgdGC0YDQvtC60LAg0LIg0L3RhA0KICovDQpkZWYgZ2V0TmV3Um93RnJvbVhscyhkZWYgdmFsdWVzLCBkZWYgY29sT2Zmc2V0LCBkZWYgZmlsZVJvd0luZGV4LCBkZWYgcm93SW5kZXgsIGJvb2xlYW4gaXNHcm91cF8xXzYpIHsNCiAgICBkZWYgbmV3Um93ID0gZ2V0TmV3Um93KGlzR3JvdXBfMV82KQ0KICAgIG5ld1Jvdy5zZXRJbmRleChyb3dJbmRleCkNCiAgICBuZXdSb3cuc2V0SW1wb3J0SW5kZXgoZmlsZVJvd0luZGV4KQ0KDQogICAgLy8g0JPRgNCw0YTQsCAyDQogICAgZGVmIGNvbEluZGV4ID0gMg0KICAgIG5ld1Jvdy5wZXJpb2QgPSBnZXRSZWNvcmRJZEltcG9ydCg4LCAnTkFNRScsIHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQk9GA0LDRhNCwIDMNCiAgICBjb2xJbmRleCA9IDMNCiAgICBuZXdSb3cubnVtYmVyID0gZ2V0UmVjb3JkSWRJbXBvcnQoMTAxLCAnQUNDT1VOVCcsIHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQs9GA0LDRhNCwIDQNCiAgICBjb2xJbmRleCA9IDQNCiAgICBuZXdSb3cuc3VtUGx1cyA9IGdldE51bWJlcih2YWx1ZXNbY29sSW5kZXhdLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0KQ0KDQogICAgLy8g0LPRgNCw0YTQsCA1DQogICAgY29sSW5kZXggPSA1DQogICAgbmV3Um93LnN1bU1pbnVzID0gZ2V0TnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQk9GA0LDRhNCwIDYNCiAgICBjb2xJbmRleCA9IDYNCiAgICBuZXdSb3cubnVtYmVyTmRzID0gZ2V0UmVjb3JkSWRJbXBvcnQoMTAxLCAnQUNDT1VOVCcsIHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQs9GA0LDRhNCwIDcNCiAgICBjb2xJbmRleCA9IDcNCiAgICBuZXdSb3cuc3VtTmRzUGx1cyA9IGdldE51bWJlcih2YWx1ZXNbY29sSW5kZXhdLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0KQ0KDQogICAgLy8g0LPRgNCw0YTQsCA4DQogICAgY29sSW5kZXggPSA4DQogICAgbmV3Um93LnN1bU5kc01pbnVzID0gZ2V0TnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQs9GA0LDRhNCwIDkNCiAgICBjb2xJbmRleCA9IDkNCiAgICBuZXdSb3cucmF0ZU5kcyA9IHZhbHVlc1tjb2xJbmRleF0NCg0KICAgIC8vINCz0YDQsNGE0LAgMTANCiAgICBjb2xJbmRleCA9IDEwDQogICAgbmV3Um93LnN1bSA9IGdldE51bWJlcih2YWx1ZXNbY29sSW5kZXhdLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0KQ0KDQogICAgcmV0dXJuIG5ld1Jvdw0KfQ0KDQovKioNCiAqINCX0LDQv9C+0LvQvdC40YLRjCDQvdC+0LLRg9GOINGB0YLRgNC+0LrRgyDQvdGEINC/0L4g0LfQvdCw0YfQtdC90LjRj9C8INC40Lcg0Y3QutGB0LXQu9GPLg0KICoNCiAqIEBwYXJhbSB0b3RhbFJvdyDRgdGC0YDQvtC60LANCiAqIEBwYXJhbSB2YWx1ZXMg0YHQv9C40YHQvtC6INGB0YLRgNC+0Log0YHQviDQt9C90LDRh9C10L3QuNGP0LzQuA0KICogQHBhcmFtIGNvbE9mZnNldCDQvtGC0YHRgtGD0L8g0LIg0LrQvtC70L7QvdC60LDRhQ0KICogQHBhcmFtIGZpbGVSb3dJbmRleCDQvdC+0LzQtdGAINGB0YLRgNC+0LrQuCDQsiDRgtGEDQogKiBAcGFyYW0gcm93SW5kZXgg0YHRgtGA0L7QutCwINCyINC90YQNCiAqLw0Kdm9pZCBmaWxsVG90YWxSb3dGcm9tWGxzKGRlZiB0b3RhbFJvdywgZGVmIHZhbHVlcywgZGVmIGNvbE9mZnNldCwgZGVmIGZpbGVSb3dJbmRleCwgZGVmIHJvd0luZGV4KSB7DQogICAgdG90YWxSb3cuc2V0SW5kZXgocm93SW5kZXgpDQogICAgdG90YWxSb3cuc2V0SW1wb3J0SW5kZXgoZmlsZVJvd0luZGV4KQ0KDQogICAgLy8g0LPRgNCw0YTQsCA0DQogICAgY29sSW5kZXggPSA0DQogICAgdG90YWxSb3cuc3VtUGx1cyA9IGdldE51bWJlcih2YWx1ZXNbY29sSW5kZXhdLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0KQ0KDQogICAgLy8g0LPRgNCw0YTQsCA1DQogICAgY29sSW5kZXggPSA1DQogICAgdG90YWxSb3cuc3VtTWludXMgPSBnZXROdW1iZXIodmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCg0KICAgIC8vINCz0YDQsNGE0LAgNw0KICAgIGNvbEluZGV4ID0gNw0KICAgIHRvdGFsUm93LnN1bU5kc1BsdXMgPSBnZXROdW1iZXIodmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCg0KICAgIC8vINCz0YDQsNGE0LAgOA0KICAgIGNvbEluZGV4ID0gOA0KICAgIHRvdGFsUm93LnN1bU5kc01pbnVzID0gZ2V0TnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQs9GA0LDRhNCwIDEwDQogICAgY29sSW5kZXggPSAxMA0KICAgIHRvdGFsUm93LnN1bSA9IGdldE51bWJlcih2YWx1ZXNbY29sSW5kZXhdLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0KQ0KfQ0KDQp2b2lkIGNvbXBhcmVTcGVjaWZpY1RvdGFsVmFsdWVzKGRlZiBkYXRhUm93cywgZGVmIHNlY3Rpb25NYXApIHsNCiAgICBkZWYgaXNJbXBvcnQgPSBmb3JtRGF0YUV2ZW50ID09IEZvcm1EYXRhRXZlbnQuSU1QT1JUDQogICAgZGVmIGxvZ0xldmVsID0gaXNJbXBvcnQgPyBMb2dMZXZlbC5XQVJOSU5HIDogTG9nTGV2ZWwuRVJST1INCiAgICAvLyDRgdGH0LjRgtCw0LXQvCDQuNGC0L7Qs9C4DQogICAgZGVmIGNhbGNSb3dzID0gW10NCiAgICBjYWxjUm93cy5hZGRBbGwoZm9ybURhdGFTZXJ2aWNlLmdldEZvcm1UZW1wbGF0ZShmb3JtRGF0YS5mb3JtVHlwZS5pZCwgZm9ybURhdGEucmVwb3J0UGVyaW9kSWQpLnJvd3MpDQogICAgdXBkYXRlSW5kZXhlcyhjYWxjUm93cykNCiAgICBzZWN0aW9uTWFwLmVhY2ggeyBrZXksIHRlbXBSb3dzIC0+DQogICAgICAgIGNhbGNSb3dzLmFkZEFsbChnZXREYXRhUm93KGNhbGNSb3dzLCAnaGVhZF8nICsga2V5KS5nZXRJbmRleCgpLCB0ZW1wUm93cy5maW5kQWxsIHsgaXQuZ2V0QWxpYXMoKSA9PSBudWxsIHx8IGl0LmdldEFsaWFzKCkuc3RhcnRzV2l0aCgndG90YWxfJykgfSkNCiAgICAgICAgdXBkYXRlSW5kZXhlcyhjYWxjUm93cykNCiAgICB9DQogICAgY2FsY1BlcmlvZFRvdGFscyhjYWxjUm93cykNCg0KICAgIHVwZGF0ZUluZGV4ZXMoZGF0YVJvd3MpDQoNCiAgICBzZWN0aW9ucy5lYWNoIHsgc2VjdGlvbiAtPg0KICAgICAgICBkZWYgcGVyaW9kVG90YWxzID0gZGF0YVJvd3MuZmluZEFsbCB7IHJvdyAtPiByb3cuZ2V0QWxpYXMoKSAhPSBudWxsICYmIHJvdy5nZXRBbGlhcygpLnN0YXJ0c1dpdGgoInRvdGFsXyIgKyBzZWN0aW9uKX0NCiAgICAgICAgZGVmIGNhbGNQZXJpb2RUb3RhbHMgPSBjYWxjUm93cy5maW5kQWxsIHsgcm93IC0+IHJvdy5nZXRBbGlhcygpICE9IG51bGwgJiYgcm93LmdldEFsaWFzKCkuc3RhcnRzV2l0aCgidG90YWxfIiArIHNlY3Rpb24pfQ0KICAgICAgICBkZWYgZnJvbUFsaWFzID0gJ2hlYWRfJyArIHNlY3Rpb24NCiAgICAgICAgZGVmIHRvQWxpYXMgPSAnaGVhZF8nICsgKEludGVnZXIudmFsdWVPZihzZWN0aW9uKSArIDEpDQogICAgICAgIGRlZiBmcm9tID0gZ2V0RGF0YVJvdyhkYXRhUm93cywgZnJvbUFsaWFzKS5nZXRJbmRleCgpDQogICAgICAgIGRlZiB0byA9ICh0b0FsaWFzICE9ICdoZWFkXzEwJykgPyAoZ2V0RGF0YVJvdyhkYXRhUm93cywgdG9BbGlhcykuZ2V0SW5kZXgoKSAtIDEpIDogZGF0YVJvd3Muc2l6ZSgpDQogICAgICAgIGRlZiBzZWN0aW9uUm93cyA9IGRhdGFSb3dzLnN1Ykxpc3QoZnJvbSwgdG8pLmZpbmRBbGx7IHJvdyAtPiByb3cuZ2V0QWxpYXMoKSA9PSBudWxsIHx8IHJvdy5nZXRBbGlhcygpLnN0YXJ0c1dpdGgoInRvdGFsXyIpIH0NCiAgICAgICAgY2hlY2tJdG9nUm93cyhzZWN0aW9uUm93cywgY2FsY1BlcmlvZFRvdGFscywgcGVyaW9kVG90YWxzLCBuZXcgR3JvdXBTdHJpbmcoKSB7DQogICAgICAgICAgICBAT3ZlcnJpZGUNCiAgICAgICAgICAgIFN0cmluZyBnZXRTdHJpbmcoRGF0YVJvdzxDZWxsPiByb3cpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWVzQnlHcm91cENvbHVtbihyb3cpDQogICAgICAgICAgICB9DQogICAgICAgIH0sIG5ldyBDaGVja0dyb3VwU3VtKCkgew0KICAgICAgICAgICAgQE92ZXJyaWRlDQogICAgICAgICAgICBTdHJpbmcgY2hlY2soRGF0YVJvdzxDZWxsPiByb3cxLCBEYXRhUm93PENlbGw+IHJvdzIpIHsNCiAgICAgICAgICAgICAgICBkZWYgY29sdW1ucw0KICAgICAgICAgICAgICAgIGlmIChJbnRlZ2VyLnZhbHVlT2Yoc2VjdGlvbikgPCA3KSB7DQogICAgICAgICAgICAgICAgICAgIGNvbHVtbnMgPSB0b3RhbENvbHVtbnMxXzZfU2FsZSAtIHNraXBDb2x1bW5zDQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChJbnRlZ2VyLnZhbHVlT2Yoc2VjdGlvbikgPiA2KSB7DQogICAgICAgICAgICAgICAgICAgIGNvbHVtbnMgPSB0b3RhbENvbHVtbnM3XzlfUHVyY2hhc2UgLSBza2lwQ29sdW1ucw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBmb3IgKGRlZiBjb2x1bW4gOiBjb2x1bW5zKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChyb3cxW2NvbHVtbl0gIT0gcm93Mltjb2x1bW5dKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29sdW1uTmFtZShyb3cxLCBjb2x1bW4pDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSkNCiAgICB9DQogICAgLy8NCiAgICBkZWYgbWVnYVRvdGFsID0gZ2V0RGF0YVJvdyhkYXRhUm93cywgIm1lZ2FfdG90YWwiKQ0KICAgIGRlZiBjb21wYXJlTWVnYVRvdGFsID0gZ2V0RGF0YVJvdyhjYWxjUm93cywgIm1lZ2FfdG90YWwiKQ0KICAgIC8vINGA0LDRgdGB0YfQuNGC0YvQstCw0LXQvCDQuNGC0L7QsyDQv9C+IDEtNiDQvdCwINC+0YHQvdC+0LLQtSDQuNGB0YXQvtC00L3Ri9GFINC00LDQvdC90YvRhQ0KICAgIGNhbGNNZWdhVG90YWwoY29tcGFyZU1lZ2FUb3RhbCwgZGF0YVJvd3MpDQogICAgZGVmIGNvbHVtbnMgPSB0b3RhbENvbHVtbnNNZWdhIC0gc2tpcENvbHVtbnMNCiAgICBpZiAoaXNJbXBvcnQpIHsNCiAgICAgICAgY29tcGFyZVRvdGFsVmFsdWVzKG1lZ2FUb3RhbCwgY29tcGFyZU1lZ2FUb3RhbCwgY29sdW1ucywgbG9nZ2VyLCBmYWxzZSkNCiAgICB9IGVsc2Ugew0KICAgICAgICBjb2x1bW5zLmVhY2ggeyBhbGlhcyAtPg0KICAgICAgICAgICAgZGVmIHZhbHVlID0gbWVnYVRvdGFsW2FsaWFzXSA/OiBCaWdEZWNpbWFsLlpFUk8NCiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBjb21wYXJlTWVnYVRvdGFsW2FsaWFzXSkgew0KICAgICAgICAgICAgICAgIGxvZ2dlci5sb2cobG9nTGV2ZWwsIFdST05HX1RPVEFMLCBmYWxzZSwgZ2V0Q29sdW1uTmFtZShtZWdhVG90YWwsIGFsaWFzKSkNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGRlZiBjb21wYXJlU3VwZXJSb3dzID0gY2FsY1N1cGVyVG90YWxzKGRhdGFSb3dzKQ0KICAgIGRlZiBzdXBlclJvd3MgPSBkYXRhUm93cy5maW5kQWxsIHsgcm93IC0+IHJvdy5nZXRBbGlhcygpICE9IG51bGwgJiYgcm93LmdldEFsaWFzKCkuc3RhcnRzV2l0aCgic3VwZXJfIikgfQ0KICAgIHN1cGVyUm93cy5lYWNoIHsgc3VwZXJSb3cgLT4NCiAgICAgICAgLy8g0YDQsNGB0YHRh9C40YLQsNC90L3QsNGPINGB0YLRgNC+0LrQsCDRgSDRgtCw0LrQuNC8INC20LUg0LDQu9C40LDRgdC+0LwNCiAgICAgICAgZGVmIGNhbGNSb3cgPSBjb21wYXJlU3VwZXJSb3dzLmZpbmQgeyByb3cgLT4NCiAgICAgICAgICAgIHJvdy5nZXRBbGlhcygpID09IHN1cGVyUm93LmdldEFsaWFzKCkNCiAgICAgICAgfQ0KICAgICAgICBpZiAoY2FsY1JvdyA9PSBudWxsKSB7DQogICAgICAgICAgICByb3dMb2cobG9nZ2VyLCBzdXBlclJvdywgU3RyaW5nLmZvcm1hdCgi0KHRgtGA0L7QutCwICVkOiDQodGC0YDQvtC60LAg0LjRgtC+0LPQsCDQvdC1INC+0YLQvdC+0YHQuNGC0YHRjyDQuiDQutCw0LrQvtC5LdC70LjQsdC+INCz0YDRg9C/0L/QtSEiLCBzdXBlclJvdy5nZXRJbmRleCgpKSwgbG9nTGV2ZWwpDQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBjb21wYXJlVG90YWxWYWx1ZXMoc3VwZXJSb3csIGNhbGNSb3csIGNvbHVtbnMsIGxvZ2dlciwgIWlzSW1wb3J0KQ0KICAgICAgICAgICAgY29tcGFyZVN1cGVyUm93cy5yZW1vdmUoY2FsY1JvdykNCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoIWNvbXBhcmVTdXBlclJvd3MuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbXBhcmVTdXBlclJvd3MuZWFjaCB7IGNhbGNSb3cgLT4NCiAgICAgICAgICAgIGRlZiBmaXJzdFZhbHVlID0gY2FsY1Jvdy5maXgNCiAgICAgICAgICAgIGRlZiBlbnRyeSA9IG1lZ2FUb3RhbHNQYXR0ZXJucy5maW5kIHsga2V5LCBwYXR0ZXJuIC0+IGZpcnN0VmFsdWUgPT1+IHBhdHRlcm59DQogICAgICAgICAgICBpZiAoZW50cnkgIT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIGRlZiBwZXJpb2ROYW1lID0gZmlyc3RWYWx1ZS5yZXBsYWNlQWxsKGVudHJ5LnZhbHVlLCAiXCQxIikNCiAgICAgICAgICAgICAgICBsb2dnZXIubG9nKGxvZ0xldmVsLCAi0JPRgNGD0L/Qv9CwINGB0YLRgNC+0Logwqslc8K7INC90LUg0LjQvNC10LXRgiDRgdGC0YDQvtC60Lggwqslc8K7ISIsIGZhbHNlLCBwZXJpb2ROYW1lLCBmaXJzdFZhbHVlKQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KfQ0KDQovLyDQstGL0L3QtdGBINC80LXRgtC+0LQg0LIg0YHQutGA0LjQv9GCINC00LvRjyDQv9GA0LDQstC60Lgg0L/RgNC+0LLQtdGA0L7Qug0Kdm9pZCBjaGVja0l0b2dSb3dzKGRlZiBkYXRhUm93cywgZGVmIHRlc3RJdG9nUm93cywgZGVmIGl0b2dSb3dzLCBHcm91cFN0cmluZyBncm91cFN0cmluZywgQ2hlY2tHcm91cFN1bSBjaGVja0dyb3VwU3VtKSB7DQogICAgZGVmIGxvZ0xldmVsID0gZm9ybURhdGFFdmVudCA9PSBGb3JtRGF0YUV2ZW50LklNUE9SVCA/IExvZ0xldmVsLldBUk5JTkcgOiBMb2dMZXZlbC5FUlJPUg0KICAgIC8vINGB0YfQuNGC0LDQtdGCINC60L7Qu9C40YfQtdGB0YLQstC+INGA0LXQsNC70YzQvdGL0YUg0LPRgNGD0L/QvyDQtNCw0L3QvdGL0YUNCiAgICBkZWYgZ3JvdXBDb3VudCA9IDANCiAgICAvLyDQmNGC0L7Qs9C+0LLRi9C1INGB0YLRgNC+0LrQuCDQsdGL0LvQuCDRg9C00LDQu9C10L3Riw0KICAgIC8vINCd0LXQuNGC0L7Qs9C+0LLRi9C1INGB0YLRgNC+0LrQuCDQsdGL0LvQuCDRg9C00LDQu9C10L3Riw0KICAgIGZvciAoaW50IGkgPSAwOyBpIDwgZGF0YVJvd3Muc2l6ZSgpOyBpKyspIHsNCiAgICAgICAgRGF0YVJvdzxDZWxsPiByb3cgPSBkYXRhUm93cy5nZXQoaSk7DQogICAgICAgIC8vINGB0YLRgNC+0LrQsCDQuNC70Lgg0LjRgtC+0LMg0LTRgNGD0LPQvtC5INCz0YDRg9C/0L/RiyDQv9C+0YHQu9C1INGB0YLRgNC+0LrQuCDQsdC10Lcg0L/QvtC00LjRgtC+0LPQsCDQvNC10LbQtNGDINC90LjQvNC4DQogICAgICAgIGlmIChpID4gMCkgew0KICAgICAgICAgICAgZGVmIHByZXZSb3cgPSBkYXRhUm93cy5nZXQoaSAtIDEpDQogICAgICAgICAgICBpZiAocHJldlJvdy5nZXRBbGlhcygpID09IG51bGwgJiYgY29tcGFyZUdyb3VwKHByZXZSb3csIHJvdykpIHsNCiAgICAgICAgICAgICAgICBpdG9nUm93cy5hZGQoZ3JvdXBDb3VudCwgbnVsbCkNCiAgICAgICAgICAgICAgICBncm91cENvdW50KysNCiAgICAgICAgICAgICAgICBTdHJpbmcgZ3JvdXBDb2xzID0gZ3JvdXBTdHJpbmcuZ2V0U3RyaW5nKHByZXZSb3cpOw0KICAgICAgICAgICAgICAgIGlmIChncm91cENvbHMgIT0gbnVsbCkgew0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIubG9nKGxvZ0xldmVsLCAi0JPRgNGD0L/Qv9CwIMKrJXPCuyDQvdC1INC40LzQtdC10YIg0YHRgtGA0L7QutC4INC40YLQvtCz0LAhIiwgZmFsc2UsIGdyb3VwQ29scyk7IC8vINC40YLQvtCz0LAgKNC90LUgINC/0L7QtNC40YLQvtCz0LApDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmIChyb3cuZ2V0QWxpYXMoKSAhPSBudWxsKSB7DQogICAgICAgICAgICAvLyDQuNGC0L7QsyDQv9C+0YHQu9C1INC40YLQvtCz0LAgKNC40LvQuCDQv9C+0YHQu9C1INGB0YLRgNC+0LrQuCDQuNC3INC00YDRg9Cz0L7QuSDQs9GA0YPQv9C/0YspDQogICAgICAgICAgICBpZiAoaSA8IDEgfHwgZGF0YVJvd3MuZ2V0KGkgLSAxKS5nZXRBbGlhcygpICE9IG51bGwgfHwgY29tcGFyZUdyb3VwKGRhdGFSb3dzLmdldChpIC0gMSksIHJvdykpIHsNCiAgICAgICAgICAgICAgICByb3dMb2cobG9nZ2VyLCByb3csIFN0cmluZy5mb3JtYXQoItCh0YLRgNC+0LrQsCAlZDog0KHRgtGA0L7QutCwINC40YLQvtCz0LAg0L3QtSDQvtGC0L3QvtGB0LjRgtGB0Y8g0Log0LrQsNC60L7QuS3Qu9C40LHQviDQs9GA0YPQv9C/0LUhIiwgcm93LmdldEluZGV4KCkpLCBsb2dMZXZlbCk7IC8vINC40YLQvtCz0LAgKNC90LUgINC/0L7QtNC40YLQvtCz0LApDQogICAgICAgICAgICAgICAgLy8g0YPQtNCw0LvRj9C10Lwg0LjQtyDQv9GA0L7QstC10YDRj9C10LzRi9GFINC40YLQvtCz0L7QsiDRgdGC0YDQvtC60YMg0LHQtdC3INC/0L7QtNGH0LjQvdC10L3QvdGL0YUg0YHRgtGA0L7Qug0KICAgICAgICAgICAgICAgIGl0b2dSb3dzLnJlbW92ZShyb3cpDQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGdyb3VwQ291bnQrKw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIGlmICh0ZXN0SXRvZ1Jvd3Muc2l6ZSgpID09IGl0b2dSb3dzLnNpemUoKSkgew0KICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IHRlc3RJdG9nUm93cy5zaXplKCk7IGkrKykgew0KICAgICAgICAgICAgRGF0YVJvdzxDZWxsPiB0ZXN0SXRvZ1JvdyA9IHRlc3RJdG9nUm93cy5nZXQoaSk7DQogICAgICAgICAgICBEYXRhUm93PENlbGw+IHJlYWxJdG9nUm93ID0gaXRvZ1Jvd3MuZ2V0KGkpOw0KICAgICAgICAgICAgaWYgKHJlYWxJdG9nUm93ID09IG51bGwpIHsNCiAgICAgICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaW50IHJvd0luZGV4ID0gZGF0YVJvd3MuaW5kZXhPZihyZWFsSXRvZ1JvdykgLSAxDQogICAgICAgICAgICBkZWYgcm93ID0gZGF0YVJvd3MuZ2V0KHJvd0luZGV4KQ0KICAgICAgICAgICAgU3RyaW5nIGdyb3VwQ29scyA9IGdyb3VwU3RyaW5nLmdldFN0cmluZyhyb3cpOw0KICAgICAgICAgICAgaWYgKGdyb3VwQ29scyAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgU3RyaW5nIGNoZWNrU3RyID0gY2hlY2tHcm91cFN1bS5jaGVjayh0ZXN0SXRvZ1JvdywgcmVhbEl0b2dSb3cpOw0KICAgICAgICAgICAgICAgIGlmIChjaGVja1N0ciAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgICAgIHJvd0xvZyhsb2dnZXIsIHJlYWxJdG9nUm93LCBTdHJpbmcuZm9ybWF0KEdST1VQX1dST05HX0lUT0dfU1VNLCByZWFsSXRvZ1Jvdy5nZXRJbmRleCgpLCBncm91cENvbHMsIGNoZWNrU3RyKSwgbG9nTGV2ZWwpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KYm9vbGVhbiBjb21wYXJlR3JvdXAoZGVmIHJvd0EsIGRlZiByb3dCKSB7DQogICAgZGVmIHBlcmlvZEEgPSAocm93QS5nZXRBbGlhcygpICE9IG51bGwpID8gcm93QS5maXg/LnJlcGxhY2UoJ9CY0YLQvtCz0L4g0LfQsCAnLCcnKSA6IGdldFZhbHVlc0J5R3JvdXBDb2x1bW4ocm93QSkNCiAgICBkZWYgcGVyaW9kQiA9IChyb3dCLmdldEFsaWFzKCkgIT0gbnVsbCkgPyByb3dCLmZpeD8ucmVwbGFjZSgn0JjRgtC+0LPQviDQt9CwICcsJycpIDogZ2V0VmFsdWVzQnlHcm91cENvbHVtbihyb3dCKQ0KICAgIHJldHVybiBwZXJpb2RBICE9IHBlcmlvZEINCn0NCg0KLy8g0JLQvtC30LLRgNCw0YnQsNC10YIg0YHRgtGA0L7QutGDINGB0L4g0LfQvdCw0YfQtdC90LjRj9C80Lgg0L/QvtC70LXQuSDRgdGC0YDQvtC60Lgg0L/QviDQutC+0YLQvtGA0YvQvCDQuNC00LXRgiDQs9GA0YPQv9C/0LjRgNC+0LLQutCwDQpTdHJpbmcgZ2V0VmFsdWVzQnlHcm91cENvbHVtbihEYXRhUm93IHJvdykgew0KICAgIGRlZiB2YWx1ZQ0KICAgIC8vINCz0YDQsNGE0LAgMTINCiAgICBpZiAocm93Py5wZXJpb2QpIHsNCiAgICAgICAgdmFsdWUgPSBnZXRSZWZCb29rVmFsdWUoOCwgcm93LnBlcmlvZCk/Lk5BTUU/LnN0cmluZ1ZhbHVlDQogICAgfSBlbHNlIHsNCiAgICAgICAgdmFsdWUgPSAn0LPRgNCw0YTQsCAyINC90LUg0LfQsNC00LDQvdCwJw0KICAgIH0NCiAgICByZXR1cm4gdmFsdWUNCn0NCg=='

        addLongText(form_template_id, longString, 'SCRIPT')
        logger.info("К версии макета добавлен скрипт")
    }

} catch (Exception ex) {
    logger.error("Error: ${ex.getLocalizedMessage()}. Все действия, выполненные скриптом, были отменены")
}

def void addTypeTemplate(FormType formType, FormTemplate formTemplate, boolean createType, boolean createTemplate) {
    def form_type_id = formType.id ?: ""
    def form_type_name = formType.name ?: ""
    def form_type_tax_type = formType.taxType.code ?: ""
    def form_type_is_ifrs = formType.isIfrs ? 1 : 0
    def form_type_ifrs_name = formType.ifrsName ?: ""
    def form_type_ifrs_code = formType.code ?: ""

    def form_template_id = formTemplate.id ?: ""
    def form_template_is_fixed_rows = formTemplate.isFixedRows() ? 1 : 0
    def form_template_name = formTemplate.name ?: ""
    def form_template_fullname = formTemplate.fullName ?: ""
    def form_template_version = formTemplate.version.format("dd.MM.yy")
    def form_template_monthly = formTemplate.isMonthly() ? 1 : 0
    def form_template_comparative = formTemplate.isComparative() ? 1 : 0
    def form_template_header = formTemplate.header ?: ""
    def form_template_accruing = formTemplate.isAccruing() ? 1 : 0
    def form_template_updating = formTemplate.isUpdating() ? 1 : 0

    String formTypeSql = "INSERT INTO FORM_TYPE (ID, NAME, TAX_TYPE, STATUS, IS_IFRS, IFRS_NAME, CODE) VALUES " +
            "('$form_type_id', '$form_type_name', '$form_type_tax_type', '0', '$form_type_is_ifrs', '$form_type_ifrs_name', '$form_type_ifrs_code')"
    if (createType) {
        namedParameterJdbcTemplate.update(formTypeSql, [:])
        logger.info("Создан тип НФ с id = $form_type_id без версии макета, колонок, стилей, заголовка, фиксированных строк и скрипта")
    }

    String formTemplateSql = "INSERT INTO FORM_TEMPLATE (ID, TYPE_ID, FIXED_ROWS, NAME, FULLNAME, VERSION, STATUS, MONTHLY, HEADER, COMPARATIVE, ACCRUING, UPDATING) VALUES " +
            "($form_template_id, '$form_type_id', '$form_template_is_fixed_rows', '$form_template_name', '$form_template_fullname', TO_DATE('$form_template_version', 'DD.MM.RR'), '1', '$form_template_monthly', '$form_template_header', '$form_template_comparative', '$form_template_accruing', '$form_template_updating')"
    if (createTemplate) {
        namedParameterJdbcTemplate.update(formTemplateSql, [:])
        logger.info("Создан тип НФ с id = $form_template_id для версии макета с id = $form_type_id, но без колонок, стилей, заголовка, фиксированных строк и скрипта")
    }
}

def void addLongText (def form_template_id, String longString, String alias) {
    final int MAX_LENGTH = 2000
    namedParameterJdbcTemplate.update("UPDATE FORM_TEMPLATE SET $alias = null where id = $form_template_id", [:])
    int start = 0
    longString = new String(longString.decodeBase64(), "UTF-8")
    while (start < longString.length()) {
        int end = (start + MAX_LENGTH) < longString.length() ? (start + MAX_LENGTH) : longString.length()
        String text = longString.substring(start, end)
       namedParameterJdbcTemplate.update('UPDATE FORM_TEMPLATE SET ' + alias + ' = ' + alias + ' || :text where id = ' +form_template_id, ['text' : text])
        start += MAX_LENGTH
    }
}