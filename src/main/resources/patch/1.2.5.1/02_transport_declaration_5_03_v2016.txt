import com.aplana.sbrf.taxaccounting.model.DeclarationTemplate
import com.aplana.sbrf.taxaccounting.model.DeclarationType
import org.apache.commons.io.IOUtils

/**
 * Создает макет декларации.
 *
 * # Инструкция:
 * Вставить текст данного скрипта на странице, соответствующей ссылке с окончанием:
 * .../gwtapp/#!scriptExecution
 * Нажать "Выполнить".
 */

boolean createType = true
boolean createTemplate = true
boolean addScript = true

try {
    // тип
    DeclarationType type = new DeclarationType()
    type.setId(31)
    type.setName('Декларация по транспортному налогу 5.03')
    type.setTaxType(TaxType.TRANSPORT)
    type.setIsIfrs(false)
    type.setIfrsName('')
    // макет
    DeclarationTemplate template = new DeclarationTemplate()
    template.setId(1031)
    template.setName('Декларация по транспортному налогу 5.03')
    template.setVersion(Date.parse('dd.MM.yyyy', '01.01.2016'))

    def type_id = type.id
    def template_id = template.id

    def rs = namedParameterJdbcTemplate.queryForObject("SELECT count(id) from DECLARATION_TYPE where id = $type_id", [:], Integer.class)
    if (rs == 1) {
        logger.info("Макет декларации с данным id = $type_id уже существует в системе!")
        if (createType) {
            return
        }
    }

    rs = namedParameterJdbcTemplate.queryForObject("SELECT count(id) from DECLARATION_TEMPLATE where id = $template_id", [:], Integer.class)
    if (rs == 1) {
        logger.info("Версия макета декларации с данным id = $template_id уже существует в системе!")
        if (createTemplate) {
            return
        }
    }

    addTypeTemplate(type, template, createType, createTemplate)

    String longString = ''
    if (addScript) {
        longString += 'cGFja2FnZSBmb3JtX3RlbXBsYXRlLnRyYW5zcG9ydC5kZWNsYXJhdGlvbl8xLnYyMDE2DQoNCmltcG9ydCBjb20uYXBsYW5hLnNicmYudGF4YWNjb3VudGluZy5tb2RlbC5Gb3JtRGF0YUV2ZW50DQppbXBvcnQgY29tLmFwbGFuYS5zYnJmLnRheGFjY291bnRpbmcubW9kZWwuVGF4VHlwZQ0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLmxvZy5Mb2dMZXZlbA0KaW1wb3J0IGdyb292eS50cmFuc2Zvcm0uRmllbGQNCmltcG9ydCBncm9vdnkueG1sLk1hcmt1cEJ1aWxkZXINCg0KLyoqDQogKiDQlNC10LrQu9Cw0YDQsNGG0LjRjyDQv9C+INGC0YDQsNC90YHQv9C+0YDRgtC90L7QvNGDINC90LDQu9C+0LPRgyA1LjAzLg0KICoNCiAqIGRlY2xhcmF0aW9uVHlwZUlkID0gMzENCiAqIGRlY2xhcmF0aW9uVGVtcGxhdGVJZCA9IDEwMzENCiAqLw0KDQpzd2l0Y2ggKGZvcm1EYXRhRXZlbnQpIHsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ1JFQVRFOg0KICAgICAgICBjaGVja0RlcGFydG1lbnRQYXJhbXMoTG9nTGV2ZWwuV0FSTklORykNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ0hFQ0s6DQogICAgICAgIGNoZWNrRGVwYXJ0bWVudFBhcmFtcyhMb2dMZXZlbC5FUlJPUikNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuTU9WRV9DUkVBVEVEX1RPX0FDQ0VQVEVEOg0KICAgICAgICBjaGVja0RlcGFydG1lbnRQYXJhbXMoTG9nTGV2ZWwuRVJST1IpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LlBSRV9DQUxDVUxBVElPTl9DSEVDSzoNCiAgICAgICAgY2hlY2tEZXBhcnRtZW50UGFyYW1zKExvZ0xldmVsLkVSUk9SKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5DQUxDVUxBVEU6DQogICAgICAgIGdlbmVyYXRlWE1MKCkNCiAgICAgICAgYnJlYWsNCiAgICBkZWZhdWx0Og0KICAgICAgICByZXR1cm4NCn0NCg0KLy8g0JrRjdGIINC/0YDQvtCy0LDQudC00LXRgNC+0LINCkBGaWVsZA0KZGVmIHByb3ZpZGVyQ2FjaGUgPSBbOl0NCi8vINCa0Y3RiCDQt9C90LDRh9C10L3QuNC5INGB0L/RgNCw0LLQvtGH0L3QuNC60LANCkBGaWVsZA0KZGVmIHJlZkJvb2tDYWNoZSA9IFs6XQ0KQEZpZWxkDQpkZWYgcmVjb3JkQ2FjaGUgPSBbOl0NCg0KLy8g0LfQvdCw0YfQtdC90LjQtSDQv9C+0LTRgNCw0LfQtNC10LvQtdC90LjRjyDQuNC3INGB0L/RgNCw0LLQvtGH0L3QuNC60LAgMzENCkBGaWVsZA0KZGVmIGRlcGFydG1lbnRQYXJhbSA9IG51bGwNCg0KLy8g0LfQvdCw0YfQtdC90LjQtSDQv9C+0LTRgNCw0LfQtNC10LvQtdC90LjRjyDQuNC3INGB0L/RgNCw0LLQvtGH0L3QuNC60LAgMzEwICjRgtCw0LHQu9C40YbQsCkNCkBGaWVsZA0KZGVmIGRlcGFydG1lbnRQYXJhbVRhYmxlID0gbnVsbA0KDQovLyDQlNCw0YLQsCDQvtC60L7QvdGH0LDQvdC40Y8g0L7RgtGH0LXRgtC90L7Qs9C+INC/0LXRgNC40L7QtNCwDQpARmllbGQNCmRlZiByZXBvcnRQZXJpb2RFbmREYXRlID0gbnVsbA0KDQpkZWYgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpIHsNCiAgICBpZiAocmVwb3J0UGVyaW9kRW5kRGF0ZSA9PSBudWxsKSB7DQogICAgICAgIHJlcG9ydFBlcmlvZEVuZERhdGUgPSByZXBvcnRQZXJpb2RTZXJ2aWNlLmdldEVuZERhdGUoZGVjbGFyYXRpb25EYXRhLnJlcG9ydFBlcmlvZElkKT8udGltZQ0KICAgIH0NCiAgICByZXR1cm4gcmVwb3J0UGVyaW9kRW5kRGF0ZQ0KfQ0KDQpkZWYgZ2V0UmVmQm9va1ZhbHVlKGRlZiBsb25nIHJlZkJvb2tJZCwgZGVmIHJlY29yZElkKSB7DQogICAgcmV0dXJuIGZvcm1EYXRhU2VydmljZS5nZXRSZWZCb29rVmFsdWUocmVmQm9va0lkLCByZWNvcmRJZCwgcmVmQm9va0NhY2hlKQ0KfQ0KDQpkZWYgZ2V0UHJvdmlkZXIoZGVmIGxvbmcgcmVmQm9va0lkKSB7DQogICAgcmV0dXJuIGZvcm1EYXRhU2VydmljZS5nZXRSZWZCb29rUHJvdmlkZXIocmVmQm9va0ZhY3RvcnksIHJlZkJvb2tJZCwgcHJvdmlkZXJDYWNoZSkNCn0NCg0KLy8g0J/QvtC40YHQuiDQt9Cw0L/QuNGB0Lgg0LIg0YHQv9GA0LDQstC+0YfQvdC40LrQtSDQv9C+INC30L3QsNGH0LXQvdC40Y4gKNC00LvRjyDRgNCw0YHRh9C10YLQvtCyKQ0KZGVmIGdldFJlY29yZChkZWYgTG9uZyByZWZCb29rSWQsIGRlZiBTdHJpbmcgYWxpYXMsIGRlZiBTdHJpbmcgdmFsdWUsIGRlZiBpbnQgcm93SW5kZXgsIGRlZiBTdHJpbmcgY29sdW1uTmFtZSwNCiAgICAgICAgICAgICAgZGVmIERhdGUgZGF0ZSwgYm9vbGVhbiByZXF1aXJlZCA9IHRydWUpIHsNCiAgICByZXR1cm4gZm9ybURhdGFTZXJ2aWNlLmdldFJlZkJvb2tSZWNvcmQocmVmQm9va0lkLCByZWNvcmRDYWNoZSwgcHJvdmlkZXJDYWNoZSwgcmVmQm9va0NhY2hlLCBhbGlhcywgdmFsdWUsIGRhdGUsDQogICAgICAgICAgICByb3dJbmRleCwgY29sdW1uTmFtZSwgbG9nZ2VyLCByZXF1aXJlZCkNCn0NCg0Kdm9pZCBjaGVja0RlcGFydG1lbnRQYXJhbXMoTG9nTGV2ZWwgbG9nTGV2ZWwpIHsNCiAgICBkZWYgZGVwYXJ0bWVudElkID0gZGVjbGFyYXRpb25EYXRhLmRlcGFydG1lbnRJZA0KDQogICAgLy8g0J/QsNGA0LDQvNC10YLRgNGLINC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPDQogICAgZGVmIGRlcGFydG1lbnRQYXJhbSA9IGdldERlcGFydG1lbnRQYXJhbSgpDQogICAgZGVmIGRlcGFydG1lbnRQYXJhbVRyYW5zcG9ydFJvdyA9IGdldERlcGFydG1lbnRQYXJhbVRhYmxlKGRlcGFydG1lbnRQYXJhbS5yZWNvcmRfaWQudmFsdWUpDQoNCiAgICAvLyDQn9GA0L7QstC10YDQutC4INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPDQogICAgZGVmIExpc3Q8U3RyaW5nPiBlcnJvckxpc3QgPSBnZXRFcnJvckRlcGFydG1lbnQoZGVwYXJ0bWVudFBhcmFtVHJhbnNwb3J0Um93KQ0KICAgIGZvciAoU3RyaW5nIGVycm9yIDogZXJyb3JMaXN0KSB7DQogICAgICAgIGxvZ2dlci5sb2cobG9nTGV2ZWwsIFN0cmluZy5mb3JtYXQoItCU0LvRjyDQv9Cw0YDQsNC80LXRgtGA0L7QsiDRgtC10LrRg9GJ0LXQs9C+INGN0LrQt9C10LzQv9C70Y/RgNCwINC00LXQutC70LDRgNCw0YbQuNC4INC90LAg0YTQvtGA0LzQtSDQvdCw0YHRgtGA0L7QtdC6INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNC5INC+0YLRgdGD0YLRgdGC0LLRg9C10YIg0LfQvdCw0YfQtdC90LjQtSDQsNGC0YDQuNCx0YPRgtCwICVzISIsIGVycm9yKSkNCiAgICB9DQogICAgZXJyb3JMaXN0ID0gZ2V0RXJyb3JUYXhQbGFjZVR5cGVDb2RlKGRlcGFydG1lbnRQYXJhbVRyYW5zcG9ydFJvdykNCiAgICBmb3IgKFN0cmluZyBlcnJvciA6IGVycm9yTGlzdCkgew0KICAgICAgICBsb2dnZXIubG9nKGxvZ0xldmVsLCBTdHJpbmcuZm9ybWF0KCLQlNC70Y8g0L/QsNGA0LDQvNC10YLRgNC+0LIg0YLQtdC60YPRidC10LPQviDRjdC60LfQtdC80L/Qu9GP0YDQsCDQtNC10LrQu9Cw0YDQsNGG0LjQuCDQvdC10LLQtdGA0L3QviDRg9C60LDQt9Cw0L3QviDQt9C90LDRh9C10L3QuNC1INCw0YLRgNC40LHRg9GC0LAgJXMg0L3QsCDRhNC+0YDQvNC1INC90LDRgdGC0YDQvtC10Log0L/QvtC00YDQsNC30LTQtdC70LXQvdC40LkhIiwgZXJyb3IpKQ0KICAgIH0NCiAgICBlcnJvckxpc3QgPSBnZXRFcnJvcklOTihkZXBhcnRtZW50UGFyYW0pDQogICAgZm9yIChTdHJpbmcgZXJyb3IgOiBlcnJvckxpc3QpIHsNCiAgICAgICAgbG9nZ2VyLmxvZyhsb2dMZXZlbCwgU3RyaW5nLmZvcm1hdCgi0JTQu9GPINC00LDQvdC90L7Qs9C+INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPINC90LAg0YTQvtGA0LzQtSDQvdCw0YHRgtGA0L7QtdC6INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNC5INC+0YLRgdGD0YLRgdGC0LLRg9C10YIg0LfQvdCw0YfQtdC90LjQtSDQsNGC0YDQuNCx0YPRgtCwICVzISIsIGVycm9yKSkNCiAgICB9DQoNCiAgICAvLyDQodC/0YDQsNCy0L7Rh9C90LjQuiAi0J/QsNGA0LDQvNC10YLRgNGLINC/0YDQtdC00YHRgtCw0LLQu9C10L3QuNGPINC00LXQutC70LDRgNCw0YbQuNC5INC/0L4g0YLRgNCw0L3RgdC/0L7RgNGC0L3QvtC80YMg0L3QsNC70L7Qs9GDIg0KICAgIGRlZiByZWdpb25JZCA9IGdldFJlZkJvb2tWYWx1ZSgzMEwsIGRlcGFydG1lbnRJZCk/LlJFR0lPTl9JRD8udmFsdWUNCiAgICBpZiAocmVnaW9uSWQgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCLQkNGC0YDQuNCx0YPRgiDCq9Cg0LXQs9C40L7QvcK7INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPINGC0LXQutGD0YnQtdC5INC90LDQu9C+0LPQvtCy0L7QuSDRhNC+0YDQvNGLINC90LUg0LfQsNC/0L7Qu9C90LXQvSAo0YHQv9GA0LDQstC+0YfQvdC40LogwqvQn9C+0LTRgNCw0LfQtNC10LvQtdC90LjRj8K7KSEiKQ0KICAgIH0NCiAgICBkZWYgZmlsdGVyID0gU3RyaW5nLmZvcm1hdCgiREVDTEFSQVRJT05fUkVHSU9OX0lEID0gJXMgYW5kIExPV0VSKFRBWF9PUkdBTl9DT0RFKSA9IExPV0VSKCclcycpIGFuZCBMT1dFUihLUFApID0gTE9XRVIoJyVzJykiLA0KICAgICAgICAgICAgcmVnaW9uSWQsIGRlY2xhcmF0aW9uRGF0YS50YXhPcmdhbkNvZGUsIGRlY2xhcmF0aW9uRGF0YS5rcHApDQogICAgZGVmIHJlY29yZHMgPSByZWZCb29rRmFjdG9yeS5nZXREYXRhUHJvdmlkZXIoMjEwKS5nZXRSZWNvcmRzKGdldFJlcG9ydFBlcmlvZEVuZERhdGUoKSAtIDEsIG51bGwsIGZpbHRlciwgbnVsbCkNCiAgICBpZiAocmVjb3Jkcy5zaXplKCkgPT0gMCkgew0KICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCLQkiDRgdC/0YDQsNCy0L7Rh9C90LjQutC1IMKr0J/QsNGA0LDQvNC10YLRgNGLINC/0YDQtdC00YHRgtCw0LLQu9C10L3QuNGPINC00LXQutC70LDRgNCw0YbQuNC5INC/0L4g0YLRgNCw0L3RgdC/0L7RgNGC0L3QvtC80YMg0L3QsNC70L7Qs9GDwrsg0L7RgtGB0YPRgtGB0YLQstGD0LXRgiDQt9Cw0L/QuNGB0Ywg0L/QviDQstGL0LHRgNCw0L3QvdGL0Lwg0L/QsNGA0LDQvNC10YLRgNCw0Lwg0LTQtdC60LvQsNGA0LDRhtC40LggKNC/0LXRgNC40L7QtCwg0YDQtdCz0LjQvtC9INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPLCDQvdCw0LvQvtCz0L7QstGL0Lkg0L7RgNCz0LDQvSwg0JrQn9CfKSEiKQ0KICAgIH0NCn0NCg0KZGVmIGdlbmVyYXRlWE1MKCkgew0KICAgIGlmICh4bWwgPT0gbnVsbCkgew0KICAgICAgICByZXR1cm4NCiAgICB9DQoNCiAgICAvLyDQv9GA0L7QstC10YDQutCwINC90LDQu9C40YfQuNGPINC40YHRgtC+0YfQvdC40LrQvtCyINCyINGB0YLRg9GC0YPRgdC1INC/0YDQuNC90Y/Rgg0KICAgIGRlZiBmb3JtRGF0YUNvbGxlY3Rpb24gPSBkZWNsYXJhdGlvblNlcnZpY2UuZ2V0QWNjZXB0ZWRGb3JtRGF0YVNvdXJjZXMoZGVjbGFyYXRpb25EYXRhLCB1c2VySW5mbywgbG9nZ2VyKQ0KDQogICAgLyoqINCf0YDQtdC00L/QvtGB0LvQtNC10L3Rj9GPINC00LDRgtCwINC+0YLRh9C10YLQvdC+0LPQviDQv9C10YDQuNC+0LTQsCDQvdCwINC60L7RgtC+0YDRg9GOINC90YPQttC90L4g0L/QvtC70YPRh9C40YLRjCDQvdCw0YHRgtGA0L7QudC60Lgg0L/QvtC00YDQsNC30LTQtdC70LXQvdC40Y8g0LjQtyDRgdC/0YDQsNCy0L7Rh9C90LjQutCwLiAqLw0KICAgIGlmIChnZXRSZXBvcnRQZXJpb2RFbmREYXRlKCkgPT0gbnVsbCkgew0KICAgICAgICBsb2dnZXIuZXJyb3IoItCe0YjQuNCx0LrQsCDQvtC/0YDQtdC00LXQu9C10L3QuNGPINC00LDRgtGLINC60L7QvdGG0LAg0L7RgtGH0LXRgtC90L7Qs9C+INC/0LXRgNC40L7QtNCwIikNCiAgICB9DQoNCiAgICAvLyDQn9C+0LvRg9GH0LjRgtGMINC/0LDRgNCw0LzQtdGC0YDRiyDQv9C+INGC0YDQsNC90YHQv9C+0YDRgtC90L7QvNGDINC90LDQu9C+0LPRgw0KICAgIGRlZiBkZXBhcnRtZW50UGFyYW0gPSBnZXREZXBhcnRtZW50UGFyYW0oKQ0KICAgIGRlZiBkZXBhcnRtZW50UGFyYW1Sb3cgPSBnZXREZXBhcnRtZW50UGFyYW1UYWJsZShkZXBhcnRtZW50UGFyYW0/LnJlY29yZF9pZD8udmFsdWUpDQoNCiAgICBkZWYgcmVvcmdGb3JtQ29kZSA9IGdldFJlZkJvb2tWYWx1ZSg1TCwgZGVwYXJ0bWVudFBhcmFtUm93Py5SRU9SR19GT1JNX0NPREU/LnJlZmVyZW5jZVZhbHVlKT8uQ09ERT8uc3RyaW5nVmFsdWUNCiAgICBkZWYgb2t2ZWRDb2RlID0gZ2V0UmVmQm9va1ZhbHVlKDM0TCwgZGVwYXJ0bWVudFBhcmFtUm93Py5PS1ZFRF9DT0RFPy5yZWZlcmVuY2VWYWx1ZSk/LkNPREU/LnN0cmluZ1ZhbHVlDQogICAgZGVmIHNpZ25hdG9yeUlkID0gZ2V0UmVmQm9va1ZhbHVlKDM1TCwgZGVwYXJ0bWVudFBhcmFtUm93Py5TSUdOQVRPUllfSUQ/LnJlZmVyZW5jZVZhbHVlKT8uQ09ERT8ubnVtYmVyVmFsdWUNCiAgICBkZWYgdGF4UGxhY2VUeXBlQ29kZSA9IGdldFJlZkJvb2tWYWx1ZSgyTCwgZGVwYXJ0bWVudFBhcmFtUm93Py5UQVhfUExBQ0VfVFlQRV9DT0RFPy5yZWZlcmVuY2VWYWx1ZSk/LkNPREU/LnN0cmluZ1ZhbHVlDQogICAgZGVmIGFwcHJvdmVEb2NOYW1lID0gZGVwYXJ0bWVudFBhcmFtUm93Py5BUFBST1ZFX0RPQ19OQU1FPy52YWx1ZQ0KICAgIGRlZiBhcHByb3ZlT3JnTmFtZSA9IGRlcGFydG1lbnRQYXJhbVJvdz8uQVBQUk9WRV9PUkdfTkFNRT8udmFsdWUNCg0KICAgIGRlZiByZXBvcnRQZXJpb2QgPSByZXBvcnRQZXJpb2RTZXJ2aWNlLmdldChkZWNsYXJhdGlvbkRhdGEucmVwb3J0UGVyaW9kSWQpDQoNCiAgICAvLyDQstGB0LUg0YHRgtGA0L7QutC4INGB0LLQvtC00L3Ri9GFLdC40YHRgtC+0YfQvdC40LrQvtCyDQogICAgZGVmIGRhdGFSb3dzID0gZ2V0RGF0YVJvd3MoZm9ybURhdGFDb2xsZWN0aW9uLCAyMDApDQogICAgLy8g0L/QvtC00LjRgtC+0LPQvtCy0YvQtSDRgdGC0YDQvtC60LgNCiAgICBkZWYgdG90YWxSb3dzID0gZGF0YVJvd3MuZmluZEFsbCB7IHJvdyAtPg0KICAgICAgICBkZWYgcmVjb3JkMjEwID0gZ2V0UmVmQm9va1ZhbHVlKDIxMEwsIHJvdy5rbm8pDQogICAgICAgIGRlZiBrbm8gPSByZWNvcmQyMTA/LlRBWF9PUkdBTl9DT0RFPy52YWx1ZQ0KICAgICAgICBkZWYga3BwID0gcmVjb3JkMjEwPy5LUFA/LnZhbHVlDQogICAgICAgIHJldHVybiAocm93LmdldEFsaWFzKCk/LnN0YXJ0c1dpdGgoInRvdGFsMiIpICYmIGtubyA9PSBkZWNsYXJhdGlvbkRhdGEudGF4T3JnYW5Db2RlICYmIGtwcCA9PSBkZWNsYXJhdGlvbkRhdGEua3BwKQ0KICAgIH0NCiAgICAvLyDQvNCw0L/QsCDRgdC+INGB0LPRgNGD0L/Qv9C40YDQvtCy0LDQvdC90YvQvNC4INGB0YLRgNC+0LrQsNC80LggKNC/0L7QtNC40YLQvtCz0L7QstCw0Y8g0YHRgtGA0L7QutCwIC0+INC/0YDQvtGB0YLRi9C1INGB0YLRgNC+0LrQuCkNCiAgICBkZWYgZGF0YVJvd3NNYXAgPSBbOl0NCiAgICB0b3RhbFJvd3MuZWFjaCB7IHRvdGFsUm93IC0+DQogICAgICAgIGRlZiByb3dzID0gZGF0YVJvd3MuZmluZEFsbCB7IHJvdyAtPg0KICAgICAgICAgICAgZGVmIHJlY29yZDIxMCA9IGdldFJlZkJvb2tWYWx1ZSgyMTBMLCByb3cua25vKQ0KICAgICAgICAgICAgZGVmIHJvd0tubyA9IHJlY29yZDIxMD8uVEFYX09SR0FOX0NPREU/LnZhbHVlDQogICAgICAgICAgICBkZWYgcm93S3BwID0gcmVjb3JkMjEwPy5LUFA/LnZhbHVlDQoNCiAgICAgICAgICAgIHJlY29yZDIxMCA9IGdldFJlZkJvb2tWYWx1ZSgyMTBMLCB0b3RhbFJvdy5rbm8pDQogICAgICAgICAgICBkZWYgdG90YWxSb3dLbm8gPSByZWNvcmQyMTA/LlRBWF9PUkdBTl9DT0RFPy52YWx1ZQ0KICAgICAgICAgICAgZGVmIHRvdGFsUm93S3BwID0gcmVjb3JkMjEwPy5LUFA/LnZhbHVlDQoNCiAgICAgICAgICAgIHJldHVybiAocm93LmdldEFsaWFzKCkgPT0gbnVsbCAmJiByb3dLbm8gPT0gdG90YWxSb3dLbm8gJiYgcm93S3BwID09IHRvdGFsUm93S3BwICYmIHJvdy5va2F0byA9PSB0b3RhbFJvdy5va2F0bykNCiAgICAgICAgfQ0KICAgICAgICBkYXRhUm93c01hcC5wdXQodG90YWxSb3csIHJvd3MpDQogICAgfQ0KDQogICAgZGVmIGJ1aWxkZXIgPSBuZXcgTWFya3VwQnVpbGRlcih4bWwpDQogICAgYnVpbGRlci7QpNCw0LnQuygNCiAgICAgICAgICAgINCY0LTQpNCw0LnQuyAgIDogZ2VuZXJhdGVYbWxGaWxlSWQoKSwNCiAgICAgICAgICAgINCS0LXRgNGB0J/RgNC+0LMgOiBhcHBsaWNhdGlvblZlcnNpb24sDQogICAgICAgICAgICDQktC10YDRgdCk0L7RgNC8IDogJzUuMDMnKSB7DQoNCiAgICAgICAgLy8g0KLQuNGC0YPQu9GM0L3Ri9C5INC70LjRgdGCDQogICAgICAgINCU0L7QutGD0LzQtdC90YIoDQogICAgICAgICAgICAgICAg0JrQndCUICAgICAgOiAiMTE1MjAwNCIsDQogICAgICAgICAgICAgICAg0JTQsNGC0LDQlNC+0LogIDogKGRvY0RhdGUgIT0gbnVsbCA/IGRvY0RhdGUgOiBuZXcgRGF0ZSgpKS5mb3JtYXQoImRkLk1NLnl5eXkiKSwNCiAgICAgICAgICAgICAgICDQn9C10YDQuNC+0LQgICA6IHJlb3JnRm9ybUNvZGUgPyA1MCA6IDM0LA0KICAgICAgICAgICAgICAgINCe0YLRh9C10YLQk9C+0LQgOiByZXBvcnRQZXJpb2QudGF4UGVyaW9kLnllYXIsDQogICAgICAgICAgICAgICAg0JrQvtC00J3QniAgICA6IGRlY2xhcmF0aW9uRGF0YS50YXhPcmdhbkNvZGUsDQogICAgICAgICAgICAgICAg0J3QvtC80JrQvtGA0YAgIDogcmVwb3J0UGVyaW9kU2VydmljZS5nZXRDb3JyZWN0aW9uTnVtYmVyKGRlY2xhcmF0aW9uRGF0YS5kZXBhcnRtZW50UmVwb3J0UGVyaW9kSWQpLA0KICAgICAgICAgICAgICAgINCf0L7QnNC10YHRgtGDICA6IHRheFBsYWNlVHlwZUNvZGUNCiAgICAgICAgKSB7DQogICAgICAgICAgICBkZWYgc3ZucCA9IFvQntCa0JLQrdCUIDogb2t2ZWRDb2RlXQ0KICAgICAgICAgICAgZGVmIHBob25lID0gZGVwYXJ0bWVudFBhcmFtUm93Py5QSE9ORT8udmFsdWUNCiAgICAgICAgICAgIGlmIChkZXBhcnRtZW50UGFyYW1Sb3c/Lk9LVkVEX0NPREU/LnZhbHVlICYmIChwaG9uZSAhPSBudWxsKSAmJiAhKHBob25lLmlzRW1wdHkoKSkpIHsNCiAgICAgICAgICAgICAgICBzdm5wLtCi0LvRhCA9IHBob25lDQogICAgICAgICAgICB9DQogICAgICAgICAgICDQodCy0J3Qnyhzdm5wKSB7DQogICAgICAgICAgICAgICAg0J3Qn9Cu0JsoDQogICAgICAgICAgICAgICAgICAgICAgICDQndCw0LjQvNCe0YDQsyA6IGRlcGFydG1lbnRQYXJhbVJvdz8uTkFNRT8udmFsdWUsDQogICAgICAgICAgICAgICAgICAgICAgICDQmNCd0J3QrtCbICAgOiBkZXBhcnRtZW50UGFyYW0/LklOTj8udmFsdWUsDQogICAgICAgICAgICAgICAgICAgICAgICDQmtCf0J8gICAgIDogZGVjbGFyYXRpb25EYXRhLmtwcCkgew0KDQogICAgICAgICAgICAgICAgICAgIGlmIChyZW9yZ0Zvcm1Db2RlICE9IG51bGwgJiYgIXJlb3JnRm9ybUNvZGUuZXF1YWxzKCIiKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAg0KHQstCg0LXQvtGA0LPQrtCbKFvQpNC+0YDQvNCg0LXQvtGA0LMgOiByZW9yZ0Zvcm1Db2RlXSArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChJbnRlZ2VyLnBhcnNlSW50KHJlb3JnRm9ybUNvZGUpIGluIFsxLCAyLCAzLCA1LCA2XSA/DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBb0JjQndCd0K7QmyA6IGRlcGFydG1lbnRQYXJhbVJvdz8uUkVPUkdfSU5OPy52YWx1ZSwg0JrQn9CfIDogZGVwYXJ0bWVudFBhcmFtUm93Py5SRU9SR19LUFA/LnZhbHVlXSA6IFs6XSkNCiAgICAgICAgICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAg0J/QvtC00L/QuNGB0LDQvdGCKNCf0YDQn9C+0LTQvyA6IHNpZ25hdG9yeUlkKSB7DQogICAgICAgICAgICAgICAg0KTQmNCeKA0KICAgICAgICAgICAgICAgICAgICAgICAg0KTQsNC80LjQu9C40Y8gIDogZGVwYXJ0bWVudFBhcmFtUm93Py5TSUdOQVRPUllfU1VSTkFNRT8udmFsdWUsDQogICAgICAgICAgICAgICAgICAgICAgICDQmNC80Y8gICAgICA6IGRlcGFydG1lbnRQYXJhbVJvdz8uU0lHTkFUT1JZX0ZJUlNUTkFNRT8udmFsdWUsDQogICAgICAgICAgICAgICAgICAgICAgICDQntGC0YfQtdGB0YLQstC+IDogZGVwYXJ0bWVudFBhcmFtUm93Py5TSUdOQVRPUllfTEFTVE5BTUU/LnZhbHVlDQogICAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgICAgIC8vINCh0LLQn9GA0LXQtCAtINCh0LLQtdC00LXQvdC40Y8g0L4g0L/RgNC10LTRgdGC0LDQstC40YLQtdC70LUg0L3QsNC70L7Qs9C+0L/Qu9Cw0YLQtdC70YzRidC40LrQsA0KICAgICAgICAgICAgICAgIGlmIChzaWduYXRvcnlJZCA9PSAyKSB7DQogICAgICAgICAgICAgICAgICAgINCh0LLQn9GA0LXQtCgNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBb0J3QsNC40LzQlNC+0LogOiBhcHByb3ZlRG9jTmFtZV0gKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGFwcHJvdmVPcmdOYW1lID8gW9Cd0LDQuNC80J7RgNCzIDogYXBwcm92ZU9yZ05hbWVdIDogWzpdKQ0KDQogICAgICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICAvLyDQotC40YLRg9C70YzQvdGL0Lkg0LvQuNGB0YIgLSDQutC+0L3QtdGGDQoNCiAgICAgICAgICAgIC8vINCg0LDQt9C00LXQuyAxDQogICAgICAgICAgICDQotGA0J3QsNC70J3QlCgpIHsNCiAgICAgICAgICAgICAgICDQodGD0LzQndCw0LvQn9CjKNCa0JHQmiA6ICIxODIxMDYwNDAxMTAyMTAwMDExMCIpIHsNCiAgICAgICAgICAgICAgICAgICAgZGF0YVJvd3NNYXAuZWFjaCB7IHRvdGFsUm93LCBncm91cFJvd3MgLT4NCiAgICAgICAgICAgICAgICAgICAgICAgINCh0YPQvNCf0KMoDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCe0JrQotCc0J4gICAgIDogZ2V0UmVmQm9va1ZhbHVlKDk2TCwgdG90YWxSb3cub2thdG8pPy5DT0RFPy52YWx1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0J3QsNC70JjRgdGH0LjRgdC7IDogZ2V0TG9uZyh0b3RhbFJvdy50YXhTdW1Ub1BheSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCQ0LLQn9Cj0JrQsjEgICA6IGdldExvbmcodG90YWxSb3cucTEpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICDQkNCy0J/Qo9Ca0LIyICAgOiBnZXRMb25nKHRvdGFsUm93LnEyKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0JDQstCf0KPQmtCyMyAgIDogZ2V0TG9uZyh0b3RhbFJvdy5xMyksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCd0LDQu9Cf0KMgICAgIDogZ2V0TG9uZyh0b3RhbFJvdy5xNCkNCiAgICAgICAgICAgICAgICAgICAgICAgICkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vINCg0LDQt9C00LXQuyAxIC0g0LrQvtC90LXRhg0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g0KDQsNC30LTQtdC7IDINCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cFJvd3MuZWFjaCB7IHJvdyAtPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICDQoNCw0YHRh9Cd0LDQu9Ci0KEoDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0JrQvtC00JLQuNC00KLQoSAgOiBnZXRSZWZCb29rVmFsdWUoNDJMLCByb3cudHNUeXBlQ29kZSk/LkNPREU/LnN0cmluZ1ZhbHVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0JjQtNCd0L7QvNCi0KEgICA6IHJvdy52aSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCc0LDRgNC60LDQotChICAgOiByb3cubW9kZWwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICDQoNC10LPQl9C90LDQutCi0KEgOiByb3cucmVnTnVtYmVyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0gKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW9Cd0LDQu9CR0LDQt9CwICA6IHJvdy50YXhCYXNlXSArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBb0J7QmtCV0JjQndCw0LvQkdCw0LfQsCA6IGdldFJlZkJvb2tWYWx1ZSgxMkwsIHJvdy50YXhCYXNlT2tlaVVuaXQpPy5DT0RFPy5zdHJpbmdWYWx1ZV0gKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHJvdy5lY29DbGFzcyA/IFvQrdC60L7Qu9C+0LPQmtC7IDogZ2V0UmVmQm9va1ZhbHVlKDQwTCwgcm93LmVjb0NsYXNzKT8uQ09ERT8ubnVtYmVyVmFsdWVdIDogWzpdKSArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCS0YvQv9GD0YHQutCi0KEgOiByb3cueWVhcnMsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCS0LvQsNC00LXQvdCi0KEgOiByb3cub3duTW9udGhzLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICDQlNC+0LvRj9Ci0KEgICA6IHJvdy5wYXJ0UmlnaHQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCa0L7RjdGE0JrQsiAgIDogcm93LmNvZWZLdg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBb0J3QsNC70KHRgtCw0LLQutCwIDogZ2V0UmVmQm9va1ZhbHVlKDQxTCwgcm93LnRheFJhdGUpPy5WQUxVRT8ubnVtYmVyVmFsdWVdICsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChyb3cuY29lZktwID8gW9Ca0L7RjdGE0JrQvzogcm93LmNvZWZLcF0gOiBbOl0pICsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFvQodGD0LzQmNGB0YfQuNGB0LsgOiBnZXRMb25nKHJvdy5jYWxjdWxhdGVkVGF4U3VtKV0gKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHJvdy5iZW5lZml0TW9udGhzID8gW9Cb0YzQs9C+0YLQnNC10YHQotChIDogcm93LmJlbmVmaXRNb250aHNdIDogWzpdKSArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBb0KHRg9C80JjRgdGH0LjRgdC70KPQv9C7IDogZ2V0TG9uZyhyb3cudGF4U3VtVG9QYXkpXSArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocm93LmNvZWZLbCAhPSBudWxsID8gW9Ca0L7RjdGE0JrQuyA6IHJvdy5jb2VmS2xdIDogWzpdKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWYgcmVjb3JkNyA9IGdldFJlZkJvb2tWYWx1ZSg3TCwgcm93LnRheEJlbmVmaXRDb2RlKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmIGNvZGUgPSBnZXRSZWZCb29rVmFsdWUoNkwsIHJlY29yZDc/LlRBWF9CRU5FRklUX0lEPy52YWx1ZSk/LkNPREU/LnZhbHVlDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWYgYmFzZSA9IHJlY29yZDc/LkJBU0U/LnZhbHVlDQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vINCa0L7QtCDQvdCw0LvQvtCz0L7QstC+0Lkg0LvRjNCz0L7RgtGLINCyINCy0LjQtNC1INC+0YHQstC+0LHQvtC20LTQtdC90LjRjyDQvtGCINC90LDQu9C+0LPQvtC+0LHQu9C+0LbQtdC90LjRjw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvZGUgIT0gbnVsbCAmJiAoY29kZS5lcXVhbHMoJzMwMjAwJykgfHwgY29kZS5lcXVhbHMoJzIwMjAwJykgfHwgY29kZS5lcXVhbHMoJzIwMjEwJykpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g0LLRi9GH0LjRgdC70LXQvdC40LUg0JrQvtC00J7RgdCy0J3QsNC7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmIHZhbEwgPSBjb2RlDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmIHZhbFggPSAiIg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsTC5lcXVhbHMoIjMwMjAwIikpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsWCA9IGJhc2UNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmIGtvZE9zbk5hbCA9ICh2YWxMICE9ICIiID8gdmFsTC50b1N0cmluZygpIDogIjAwMDAiKSArICh2YWxYICE9ICcnID8gIi8iICsgdmFsWCA6ICcnKQ0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0JvRjNCz0L7RgtCe0YHQstCd0LDQuygNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCa0L7QtNCe0YHQstCd0LDQuzoga29kT3NuTmFsLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0KHRg9C80J7RgdCy0J3QsNC7OiBnZXRMb25nKHJvdy50YXhCZW5lZml0U3VtKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g0JrQvtC0INC90LDQu9C+0LPQvtCy0L7QuSDQu9GM0LPQvtGC0Ysg0LIg0LLQuNC00LUg0YPQvNC10L3RjNGI0LXQvdC40Y8g0YHRg9C80LzRiyDQvdCw0LvQvtCz0LANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2RlICE9IG51bGwgJiYgY29kZS5lcXVhbHMoIjIwMjIwIikpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyDQstGL0YfQuNGB0LvQtdC90LjQtSDQmtC+0LTQo9C80LXQvdCh0YPQvA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZiB2YWxMID0gY29kZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZiB2YWxYID0gYmFzZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZiBrb2RVbWVuU3VtID0gKHZhbEwgIT0gIiIgPyB2YWxMLnRvU3RyaW5nKCkgOiAiMDAwMCIpICsgIi8iICsgdmFsWA0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0JvRjNCz0L7RgtCj0LzQtdC90KHRg9C8KA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0JrQvtC00KPQvNC10L3QodGD0LwgOiBrb2RVbWVuU3VtLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0KHRg9C80KPQvNC10L3QodGD0LwgOiBnZXRMb25nKHJvdy50YXhCZW5lZml0U3VtKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g0JrQvtC0INC90LDQu9C+0LPQvtCy0L7QuSDQu9GM0LPQvtGC0Ysg0LIg0LLQuNC00LUg0YHQvdC40LbQtdC90LjRjyDQvdCw0LvQvtCz0L7QstC+0Lkg0YHRgtCw0LLQutC4DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29kZSAhPSBudWxsICYmIGNvZGUuZXF1YWxzKCIyMDIzMCIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g0LLRi9GH0LjRgdC70LXQvdC40LUg0JrQvtC00KHQvdC40LbQodGC0LDQsg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZiB2YWxMID0gY29kZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZiB2YWxYID0gYmFzZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZiBrb2ROaXpoU3RhdiA9ICh2YWxMICE9ICIiID8gdmFsTC50b1N0cmluZygpIDogIjAwMDAiKSArICIvIiArIHZhbFgNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgINCb0YzQs9C+0YLQodC90LjQttCh0YLQsNCyKA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0JrQvtC00KHQvdC40LbQodGC0LDQsiA6IGtvZE5pemhTdGF2LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg0KHRg9C80KHQvdC40LbQodGC0LDQsiA6IGdldExvbmcocm93LnRheEJlbmVmaXRTdW0pDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vINCg0LDQt9C00LXQuyAyIC0g0LrQvtC90LXRhg0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KfQ0KDQovKiog0J/QvtC70YPRh9C40YLRjCDRgdGC0YDQvtC60Lgg0YTQvtGA0LzRiy4gKi8NCmRlZiBnZXREYXRhUm93cyhkZWYgZm9ybURhdGFDb2xsZWN0aW9uLCBkZWYgZm9ybVR5cGVJZCkgew0KICAgIGRlZiBmb3JtTGlzdCA9IGZvcm1EYXRhQ29sbGVjdGlvbi5yZWNvcmRzLmZpbmRBbGwgeyBpdC5nZXRGb3JtVHlwZSgpLmdldElkKCkgPT0gZm9ybVR5cGVJZCB9DQogICAgZGVmIGRhdGFSb3dzID0gW10NCiAgICBmb3IgKGRlZiBmb3JtIDogZm9ybUxpc3QpIHsNCiAgICAgICAgZGF0YVJvd3MgKz0gKGZvcm1EYXRhU2VydmljZS5nZXREYXRhUm93SGVscGVyKGZvcm0pPy5nZXRBbGwoKSA/OiBbXSkNCiAgICB9DQogICAgcmV0dXJuIGRhdGFSb3dzLmlzRW1wdHkoKSA/IG51bGwgOiBkYXRhUm93cw0KfQ0KDQpMaXN0PFN0cmluZz4gZ2V0RXJyb3JEZXBhcnRtZW50KGRlZiByZWNvcmQpIHsNCiAgICBMaXN0PFN0cmluZz4gZXJyb3JMaXN0ID0gbmV3IEFycmF5TGlzdDxTdHJpbmc+KCkNCiAgICBpZiAocmVjb3JkLk5BTUU/LnN0cmluZ1ZhbHVlID09IG51bGwgfHwgcmVjb3JkLk5BTUUuc3RyaW5nVmFsdWUuaXNFbXB0eSgpKSB7DQogICAgICAgIGVycm9yTGlzdC5hZGQoIsKr0J3QsNC40LzQtdC90L7QstCw0L3QuNC1INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPwrsiKQ0KICAgIH0NCiAgICBpZiAocmVjb3JkLktQUD8uc3RyaW5nVmFsdWUgPT0gbnVsbCB8fCByZWNvcmQuS1BQLnN0cmluZ1ZhbHVlLmlzRW1wdHkoKSkgew0KICAgICAgICBlcnJvckxpc3QuYWRkKCLCq9Ca0J/Qn8K7IikNCiAgICB9DQogICAgaWYgKHJlY29yZC5UQVhfT1JHQU5fQ09ERT8uc3RyaW5nVmFsdWUgPT0gbnVsbCB8fCByZWNvcmQuVEFYX09SR0FOX0NPREUuc3RyaW5nVmFsdWUuaXNFbXB0eSgpKSB7DQogICAgICAgIGVycm9yTGlzdC5hZGQoIsKr0JrQvtC0INC90LDQu9C+0LPQvtCy0L7Qs9C+INC+0YDQs9Cw0L3QsMK7IikNCiAgICB9DQogICAgaWYgKHJlY29yZC5PS1ZFRF9DT0RFPy5yZWZlcmVuY2VWYWx1ZSA9PSBudWxsKSB7DQogICAgICAgIGVycm9yTGlzdC5hZGQoIsKr0JrQvtC0INCy0LjQtNCwINGN0LrQvtC90L7QvNC40YfQtdGB0LrQvtC5INC00LXRj9GC0LXQu9GM0L3QvtGB0YLQuCDQuCDQv9C+INC60LvQsNGB0YHQuNGE0LjQutCw0YLQvtGA0YMg0J7QmtCS0K3QlMK7IikNCiAgICB9DQogICAgZGVmIHJlb3JnRm9ybUNvZGUgPSBnZXRSZWZCb29rVmFsdWUoNUwsIHJlY29yZD8uUkVPUkdfRk9STV9DT0RFPy5yZWZlcmVuY2VWYWx1ZSk/LkNPREU/LnN0cmluZ1ZhbHVlDQogICAgaWYgKHJlb3JnRm9ybUNvZGUgIT0gbnVsbCAmJiAhcmVvcmdGb3JtQ29kZS5lcXVhbHMoIiIpICYmIEludGVnZXIucGFyc2VJbnQocmVvcmdGb3JtQ29kZSkgaW4gWzEsIDIsIDMsIDUsIDZdKSB7DQogICAgICAgIGlmIChyZWNvcmQuUkVPUkdfSU5OPy5zdHJpbmdWYWx1ZSA9PSBudWxsIHx8IHJlY29yZC5SRU9SR19JTk4uc3RyaW5nVmFsdWUuaXNFbXB0eSgpKSB7DQogICAgICAgICAgICBlcnJvckxpc3QuYWRkKCLCq9CY0J3QnSDRgNC10L7RgNCz0LDQvdC40LfQvtCy0LDQvdC90L7Qs9C+INC+0LHQvtGB0L7QsdC70LXQvdC90L7Qs9C+INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPwrsiKQ0KICAgICAgICB9DQogICAgICAgIGlmIChyZWNvcmQuUkVPUkdfS1BQPy5zdHJpbmdWYWx1ZSA9PSBudWxsIHx8IHJlY29yZC5SRU9SR19LUFAuc3RyaW5nVmFsdWUuaXNFbXB0eSgpKSB7DQogICAgICAgICAgICBlcnJvckxpc3QuYWRkKCLCq9Ca0J/QnyDRgNC10L7RgNCz0LDQvdC40LfQvtCy0LDQvdC90L7Qs9C+INC+0LHQvtGB0L7QsdC70LXQvdC90L7Qs9C+INC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPwrsi'
        longString += 'KQ0KICAgICAgICB9DQogICAgfQ0KICAgIGlmIChyZWNvcmQuU0lHTkFUT1JZX0lEPy5yZWZlcmVuY2VWYWx1ZSA9PSBudWxsKSB7DQogICAgICAgIGVycm9yTGlzdC5hZGQoIsKr0J/RgNC40LfQvdCw0Log0LvQuNGG0LAg0L/QvtC00L/QuNGB0LDQstGI0LXQs9C+INC00L7QutGD0LzQtdC90YLCuyIpDQogICAgfQ0KICAgIGlmIChyZWNvcmQuU0lHTkFUT1JZX1NVUk5BTUU/LnN0cmluZ1ZhbHVlID09IG51bGwgfHwgcmVjb3JkLlNJR05BVE9SWV9TVVJOQU1FLnN0cmluZ1ZhbHVlLmlzRW1wdHkoKSkgew0KICAgICAgICBlcnJvckxpc3QuYWRkKCLCq9Ck0LDQvNC40LvQuNGPINC/0L7QtNC/0LjRgdCw0L3RgtCwwrsiKQ0KICAgIH0NCiAgICBpZiAocmVjb3JkLlNJR05BVE9SWV9GSVJTVE5BTUU/LnN0cmluZ1ZhbHVlID09IG51bGwgfHwgcmVjb3JkLlNJR05BVE9SWV9GSVJTVE5BTUUuc3RyaW5nVmFsdWUuaXNFbXB0eSgpKSB7DQogICAgICAgIGVycm9yTGlzdC5hZGQoIsKr0JjQvNGPINC/0L7QtNC/0LjRgdCw0L3RgtCwwrsiKQ0KICAgIH0NCiAgICBkZWYgc2lnbmF0b3J5SWQgPSBnZXRSZWZCb29rVmFsdWUoMzVMLCByZWNvcmQ/LlNJR05BVE9SWV9JRD8ucmVmZXJlbmNlVmFsdWUpPy5DT0RFPy5udW1iZXJWYWx1ZQ0KICAgIGlmIChzaWduYXRvcnlJZCAhPSBudWxsICYmIHNpZ25hdG9yeUlkICE9IDEpIHsNCiAgICAgICAgaWYgKHJlY29yZC5BUFBST1ZFX0RPQ19OQU1FPy5zdHJpbmdWYWx1ZSA9PSBudWxsIHx8IHJlY29yZC5BUFBST1ZFX0RPQ19OQU1FLnN0cmluZ1ZhbHVlLmlzRW1wdHkoKSkgew0KICAgICAgICAgICAgZXJyb3JMaXN0LmFkZCgiwqvQndCw0LjQvNC10L3QvtCy0LDQvdC40LUg0LTQvtC60YPQvNC10L3RgtCwLCDQv9C+0LTRgtCy0LXRgNC20LTQsNGO0YnQtdCz0L4g0L/QvtC70L3QvtC80L7Rh9C40Y8g0L/RgNC10LTRgdGC0LDQstC40YLQtdC70Y/CuyIpDQogICAgICAgIH0NCiAgICB9DQogICAgaWYgKHJlY29yZC5UQVhfT1JHQU5fQ09ERV9QUk9NPy52YWx1ZSA9PSBudWxsIHx8IHJlY29yZC5UQVhfT1JHQU5fQ09ERV9QUk9NLnZhbHVlLmlzRW1wdHkoKSkgew0KICAgICAgICBlcnJvckxpc3QuYWRkKCLCq9Ca0L7QtCDQvdCw0LvQvtCz0L7QstC+0LPQviDQvtGA0LPQsNC90LAgKNC/0YDQvtC8LinCuyIpDQogICAgfQ0KICAgIGVycm9yTGlzdA0KfQ0KDQpMaXN0PFN0cmluZz4gZ2V0RXJyb3JUYXhQbGFjZVR5cGVDb2RlKGRlZiByZWNvcmQpIHsNCiAgICBMaXN0PFN0cmluZz4gZXJyb3JMaXN0ID0gbmV3IEFycmF5TGlzdDxTdHJpbmc+KCkNCiAgICBkZWYgY29kZSA9IHJlY29yZC5UQVhfUExBQ0VfVFlQRV9DT0RFPy5yZWZlcmVuY2VWYWx1ZQ0KICAgIGlmIChjb2RlID09IG51bGwgfHwgIShnZXRSZWZCb29rVmFsdWUoMkwsIGNvZGUpPy5DT0RFPy5zdHJpbmdWYWx1ZSBpbiBbJzIxMycsICcyMTYnLCAnMjYwJ10pKSB7DQogICAgICAgIGVycm9yTGlzdC5hZGQoIsKr0JrQvtC0INC80LXRgdGC0LAsINC/0L4g0LrQvtGC0L7RgNC+0LzRgyDQv9GA0LXQtNGB0YLQsNCy0LvRj9C10YLRgdGPINC00L7QutGD0LzQtdC90YLCuyIpDQogICAgfQ0KICAgIGVycm9yTGlzdA0KfQ0KDQpMaXN0PFN0cmluZz4gZ2V0RXJyb3JJTk4ocmVjb3JkKSB7DQogICAgTGlzdDxTdHJpbmc+IGVycm9yTGlzdCA9IG5ldyBBcnJheUxpc3Q8U3RyaW5nPigpDQogICAgaWYgKHJlY29yZC5JTk4gPT0gbnVsbCB8fCByZWNvcmQuSU5OLnN0cmluZ1ZhbHVlID09IG51bGwgfHwgcmVjb3JkLklOTi5zdHJpbmdWYWx1ZS5pc0VtcHR5KCkpIHsNCiAgICAgICAgZXJyb3JMaXN0LmFkZCgiwqvQmNCd0J3CuyIpDQogICAgfQ0KICAgIGVycm9yTGlzdA0KfQ0KDQovLyDQn9C+0LvRg9GH0LjRgtGMINC/0LDRgNCw0LzQtdGC0YDRiyDQv9C+0LTRgNCw0LfQtNC10LvQtdC90LjRjyAo0LjQtyDRgdC/0YDQsNCy0L7Rh9C90LjQutCwIDMxKQ0KZGVmIGdldERlcGFydG1lbnRQYXJhbSgpIHsNCiAgICBpZiAoZGVwYXJ0bWVudFBhcmFtID09IG51bGwpIHsNCiAgICAgICAgZGVmIGRlcGFydG1lbnRJZCA9IGRlY2xhcmF0aW9uRGF0YS5kZXBhcnRtZW50SWQNCiAgICAgICAgZGVmIGRlcGFydG1lbnRQYXJhbUxpc3QgPSBnZXRQcm92aWRlcigzMUwpLmdldFJlY29yZHMoZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpIC0gMSwgbnVsbCwgIkRFUEFSVE1FTlRfSUQgPSAkZGVwYXJ0bWVudElkIiwgbnVsbCkNCiAgICAgICAgaWYgKGRlcGFydG1lbnRQYXJhbUxpc3QgPT0gbnVsbCB8fCBkZXBhcnRtZW50UGFyYW1MaXN0LnNpemUoKSA9PSAwIHx8IGRlcGFydG1lbnRQYXJhbUxpc3QuZ2V0KDApID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oItCe0YjQuNCx0LrQsCDQv9GA0Lgg0L/QvtC70YPRh9C10L3QuNC4INC90LDRgdGC0YDQvtC10Log0L7QsdC+0YHQvtCx0LvQtdC90L3QvtCz0L4g0L/QvtC00YDQsNC30LTQtdC70LXQvdC40Y8uINCd0LDRgdGC0YDQvtC50LrQuCDQv9C+0LTRgNCw0LfQtNC10LvQtdC90LjRjyDQt9Cw0L/QvtC70L3QtdC90Ysg0L3QtSDQv9C+0LvQvdC+0YHRgtGM0Y4iKQ0KICAgICAgICB9DQogICAgICAgIGRlcGFydG1lbnRQYXJhbSA9IGRlcGFydG1lbnRQYXJhbUxpc3Q/LmdldCgwKQ0KICAgIH0NCiAgICByZXR1cm4gZGVwYXJ0bWVudFBhcmFtDQp9DQoNCi8vINCf0L7Qu9GD0YfQuNGC0Ywg0L/QsNGA0LDQvNC10YLRgNGLINC/0L7QtNGA0LDQt9C00LXQu9C10L3QuNGPICjQuNC3INGB0L/RgNCw0LLQvtGH0L3QuNC60LAgMzEwKQ0KZGVmIGdldERlcGFydG1lbnRQYXJhbVRhYmxlKGRlZiBkZXBhcnRtZW50UGFyYW1JZCkgew0KICAgIGlmIChkZXBhcnRtZW50UGFyYW1UYWJsZSA9PSBudWxsKSB7DQogICAgICAgIGRlZiBmaWx0ZXIgPSAiTElOSyA9ICRkZXBhcnRtZW50UGFyYW1JZCBhbmQgVEFYX09SR0FOX0NPREUgPScke2RlY2xhcmF0aW9uRGF0YS50YXhPcmdhbkNvZGV9JyBhbmQgS1BQID0nJHtkZWNsYXJhdGlvbkRhdGEua3BwfSciDQogICAgICAgIGRlZiBkZXBhcnRtZW50UGFyYW1UYWJsZUxpc3QgPSBnZXRQcm92aWRlcigzMTBMKS5nZXRSZWNvcmRzKGdldFJlcG9ydFBlcmlvZEVuZERhdGUoKSAtIDEsIG51bGwsIGZpbHRlciwgbnVsbCkNCiAgICAgICAgaWYgKGRlcGFydG1lbnRQYXJhbVRhYmxlTGlzdCA9PSBudWxsIHx8IGRlcGFydG1lbnRQYXJhbVRhYmxlTGlzdC5zaXplKCkgPT0gMCB8fCBkZXBhcnRtZW50UGFyYW1UYWJsZUxpc3QuZ2V0KDApID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oItCe0YjQuNCx0LrQsCDQv9GA0Lgg0L/QvtC70YPRh9C10L3QuNC4INC90LDRgdGC0YDQvtC10Log0L7QsdC+0YHQvtCx0LvQtdC90L3QvtCz0L4g0L/QvtC00YDQsNC30LTQtdC70LXQvdC40Y8uINCd0LDRgdGC0YDQvtC50LrQuCDQv9C+0LTRgNCw0LfQtNC10LvQtdC90LjRjyDQt9Cw0L/QvtC70L3QtdC90Ysg0L3QtSDQv9C+0LvQvdC+0YHRgtGM0Y4iKQ0KICAgICAgICB9DQogICAgICAgIGRlcGFydG1lbnRQYXJhbVRhYmxlID0gZGVwYXJ0bWVudFBhcmFtVGFibGVMaXN0LmdldCgwKQ0KICAgIH0NCiAgICByZXR1cm4gZGVwYXJ0bWVudFBhcmFtVGFibGUNCn0NCg0KZGVmIGdldExvbmcoZGVmIHZhbHVlKSB7DQogICAgcmV0dXJuICgoQmlnRGVjaW1hbCkgdmFsdWUpPy5zZXRTY2FsZSgwLCBCaWdEZWNpbWFsLlJPVU5EX0hBTEZfVVApDQp9DQoNCmRlZiBnZW5lcmF0ZVhtbEZpbGVJZCgpIHsNCiAgICBkZWYgZGVwYXJ0bWVudFBhcmFtID0gZ2V0RGVwYXJ0bWVudFBhcmFtKCkNCiAgICBkZWYgZGVwYXJ0bWVudFBhcmFtVHJhbnNwb3J0Um93ID0gZGVwYXJ0bWVudFBhcmFtID8gZ2V0RGVwYXJ0bWVudFBhcmFtVGFibGUoZGVwYXJ0bWVudFBhcmFtPy5yZWNvcmRfaWQ/LnZhbHVlKSA6IG51bGwNCiAgICBpZiAoZGVwYXJ0bWVudFBhcmFtICYmIGRlcGFydG1lbnRQYXJhbVRyYW5zcG9ydFJvdykgew0KICAgICAgICBkZWYgcl90ID0gVGF4VHlwZS5UUkFOU1BPUlQuZGVjbGFyYXRpb25QcmVmaXgNCiAgICAgICAgZGVmIGEgPSBkZXBhcnRtZW50UGFyYW1UcmFuc3BvcnRSb3c/LlRBWF9PUkdBTl9DT0RFX1BST00/LnZhbHVlDQogICAgICAgIGRlZiBrID0gZGVwYXJ0bWVudFBhcmFtVHJhbnNwb3J0Um93Py5UQVhfT1JHQU5fQ09ERT8udmFsdWUNCiAgICAgICAgZGVmIG8gPSBkZXBhcnRtZW50UGFyYW0/LklOTj8udmFsdWUgKyBkZXBhcnRtZW50UGFyYW1UcmFuc3BvcnRSb3c/LktQUD8udmFsdWUNCiAgICAgICAgZGVmIGRhdGUgPSBDYWxlbmRhci5nZXRJbnN0YW5jZSgpLmdldFRpbWUoKT8uZm9ybWF0KCJ5eXl5TU1kZCIpDQogICAgICAgIGRlZiBuID0gVVVJRC5yYW5kb21VVUlEKCkudG9TdHJpbmcoKS50b1VwcGVyQ2FzZSgpDQogICAgICAgIC8vIFJfVF9BX0tfT19HR0dHTU1ERF9ODQogICAgICAgIGRlZiBmaWxlSWQgPSByX3QgKyAnXycgKw0KICAgICAgICAgICAgICAgIGEgKyAnXycgKw0KICAgICAgICAgICAgICAgIGsgKyAnXycgKw0KICAgICAgICAgICAgICAgIG8gKyAnXycgKw0KICAgICAgICAgICAgICAgIGRhdGUgKyAnXycgKw0KICAgICAgICAgICAgICAgIG4NCiAgICAgICAgcmV0dXJuIGZpbGVJZA0KICAgIH0NCiAgICByZXR1cm4gbnVsbA0KfQ=='

        addLongText(template_id, longString, 'CREATE_SCRIPT')
        logger.info("К версии макета добавлен скрипт")
    }

} catch (Exception ex) {
    logger.error("Error: ${ex.getLocalizedMessage()}. Все изменения откатаны")
}

def void addTypeTemplate(DeclarationType type, DeclarationTemplate template, boolean createType, boolean createTemplate) {
    def type_id = type.id ?: ""
    def type_name = type.name ?: ""
    def type_tax_type = type.taxType.code ?: ""
    def type_is_ifrs = type.isIfrs ? 1 : 0
    def type_ifrs_name = type.ifrsName ?: ""

    def template_id = template.id ?: ""
    def template_name = template.name ?: ""
    def template_version = template.version.format("dd.MM.yy")

    String declarationTypeSql = "INSERT INTO DECLARATION_TYPE (ID, NAME, TAX_TYPE, STATUS, IS_IFRS, IFRS_NAME) VALUES " +
            "('$type_id', '$type_name', '$type_tax_type', '0', '$type_is_ifrs', '$type_ifrs_name')"
    if (createType) {
        namedParameterJdbcTemplate.update(declarationTypeSql, [:])
        logger.info("Создан тип декларации с id = $type_id без версии макета")
    }

    String templateSql = "INSERT INTO DECLARATION_TEMPLATE (ID, DECLARATION_TYPE_ID, NAME, VERSION, STATUS) VALUES " +
            "($template_id, '$type_id', '$template_name', TO_DATE('$template_version', 'DD.MM.RR'), '1')"
    if (createTemplate) {
        namedParameterJdbcTemplate.update(templateSql, [:])
        logger.info("Создан макет декларации с id = $template_id для типа декларации с id = $type_id, но без xsd, jrxml и скрипта")
    }
}

def void addLongText(def template_id, String longString, String alias) {
    final int MAX_LENGTH = 2000
    namedParameterJdbcTemplate.update("UPDATE DECLARATION_TEMPLATE SET $alias = null where id = $template_id", [:])
    int start = 0
    longString = new String(longString.decodeBase64(), "UTF-8")
    while (start < longString.length()) {
        int end = (start + MAX_LENGTH) < longString.length() ? (start + MAX_LENGTH) : longString.length()
        String text = longString.substring(start, end)
        namedParameterJdbcTemplate.update('UPDATE DECLARATION_TEMPLATE SET ' + alias + ' = ' + alias + ' || :text where id = ' +template_id, ['text' : text])
        start += MAX_LENGTH
    }
}