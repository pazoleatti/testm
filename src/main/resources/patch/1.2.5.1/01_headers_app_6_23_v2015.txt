import com.aplana.sbrf.taxaccounting.model.Column
import com.aplana.sbrf.taxaccounting.model.ColumnType
import com.aplana.sbrf.taxaccounting.model.FormStyle
import com.aplana.sbrf.taxaccounting.model.FormTemplate
import com.aplana.sbrf.taxaccounting.model.FormType
import org.apache.commons.io.IOUtils

/**
 Обновляет скрипт и заголовок макета 6.23
 # Инструкция:
 Вставить текст данного скрипта на странице, соответствующей ссылке с окончанием:
 .../gwtapp/#!scriptExecution
 Нажать "Выполнить".

 */

boolean createType = false
boolean createTemplate = false
boolean addColumns = false
boolean addStyles = false
boolean addDataRows = false
boolean addDataHeaders = true
boolean addScript = true

try {
    // id типа формы, имя типа формы, вид налога(I, T, V, D, P, E, M), включать в ИФРС(флаг), имя ИФРС
    FormType formType = new FormType()
    formType.setId(832)
    formType.setName('6.23. Отчет в отношении прочих доходов ПАО Сбербанк, связанных с оказанием услуг')
    formType.setTaxType(TaxType.DEAL)
    formType.setIsIfrs(false)
    formType.setIfrsName('')
    formType.setCode('')
    // id шаблона формы, имя шаблона короткое, имя шаблона полное, год версии, ежемесячность(флаг), код
    FormTemplate formTemplate = new FormTemplate()
    formTemplate.setId(832)
    formTemplate.setFixedRows(false)
    formTemplate.setName('6.23. Оказание услуг (прочие доходы)')
    formTemplate.setFullName('6.23. Отчет в отношении прочих доходов ПАО Сбербанк, связанных с оказанием услуг')
    formTemplate.setVersion(Date.parse('dd.MM.yyyy', '01.01.2015'))
    formTemplate.setMonthly(false)
    formTemplate.setHeader('')
    formTemplate.setComparative(false)
    formTemplate.setAccruing(false)
    formTemplate.setUpdating(false)

    def form_type_id = formType.id
    def form_template_id = formTemplate.id

    def rs = namedParameterJdbcTemplate.queryForObject("SELECT count(id) from FORM_TYPE where id = $form_type_id", [:], Integer.class)
    if (rs == 1) {
        logger.info("Макет НФ с данным id = $form_type_id уже существует в системе!")
        if (createType) {
            return
        }
    }

    rs = namedParameterJdbcTemplate.queryForObject("SELECT count(id) from FORM_TEMPLATE where id = $form_template_id", [:], Integer.class)
    if (rs == 1) {
        logger.info("Версия макета НФ с данным id = $form_template_id уже существует в системе!")
        if (createTemplate) {
            return
        }
    }

    String longString = ''

    longString = ''
    if (addDataHeaders) {
        longString += 'PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjxyb3dzPg0KICAgIDxyb3cgYWxpYXM9IiI+DQogICAgICAgIDxjZWxsIGFsaWFzPSJyb3dOdW1iZXIiIGNvbFNwYW49IjQiIHJvd1NwYW49IjEiIHZhbHVlPSLQntCx0YnQsNGPINC40L3RhNC+0YDQvNCw0YbQuNGPIi8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJuYW1lIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0J7QsdGJ0LDRjyDQuNC90YTQvtGA0LzQsNGG0LjRjyIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iaWtzciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCe0LHRidCw0Y8g0LjQvdGE0L7RgNC80LDRhtC40Y8iLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImNvdW50cnlDb2RlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0J7QsdGJ0LDRjyDQuNC90YTQvtGA0LzQsNGG0LjRjyIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0ic3VtIiBjb2xTcGFuPSI3IiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHQstC10LTQtdC90LjRjyDQviDRgdC00LXQu9C60LUiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImRvY051bWJlciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCh0LLQtdC00LXQvdC40Y8g0L4g0YHQtNC10LvQutC1Ii8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJkb2NEYXRlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHQstC10LTQtdC90LjRjyDQviDRgdC00LXQu9C60LUiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InNlcnZpY2VUeXBlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHQstC10LTQtdC90LjRjyDQviDRgdC00LXQu9C60LUiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InByaWNlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHQstC10LTQtdC90LjRjyDQviDRgdC00LXQu9C60LUiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImNvc3QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQodCy0LXQtNC10L3QuNGPINC+INGB0LTQtdC70LrQtSIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iZGVhbERvbmVEYXRlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0KHQstC10LTQtdC90LjRjyDQviDRgdC00LXQu9C60LUiLz4NCiAgICA8L3Jvdz4NCiAgICA8cm93IGFsaWFzPSIiPg0KICAgICAgICA8Y2VsbCBhbGlhcz0icm93TnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIyIiB2YWx1ZT0i4oSWINC/L9C/Ii8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJuYW1lIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIyIiB2YWx1ZT0i0J/QvtC70L3QvtC1INC90LDQuNC80LXQvdC+0LLQsNC90LjQtSDRjtGA0LjQtNC40YfQtdGB0LrQvtCz0L4g0LvQuNGG0LAg0YEg0YPQutCw0LfQsNC90LjQtdC8INCe0J/QpCIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iaWtzciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMiIgdmFsdWU9ItCY0J3QnS8g0JrQmNCeIi8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJjb3VudHJ5Q29kZSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMiIgdmFsdWU9ItCa0L7QtCDRgdGC0YDQsNC90Ysg0L/QviDQutC70LDRgdGB0LjRhNC40LrQsNGC0L7RgNGDINCe0JrQodCcIi8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJzdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjIiIHZhbHVlPSLQodGD0LzQvNCwINC00L7RhdC+0LTQvtCyINCR0LDQvdC60LAsINGA0YPQsS4iLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImRvY051bWJlciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMiIgdmFsdWU9ItCd0L7QvNC10YAg0LTQvtCz0L7QstC+0YDQsCIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iZG9jRGF0ZSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMiIgdmFsdWU9ItCU0LDRgtCwINC00L7Qs9C+0LLQvtGA0LAiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InNlcnZpY2VUeXBlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIyIiB2YWx1ZT0i0JLQuNC0INGD0YHQu9GD0LMiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InByaWNlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIyIiB2YWx1ZT0i0KbQtdC90LAiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImNvc3QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjIiIHZhbHVlPSLQodGC0L7QuNC80L7RgdGC0YwiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImRlYWxEb25lRGF0ZSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMiIgdmFsdWU9ItCU0LDRgtCwINGB0L7QstC10YDRiNC10L3QuNGPINGB0LTQtdC70LrQuCIvPg0KICAgIDwvcm93Pg0KICAgIDxyb3cgYWxpYXM9IiI+DQogICAgICAgIDxjZWxsIGFsaWFzPSJyb3dOdW1iZXIiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLihJYg0L8v0L8iLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9Im5hbWUiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQn9C+0LvQvdC+0LUg0L3QsNC40LzQtdC90L7QstCw0L3QuNC1INGO0YDQuNC00LjRh9C10YHQutC+0LPQviDQu9C40YbQsCDRgSDRg9C60LDQt9Cw0L3QuNC10Lwg0J7Qn9CkIi8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJpa3NyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0JjQndCdLyDQmtCY0J4iLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImNvdW50cnlDb2RlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0JrQvtC0INGB0YLRgNCw0L3RiyDQv9C+INC60LvQsNGB0YHQuNGE0LjQutCw0YLQvtGA0YMg0J7QmtCh0JwiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InN1bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCh0YPQvNC80LAg0LTQvtGF0L7QtNC+0LIg0JHQsNC90LrQsCwg0YDRg9CxLiIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iZG9jTnVtYmVyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0J3QvtC80LXRgCDQtNC+0LPQvtCy0L7RgNCwIi8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJkb2NEYXRlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0JTQsNGC0LAg0LTQvtCz0L7QstC+0YDQsCIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0ic2VydmljZVR5cGUiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQktC40LQg0YPRgdC70YPQsyIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0icHJpY2UiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQptC10L3QsCIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iY29zdCIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCh0YLQvtC40LzQvtGB0YLRjCIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iZGVhbERvbmVEYXRlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0JTQsNGC0LAg0YHQvtCy0LXRgNGI0LXQvdC40Y8g0YHQtNC10LvQutC4Ii8+DQogICAgPC9yb3c+DQogICAgPHJvdyBhbGlhcz0iIj4NCiAgICAgICAgPGNlbGwgYWxpYXM9InJvd051bWJlciIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCz0YAuIDEiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9Im5hbWUiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQs9GALiAyIi8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJpa3NyIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0LPRgC4gMyIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iY291bnRyeUNvZGUiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQs9GALiA0Ii8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJzdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQs9GALiA1Ii8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJkb2NOdW1iZXIiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQs9GALiA2Ii8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJkb2NEYXRlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0LPRgC4gNyIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0ic2VydmljZVR5cGUiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQs9GALiA4Ii8+DQogICAgICAgIDxjZWxsIGFsaWFzPSJwcmljZSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCz0YAuIDkiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImNvc3QiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQs9GALiAxMCIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iZGVhbERvbmVEYXRlIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0i0LPRgC4gMTEiLz4NCiAgICA8L3Jvdz4NCjwvcm93cz4='

        addLongText(form_template_id, longString, 'DATA_HEADERS')
        logger.info("К версии макета добавлен заголовок")
    }

    longString = ''
    if (addScript) {
        longString += 'cGFja2FnZSBmb3JtX3RlbXBsYXRlLmRlYWwuYXBwXzZfMjMudjIwMTUNCg0KaW1wb3J0IGF1LmNvbS5ieXRlY29kZS5vcGVuY3N2LkNTVlJlYWRlcg0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLkZvcm1EYXRhRXZlbnQNCmltcG9ydCBjb20uYXBsYW5hLnNicmYudGF4YWNjb3VudGluZy5tb2RlbC5leGNlcHRpb24uU2VydmljZUV4Y2VwdGlvbg0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLmxvZy5Mb2dMZXZlbA0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLnNlcnZpY2Uuc2NyaXB0LnV0aWwuU2NyaXB0VXRpbHMNCmltcG9ydCBncm9vdnkudHJhbnNmb3JtLkZpZWxkDQoNCi8qKg0KICogNi4yMy4g0J7RgtGH0LXRgiDQsiDQvtGC0L3QvtGI0LXQvdC40Lgg0L/RgNC+0YfQuNGFINC00L7RhdC+0LTQvtCyINCf0JDQniDQodCx0LXRgNCx0LDQvdC6LCDRgdCy0Y/Qt9Cw0L3QvdGL0YUg0YEg0L7QutCw0LfQsNC90LjQtdC8INGD0YHQu9GD0LMNCiAqDQogKiBmb3JtVGVtcGxhdGVJZCA9IDgzMg0KICoNCiAqIEBhdXRob3IgRU1hbWVkb3ZhDQogKi8NCg0KLy8g0LPRgNCw0YTQsCAxICAoMSkgICAtIHJvd051bWJlciAgICAgICAtIOKEliDQvy/Qvw0KLy8g0LPRgNCw0YTQsCAyICAoMikgICAtIG5hbWUgICAgICAgICAgICAtINCf0L7Qu9C90L7QtSDQvdCw0LjQvNC10L3QvtCy0LDQvdC40LUg0Y7RgNC40LTQuNGH0LXRgdC60L7Qs9C+INC70LjRhtCwINGBINGD0LrQsNC30LDQvdC40LXQvCDQntCf0KQNCi8vINCz0YDQsNGE0LAgMyAgKDMpICAgLSBpa3NyICAgICAgICAgICAgLSDQmNCd0J0vINCa0JjQng0KLy8g0LPRgNCw0YTQsCA0ICAoNCkgICAtIGNvdW50cnlDb2RlICAgICAtINCa0L7QtCDRgdGC0YDQsNC90Ysg0YDQtdCz0LjRgdGC0YDQsNGG0LjQuCDQv9C+INC60LvQsNGB0YHQuNGE0LjQutCw0YLQvtGA0YMg0J7QmtCh0JwNCi8vINCz0YDQsNGE0LAgNSAgKDUpICAgLSBzdW0gICAgICAgICAgICAgLSDQodGD0LzQvNCwINC00L7RhdC+0LTQvtCyINCR0LDQvdC60LAg0L/QviDQtNCw0L3QvdGL0Lwg0LHRg9GF0LPQsNC70YLQtdGA0YHQutC+0LPQviDRg9GH0LXRgtCwLCDRgNGD0LEuDQovLyDQs9GA0LDRhNCwIDYgICg2KSAgIC0gZG9jTnVtYmVyICAgICAgIC0g0J3QvtC80LXRgCDQtNC+0LPQvtCy0L7RgNCwDQovLyDQs9GA0LDRhNCwIDcgICg3KSAgIC0gZG9jRGF0ZSAgICAgICAgIC0g0JTQsNGC0LAg0LTQvtCz0L7QstC+0YDQsA0KLy8g0LPRgNCw0YTQsCA4ICAoOCkgICAtIHNlcnZpY2VUeXBlICAgICAtINCS0LjQtCDRg9GB0LvRg9CzDQovLyDQs9GA0LDRhNCwIDkgICg5KSAgIC0gcHJpY2UgCQkJLSDQptC10L3QsA0KLy8g0LPRgNCw0YTQsCAxMCAoMTApICAtIGNvc3QgCQkJLSDQodGC0L7QuNC80L7RgdGC0YwNCi8vINCz0YDQsNGE0LAgMTEgKDExKSAgLSBkZWFsRG9uZURhdGUgICAgLSDQlNCw0YLQsCDRgdC+0LLQtdGA0YjQtdC90LjRjyDRgdC00LXQu9C60LgNCg0Kc3dpdGNoIChmb3JtRGF0YUV2ZW50KSB7DQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LkNSRUFURToNCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLmNoZWNrVW5pcXVlKGZvcm1EYXRhLCBsb2dnZXIpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LkFGVEVSX0xPQUQ6DQogICAgICAgIGFmdGVyTG9hZCgpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LkNBTENVTEFURToNCiAgICAgICAgY2FsYygpDQogICAgICAgIGxvZ2ljQ2hlY2soKQ0KICAgICAgICBmb3JtRGF0YVNlcnZpY2Uuc2F2ZUNhY2hlZERhdGFSb3dzKGZvcm1EYXRhLCBsb2dnZXIpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LkNIRUNLOg0KICAgICAgICBsb2dpY0NoZWNrKCkNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQUREX1JPVzoNCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLmFkZFJvdyhmb3JtRGF0YSwgY3VycmVudERhdGFSb3csIGVkaXRhYmxlQ29sdW1ucywgYXV0b0ZpbGxDb2x1bW5zKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5ERUxFVEVfUk9XOg0KICAgICAgICBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSkuZGVsZXRlKGN1cnJlbnREYXRhUm93KQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX0NSRUFURURfVE9fUFJFUEFSRUQ6ICAvLyDQn9C+0LTQs9C+0YLQvtCy0LjRgtGMINC40LcgItCh0L7Qt9C00LDQvdCwDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfQ1JFQVRFRF9UT19BUFBST1ZFRDogIC8vINCj0YLQstC10YDQtNC40YLRjCDQuNC3ICLQodC+0LfQtNCw0L3QsCINCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuTU9WRV9QUkVQQVJFRF9UT19BUFBST1ZFRDogLy8g0KPRgtCy0LXRgNC00LjRgtGMINC40LcgItCf0L7QtNCz0L7RgtC+0LLQu9C10L3QsCINCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuTU9WRV9DUkVBVEVEX1RPX0FDQ0VQVEVEOiAgLy8g0J/RgNC40L3Rj9GC0Ywg0LjQtyAi0KHQvtC30LTQsNC90LAiDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfUFJFUEFSRURfVE9fQUNDRVBURUQ6IC8vINCf0YDQuNC90Y/RgtGMINC40LcgItCf0L7QtNCz0L7RgtC+0LLQu9C10L3QsCINCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuTU9WRV9BUFBST1ZFRF9UT19BQ0NFUFRFRDogLy8g0J/RgNC40L3Rj9GC0Ywg0LjQtyAi0KPRgtCy0LXRgNC20LTQtdC90LAiDQogICAgICAgIGxvZ2ljQ2hlY2soKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5DT01QT1NFOiAvLyDQmtC+0L3RgdC+0LvQuNC00LDRhtC40Y8NCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLmNvbnNvbGlkYXRpb25TaW1wbGUoZm9ybURhdGEsIGxvZ2dlciwgdXNlckluZm8pDQogICAgICAgIGNhbGMoKQ0KICAgICAgICBsb2dpY0NoZWNrKCkNCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLnNhdmVDYWNoZWREYXRhUm93cyhmb3JtRGF0YSwgbG9nZ2VyKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5JTVBPUlQ6DQogICAgICAgIGltcG9ydERhdGEoKQ0KICAgICAgICBmb3JtRGF0YVNlcnZpY2Uuc2F2ZUNhY2hlZERhdGFSb3dzKGZvcm1EYXRhLCBsb2dnZXIpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LklNUE9SVF9UUkFOU1BPUlRfRklMRToNCiAgICAgICAgaW1wb3J0VHJhbnNwb3J0RGF0YSgpDQogICAgICAgIGZvcm1EYXRhU2VydmljZS5zYXZlQ2FjaGVkRGF0YVJvd3MoZm9ybURhdGEsIGxvZ2dlcikNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuU09SVF9ST1dTOg0KICAgICAgICBzb3J0Rm9ybURhdGFSb3dzKCkNCiAgICAgICAgYnJlYWsNCn0NCg0KLy8vLyDQmtGN0YjQuCDQuCDQutC+0L3RgdGC0LDQvdGC0YsNCkBGaWVsZA0KZGVmIHByb3ZpZGVyQ2FjaGUgPSBbOl0NCkBGaWVsZA0KZGVmIHJlY29yZENhY2hlID0gWzpdDQpARmllbGQNCmRlZiByZWZCb29rQ2FjaGUgPSBbOl0NCkBGaWVsZA0KZGVmIGFsbENvbHVtbnMgPSBbJ3Jvd051bWJlcicsICduYW1lJywgJ2lrc3InLCAnY291bnRyeUNvZGUnLCAnc2VydmljZVR5cGUnLCAnc3VtJywgJ2RvY051bWJlcicsDQogICAgICAgICAgICAgICAgICAnZG9jRGF0ZScsICdwcmljZScsICdjb3N0JywgJ2RlYWxEb25lRGF0ZSddDQoNCi8vINCg0LXQtNCw0LrRgtC40YDRg9C10LzRi9C1INCw0YLRgNC40LHRg9GC0YsNCkBGaWVsZA0KZGVmIGVkaXRhYmxlQ29sdW1ucyA9IFsnbmFtZScsICdzdW0nLCAnZG9jTnVtYmVyJywgJ2RvY0RhdGUnLCAnc2VydmljZVR5cGUnLCAnZGVhbERvbmVEYXRlJ10NCg0KLy8g0JDQstGC0L7Qt9Cw0L/QvtC70L3Rj9C10LzRi9C1INCw0YLRgNC40LHRg9GC0YsNCkBGaWVsZA0KZGVmIGF1dG9GaWxsQ29sdW1ucyA9IFsncm93TnVtYmVyJywgJ2lrc3InLCAnY291bnRyeUNvZGUnLCAncHJpY2UnLCAnY29zdCddDQoNCi8vINCf0YDQvtCy0LXRgNGP0LXQvNGL0LUg0L3QsCDQv9GD0YHRgtGL0LUg0LfQvdCw0YfQtdC90LjRjyDQsNGC0YDQuNCx0YPRgtGLDQpARmllbGQNCmRlZiBub25FbXB0eUNvbHVtbnMgPSBbJ25hbWUnLCAnc2VydmljZVR5cGUnLCAnc3VtJywgJ2RvY051bWJlcicsICdkb2NEYXRlJywgJ3ByaWNlJywgJ2Nvc3QnLCAnZGVhbERvbmVEYXRlJ10NCg0KLy8g0J/QvtC70Y8g0LTQu9GPINGA0LDRgdGB0YfQtdGC0LAgItCY0YLQvtCz0L4iDQpARmllbGQNCmRlZiB0b3RhbENvbHVtbnMgPSBbJ3N1bScsICdjb3N0J10NCg0KLy8g0JTQsNGC0LAg0L3QsNGH0LDQu9CwINC+0YLRh9C10YLQvdC+0LPQviDQv9C10YDQuNC+0LTQsA0KQEZpZWxkDQpkZWYgc3RhcnREYXRlID0gbnVsbA0KDQovLyDQlNCw0YLQsCDQvtC60L7QvdGH0LDQvdC40Y8g0L7RgtGH0LXRgtC90L7Qs9C+INC/0LXRgNC40L7QtNCwDQpARmllbGQNCmRlZiBlbmREYXRlID0gbnVsbA0KDQpkZWYgZ2V0UmVwb3J0UGVyaW9kU3RhcnREYXRlKCkgew0KICAgIGlmIChzdGFydERhdGUgPT0gbnVsbCkgew0KICAgICAgICBzdGFydERhdGUgPSByZXBvcnRQZXJpb2RTZXJ2aWNlLmdldFN0YXJ0RGF0ZShmb3JtRGF0YS5yZXBvcnRQZXJpb2RJZCkudGltZQ0KICAgIH0NCiAgICByZXR1cm4gc3RhcnREYXRlDQp9DQoNCmRlZiBnZXRSZXBvcnRQZXJpb2RFbmREYXRlKCkgew0KICAgIGlmIChlbmREYXRlID09IG51bGwpIHsNCiAgICAgICAgZW5kRGF0ZSA9IHJlcG9ydFBlcmlvZFNlcnZpY2UuZ2V0RW5kRGF0ZShmb3JtRGF0YS5yZXBvcnRQZXJpb2RJZCkudGltZQ0KICAgIH0NCiAgICByZXR1cm4gZW5kRGF0ZQ0KfQ0KDQovLy8vINCe0LHQtdGA0YLQutC4INC80LXRgtC+0LTQvtCyDQoNCi8vINCg0LDQt9GL0LzQtdC90L7QstCw0L3QuNC1INC30LDQv9C40YHQuCDRgdC/0YDQsNCy0L7Rh9C90LjQutCwDQpkZWYgZ2V0UmVmQm9va1ZhbHVlKGRlZiBsb25nIHJlZkJvb2tJZCwgZGVmIExvbmcgcmVjb3JkSWQpIHsNCiAgICByZXR1cm4gZm9ybURhdGFTZXJ2aWNlLmdldFJlZkJvb2tWYWx1ZShyZWZCb29rSWQsIHJlY29yZElkLCByZWZCb29rQ2FjaGUpDQp9DQoNCi8vLy8g0JrQsNGB0YLQvtC80L3Ri9C1INC80LXRgtC+0LTRiw0KDQovLyDQm9C+0LPQuNGH0LXRgdC60LjQtSDQv9GA0L7QstC10YDQutC4DQp2b2lkIGxvZ2ljQ2hlY2soKSB7DQogICAgZGVmIGRhdGFSb3dzID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpLmFsbENhY2hlZA0KICAgIGlmIChkYXRhUm93cy5pc0VtcHR5KCkpIHsNCiAgICAgICAgcmV0dXJuDQogICAgfQ0KICAgIGRlZiB5ZWFyU3RhcnREYXRlID0gRGF0ZS5wYXJzZSgnZGQuTU0ueXl5eScsICcwMS4wMS4nICsgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpLmZvcm1hdCgneXl5eScpKQ0KDQogICAgZm9yIChyb3cgaW4gZGF0YVJvd3MpIHsNCiAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpICE9IG51bGwpIHsNCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgZGVmIHJvd051bSA9IHJvdy5nZXRJbmRleCgpDQoNCiAgICAgICAgLy8g0J/RgNC+0LLQtdGA0LrQsCDQt9Cw0L/QvtC70L3QtdC90LjRjyDQvtCx0Y/Qt9Cw0YLQtdC70YzQvdGL0YUg0L/QvtC70LXQuQ0KICAgICAgICBjaGVja05vbkVtcHR5Q29sdW1ucyhyb3csIHJvd051bSwgbm9uRW1wdHlDb2x1bW5zLCBsb2dnZXIsIHRydWUpDQoNCiAgICAgICAgLy8g0J/RgNC+0LLQtdGA0LrQsCDRgdGD0LzQvNGLINC00L7RhdC+0LTQvtCyDQogICAgICAgIGlmIChyb3cuc3VtICE9IG51bGwgJiYgcm93LnN1bSA8IDApIHsNCiAgICAgICAgICAgIGRlZiBtc2cgPSBnZXRDb2x1bW5OYW1lKHJvdywgJ3N1bScpDQogICAgICAgICAgICBsb2dnZXIud2Fybigi0KHRgtGA0L7QutCwICRyb3dOdW06INCX0L3QsNGH0LXQvdC40LUg0LPRgNCw0YTRiyDCqyRtc2fCuyDQtNC+0LvQttC90L4g0LHRi9GC0Ywg0LHQvtC70YzRiNC1INC40LvQuCDRgNCw0LLQvdC+IMKrMMK7ISIpDQogICAgICAgIH0NCg0KICAgICAgICAvLyDQn9GA0L7QstC10YDQutCwINC60L7RgNGA0LXQutGC0L3QvtGB0YLQuCDQtNCw0YLRiyDQtNC+0LPQvtCy0L7RgNCwDQogICAgICAgIGNoZWNrRGF0ZVBlcmlvZChsb2dnZXIsIHJvdywgJ2RvY0RhdGUnLCBEYXRlLnBhcnNlKCdkZC5NTS55eXl5JywgJzAxLjAxLjE5OTEnKSwgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpLCB0cnVlKQ0KDQogICAgICAgIC8vINCf0YDQvtCy0LXRgNC60LAg0YbQtdC90YsNCiAgICAgICAgaWYgKHJvdy5zdW0gIT0gbnVsbCAmJiByb3cucHJpY2UgIT0gcm93LnN1bSkgew0KICAgICAgICAgICAgZGVmIG1zZzEgPSBnZXRDb2x1bW5OYW1lKHJvdywgJ3ByaWNlJykNCiAgICAgICAgICAgIGRlZiBtc2cyID0gZ2V0Q29sdW1uTmFtZShyb3csICdzdW0nKQ0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJHJvd051bTog0JfQvdCw0YfQtdC90LjQtSDQs9GA0LDRhNGLIMKrJG1zZzHCuyDQtNC+0LvQttC90L4g0LHRi9GC0Ywg0YDQsNCy0L3QviDQt9C90LDRh9C10L3QuNGOINCz0YDQsNGE0YsgwqskbXNnMsK7ISIpDQogICAgICAgIH0NCg0KICAgICAgICAvLyDQn9GA0L7QstC10YDQutCwINGB0YLQvtC40LzQvtGB0YLQuA0KICAgICAgICBpZiAocm93LnN1bSAhPSBudWxsICYmIHJvdy5jb3N0ICE9IHJvdy5zdW0pIHsNCiAgICAgICAgICAgIGRlZiBtc2cxID0gZ2V0Q29sdW1uTmFtZShyb3csICdjb3N0JykNCiAgICAgICAgICAgIGRlZiBtc2cyID0gZ2V0Q29sdW1uTmFtZShyb3csICdzdW0nKQ0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJHJvd051bTog0JfQvdCw0YfQtdC90LjQtSDQs9GA0LDRhNGLIMKrJG1zZzHCuyDQtNC+0LvQttC90L4g0LHRi9GC0Ywg0YDQsNCy0L3QviDQt9C90LDRh9C10L3QuNGOINCz0YDQsNGE0YsgwqskbXNnMsK7ISIpDQogICAgICAgIH0NCg0KICAgICAgICAvLyDQn9GA0L7QstC10YDQutCwINC60L7RgNGA0LXQutGC0L3QvtGB0YLQuCDQtNCw0YLRiyDRgdC+0LLQtdGA0YjQtdC90LjRjyDRgdC00LXQu9C60LgNCiAgICAgICAgY2hlY2tEYXRlUGVyaW9kRXh0KGxvZ2dlciwgcm93LCAnZGVhbERvbmVEYXRlJywgJ2RvY0RhdGUnLCB5ZWFyU3RhcnREYXRlLCBnZXRSZXBvcnRQZXJpb2RFbmREYXRlKCksIHRydWUpDQogICAgfQ0KfQ0KDQovLyDQkNC70LPQvtGA0LjRgtC80Ysg0LfQsNC/0L7Qu9C90LXQvdC40Y8g0L/QvtC70LXQuSDRhNC+0YDQvNGLDQp2b2lkIGNhbGMoKSB7DQogICAgZGVmIGRhdGFSb3dzID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpLmFsbENhY2hlZA0KICAgIGZvciAocm93IGluIGRhdGFSb3dzKSB7DQogICAgICAgIHJvdy5wcmljZSA9IHJvdy5zdW0NCiAgICAgICAgcm93LmNvc3QgPSByb3cuc3VtDQogICAgfQ0KfQ0KDQovLyDQn9C+0LvRg9GH0LXQvdC40LUg0LjQvNC/0L7RgNGC0LjRgNGD0LXQvNGL0YUg0LTQsNC90L3Ri9GFDQp2b2lkIGltcG9ydERhdGEoKSB7DQogICAgZGVmIHRtcFJvdyA9IGZvcm1EYXRhLmNyZWF0ZURhdGFSb3coKQ0KICAgIGludCBDT0xVTU5fQ09VTlQgPSAxMQ0KICAgIGludCBIRUFERVJfUk9XX0NPVU5UID0gNA0KICAgIFN0cmluZyBUQUJMRV9TVEFSVF9WQUxVRSA9ICfQntCx0YnQsNGPINC40L3RhNC+0YDQvNCw0YbQuNGPJw0KICAgIFN0cmluZyBUQUJMRV9FTkRfVkFMVUUgPSBudWxsDQogICAgaW50IElOREVYX0ZPUl9TS0lQID0gMA0KDQogICAgZGVmIGFsbFZhbHVlcyA9IFtdICAgICAgLy8g0LfQvdCw0YfQtdC90LjRjyDRhNC+0YDQvNGLDQogICAgZGVmIGhlYWRlclZhbHVlcyA9IFtdICAgLy8g0LfQvdCw0YfQtdC90LjRjyDRiNCw0L/QutC4DQogICAgZGVmIHBhcmFtc01hcCA9IFsncm93T2Zmc2V0JyA6IDAsICdjb2xPZmZzZXQnIDogMF0gIC8vINC80LDQv9CwINGBINC/0LDRgNCw0LzQtdGC0YDQsNC80LggKNC+0YLRgdGC0YPQv9GLINGB0LLQtdGA0YXRgyDQuCDRgdC70LXQstCwKQ0KDQogICAgY2hlY2tBbmRSZWFkRmlsZShJbXBvcnRJbnB1dFN0cmVhbSwgVXBsb2FkRmlsZU5hbWUsIGFsbFZhbHVlcywgaGVhZGVyVmFsdWVzLCBUQUJMRV9TVEFSVF9WQUxVRSwgVEFCTEVfRU5EX1ZBTFVFLCBIRUFERVJfUk9XX0NPVU5ULCBwYXJhbXNNYXApDQoNCiAgICAvLyDQv9GA0L7QstC10YDQutCwINGI0LDQv9C60LgNCiAgICBjaGVja0hlYWRlclhscyhoZWFkZXJWYWx1ZXMsIENPTFVNTl9DT1VOVCwgSEVBREVSX1JPV19DT1VOVCwgdG1wUm93KQ0KICAgIGlmIChsb2dnZXIuY29udGFpbnNMZXZlbChMb2dMZXZlbC5FUlJPUikpIHsNCiAgICAgICAgcmV0dXJuOw0KICAgIH0NCiAgICAvLyDQvtGB0LLQvtCx0L7QttC00LXQvdC40LUg0YDQtdGB0YPRgNGB0L7QsiDQtNC70Y8g0Y3QutC+0L3QvtC80LjQuCDQv9Cw0LzRj9GC0LgNCiAgICBoZWFkZXJWYWx1ZXMuY2xlYXIoKQ0KICAgIGhlYWRlclZhbHVlcyA9IG51bGwNCg0KICAgIGRlZiBmaWxlUm93SW5kZXggPSBwYXJhbXNNYXAucm93T2Zmc2V0DQogICAgZGVmIGNvbE9mZnNldCA9IHBhcmFtc01hcC5jb2xPZmZzZXQNCiAgICBwYXJhbXNNYXAuY2xlYXIoKQ0KICAgIHBhcmFtc01hcCA9IG51bGwNCg0KICAgIGRlZiByb3dJbmRleCA9IDANCiAgICBkZWYgcm93cyA9IFtdDQogICAgZGVmIGFsbFZhbHVlc0NvdW50ID0gYWxsVmFsdWVzLnNpemUoKQ0KDQogICAgLy8g0YTQvtGA0LzQuNGA0LLQsNC90LjQtSDRgdGC0YDQvtC6INC90YQNCiAgICBmb3IgKGRlZiBpID0gMDsgaSA8IGFsbFZhbHVlc0NvdW50OyBpKyspIHsNCiAgICAgICAgcm93VmFsdWVzID0gYWxsVmFsdWVzWzBdDQogICAgICAgIGZpbGVSb3dJbmRleCsrDQogICAgICAgIC8vINCy0YHQtSDRgdGC0YDQvtC60Lgg0L/Rg9GB0YLRi9C1IC0g0LLRi9GF0L7QtA0KICAgICAgICBpZiAoIXJvd1ZhbHVlcyB8fCByb3dWYWx1ZXMuaXNFbXB0eSgpIHx8ICFyb3dWYWx1ZXMuZmluZCB7IGl0IH0pIHsNCiAgICAgICAgICAgIGFsbFZhbHVlcy5yZW1vdmUocm93VmFsdWVzKQ0KICAgICAgICAgICAgcm93VmFsdWVzLmNsZWFyKCkNCiAgICAgICAgICAgIGJyZWFrDQogICAgICAgIH0NCiAgICAgICAgcm93SW5kZXgrKw0KICAgICAgICAvLyDQv9GA0L7RgdGC0LDRjyDRgdGC0YDQvtC60LANCiAgICAgICAgZGVmIG5ld1JvdyA9IGdldE5ld1Jvd0Zyb21YbHMocm93VmFsdWVzLCBjb2xPZmZzZXQsIGZpbGVSb3dJbmRleCwgcm93SW5kZXgpDQogICAgICAgIHJvd3MuYWRkKG5ld1JvdykNCiAgICAgICAgLy8g0L7RgdCy0L7QsdC+0LTQuNGC0Ywg0L3QtdC90YPQttC90YvQtSDQtNCw0L3QvdGL0LUgLSDQuNC90LDRh9C1INC90LUg0YXQstCw0YLQuNGCINC/0LDQvNGP0YLQuA0KICAgICAgICBhbGxWYWx1ZXMucmVtb3ZlKHJvd1ZhbHVlcykNCiAgICAgICAgcm93VmFsdWVzLmNsZWFyKCkNCiAgICB9DQoNCiAgICBzaG93TWVzc2FnZXMocm93cywgbG9nZ2VyKQ0KICAgIGlmICghbG9nZ2VyLmNvbnRhaW5zTGV2ZWwoTG9nTGV2ZWwuRVJST1IpKSB7DQogICAgICAgIHVwZGF0ZUluZGV4ZXMocm93cykNCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpLmFsbENhY2hlZCA9IHJvd3MNCiAgICB9DQp9DQoNCi8qKg0KICog0J/RgNC+0LLQtdGA0LjRgtGMINGI0LDQv9C60YMg0YLQsNCx0LvQuNGG0YsNCiAqDQogKiBAcGFyYW0gaGVhZGVyUm93cyDRgdGC0YDQvtC60Lgg0YjQsNC/0LrQuA0KICogQHBhcmFtIGNvbENvdW50INC60L7Qu9C40YfQtdGB0YLQstC+INC60L7Qu9C+0L3QvtC6INCyINGC0LDQsdC70LjRhtC1DQogKiBAcGFyYW0gcm93Q291bnQg0LrQvtC70LjRh9C10YHRgtCy0L4g0YHRgtGA0L7QuiDQsiDRgtCw0LHQu9C40YbQtQ0KICogQHBhcmFtIHRtcFJvdyDQstGB0L/QvtC80L7Qs9Cw0YLQtdC70YzQvdCw0Y8g0YHRgtGA0L7QutCwINC00LvRjyDQv9C+0LvRg9GH0LXQvdC40Y8g0L3QsNC30LLQsNC90LjQuCDQs9GA0LDRhNC+0LINCiAqLw0Kdm9pZCBjaGVja0hlYWRlclhscyhkZWYgaGVhZGVyUm93cywgZGVmIGNvbENvdW50LCByb3dDb3VudCwgZGVmIHRtcFJvdykgew0KICAgIGNoZWNrSGVhZGVyU2l6ZShoZWFkZXJSb3dzLCBjb2xDb3VudCwgcm93Q291bnQpDQoNCiAgICBkZWYgaGVhZGVyTWFwcGluZyA9IFsNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMF1bMF0pIDogJ9Ce0LHRidCw0Y8g0LjQvdGE0L7RgNC80LDRhtC40Y8nXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzBdWzRdKSA6ICfQodCy0LXQtNC10L3QuNGPINC+INGB0LTQtdC70LrQtSddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMV1bMF0pIDogdG1wUm93LmdldENlbGwoJ3Jvd051bWJlcicpLmNvbHVtbi5uYW1lXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzFdWzFdKSA6IHRtcFJvdy5nZXRDZWxsKCduYW1lJykuY29sdW1uLm5hbWVdKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMV1bMl0pIDogdG1wUm93LmdldENlbGwoJ2lrc3InKS5jb2x1bW4ubmFtZV0pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1sxXVszXSkgOiB0bXBSb3cuZ2V0Q2VsbCgnY291bnRyeUNvZGUnKS5jb2x1bW4ubmFtZV0pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1sxXVs0XSkgOiB0bXBSb3cuZ2V0Q2VsbCgnc3VtJykuY29sdW1uLm5hbWVdKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMV1bNV0pIDogdG1wUm93LmdldENlbGwoJ2RvY051bWJlcicpLmNvbHVtbi5uYW1lXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzFdWzZdKSA6IHRtcFJvdy5nZXRDZWxsKCdkb2NEYXRlJykuY29sdW1uLm5hbWVdKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMV1bN10pIDogdG1wUm93LmdldENlbGwoJ3NlcnZpY2VUeXBlJykuY29sdW1uLm5hbWVdKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMV1bOF0pIDogdG1wUm93LmdldENlbGwoJ3ByaWNlJykuY29sdW1uLm5hbWVdKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMV1bOV0pIDogdG1wUm93LmdldENlbGwoJ2Nvc3QnKS5jb2x1bW4ubmFtZV0pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1sxXVsxMF0pOiB0bXBSb3cuZ2V0Q2VsbCgnZGVhbERvbmVEYXRlJykuY29sdW1uLm5hbWVdKQ0KICAgIF0NCiAgICAoMC4uMTApLmVhY2h7DQogICAgICAgIGhlYWRlck1hcHBpbmcuYWRkKChbKGhlYWRlclJvd3NbM11baXRdKTogJ9Cz0YAuICcgKyAoaXQgKyAxKV0pKQ0KICAgIH0NCiAgICBjaGVja0hlYWRlckVxdWFscyhoZWFkZXJNYXBwaW5nLCBsb2dnZXIpDQp9DQoNCi8qKg0KICog0J/QvtC70YPRh9C40YLRjCDQvdC+0LLRg9GOINGB0YLRgNC+0LrRgyDQvdGEINC/0L4g0LfQvdCw0YfQtdC90LjRj9C8INC40Lcg0Y3QutGB0LXQu9GPLg0KICoNCiAqIEBwYXJhbSB2YWx1ZXMg0YHQv9C40YHQvtC6INGB0YLRgNC+0Log0YHQviDQt9C90LDRh9C10L3QuNGP0LzQuA0KICogQHBhcmFtIGNvbE9mZnNldCDQvtGC0YHRgtGD0L8g0LIg0LrQvtC70L7QvdC60LDRhQ0KICogQHBhcmFtIGZpbGVSb3dJbmRleCDQvdC+0LzQtdGAINGB0YLRgNC+0LrQuCDQsiDRgtGEDQogKiBAcGFyYW0gcm93SW5kZXgg0YHRgtGA0L7QutCwINCyINC90YQNCiAqLw0KZGVmIGdldE5ld1Jvd0Zyb21YbHMoZGVmIHZhbHVlcywgZGVmIGNvbE9mZnNldCwgZGVmIGZpbGVSb3dJbmRleCwgZGVmIHJvd0luZGV4KSB7DQogICAgZGVmIG5ld1JvdyA9IGZvcm1EYXRhLmNyZWF0ZVN0b3JlTWVzc2FnaW5nRGF0YVJvdygpDQogICAgbmV3Um93LnNldEluZGV4KHJvd0luZGV4KQ0KICAgIG5ld1Jvdy5zZXRJbXBvcnRJbmRleChmaWxlUm93SW5kZXgpDQogICAgZWRpdGFibGVDb2x1bW5zLmVhY2ggew0KICAgICAgICBuZXdSb3cuZ2V0Q2VsbChpdCkuZWRpdGFibGUgPSB0cnVlDQogICAgICAgIG5ld1Jvdy5nZXRDZWxsKGl0KS5zZXRTdHlsZUFsaWFzKCfQoNC10LTQsNC60YLQuNGA0YPQtdC80LDRjycpDQogICAgfQ0KICAgIGF1dG9GaWxsQ29sdW1ucy5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLnNldFN0eWxlQWxpYXMoJ9CQ0LLRgtC+0LfQsNC/0L7Qu9C90Y/QtdC80LDRjycpDQogICAgfQ0KDQogICAgZGVmIFN0cmluZyBpa3NyTmFtZSA9IGdldENvbHVtbk5hbWUobmV3Um93LCAnaWtzcicpDQogICAgZGVmIG5hbWVGcm9tRmlsZSA9IHZhbHVlc1sxXQ0KDQogICAgZGVmIGludCBjb2xJbmRleCA9IDENCg0KICAgIGRlZiByZWNvcmRJZCA9IGdldFRjb1JlY29yZElkKG5hbWVGcm9tRmlsZSwgdmFsdWVzWzJdLCBpa3NyTmFtZSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCwgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpLCBmYWxzZSwgbG9nZ2VyLCByZWZCb29rRmFjdG9yeSwgcmVjb3JkQ2FjaGUpDQogICAgZGVmIG1hcCA9IGdldFJlZkJvb2tWYWx1ZSg1MjAsIHJlY29yZElkKQ0KDQogICAgLy8g0LPRgNCw0YTQsCAyDQogICAgbmV3Um93Lm5hbWUgPSByZWNvcmRJZA0KICAgIGNvbEluZGV4KysNCg0KICAgIC8vINCz0YDQsNGE0LAgMw0KICAgIGlmIChtYXAgIT0gbnVsbCkgew0KICAgICAgICBkZWYgZXhwZWN0ZWRWYWx1ZXMgPSBbIG1hcC5JTk4/LnZhbHVlLCBtYXAuUkVHX05VTT8udmFsdWUsIG1hcC5UQVhfQ09ERV9JTkNPUlBPUkFUSU9OPy52YWx1ZSwgbWFwLlNXSUZUPy52YWx1ZSwgbWFwLktJTz8udmFsdWUgXQ0KICAgICAgICBleHBlY3RlZFZhbHVlcyA9IGV4cGVjdGVkVmFsdWVzLnVuaXF1ZSgpLmZpbmRBbGx7IGl0ICE9IG51bGwgJiYgaXQgIT0gJycgfQ0KICAgICAgICBmb3JtRGF0YVNlcnZpY2UuY2hlY2tSZWZlcmVuY2VWYWx1ZSh2YWx1ZXNbY29sSW5kZXhdLCBleHBlY3RlZFZhbHVlcywgZ2V0Q29sdW1uTmFtZShuZXdSb3csICdpa3NyJyksIG1hcC5OQU1FLnZhbHVlLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0LCBsb2dnZXIsIGZhbHNlKQ0KICAgIH0NCiAgICBjb2xJbmRleCsrDQoNCiAgICAvLyDQs9GA0LDRhNCwIDQNCiAgICBpZiAobWFwICE9IG51bGwpIHsNCiAgICAgICAgZGVmIGNvdW50cnlNYXAgPSBnZXRSZWZCb29rVmFsdWUoMTAsIG1hcC5DT1VOVFJZX0NPREU/LnJlZmVyZW5jZVZhbHVlKQ0KICAgICAgICBpZiAoY291bnRyeU1hcCAhPSBudWxsKSB7DQogICAgICAgICAgICBmb3JtRGF0YVNlcnZpY2UuY2hlY2tSZWZlcmVuY2VWYWx1ZSh2YWx1ZXNbY29sSW5kZXhdLCBbY291bnRyeU1hcC5DT0RFPy5zdHJpbmdWYWx1ZV0sIGdldENvbHVtbk5hbWUobmV3Um93LCAnY291bnRyeUNvZGUnKSwgbWFwLk5BTUUudmFsdWUsIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQsIGxvZ2dlciwgZmFsc2UpDQogICAgICAgIH0NCiAgICB9DQogICAgY29sSW5kZXgrKw0KDQogICAgLy8g0LPRgNCw0YTQsCA1DQogICAgbmV3Um93LnN1bSA9IHBhcnNlTnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQsIGxvZ2dlciwgdHJ1ZSkNCiAgICBjb2xJbmRleCsrDQoNCiAgICAvLyDQs9GA0LDRhNCwIDYNCiAgICBuZXdSb3cuZG9jTnVtYmVyID0gdmFsdWVzW2NvbEluZGV4XQ0KICAgIGNvbEluZGV4KysNCg0KICAgIC8vINCz0YDQsNGE0LAgNw0KICAgIG5ld1Jvdy5kb2NEYXRlID0gcGFyc2VEYXRlKHZhbHVlc1tjb2xJbmRleF0sICJkZC5NTS55eXl5IiwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCwgbG9nZ2VyLCB0cnVlKQ0KICAgIGNvbEluZGV4KysNCg0KICAgIC8vINCz0YDQsNGE0LAgOA0KICAgIG5ld1Jvdy5zZXJ2aWNlVHlwZSA9IHZhbHVlc1tjb2xJbmRleF0NCiAgICBjb2xJbmRleCsrDQoNCiAgICAvLyDQs9GA0LDRhNCwIDkNCiAgICBuZXdSb3cucHJpY2UgPSBwYXJzZU51bWJlcih2YWx1ZXNbY29sSW5kZXhdLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0LCBsb2dnZXIsIHRydWUpDQogICAgY29sSW5kZXgrKw0KDQogICAgLy8g0LPRgNCw0YTQsCAxMA0KICAgIG5ld1Jvdy5jb3N0ID0gcGFyc2VOdW1iZXIodmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCwgbG9nZ2VyLCB0cnVlKQ0KICAgIGNvbEluZGV4KysNCg0KICAgIC8vINCz0YDQsNGE0LAgMTENCiAgICBuZXdSb3cuZGVhbERvbmVEYXRlID0gcGFyc2VEYXRlKHZhbHVlc1tjb2xJbmRleF0sICJkZC5NTS55eXl5IiwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCwgbG9nZ2VyLCB0cnVlKQ0KDQogICAgcmV0dXJuIG5ld1Jvdw0KfQ0KDQp2b2lkIGltcG9ydFRyYW5zcG9ydERhdGEoKSB7DQogICAgY2hlY2tURihJbXBvcnRJbnB1dFN0cmVhbSwgVXBsb2FkRmlsZU5hbWUpDQoNCiAgICBpbnQgQ09MVU1OX0NPVU5UID0gMTENCiAgICBkZWYgREVGQVVMVF9DSEFSU0VUID0gImNwODY2Ig0KICAgIGNoYXIgU0VQQVJBVE9SID0gJ3wnDQogICAgY2hhciBRVU9URSA9ICdcMCcNCg0KICAgIFN0cmluZ1tdIHJvd0NlbGxzDQogICAgaW50IGZpbGVSb3dJbmRleCA9IDIgICAgLy8g0L3QvtC80LXRgCDRgdGC0YDQvtC60Lgg0LIg0YTQsNC50LvQtSAoMSwgMiwgLi4pDQogICAgaW50IHJvd0luZGV4ID0gMCAgICAgICAgLy8g0L3QvtC80LXRgCDRgdGC0YDQvtC60Lgg0LIg0J3QpCAoMSwgMiwgLi4pDQogICAgZGVmIG5ld1Jvd3MgPSBbXQ0KDQogICAgSW5wdXRTdHJlYW1SZWFkZXIgaXNyID0gbmV3IElucHV0U3RyZWFtUmVhZGVyKEltcG9ydElucHV0U3RyZWFtLCBERUZBVUxUX0NIQVJTRVQpDQogICAgQ1NWUmVhZGVyIHJlYWRlciA9IG5ldyBDU1ZSZWFkZXIoaXNyLCBTRVBBUkFUT1IsIFFVT1RFKQ0KICAgIHRyeSB7DQogICAgICAgIC8vINC/0YDQvtCy0LXRgNC40YLRjCDQv9C10YDQstGL0LUg0YHRgtGA0L7QutC4INGC0YQgLSDQt9Cw0LPQvtC70L7QstC+0Log0Lgg0L/Rg9GB0YLQsNGPINGB0YLRgNC+0LrQsA0KICAgICAgICBjaGVja0ZpcnN0Um93c1RGKHJlYWRlciwgbG9nZ2VyKQ0KDQogICAgICAgIC8vINCz0YDRg9C30LjQvCDQvtGB0L3QvtCy0L3Ri9C1INC00LDQvdC90YvQtQ0KICAgICAgICB3aGlsZSAoKHJvd0NlbGxzID0gcmVhZGVyLnJlYWROZXh0KCkpICE9IG51bGwpIHsNCiAgICAgICAgICAgIGZpbGVSb3dJbmRleCsrDQogICAgICAgICAgICByb3dJbmRleCsrDQogICAgICAgICAgICBpZiAoaXNFbXB0eUNlbGxzKHJvd0NlbGxzKSkgeyAvLyDQv9GA0L7QstC10YDQutCwINC+0LrQvtC90YfQsNC90LjRjyDQsdC70L7QutCwINC00LDQvdC90YvRhSwg0L/Rg9GB0YLQsNGPINGB0YLRgNC+0LrQsA0KICAgICAgICAgICAgICAgIGJyZWFrDQogICAgICAgICAgICB9DQogICAgICAgICAgICBkZWYgbmV3Um93ID0gZ2V0TmV3Um93KHJvd0NlbGxzLCBDT0xVTU5fQ09VTlQsIGZpbGVSb3dJbmRleCwgcm93SW5kZXgsIGZhbHNlKQ0KICAgICAgICAgICAgaWYgKG5ld1Jvdykgew0KICAgICAgICAgICAgICAgIG5ld1Jvd3MuYWRkKG5ld1JvdykNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0gZmluYWxseSB7DQogICAgICAgIHJlYWRlci5jbG9zZSgpDQogICAgfQ0KDQogICAgLy8g0L7RgtC+0LHRgNCw0LbQsNGC0Ywg0L7RiNC40LHQutC4INC/0LXRgNC10L/QvtC70L3QtdC90LjRjyDRgNCw0LfRgNGP0LTQsA0KICAgIHNob3dNZXNzYWdlcyhuZXdSb3dzLCBsb2dnZXIpDQoNCiAgICBpZiAoIWxvZ2dlci5jb250YWluc0xldmVsKExvZ0xldmVsLkVSUk9SKSkgew0KICAgICAgICB1cGRhdGVJbmRleGVzKG5ld1Jvd3MpDQogICAgICAgIGZvcm1EYXRhU2VydmljZS5nZXREYXRhUm93SGVscGVyKGZvcm1EYXRhKS5hbGxDYWNoZWQgPSBuZXdSb3dzDQogICAgfQ0KfQ0KLyoqDQogKiDQn9C+0LvRg9GH0LjRgtGMINC90L7QstGD0Y4g0YHRgtGA0L7QutGDINC90YQg0L/QviDRgdGC0YDQvtC60LUg0LjQtyDRgtGEICgqLnJudSkuDQogKg0KICogQHBhcmFtIHJvd0NlbGxzINGB0L/QuNGB0L7QuiDRgdGC0YDQvtC6INGB0L4g0LfQvdCw0YfQtdC90LjRj9C80LgNCiAqIEBwYXJhbSBjb2x1bW5Db3VudCDQutC+0LvQuNGH0LXRgdGC0LLQviDQutC+0LvQvtC90L7Qug0KICogQHBhcmFtIGZpbGVSb3dJbmRleCDQvdC+0LzQtdGAINGB0YLRgNC+0LrQuCDQsiDRgtGEDQogKiBAcGFyYW0gcm93SW5kZXgg0YHRgtGA0L7QutCwINCyINC90YQNCiAqIEBwYXJhbSBpc1RvdGFsINC/0YDQuNC30L3QsNC6INC40YLQvtCz0L7QstC+0Lkg0YHRgtGA0L7QutC4DQogKg0KICogQHJldHVybiDQstC10YDQvdC10YIg0YHRgtGA0L7QutGDINC90YQg0LjQu9C4IG51bGwsINC10YHQu9C4INC60L7Qu9C40YfQtdGB0YLQstC+INC30L3QsNGH0LXQvdC40Lkg0LIg0YHRgtGA0L7QutC1INGC0YQg0LzQtdC90YzRiNC1DQogKi8NCmRlZiBnZXROZXdSb3coU3RyaW5nW10gcm93Q2VsbHMsIGRlZiBjb2x1bW5Db3VudCwgZGVmIGZpbGVSb3dJbmRleCwgZGVmIHJvd0luZGV4LCBkZWYgaXNUb3RhbCkgew0KICAgIGRlZiBuZXdSb3cgPSBmb3JtRGF0YS5jcmVhdGVTdG9yZU1lc3NhZ2luZ0RhdGFSb3coKQ0KICAgIG5ld1Jvdy5zZXRJbmRleChyb3dJbmRleCkNCiAgICBuZXdSb3cuc2V0SW1wb3J0SW5kZXgoZmlsZVJvd0luZGV4KQ0KDQogICAgaWYgKHJvd0NlbGxzLmxlbmd0aCAhPSBjb2x1bW5Db3VudCArIDIpIHsNCiAgICAgICAgcm93RXJyb3IobG9nZ2VyLCBuZXdSb3csIFN0cmluZy5mb3JtYXQoUk9XX0ZJTEVfV1JPTkcsIGZpbGVSb3dJbmRleCkpDQogICAgICAgIHJldHVybiBudWxsDQogICAgfQ0KDQogICAgZWRpdGFibGVDb2x1bW5zLmVhY2ggew0KICAgICAgICBuZXdSb3cuZ2V0Q2VsbChpdCkuZWRpdGFibGUgPSB0cnVlDQogICAgICAgIG5ld1Jvdy5nZXRDZWxsKGl0KS5zZXRTdHlsZUFsaWFzKCfQoNC10LTQsNC60YLQuNGA0YPQtdC80LDRjycpDQogICAgfQ0KICAgIGF1dG9GaWxsQ29sdW1ucy5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLnNldFN0eWxlQWxpYXMoJ9CQ0LLRgtC+0LfQsNC/0L7Qu9C90Y/QtdC80LDRjycpDQogICAgfQ0KDQogICAgZGVmIGludCBjb2xPZmZzZXQgPSAxDQoNCiAgICBpZiAoIWlzVG90YWwpIHsNCiAgICAgICAgZGVmIFN0cmluZyBpa3NyTmFtZSA9IGdldENvbHVtbk5hbWUobmV3Um93LCAnaWtzcicpDQogICAgICAgIGRlZiBuYW1lRnJvbUZpbGUgPSBwdXJlKHJvd0NlbGxzWzJdKQ0KICAgICAgICBkZWYgcmVjb3JkSWQgPSBnZXRUY29SZWNvcmRJZChuYW1lRnJvbUZpbGUsICBwdXJlKHJvd0NlbGxzWzNdKSwgaWtzck5hbWUsIGZpbGVSb3dJbmRleCwgMiwgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpLCBmYWxzZSwgbG9nZ2VyLCByZWZCb29rRmFjdG9yeSwgcmVjb3JkQ2FjaGUpDQogICAgICAgIGRlZiBtYXAgPSBnZXRSZWZCb29rVmFsdWUoNTIwLCByZWNvcmRJZCkNCg0KICAgICAgICAvLyDQs9GA0LDRhNCwIDINCiAgICAgICAgbmV3Um93Lm5hbWUgPSByZWNvcmRJZA0KICAgICAgICAvLyDQs9GA0LDRhNCwIDMNCiAgICAgICAgaWYgKG1hcCAhPSBudWxsKSB7DQogICAgICAgICAgICBkZWYgZXhwZWN0ZWRWYWx1ZXMgPSBbIG1hcC5JTk4/LnZhbHVlLCBtYXAuUkVHX05VTT8udmFsdWUsIG1hcC5UQVhfQ09ERV9JTkNPUlBPUkFUSU9OPy52YWx1ZSwgbWFwLlNXSUZUPy52YWx1ZSwgbWFwLktJTz8udmFsdWUgXQ0KICAgICAgICAgICAgZXhwZWN0ZWRWYWx1ZXMgPSBleHBlY3RlZFZhbHVlcy51bmlxdWUoKS5maW5kQWxseyBpdCAhPSBudWxsICYmIGl0ICE9ICcnIH0NCiAgICAgICAgICAgIGZvcm1EYXRhU2VydmljZS5jaGVja1JlZmVyZW5jZVZhbHVlKHB1cmUocm93Q2VsbHNbM10pLCBleHBlY3RlZFZhbHVlcywgZ2V0Q29sdW1uTmFtZShuZXdSb3csICdpa3NyJyksIG1hcC5OQU1FLnZhbHVlLCBmaWxlUm93SW5kZXgsIDMgKyBjb2xPZmZzZXQsIGxvZ2dlciwgZmFsc2UpDQogICAgICAgIH0NCiAgICAgICAgLy8g0LPRgNCw0YTQsCA0DQogICAgICAgIGlmIChtYXAgIT0gbnVsbCkgew0KICAgICAgICAgICAgZGVmIGNvdW50cnlNYXAgPSBnZXRSZWZCb29rVmFsdWUoMTAsIG1hcC5DT1VOVFJZX0NPREU/LnJlZmVyZW5jZVZhbHVlKQ0KICAgICAgICAgICAgaWYgKGNvdW50cnlNYXAgIT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIGZvcm1EYXRhU2VydmljZS5jaGVja1JlZmVyZW5jZVZhbHVlKHB1cmUocm93Q2VsbHNbNF0pLCBbY291bnRyeU1hcC5DT0RFPy5zdHJpbmdWYWx1ZV0sIGdldENvbHVtbk5hbWUobmV3Um93LCAnY291bnRyeUNvZGUnKSwgbWFwLk5BTUUudmFsdWUsIGZpbGVSb3dJbmRleCwgNCArIGNvbE9mZnNldCwgbG9nZ2VyLCBmYWxzZSkNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICAvLyDQs9GA0LDRhNCwIDYNCiAgICAgICAgbmV3Um93LmRvY051bWJlciA9IHB1cmUocm93Q2VsbHNbNl0pDQogICAgICAgIC8vINCz0YDQsNGE0LAgNw0KICAgICAgICBuZXdSb3cuZG9jRGF0ZSA9IHBhcnNlRGF0ZShwdXJlKHJvd0NlbGxzWzddKSwgImRkLk1NLnl5eXkiLCBmaWxlUm93SW5kZXgsIDcgKyBjb2xPZmZzZXQsIGxvZ2dlciwgdHJ1ZSkNCiAgICAgICAgLy8g0LPRgNCw0YTQsCA4DQogICAgICAgIG5ld1Jvdy5zZXJ2aWNlVHlwZSA9IHB1cmUocm93Q2VsbHNbOF0pDQogICAgICAgIC8vINCz0YDQsNGE0LAgMTENCiAgICAgICAgbmV3Um93LmRlYWxEb25lRGF0ZSA9IHBhcnNlRGF0ZShw'
        longString += 'dXJlKHJvd0NlbGxzWzExXSksICJkZC5NTS55eXl5IiwgZmlsZVJvd0luZGV4LCAxMSArIGNvbE9mZnNldCwgbG9nZ2VyLCB0cnVlKQ0KICAgICAgICAvLyDQs9GA0LDRhNCwIDkNCiAgICAgICAgbmV3Um93LnByaWNlID0gcGFyc2VOdW1iZXIocHVyZShyb3dDZWxsc1s5XSksIGZpbGVSb3dJbmRleCwgOSArIGNvbE9mZnNldCwgbG9nZ2VyLCB0cnVlKQ0KICAgIH0NCiAgICAvLyDQs9GA0LDRhNCwIDUNCiAgICBuZXdSb3cuc3VtID0gcGFyc2VOdW1iZXIocHVyZShyb3dDZWxsc1s1XSksIGZpbGVSb3dJbmRleCwgNSArIGNvbE9mZnNldCwgbG9nZ2VyLCB0cnVlKQ0KICAgIC8vINCz0YDQsNGE0LAgMTANCiAgICBuZXdSb3cuY29zdCA9IHBhcnNlTnVtYmVyKHB1cmUocm93Q2VsbHNbMTBdKSwgZmlsZVJvd0luZGV4LCAxMCArIGNvbE9mZnNldCwgbG9nZ2VyLCB0cnVlKQ0KDQogICAgcmV0dXJuIG5ld1Jvdw0KfQ0KDQpTdHJpbmcgcHVyZShTdHJpbmcgY2VsbCkgew0KICAgIHJldHVybiBTdHJpbmdVdGlscy5jbGVhblN0cmluZyhjZWxsKT8uaW50ZXJuKCkNCn0NCg0KLy8g0KHQvtGA0YLQuNGA0L7QstC60LAg0LPRgNGD0L/QvyDQuCDRgdGC0YDQvtC6DQp2b2lkIHNvcnRGb3JtRGF0YVJvd3MoZGVmIHNhdmVJbkRCID0gdHJ1ZSkgew0KICAgIGRlZiBkYXRhUm93SGVscGVyID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpDQogICAgZGVmIGRhdGFSb3dzID0gZGF0YVJvd0hlbHBlci5hbGxDYWNoZWQNCiAgICBzb3J0Um93cyhyZWZCb29rU2VydmljZSwgbG9nZ2VyLCBkYXRhUm93cywgbnVsbCwgbnVsbCwgbnVsbCkNCiAgICBpZiAoc2F2ZUluREIpIHsNCiAgICAgICAgZGF0YVJvd0hlbHBlci5zYXZlU29ydCgpDQogICAgfSBlbHNlIHsNCiAgICAgICAgdXBkYXRlSW5kZXhlcyhkYXRhUm93cykNCiAgICB9DQp9DQoNCnZvaWQgYWZ0ZXJMb2FkKCkgew0KICAgIGlmIChiaW5kaW5nLnZhcmlhYmxlcy5jb250YWluc0tleSgic3BlY2lhbFBlcmlvZCIpKSB7DQogICAgICAgIC8vINC40LzRjyDQv9C10YDQuNC+0LTQsCDQuCDQutC+0L3QtdGH0L3QsNGPINC00LDRgtCwINC60L7RgNGA0LXQutGC0L3Riw0KICAgICAgICAvLyDRg9GB0YLQsNC90LDQstC70LjQstCw0LXQvCDQtNCw0YLRgyDQtNC70Y8g0YHQv9GA0LDQstC+0YfQvdC40LrQvtCyDQogICAgICAgIHNwZWNpYWxQZXJpb2QuY2FsZW5kYXJTdGFydERhdGUgPSByZXBvcnRQZXJpb2RTZXJ2aWNlLmdldFN0YXJ0RGF0ZShmb3JtRGF0YS5yZXBvcnRQZXJpb2RJZCkudGltZQ0KICAgIH0NCn0='

        addLongText(form_template_id, longString, 'SCRIPT')
        logger.info("К версии макета добавлен скрипт")
    }

} catch (Exception ex) {
    logger.error("Error: ${ex.getLocalizedMessage()}. Все действия, выполненные скриптом, были отменены")
}

def void addLongText (def form_template_id, String longString, String alias) {
    final int MAX_LENGTH = 2000
    namedParameterJdbcTemplate.update("UPDATE FORM_TEMPLATE SET $alias = null where id = $form_template_id", [:])
    int start = 0
    longString = new String(longString.decodeBase64(), "UTF-8")
    while (start < longString.length()) {
        int end = (start + MAX_LENGTH) < longString.length() ? (start + MAX_LENGTH) : longString.length()
        String text = longString.substring(start, end)
       namedParameterJdbcTemplate.update('UPDATE FORM_TEMPLATE SET ' + alias + ' = ' + alias + ' || :text where id = ' +form_template_id, ['text' : text])
        start += MAX_LENGTH
    }
}