/**
 * https://jira.aplana.com/browse/SBRFACCTAX-15581
 * Скрипт обновления макета id = 848 "(724.1.1) Корректировка сумм НДС и налоговых вычетов за прошедшие налоговые периоды".
 * Обновляются столбцы и скрипт макета.
 *
 * # Инструкция:
 * Вставить текст данного скрипта на странице, соответствующей ссылке с окончанием:
 * .../gwtapp/#!scriptExecution
 * Нажать "Выполнить".
 */

try {
    def form_template_id = 848

    // обновление размерности столбцов
    def sql = "UPDATE form_column SET max_length = 19 WHERE form_template_id = 848 AND alias in ('sumPlus', 'sumMinus', 'sumNdsPlus', 'sumNdsMinus', 'sum')"
    namedParameterJdbcTemplate.update(sql, [:])
    logger.info('Обновлены столбцы макета "(724.1.1) Корректировка сумм НДС и налоговых вычетов за прошедшие налоговые периоды".')

    // обновление скрипта макета
    longString = ''
    longString += 'cGFja2FnZSBmb3JtX3RlbXBsYXRlLnZhdC52YXRfNzI0XzFfMS52MjAxNQ0KDQppbXBvcnQgY29tLmFwbGFuYS5zYnJmLnRheGFjY291bnRpbmcuZGFvLmltcGwudXRpbC5TcWxVdGlscw0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLkRlY2xhcmF0aW9uRGF0YQ0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLkRlcGFydG1lbnRSZXBvcnRQZXJpb2QNCmltcG9ydCBjb20uYXBsYW5hLnNicmYudGF4YWNjb3VudGluZy5tb2RlbC5Gb3JtRGF0YUV2ZW50DQppbXBvcnQgY29tLmFwbGFuYS5zYnJmLnRheGFjY291bnRpbmcubW9kZWwuRm9ybURhdGFLaW5kDQppbXBvcnQgY29tLmFwbGFuYS5zYnJmLnRheGFjY291bnRpbmcubW9kZWwuVGF4VHlwZQ0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLldvcmtmbG93U3RhdGUNCmltcG9ydCBjb20uYXBsYW5hLnNicmYudGF4YWNjb3VudGluZy5tb2RlbC5leGNlcHRpb24uU2VydmljZUV4Y2VwdGlvbg0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLmxvZy5Mb2dMZXZlbA0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLnV0aWwuRGVwYXJ0bWVudFJlcG9ydFBlcmlvZEZpbHRlcg0KaW1wb3J0IG9yZy5hcGFjaGUuY29tbW9ucy5sYW5nMy5TdHJpbmdVdGlscw0KaW1wb3J0IGdyb292eS50cmFuc2Zvcm0uRmllbGQNCmltcG9ydCBvcmcuc3ByaW5nZnJhbWV3b3JrLmpkYmMuY29yZS5Sb3dNYXBwZXINCg0KaW1wb3J0IGphdmF4LnhtbC5zdHJlYW0uWE1MU3RyZWFtUmVhZGVyDQppbXBvcnQgamF2YS5zcWwuUmVzdWx0U2V0DQppbXBvcnQgamF2YS5zcWwuU1FMRXhjZXB0aW9uDQoNCi8qKg0KICogKDcyNC4xLjEpINCa0L7RgNGA0LXQutGC0LjRgNC+0LLQutCwINGB0YPQvNC8INCd0JTQoSDQuCDQvdCw0LvQvtCz0L7QstGL0YUg0LLRi9GH0LXRgtC+0LIg0LfQsCDQv9GA0L7RiNC10LTRiNC40LUg0L3QsNC70L7Qs9C+0LLRi9C1INC/0LXRgNC40L7QtNGLDQogKg0KICogZm9ybVRlbXBsYXRlSWQ9ODQ4DQogKi8NCg0KLy8g0LPRgNCw0YTQsCAxICAtIHJvd051bQ0KLy8g0LPRgNCw0YTQsCAgICAtIGZpeA0KLy8g0LPRgNCw0YTQsCAyICAtIHBlcmlvZA0KLy8g0LPRgNCw0YTQsCAzICAtIG51bWJlcg0KLy8g0LPRgNCw0YTQsCA0ICAtIHN1bVBsdXMNCi8vINCz0YDQsNGE0LAgNSAgLSBzdW1NaW51cw0KLy8g0LPRgNCw0YTQsCA2ICAtIG51bWJlck5kcw0KLy8g0LPRgNCw0YTQsCA3ICAtIHN1bU5kc1BsdXMNCi8vINCz0YDQsNGE0LAgOCAgLSBzdW1OZHNNaW51cw0KLy8g0LPRgNCw0YTQsCA5ICAtIHJhdGVOZHMNCi8vINCz0YDQsNGE0LAgMTAgLSBzdW0NCg0Kc3dpdGNoIChmb3JtRGF0YUV2ZW50KSB7DQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LkNSRUFURToNCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLmNoZWNrVW5pcXVlKGZvcm1EYXRhLCBsb2dnZXIpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LkNBTENVTEFURToNCiAgICAgICAgcHJlQ2FsY0NoZWNrKCkNCiAgICAgICAgY2hlY2tGaWxsRGVjbGFyYXRpb25NYXAodHJ1ZSkNCiAgICAgICAgaWYgKCFsb2dnZXIuY29udGFpbnNMZXZlbChMb2dMZXZlbC5FUlJPUikpIHsNCiAgICAgICAgICAgIGNhbGMoKQ0KICAgICAgICAgICAgbG9naWNDaGVjaygpDQogICAgICAgIH0NCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLnNhdmVDYWNoZWREYXRhUm93cyhmb3JtRGF0YSwgbG9nZ2VyLCBmb3JtRGF0YUV2ZW50LCBzY3JpcHRTdGF0dXNIb2xkZXIpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LkNIRUNLOg0KICAgICAgICBsb2dpY0NoZWNrKCkNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQUREX1JPVzoNCiAgICAgICAgYWRkUm93KCkNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuREVMRVRFX1JPVzoNCiAgICAgICAgaWYgKGN1cnJlbnREYXRhUm93ICE9IG51bGwgJiYgY3VycmVudERhdGFSb3cuZ2V0QWxpYXMoKSA9PSBudWxsKSB7DQogICAgICAgICAgICBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSk/LmRlbGV0ZShjdXJyZW50RGF0YVJvdykNCiAgICAgICAgfQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX0NSRUFURURfVE9fUFJFUEFSRUQ6ICAvLyDQn9C+0LTQs9C+0YLQvtCy0LjRgtGMINC40LcgItCh0L7Qt9C00LDQvdCwIg0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX0NSRUFURURfVE9fQVBQUk9WRUQ6ICAvLyDQo9GC0LLQtdGA0LTQuNGC0Ywg0LjQtyAi0KHQvtC30LTQsNC90LAiDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfQ1JFQVRFRF9UT19BQ0NFUFRFRDogIC8vINCf0YDQuNC90Y/RgtGMINC40LcgItCh0L7Qt9C00LDQvdCwIg0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX1BSRVBBUkVEX1RPX0FQUFJPVkVEOiAvLyDQo9GC0LLQtdGA0LTQuNGC0Ywg0LjQtyAi0J/QvtC00LPQvtGC0L7QstC70LXQvdCwIg0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX1BSRVBBUkVEX1RPX0FDQ0VQVEVEOiAvLyDQn9GA0LjQvdGP0YLRjCDQuNC3ICLQn9C+0LTQs9C+0YLQvtCy0LvQtdC90LAiDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfQVBQUk9WRURfVE9fQUNDRVBURUQ6IC8vINCf0YDQuNC90Y/RgtGMINC40LcgItCj0YLQstC10YDQttC00LXQvdCwIg0KICAgICAgICBsb2dpY0NoZWNrKCkNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuTU9WRV9BQ0NFUFRFRF9UT19BUFBST1ZFRDoNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuTU9WRV9BQ0NFUFRFRF9UT19DUkVBVEVEOg0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX0FDQ0VQVEVEX1RPX1BSRVBBUkVEOg0KICAgICAgICBjaGVja0RlY2xhcmF0aW9uQWNjZXB0ZWQoKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5DT01QT1NFOg0KICAgICAgICBjb25zb2xpZGF0aW9uKCkNCiAgICAgICAgY2hlY2tGaWxsRGVjbGFyYXRpb25NYXAoZmFsc2UpDQogICAgICAgIGNhbGMoKQ0KICAgICAgICBsb2dpY0NoZWNrKCkNCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLnNhdmVDYWNoZWREYXRhUm93cyhmb3JtRGF0YSwgbG9nZ2VyKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5JTVBPUlQ6DQogICAgICAgIGltcG9ydERhdGEoKQ0KICAgICAgICBmb3JtRGF0YVNlcnZpY2Uuc2F2ZUNhY2hlZERhdGFSb3dzKGZvcm1EYXRhLCBsb2dnZXIpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LlNPUlRfUk9XUzoNCiAgICAgICAgc29ydEZvcm1EYXRhUm93cygpDQogICAgICAgIGJyZWFrDQp9DQoNCi8vLy8g0JrRjdGI0Lgg0Lgg0LrQvtC90YHRgtCw0L3RgtGLDQpARmllbGQNCmRlZiBwcm92aWRlckNhY2hlID0gWzpdDQpARmllbGQNCmRlZiByZWNvcmRDYWNoZSA9IFs6XQ0KQEZpZWxkDQpkZWYgcmVmQm9va0NhY2hlID0gWzpdDQoNCi8vINCy0YHQtSDQsNGC0YDQuNCx0YPRgtGLDQpARmllbGQNCmRlZiBhbGxDb2x1bW5zID0gWydyb3dOdW0nLCAnZml4JywgJ3BlcmlvZCcsICdudW1iZXInLCAnc3VtUGx1cycsICdzdW1NaW51cycsICdudW1iZXJOZHMnLCAnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cycsICdyYXRlTmRzJywgJ3N1bSddDQoNCi8vINCg0LXQtNCw0LrRgtC40YDRg9C10LzRi9C1INCw0YLRgNC40LHRg9GC0YsgKNCz0YDQsNGE0LAgMiwzLDYtOCkg0L3QtSDQtNC70Y8g0YDQsNC30LTQtdC70L7QsiAxLTYNCkBGaWVsZA0KZGVmIGVkaXRhYmxlQ29sdW1ucyA9IFsncGVyaW9kJywgJ251bWJlcicsICdudW1iZXJOZHMnLCAnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cyddDQoNCi8vINCg0LXQtNCw0LrRgtC40YDRg9C10LzRi9C1INCw0YLRgNC40LHRg9GC0YsgKNCz0YDQsNGE0LAgMi04KSDQtNC70Y8g0YDQsNC30LTQtdC70L7QsiAxLTYNCkBGaWVsZA0KZGVmIGVkaXRhYmxlQ29sdW1uc18xXzYgPSBbJ3BlcmlvZCcsICdudW1iZXInLCAnc3VtUGx1cycsICdzdW1NaW51cycsICdudW1iZXJOZHMnLCAnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cyddDQoNCi8vINCf0YDQvtCy0LXRgNGP0LXQvNGL0LUg0L3QsCDQv9GD0YHRgtGL0LUg0LfQvdCw0YfQtdC90LjRjyDQsNGC0YDQuNCx0YPRgtGLICjQs9GA0LDRhNCwIDIsIDMsIDksIDEwKQ0KQEZpZWxkDQpkZWYgbm9uRW1wdHlDb2x1bW5zID0gWydwZXJpb2QnLCAnbnVtYmVyJywgJ3JhdGVOZHMnLCAnc3VtJ10NCg0KQEZpZWxkDQpkZWYgZW1wdHlDb2x1bW5zXzdfOSA9IFsnc3VtUGx1cycsICdzdW1NaW51cyddDQoNCi8vINCQ0YLRgNC40LHRg9GC0Ysg0LjRgtC+0LPQvtCy0YvRhSDRgdGC0YDQvtC6INC00LvRjyDQutC+0YLQvtGA0YvRhSDQstGL0YfQuNGB0LvRj9GO0YLRgdGPINGB0YPQvNC80YsNCi8vINC00LvRjyDQs9GA0YPQv9C/IDEgLSA2LCAi0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/RgNC+0LTQsNC2Li4uIiAo0LPRgNCw0YTQsCA0LCA1LCA3LCA4LCAxMCkNCkBGaWVsZA0KZGVmIHRvdGFsQ29sdW1uczFfNl9TYWxlID0gWydzdW1QbHVzJywgJ3N1bU1pbnVzJywgJ3N1bU5kc1BsdXMnLCAnc3VtTmRzTWludXMnLCAnc3VtJ10NCg0KLy8g0LTQu9GPINCz0YDRg9C/0L/RiyAi0JLQodCV0JPQniDQv9C+INGA0LDQt9C00LXQu9Cw0LwgMS02IiAo0LPRgNCw0YTQsCA3LCA4KQ0KQEZpZWxkDQpkZWYgdG90YWxDb2x1bW5zTWVnYSA9IFsnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cyddDQoNCi8vINC00LvRjyDQs9GA0YPQv9C/0YsgNywgOCwgOSwgItCS0KHQldCT0J4g0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3QvtC80YMg0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0L7QutGD0L/QvtC6Li4uIiAo0LPRgNCw0YTQsCA3LCA4LCAxMCkNCkBGaWVsZA0KZGVmIHRvdGFsQ29sdW1uczdfOV9QdXJjaGFzZSA9IFsnc3VtTmRzUGx1cycsICdzdW1OZHNNaW51cycsICdzdW0nXQ0KDQpARmllbGQNCmRlZiBza2lwQ29sdW1ucyA9IFsnc3VtTWludXMnLCAnc3VtTmRzTWludXMnXQ0KDQpARmllbGQNCmRlZiBza2lwQ29sdW1uc0RlY2xhcmF0aW9uID0gWydzdW1NaW51cycsICdzdW1OZHNNaW51cycsICdzdW0nXQ0KDQovLyDQk9GA0YPQv9C/0LjRgNGD0LXQvNGL0LUg0LDRgtGA0LjQsdGD0YLRiyAo0LPRgNCw0YTQsCAyKQ0KQEZpZWxkDQpkZWYgZ3JvdXBDb2x1bW5zID0gWydwZXJpb2QnXQ0KDQovLyDQodC+0YDRgtC40YDRg9C10LzRi9C1INCw0YLRgNC40LHRg9GC0YsgKNCz0YDQsNGE0LAgMiwgNiwgMykNCkBGaWVsZA0KZGVmIHNvcnRDb2x1bW5zID0gWydwZXJpb2QnLCAnbnVtYmVyTmRzJywgJ251bWJlciddDQoNCi8vINGB0L/QuNGB0L7QuiDQsNC70LjQsNGB0L7QsiDQv9C+0LTRgNCw0LfQtNC10LvQvtCyDQpARmllbGQNCmRlZiBzZWN0aW9ucyA9IFsnMScsICcyJywgJzMnLCAnNCcsICc1JywgJzYnLCAnNycsICc4JywgJzknXQ0KDQpARmllbGQNCmRlZiByYXRlTWFwID0gWw0KICAgICAgICAnMScgOiBbJzE4JywgJzEnXSwNCiAgICAgICAgJzInIDogWycxMCcsICcyJ10sDQogICAgICAgICczJyA6IFsnMTgvMTE4JywgJzMsIDUtOSddLA0KICAgICAgICAnNCcgOiBbJzEwLzExMCcsICc0J10sDQogICAgICAgICc1JyA6IFsnMTgvMTE4JywgJzMsIDUtOSddLA0KICAgICAgICAnNicgOiBbJzE4LzExOCcsICczLCA1LTknXSwNCiAgICAgICAgJzcnIDogWycxOC8xMTgnLCAnMywgNS05J10sDQogICAgICAgICc4JyA6IFsnMTgvMTE4JywgJzMsIDUtOSddLA0KICAgICAgICAnOScgOiBbJzE4LzExOCcsICczLCA1LTknXQ0KXQ0KDQpARmllbGQNCmRlZiBudW1iZXJNYXAgPSBbICcxJyA6IFtbJzYwMzA5MDEnXSwgJzEtNCddLA0KICAgICAgICAgICAgICAgICAgJzInIDogW1snNjAzMDkwMSddLCAnMS00J10sDQogICAgICAgICAgICAgICAgICAnMycgOiBbWyc2MDMwOTAxJ10sICcxLTQnXSwNCiAgICAgICAgICAgICAgICAgICc0JyA6IFtbJzYwMzA5MDEnXSwgJzEtNCddLA0KICAgICAgICAgICAgICAgICAgJzUnIDogW1snNjAzMDkwNCddLCAnNSddLA0KICAgICAgICAgICAgICAgICAgJzYnIDogW1snNjAzMDkwNSddLCAnNiddLA0KICAgICAgICAgICAgICAgICAgJzcnIDogW1snNjAzMDkwMyddLCAnNywgOSddLA0KICAgICAgICAgICAgICAgICAgJzgnIDogW1snNjAzMDkwMScsICc2MDMwOTA0JywgJzYwMzA5MDUnXSwgJzgnXSwNCiAgICAgICAgICAgICAgICAgICc5JyA6IFtbJzYwMzA5MDMnXSwgJzcsIDknXQ0KXQ0KDQpARmllbGQNCmRlZiBzZWN0aW9uc0xhYmVscyA9IFsnc2FsZV8xOCcgOiAi0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/RgNC+0LTQsNC2INC30LAgJXMg0L/QviDRgdGC0LDQstC60LUgMTglJSIsDQogICAgICAgICAgICAgICAgICAgICAgJ3NhbGVfMTAnIDogItCS0KHQldCT0J4g0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3QvtC80YMg0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0YDQvtC00LDQtiDQt9CwICVzINC/0L4g0YHRgtCw0LLQutC1IDEwJSUiLA0KICAgICAgICAgICAgICAgICAgICAgICdwdXJjaGFzZScgOiAi0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/QvtC60YPQv9C+0Log0LfQsCAlcyDQv9C+INGB0YLQsNCy0LrQtSAxOCUlIl0NCg0KQEZpZWxkDQpkZWYgc3RhcnREYXRlID0gbnVsbA0KDQpARmllbGQNCmRlZiBlbmREYXRlID0gbnVsbA0KDQpkZWYgZ2V0UmVwb3J0UGVyaW9kU3RhcnREYXRlKCkgew0KICAgIGlmIChzdGFydERhdGUgPT0gbnVsbCkgew0KICAgICAgICBzdGFydERhdGUgPSByZXBvcnRQZXJpb2RTZXJ2aWNlLmdldENhbGVuZGFyU3RhcnREYXRlKGZvcm1EYXRhLnJlcG9ydFBlcmlvZElkKS50aW1lDQogICAgfQ0KICAgIHJldHVybiBzdGFydERhdGUNCn0NCg0KZGVmIGdldFJlcG9ydFBlcmlvZEVuZERhdGUoKSB7DQogICAgaWYgKGVuZERhdGUgPT0gbnVsbCkgew0KICAgICAgICBlbmREYXRlID0gcmVwb3J0UGVyaW9kU2VydmljZS5nZXRFbmREYXRlKGZvcm1EYXRhLnJlcG9ydFBlcmlvZElkKS50aW1lDQogICAgfQ0KICAgIHJldHVybiBlbmREYXRlDQp9DQoNCi8vINCf0L7QuNGB0Log0LfQsNC/0LjRgdC4INCyINGB0L/RgNCw0LLQvtGH0L3QuNC60LUg0L/QviDQt9C90LDRh9C10L3QuNGOICjQtNC70Y8g0YDQsNGB0YfQtdGC0L7QsikgKyDQv9C+INC00LDRgtC1DQpkZWYgZ2V0UmVmQm9va1JlY29yZChkZWYgTG9uZyByZWZCb29rSWQsIGRlZiBTdHJpbmcgYWxpYXMsIGRlZiBTdHJpbmcgdmFsdWUsIGRlZiBEYXRlIGRheSwgZGVmIGludCByb3dJbmRleCwgZGVmIFN0cmluZyBjZWxsTmFtZSwNCiAgICAgICAgICAgICAgICAgICAgIGJvb2xlYW4gcmVxdWlyZWQpIHsNCiAgICByZXR1cm4gZm9ybURhdGFTZXJ2aWNlLmdldFJlZkJvb2tSZWNvcmQocmVmQm9va0lkLCByZWNvcmRDYWNoZSwgcHJvdmlkZXJDYWNoZSwgcmVmQm9va0NhY2hlLCBhbGlhcywgdmFsdWUsDQogICAgICAgICAgICBkYXksIHJvd0luZGV4LCBjZWxsTmFtZSwgbG9nZ2VyLCByZXF1aXJlZCkNCn0NCg0KLy8g0J/QvtC40YHQuiDQt9Cw0L/QuNGB0Lgg0LIg0YHQv9GA0LDQstC+0YfQvdC40LrQtSDQv9C+INC30L3QsNGH0LXQvdC40Y4gKNC00LvRjyDQuNC80L/QvtGA0YLQsCkNCmRlZiBnZXRSZWNvcmRJZEltcG9ydChkZWYgTG9uZyByZWZCb29rSWQsIGRlZiBTdHJpbmcgYWxpYXMsIGRlZiBTdHJpbmcgdmFsdWUsIGRlZiBpbnQgcm93SW5kZXgsIGRlZiBpbnQgY29sSW5kZXgsDQogICAgICAgICAgICAgICAgICAgICAgZGVmIGJvb2xlYW4gcmVxdWlyZWQgPSBmYWxzZSkgew0KICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlLnRyaW0oKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgcmV0dXJuIG51bGwNCiAgICB9DQogICAgcmV0dXJuIGZvcm1EYXRhU2VydmljZS5nZXRSZWZCb29rUmVjb3JkSWRJbXBvcnQocmVmQm9va0lkLCByZWNvcmRDYWNoZSwgcHJvdmlkZXJDYWNoZSwgYWxpYXMsIHZhbHVlLA0KICAgICAgICAgICAgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpLCByb3dJbmRleCwgY29sSW5kZXgsIGxvZ2dlciwgcmVxdWlyZWQpDQp9DQoNCi8vINCg0LDQt9GL0LzQtdC90L7QstCw0L3QuNC1INC30LDQv9C40YHQuCDRgdC/0YDQsNCy0L7Rh9C90LjQutCwDQpkZWYgZ2V0UmVmQm9va1ZhbHVlKGRlZiBsb25nIHJlZkJvb2tJZCwgZGVmIExvbmcgcmVjb3JkSWQpIHsNCiAgICByZXR1cm4gZm9ybURhdGFTZXJ2aWNlLmdldFJlZkJvb2tWYWx1ZShyZWZCb29rSWQsIHJlY29yZElkLCByZWZCb29rQ2FjaGUpDQp9DQoNCi8vINCf0L7Qu9GD0YfQtdC90LjQtSDRh9C40YHQu9CwINC40Lcg0YHRgtGA0L7QutC4INC/0YDQuCDQuNC80L/QvtGA0YLQtQ0KZGVmIGdldE51bWJlcihkZWYgdmFsdWUsIGRlZiBpbmRleFJvdywgZGVmIGluZGV4Q29sKSB7DQogICAgcmV0dXJuIHBhcnNlTnVtYmVyKHZhbHVlLCBpbmRleFJvdywgaW5kZXhDb2wsIGxvZ2dlciwgdHJ1ZSkNCn0NCg0KLy8vLyDQmtCw0YHRgtC+0LzQvdGL0LUg0LzQtdGC0L7QtNGLDQpkZWYgYWRkUm93KCkgew0KICAgIGRlZiBkYXRhUm93SGVscGVyID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpDQogICAgZGVmIGRhdGFSb3dzID0gZGF0YVJvd0hlbHBlci5hbGxDYWNoZWQNCiAgICBkZWYgaW5kZXgNCiAgICBib29sZWFuIGlzR3JvdXBfMV82ID0gZmFsc2UNCiAgICBpZiAoY3VycmVudERhdGFSb3cgIT0gbnVsbCkgew0KICAgICAgICBkZWYgYWxpYXMgPSBjdXJyZW50RGF0YVJvdy5nZXRBbGlhcygpDQogICAgICAgIGluZGV4ID0gY3VycmVudERhdGFSb3cuZ2V0SW5kZXgoKQ0KICAgICAgICBpZiAoYWxpYXMgPT0gbnVsbCB8fCBhbGlhcy5zdGFydHNXaXRoKCdoZWFkJykpIHsNCiAgICAgICAgICAgIGluZGV4KysNCiAgICAgICAgfQ0KICAgICAgICBpZiAoYWxpYXMgIT0gbnVsbCAmJiBhbGlhcyA9PSAibWVnYV90b3RhbCIpIHsNCiAgICAgICAgICAgIGluZGV4ICs9IDINCiAgICAgICAgfQ0KICAgICAgICBpc0dyb3VwXzFfNiA9IGdldERhdGFSb3coZGF0YVJvd3MsICdtZWdhX3RvdGFsJykuZ2V0SW5kZXgoKSA+IGN1cnJlbnREYXRhUm93LmdldEluZGV4KCkNCiAgICB9IGVsc2Ugew0KICAgICAgICBpbmRleCA9IGRhdGFSb3dzLnNpemUoKSArIDENCiAgICB9DQogICAgZGF0YVJvd0hlbHBlci5pbnNlcnQoZ2V0TmV3Um93KGlzR3JvdXBfMV82KSwgaW5kZXgpDQp9DQoNCi8qKiDQn9C+0LvRg9GH0LjRgtGMINC90L7QstGD0Y4g0YHRgtGA0L7QutGDINGBINC30LDQtNCw0L3QvdGL0LzQuCDRgdGC0LjQu9GP0LzQuC4gKi8NCmRlZiBnZXROZXdSb3coYm9vbGVhbiBpc0dyb3VwXzFfNikgew0KICAgIGRlZiBuZXdSb3cgPSAoZm9ybURhdGFFdmVudCBpbiBbRm9ybURhdGFFdmVudC5JTVBPUlQsIEZvcm1EYXRhRXZlbnQuSU1QT1JUX1RSQU5TUE9SVF9GSUxFXSkgPyBmb3JtRGF0YS5jcmVhdGVTdG9yZU1lc3NhZ2luZ0RhdGFSb3coKSA6IGZvcm1EYXRhLmNyZWF0ZURhdGFSb3coKQ0KICAgIGRlZiBjb2x1bW5zID0gaXNHcm91cF8xXzYgPyBlZGl0YWJsZUNvbHVtbnNfMV82IDogZWRpdGFibGVDb2x1bW5zDQogICAgY29sdW1ucy5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLmVkaXRhYmxlID0gdHJ1ZQ0KICAgICAgICBuZXdSb3cuZ2V0Q2VsbChpdCkuc3R5bGVBbGlhcyA9ICfQoNC10LTQsNC60YLQuNGA0YPQtdC80LDRjycNCiAgICB9DQogICAgKGFsbENvbHVtbnMgLSBjb2x1bW5zKS5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLnN0eWxlQWxpYXMgPSAn0JDQstGC0L7Qt9Cw0L/QvtC70L3Rj9C10LzQsNGPJw0KICAgIH0NCiAgICByZXR1cm4gbmV3Um93DQp9DQoNCkBGaWVsZA0KZGVmIHBlcmlvZE5hbWVzID0gWyLQv9C10YDQstGL0Lkg0LrQstCw0YDRgtCw0LsiLCAi0LLRgtC+0YDQvtC5INC60LLQsNGA0YLQsNC7IiwgItGC0YDQtdGC0LjQuSDQutCy0LDRgNGC0LDQuyIsICLRh9C10YLQstGR0YDRgtGL0Lkg0LrQstCw0YDRgtCw0LsiXQ0KQEZpZWxkDQpkZWYgZGVjbGFyYXRpb25UeXBlOXNvdXJjZXMgPSAyMQ0KQEZpZWxkDQpkZWYgZGVjbGFyYXRpb25UeXBlOV8xID0gMTUNCkBGaWVsZA0KZGVmIGRlY2xhcmF0aW9uVHlwZThzb3VyY2VzID0gMTgNCkBGaWVsZA0KZGVmIGRlY2xhcmF0aW9uVHlwZThfMSA9IDEzDQpARmllbGQNCmRlZiBkZWNsYXJhdGlvblR5cGU5c291cmNlc05hbWUgPSAn0JTQtdC60LvQsNGA0LDRhtC40Y8g0L/QviDQndCU0KEgKNGA0LDQt9C00LXQuyA5INCx0LXQtyDQutC+0L3RgdC+0LvQuNC0LiDRhNC+0YDQvNGLKScNCkBGaWVsZA0KZGVmIGRlY2xhcmF0aW9uVHlwZTlfMU5hbWUgPSAn0JTQtdC60LvQsNGA0LDRhtC40Y8g0L/QviDQndCU0KEgKNGA0LDQt9C00LXQuyA5LjEpJw0KQEZpZWxkDQpkZWYgZGVjbGFyYXRpb25UeXBlOHNvdXJjZXNOYW1lID0gItCU0LXQutC70LDRgNCw0YbQuNGPINC/0L4g0J3QlNChICjRgNCw0LfQtNC10LsgOCDQsdC10Lcg0LrQvtC90YHQvtC70LjQtC4g0YTQvtGA0LzRiykiDQpARmllbGQNCmRlZiBkZWNsYXJhdGlvblR5cGU4XzFOYW1lID0gItCU0LXQutC70LDRgNCw0YbQuNGPINC/0L4g0J3QlNChICjRgNCw0LfQtNC10LsgOC4xKSINCkBGaWVsZA0KZGVmIHVucElkID0gMQ0KQEZpZWxkDQpkZWYgZGVjbGFyYXRpb25TYWxlTWFwDQpARmllbGQNCmRlZiBkZWNsYXJhdGlvblB1cmNoYXNlTWFwDQoNCnZvaWQgY2hlY2tGaWxsRGVjbGFyYXRpb25NYXAoYm9vbGVhbiBzaG93TWVzc2FnZXMpIHsNCiAgICBkZWYgZGF0YVJvd3MgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSkuYWxsQ2FjaGVkDQogICAgZGVmIHJlcG9ydFBlcmlvZCA9IGdldFJlcG9ydFBlcmlvZChmb3JtRGF0YS5yZXBvcnRQZXJpb2RJZCkNCiAgICBkZWYgcGVyaW9kVHlwZXNTYWxlID0gW10gLy8g0JTQu9GPINC30LDQv9C+0LvQvdC10L3QuNGPINCz0YDQsNGEIDQoNSksIDcoOCkg0L/QviDRhNC40LrRgdC40YDQvtCy0LDQvdC90YvQvCDRgdGC0YDQvtC60LDQvCDihJYxNiwgMTcNCiAgICBkZWYgcGVyaW9kVHlwZXNQdXJjaGFzZSA9IFtdIC8vINCU0LvRjyDQt9Cw0L/QvtC70L3QtdC90LjRjyDQs9GA0LDRhNGLIDcoOCkg0L/QviDRhNC40LrRgdC40YDQvtCy0LDQvdC90L7QuSDRgdGC0YDQvtC60LUg4oSWMjINCiAgICBkZWYgaGVhZDhJbmRleCA9IGdldERhdGFSb3coZGF0YVJvd3MsICdoZWFkXzgnKS5nZXRJbmRleCgpDQogICAgZm9yIChkZWYgcm93IDogZGF0YVJvd3MpIHsNCiAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpKSB7DQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICB9DQogICAgICAgIGRlZiBwZXJpb2RUeXBlID0gZ2V0UmVmQm9va1ZhbHVlKDgsIHJvdy5wZXJpb2QpDQogICAgICAgIGlmICghcGVyaW9kTmFtZXMuY29udGFpbnMocGVyaW9kVHlwZT8uTkFNRT8uc3RyaW5nVmFsdWUpKSB7DQogICAgICAgICAgICByZXR1cm4NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGlmIChyb3cuZ2V0SW5kZXgoKSA8IGhlYWQ4SW5kZXgpIHsNCiAgICAgICAgICAgICAgICBwZXJpb2RUeXBlc1NhbGUuYWRkKHBlcmlvZFR5cGUpDQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHBlcmlvZFR5cGVzUHVyY2hhc2UuYWRkKHBlcmlvZFR5cGUpDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBkZWYgcmVwb3J0UGVyaW9kcyA9IHJlcG9ydFBlcmlvZFNlcnZpY2UubGlzdEJ5VGF4UGVyaW9kKHJlcG9ydFBlcmlvZC50YXhQZXJpb2QuaWQpDQogICAgZGVmIHVucE5hbWUgPSBkZXBhcnRtZW50U2VydmljZS5nZXQodW5wSWQpLm5hbWUNCiAgICAvLyDRgNCw0LfQtNC10LvRiyAxLTcsINC/0YDQvtC00LDQttC4DQogICAgaWYgKGRlY2xhcmF0aW9uU2FsZU1hcCA9PSBudWxsKSB7DQogICAgICAgIGRlY2xhcmF0aW9uU2FsZU1hcCA9IGNoZWNrR2V0U291cmNlRGVjbGFyYXRpb24odHJ1ZSwgc2hvd01lc3NhZ2VzLCBwZXJpb2RUeXBlc1NhbGUsIHJlcG9ydFBlcmlvZHMsIHJlcG9ydFBlcmlvZCwgdW5wTmFtZSwgZGVjbGFyYXRpb25UeXBlOXNvdXJjZXMsIGRlY2xhcmF0aW9uVHlwZTlfMSkNCiAgICB9DQogICAgLy8g0YDQsNC30LTQtdC70YsgOCwgOSwg0L/QvtC60YPQv9C60LgNCiAgICBpZiAoZGVjbGFyYXRpb25QdXJjaGFzZU1hcCA9PSBudWxsKSB7DQogICAgICAgIGRlY2xhcmF0aW9uUHVyY2hhc2VNYXAgPSBjaGVja0dldFNvdXJjZURlY2xhcmF0aW9uKGZhbHNlLCBzaG93TWVzc2FnZXMsIHBlcmlvZFR5cGVzUHVyY2hhc2UsIHJlcG9ydFBlcmlvZHMsIHJlcG9ydFBlcmlvZCwgdW5wTmFtZSwgZGVjbGFyYXRpb25UeXBlOHNvdXJjZXMsIGRlY2xhcmF0aW9uVHlwZThfMSkNCiAgICB9DQp9DQoNCi8vINC/0YDQvtCy0LXRgNC60Lgg0L3QsNC70LjRh9C40Y8g0LTQtdC60LvQsNGA0LDRhtC40LkNCmRlZiBjaGVja0dldFNvdXJjZURlY2xhcmF0aW9uKGJvb2xlYW4gaXNTYWxlLCBib29sZWFuIHNob3dNZXNzYWdlcywgZGVmIHBlcmlvZFR5cGVzLCBkZWYgcmVwb3J0UGVyaW9kcywgZGVmIHJlcG9ydFBlcmlvZCwgZGVmIHVucE5hbWUsIGRlZiB0eXBlRmlyc3QsIGRlZiB0eXBlU2Vjb25kKSB7DQogICAgZGVmIGRlY2xhcmF0aW9uVHlwZU5hbWVGaXJzdCA9IGlzU2FsZSA/IGRlY2xhcmF0aW9uVHlwZTlzb3VyY2VzTmFtZSA6IGRlY2xhcmF0aW9uVHlwZThzb3VyY2VzTmFtZQ0KICAgIGRlZiBkZWNsYXJhdGlvblR5cGVOYW1lU2Vjb25kID0gaXNTYWxlID8gZGVjbGFyYXRpb25UeXBlOV8xTmFtZSA6IGRlY2xhcmF0aW9uVHlwZThfMU5hbWUNCiAgICBkZWYgeWVhciA9IHJlcG9ydFBlcmlvZD8udGF4UGVyaW9kPy55ZWFyDQogICAgZGVmIHBlcmlvZFR5cGVJZHMgPSBwZXJpb2RUeXBlcy5zb3J0eyBpdC5DT0RFLnN0cmluZ1ZhbHVlIH0uY29sbGVjdCB7IGl0LnJlY29yZF9pZC52YWx1ZSB9DQogICAgZGVmIGRlY2xhcmF0aW9uTWFwID0gWzpdDQogICAgcGVyaW9kVHlwZUlkcy5lYWNoIHsgcGVyaW9kVHlwZUlkIC0+DQogICAgICAgIGRlZiBwZXJpb2ROYW1lID0gZ2V0UmVmQm9va1ZhbHVlKDgsIHBlcmlvZFR5cGVJZCk/Lk5BTUU/LnN0cmluZ1ZhbHVlDQogICAgICAgIGRlZiBwZXJpb2QgPSByZXBvcnRQZXJpb2RzLmZpbmQgeyBpdC5kaWN0VGF4UGVyaW9kSWQgPT0gcGVyaW9kVHlwZUlkIH0NCiAgICAgICAgZGVmIGNvcnJOdW1iZXIgPSAwDQogICAgICAgIGlmIChwZXJpb2QgIT0gbnVsbCkgew0KICAgICAgICAgICAgZGVmIGRlcGFydG1lbnRSZXBvcnRQZXJpb2QgPSBnZXRMYXN0RGVwYXJ0bWVudFJlcG9ydFBlcmlvZCh1bnBJZCwgcGVyaW9kLmlkKQ0KICAgICAgICAgICAgY29yck51bWJlciA9IHJlcG9ydFBlcmlvZFNlcnZpY2UuZ2V0Q29ycmVjdGlvbk51bWJlcihkZXBhcnRtZW50UmVwb3J0UGVyaW9kLmlkKQ0KICAgICAgICB9DQogICAgICAgIGlmIChjb3JyTnVtYmVyID09IDApIHsgLy8g0YHQvtC+0LHRidC10L3QuNC1IDMNCiAgICAgICAgICAgIGRlZiBNRVNTQUdFXzNfU0FMRSA9ICLQndC10LLQvtC30LzQvtC20L3QviDQvtC/0YDQtdC00LXQu9C40YLRjCDQtNC10LrQu9Cw0YDQsNGG0LjRji3QuNGB0YLQvtGH0L3QuNC6LCDRgi7Qui4g0L3QtSDRgdC+0LfQtNCw0L0g0LrQvtGA0YDQtdC60YLQuNGA0YPRjtGJ0LjQuSDQv9C10YDQuNC+0LQgwqslcywgJXPCuy4gIiArDQogICAgICAgICAgICAgICAgICAgICLQn9GA0Lgg0LfQsNC/0L7Qu9C90LXQvdC40Lgg0YHRgtGA0L7QuiDCq9CS0KHQldCT0J4g0LfQsCAlc8K7INC/0L4g0LTQvtC/LiDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/RgNC+0LTQsNC2INC/0L4g0YHRgtCw0LLQutC1IDE4JSUsIDEwJSUg0LfQvdCw0YfQtdC90LjRjyDRgtGA0LXQsdGD0LXQvNGL0YUg0YHRgtGA0L7QuiDQtNC10LrQu9Cw0YDQsNGG0LjQuC3QuNGB0YLQvtGH0L3QuNC60LAg0LHRg9C00YPRgiDQv9GA0LjQvdGP0YLRiyDQt9CwINC90YPQu9C10LLRi9C1LiINCiAgICAgICAgICAgIGRlZiBNRVNTQUdFXzNfUFVSQ0hBU0UgPSAi0J3QtdCy0L7Qt9C80L7QttC90L4g0L7Qv9GA0LXQtNC10LvQuNGC0Ywg0LTQtdC60LvQsNGA0LDRhtC40Y4t0LjRgdGC0L7Rh9C90LjQuiwg0YIu0LouINC90LUg0YHQvtC30LTQsNC9INC60L7RgNGA0LXQutGC0LjRgNGD0Y7RidC40Lkg0L/QtdGA0LjQvtC0IMKrJXMsICVzwrsuICIgKw0KICAgICAgICAgICAgICAgICAgICAi0J/RgNC4INC30LDQv9C+0LvQvdC10L3QuNC4INGB0YLRgNC+0LrQuCDCq9CS0KHQldCT0J4g0LfQsCAlc8K7INC/0L4g0LTQvtC/LiDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/QvtC60YPQv9C+0Log0L/QviDRgdGC0LDQstC60LUgMTglJSDQt9C90LDRh9C10L3QuNC1INGC0YDQtdCx0YPQtdC80L7QuSDRgdGC0YDQvtC60Lgg0LTQtdC60LvQsNGA0LDRhtC40Lgt0LjRgdGC0L7Rh9C90LjQutCwINCx0YPQtNC10YIg0L/RgNC40L3Rj9GC0L4g0LfQsCDQvdGD0LvQtdCy0L7QtS4iDQogICAgICAgICAgICBpZiAoc2hvd01lc3NhZ2VzKSB7DQogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oaXNTYWxlID8gTUVTU0FHRV8zX1NBTEUgOiBNRVNTQUdFXzNfUFVSQ0hBU0UsIHllYXIsIHBlcmlvZE5hbWUsIHBlcmlvZE5hbWUpDQogICAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSBpZiAoY29yck51bWJlciA9PSAxKSB7DQogICAgICAgICAgICAvLyDQktGL0L/QvtC70L3QuNGC0Ywg0L/QvtC40YHQuiDQtNC10LrQu9Cw0YDQsNGG0LjQuC3QuNGB0YLQvtGH0L3QuNC60LAgwqvQlNC10LrQu9Cw0YDQsNGG0LjRjyDQv9C+INCd0JTQoSAo0YDQsNC30LTQtdC7IDgvOSDQsdC10Lcg0LrQvtC90YHQvtC70LjQtC4g0YTQvtGA0LzRiynCuw0KICAgICAgICAgICAgRGVwYXJ0bWVudFJlcG9ydFBlcmlvZEZpbHRlciBmaWx0ZXIgPSBuZXcgRGVwYXJ0bWVudFJlcG9ydFBlcmlvZEZpbHRlcigpDQogICAgICAgICAgICAvLyDQuNGJ0LXQvCDQvdC1INCyINC60L7RgNGA0LXQutGC0LjRgNGD0Y7RidC10Lwg0L/QtdGA0LjQvtC00LUNCiAgICAgICAgICAgIGZpbHRlci5pc0NvcnJlY3Rpb24gPSBmYWxzZQ0KICAgICAgICAgICAgZmlsdGVyLmNvcnJlY3Rpb25EYXRlID0gbnVsbA0KICAgICAgICAgICAgZmlsdGVyLmRlcGFydG1lbnRJZExpc3QgPSBbdW5wSWRdDQogICAgICAgICAgICBmaWx0ZXIudGF4VHlwZUxpc3QgPSBbVGF4VHlwZS5WQVRdDQogICAgICAgICAgICBmaWx0ZXIueWVhclN0YXJ0ID0geWVhcg0KICAgICAgICAgICAgZmlsdGVyLnllYXJFbmQgPSB5ZWFyDQogICAgICAgICAgICBkZWYgZGVwYXJ0bWVudFJlcG9ydFBlcmlvZHMgPSBnZXRMaXN0QnlGaWx0ZXIoZmlsdGVyKQ0KICAgICAgICAgICAgZGVmIGRlY2xhcmF0aW9uRFJQID0gZGVwYXJ0bWVudFJlcG9ydFBlcmlvZHMuZmluZCB7IGl0LnJlcG9ydFBlcmlvZC5kaWN0VGF4UGVyaW9kSWQgPT0gcGVyaW9kVHlwZUlkIH0NCiAgICAgICAgICAgIGRlZiBkZWNsYXJhdGlvbnMgPSBkZWNsYXJhdGlvblNlcnZpY2UuZmluZCh0eXBlRmlyc3QsIGRlY2xhcmF0aW9uRFJQLmlkKQ0KICAgICAgICAgICAgaWYgKGRlY2xhcmF0aW9ucyAhPSBudWxsICYmIGRlY2xhcmF0aW9ucy5zaXplKCkgPT0gMSAmJiBkZWNsYXJhdGlvbnNbMF0uYWNjZXB0ZWQpIHsgLy8g0KHQvtC+0LHRidC10L3QuNC1IDQNCiAgICAgICAgICAgICAgICBkZWNsYXJhdGlvbk1hcC5wdXQocGVyaW9kVHlwZUlkLCBkZWNsYXJhdGlvbnNbMF0pDQogICAgICAgICAgICAgICAgZGVmIE1FU1NBR0VfNF9TQUxFX1NIT1JUID0gItCU0LvRjyDQt9Cw0L/QvtC70L3QtdC90LjRjyDRgdGC0YDQvtC6IMKr0JLQodCV0JPQniDQt9CwICVzwrsg0L/QviDQtNC+0L8uINC70LjRgdGC0YMg0LrQvdC40LPQuCDQv9GA0L7QtNCw0LYg0L/QviDRgdGC0LDQstC60LUgMTglJSwgMTAlJSDQvtC/0YDQtdC00LXQu9C10L3QsCDQtNC10LrQu9Cw0YDQsNGG0LjRjy3QuNGB0YLQvtGH0L3QuNC6LiAiICsNCiAgICAgICAgICAgICAgICAgICAgICAgICLQktC40LQ6IMKrJXPCuywg0J/QvtC00YDQsNC30LTQtdC70LXQvdC40LU6IMKrJXPCuywg0J/QtdGA0LjQvtC0OiDCqyVzLCAlc8K7LiINCiAgICAgICAgICAgICAgICBkZWYgTUVTU0FHRV80X1BVUkNIQVNFX1NIT1JUID0gItCU0LvRjyDQt9Cw0L/QvtC70L3QtdC90LjRjyDRgdGC0YDQvtC60LggwqvQktCh0JXQk9CeINC30LAgJXPCuyDQv9C+INC00L7Qvy4g0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0L7QutGD0L/QvtC6INC/0L4g0YHRgtCw0LLQutC1IDE4JSUg0L7Qv9GA0LXQtNC10LvQtdC90LAg0LTQtdC60LvQsNGA0LDRhtC40Y8t0LjRgdGC0L7Rh9C90LjQui4gIiArDQogICAgICAgICAgICAgICAgICAgICAgICAi0JLQuNC0OiDCqyVzwrssINCf0L7QtNGA0LDQt9C00LXQu9C10L3QuNC1OiDCqyVzwrssINCf0LXRgNC40L7QtDogwqslcywgJXPCuy4iDQogICAgICAgICAgICAgICAgaWYgKHNob3dNZXNzYWdlcykgew0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhpc1NhbGUgPyBNRVNTQUdFXzRfU0FMRV9TSE9SVCA6IE1FU1NBR0VfNF9QVVJDSEFTRV9TSE9SVCwgcGVyaW9kTmFtZSwgZGVjbGFyYXRpb25UeXBlTmFtZUZpcnN0LCB1bnBOYW1lLCB5ZWFyLCBwZXJpb2ROYW1lKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVjbGFyYXRpb25zLmlzRW1wdHkoKSB8fCAhZGVjbGFyYXRpb25zWzBdLmFjY2VwdGVkKSB7IC8vINCh0L7QvtCx0YnQtdC90LjQtSAxDQogICAgICAgICAgICAgICAgZGVmIE1FU1NBR0VfMV9TQUxFID0gItCd0LUg0L3QsNC50LTQtdC90LAg0LTQtdC60LvQsNGA0LDRhtC40Y8t0LjRgdGC0L7Rh9C90LjQui4g0JLQuNC0OiDCqyVzwrssINCf0L7QtNGA0LDQt9C00LXQu9C10L3QuNC1OiDCqyVzwrssINCf0LXRgNC40L7QtDogwqslcywgJXPCuy4g0J/RgNC4INC30LDQv9C+0LvQvdC10L3QuNC4INGB0YLRgNC+0LogwqvQktCh0JXQk9CeINC30LAgJXPCuyAiICsNCiAgICAgICAgICAgICAgICAgICAgICAgICLQv9C+INC00L7Qvy4g0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0YDQvtC00LDQtiDQv9C+INGB0YLQsNCy0LrQtSAxOCUlLCAxMCUlINC30L3QsNGH0LXQvdC40Y8g0YLRgNC10LHRg9C10LzRi9GFINGB0YLRgNC+0Log0LTQtdC60LvQsNGA0LDRhtC40Lgt0LjRgdGC0L7Rh9C90LjQutCwINCx0YPQtNGD0YIg0L/RgNC40L3Rj9GC0Ysg0LfQsCDQvdGD0LvQtdCy0YvQtS4iDQogICAgICAgICAgICAgICAgZGVmIE1FU1NBR0VfMV9QVVJDSEFTRSA9ICLQndC1INC90LDQudC00LXQvdCwINC00LXQutC70LDRgNCw0YbQuNGPLdC40YHRgtC+0YfQvdC40LouINCS0LjQtDogwqslc8K7LCDQn9C+0LTRgNCw0LfQtNC10LvQtdC90LjQtTogwqslc8K7LCDQn9C10YDQuNC+0LQ6IMKrJXMsICVzwrsuINCf0YDQuCDQt9Cw0L/QvtC70L3QtdC90LjQuCDRgdGC0YDQvtC60LggwqvQktCh0JXQk9CeINC30LAgJXPCuyAiICsNCiAgICAgICAgICAgICAgICAgICAgICAgICLQv9C+INC00L7Qvy4g0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0L7QutGD0L/QvtC6INC/0L4g0YHRgtCw0LLQutC1IDE4JSUg0LfQvdCw0YfQtdC90LjQtSDRgtGA0LXQsdGD0LXQvNC+0Lkg0YHRgtGA0L7QutC4INC00LXQutC70LDRgNCw0YbQuNC4LdC40YHRgtC+0YfQvdC40LrQsCDQsdGD0LTQtdGCINC/0YDQuNC90Y/RgtC+INC30LAg0L3Rg9C70LXQstC+0LUuIg0KICAgICAgICAgICAgICAgIGlmIChzaG93TWVzc2FnZXMpIHsNCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oaXNTYWxlID8gTUVTU0FHRV8xX1NBTEUgOiBNRVNTQUdFXzFfUFVSQ0hBU0UsIGRlY2xhcmF0aW9uVHlwZU5hbWVGaXJzdCwgdW5wTmFtZSwgeWVhciwgcGVyaW9kTmFtZSwgcGVyaW9kTmFtZSkNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAvLyDQktGL0L/QvtC70L3QuNGC0Ywg0L/QvtC40YHQuiDQtNC10LrQu9Cw0YDQsNGG0LjQuC3QuNGB0YLQvtGH0L3QuNC60LAgwqvQlNC10LrQu9Cw0YDQsNGG0LjRjyDQv9C+INCd0JTQoSAo0YDQsNC30LTQtdC7IDgvOS4xKcK7DQogICAgICAgICAgICBEZXBhcnRtZW50UmVwb3J0UGVyaW9kRmlsdGVyIGZpbHRlciA9IG5ldyBEZXBhcnRtZW50UmVwb3J0UGVyaW9kRmlsdGVyKCkNCiAgICAgICAgICAgIC8vINC40YnQtdC8INCyINC60L7RgNGA0LXQutGC0LjRgNGD0Y7RidC10Lwg0L/QtdGA0LjQvtC00LUNCiAgICAgICAgICAgIGZpbHRlci5pc0NvcnJlY3Rpb24gPSB0cnVlDQogICAgICAgICAgICBmaWx0ZXIuZGVwYXJ0bWVudElkTGlzdCA9IFt1bnBJZF0NCiAgICAgICAgICAgIGZpbHRlci50YXhUeXBlTGlzdCA9IFtUYXhUeXBlLlZBVF0NCiAgICAgICAgICAgIGZpbHRlci55ZWFyU3RhcnQgPSB5ZWFyDQogICAgICAgICAgICBmaWx0ZXIueWVhckVuZCA9IHllYXINCiAgICAgICAgICAgIGRlZiBkZXBhcnRtZW50UmVwb3J0UGVyaW9kcyA9IGdldExpc3RCeUZpbHRlcihm'

    longString += 'aWx0ZXIpDQogICAgICAgICAgICAvLyDRg9Cx0LjRgNCw0LXQvCDQv9C+0YHQu9C10LTQvdGO0Y4g0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60YMNCiAgICAgICAgICAgIGlmICghZGVwYXJ0bWVudFJlcG9ydFBlcmlvZHMuaXNFbXB0eSgpKSB7DQogICAgICAgICAgICAgICAgZGVwYXJ0bWVudFJlcG9ydFBlcmlvZHMucmVtb3ZlKGRlcGFydG1lbnRSZXBvcnRQZXJpb2RzLnNpemUoKSAtIDEpDQogICAgICAgICAgICB9DQogICAgICAgICAgICAvLyDQvdCw0YfQuNC90LDRjyDRgSDQv9C+0YHQu9C10LTQvdC10Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60Lgg0LjRidC10Lwg0LTQtdC60LvQsNGA0LDRhtC40Y4g0YEg0J/RgNC40LfQvdCh0LLQtdC0OTEgPSAwDQogICAgICAgICAgICBEZXBhcnRtZW50UmVwb3J0UGVyaW9kIGRycFRlbXANCiAgICAgICAgICAgIGZvciAoZHJwIGluIGRlcGFydG1lbnRSZXBvcnRQZXJpb2RzLnJldmVyc2UoKSkgew0KICAgICAgICAgICAgICAgIGlmIChkcnAucmVwb3J0UGVyaW9kLmRpY3RUYXhQZXJpb2RJZCAhPSBwZXJpb2RUeXBlSWQpIHsNCiAgICAgICAgICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZGVmIGRlY2xhcmF0aW9ucyA9IGRlY2xhcmF0aW9uU2VydmljZS5maW5kKHR5cGVTZWNvbmQsIGRycC5pZCkNCiAgICAgICAgICAgICAgICBpZiAoZGVjbGFyYXRpb25zICE9IG51bGwgJiYgZGVjbGFyYXRpb25zLnNpemUoKSA9PSAxICYmIGRlY2xhcmF0aW9uc1swXS5hY2NlcHRlZCAmJiBnZXREZWNsYXJhdGlvblhtbEF0dHIoZGVjbGFyYXRpb25zWzBdLCBbJ9CU0L7QutGD0LzQtdC90YInXSwgJ9Cf0YDQuNC30L3QodCy0LXQtDkxJykgPT0gJzAnKSB7DQogICAgICAgICAgICAgICAgICAgIGRlY2xhcmF0aW9uTWFwLnB1dChwZXJpb2RUeXBlSWQsIGRlY2xhcmF0aW9uc1swXSkNCiAgICAgICAgICAgICAgICAgICAgZHJwVGVtcCA9IGRycA0KICAgICAgICAgICAgICAgICAgICBicmVhaw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChkZWNsYXJhdGlvbk1hcFtwZXJpb2RUeXBlSWRdICE9IG51bGwpIHsgLy8g0KHQvtC+0LHRidC10L3QuNC1IDQNCiAgICAgICAgICAgICAgICBkZWYgTUVTU0FHRV80X1NBTEUgPSAi0JTQu9GPINC30LDQv9C+0LvQvdC10L3QuNGPINGB0YLRgNC+0LogwqvQktCh0JXQk9CeINC30LAgJXPCuyDQv9C+INC00L7Qvy4g0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0YDQvtC00LDQtiDQv9C+INGB0YLQsNCy0LrQtSAxOCUlLCAxMCUlINC+0L/RgNC10LTQtdC70LXQvdCwINC00LXQutC70LDRgNCw0YbQuNGPLdC40YHRgtC+0YfQvdC40LouICIgKw0KICAgICAgICAgICAgICAgICAgICAgICAgItCS0LjQtDogwqslc8K7LCDQn9C+0LTRgNCw0LfQtNC10LvQtdC90LjQtTogwqslc8K7LCDQn9C10YDQuNC+0LQ6IMKrJXMsICVzwrssINCU0LDRgtCwINGB0LTQsNGH0Lgg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60Lg6IMKrJXPCuy4iDQogICAgICAgICAgICAgICAgZGVmIE1FU1NBR0VfNF9QVVJDSEFTRSA9ICLQlNC70Y8g0LfQsNC/0L7Qu9C90LXQvdC40Y8g0YHRgtGA0L7QutC4IMKr0JLQodCV0JPQniDQt9CwICVzwrsg0L/QviDQtNC+0L8uINC70LjRgdGC0YMg0LrQvdC40LPQuCDQv9C+0LrRg9C/0L7QuiDQv9C+INGB0YLQsNCy0LrQtSAxOCUlINC+0L/RgNC10LTQtdC70LXQvdCwINC00LXQutC70LDRgNCw0YbQuNGPLdC40YHRgtC+0YfQvdC40LouICIgKw0KICAgICAgICAgICAgICAgICAgICAgICAgItCS0LjQtDogwqslc8K7LCDQn9C+0LTRgNCw0LfQtNC10LvQtdC90LjQtTogwqslc8K7LCDQn9C10YDQuNC+0LQ6IMKrJXMsICVzwrssINCU0LDRgtCwINGB0LTQsNGH0Lgg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60Lg6IMKrJXPCuy4iDQogICAgICAgICAgICAgICAgaWYgKHNob3dNZXNzYWdlcykgew0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhpc1NhbGUgPyBNRVNTQUdFXzRfU0FMRSA6IE1FU1NBR0VfNF9QVVJDSEFTRSwgcGVyaW9kTmFtZSwgZGVjbGFyYXRpb25UeXBlTmFtZVNlY29uZCwgdW5wTmFtZSwgeWVhciwgcGVyaW9kTmFtZSwgZHJwVGVtcC5jb3JyZWN0aW9uRGF0ZS5mb3JtYXQoImRkLk1NLnl5eXkiKSkNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9IGVsc2UgeyAvLyDQodC+0L7QsdGJ0LXQvdC40LUgMg0KICAgICAgICAgICAgICAgIGRlZiBNRVNTQUdFXzJfU0FMRSA9ICLQndC1INC90LDQudC00LXQvdCwINC00LXQutC70LDRgNCw0YbQuNGPLdC40YHRgtC+0YfQvdC40Log0YHQviDRgdGC0YDQvtC60L7QuSDCqzAwMcK7INGA0LDQstC90L7QuSDCqzDCuy4g0JLQuNC0OiDCqyVzwrssINCf0L7QtNGA0LDQt9C00LXQu9C10L3QuNC1OiDCqyVzwrssINCf0LXRgNC40L7QtDogwqslcywgJXPCuywgIiArDQogICAgICAgICAgICAgICAgICAgICAgICAi0JTQsNGC0LAg0YHQtNCw0YfQuCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuDogwqvQvNC10L3RjNGI0LUgJXPCuy4g0J/RgNC4INC30LDQv9C+0LvQvdC10L3QuNC4INGB0YLRgNC+0LogwqvQktCh0JXQk9CeINC30LAgJXPCuyDQv9C+INC00L7Qvy4g0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0YDQvtC00LDQtiDQv9C+INGB0YLQsNCy0LrQtSAxOCUlLCAxMCUlINC30L3QsNGH0LXQvdC40Y8g0YLRgNC10LHRg9C10LzRi9GFINGB0YLRgNC+0Log0LTQtdC60LvQsNGA0LDRhtC40Lgt0LjRgdGC0L7Rh9C90LjQutCwINCx0YPQtNGD0YIg0L/RgNC40L3Rj9GC0Ysg0LfQsCDQvdGD0LvQtdCy0YvQtS4iDQogICAgICAgICAgICAgICAgZGVmIE1FU1NBR0VfMl9QVVJDSEFTRSA9ICLQndC1INC90LDQudC00LXQvdCwINC00LXQutC70LDRgNCw0YbQuNGPLdC40YHRgtC+0YfQvdC40Log0YHQviDRgdGC0YDQvtC60L7QuSDCqzAwMcK7INGA0LDQstC90L7QuSDCqzDCuy4g0JLQuNC0OiDCqyVzwrssINCf0L7QtNGA0LDQt9C00LXQu9C10L3QuNC1OiDCqyVzwrssINCf0LXRgNC40L7QtDogwqslcywgJXPCuywgIiArDQogICAgICAgICAgICAgICAgICAgICAgICAi0JTQsNGC0LAg0YHQtNCw0YfQuCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuDogwqvQvNC10L3RjNGI0LUgJXPCuy4g0J/RgNC4INC30LDQv9C+0LvQvdC10L3QuNC4INGB0YLRgNC+0LrQuCDCq9CS0KHQldCT0J4g0LfQsCAlc8K7INC/0L4g0LTQvtC/LiDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/QvtC60YPQv9C+0Log0L/QviDRgdGC0LDQstC60LUgMTglJSDQt9C90LDRh9C10L3QuNC1INGC0YDQtdCx0YPQtdC80L7QuSDRgdGC0YDQvtC60Lgg0LTQtdC60LvQsNGA0LDRhtC40Lgt0LjRgdGC0L7Rh9C90LjQutCwINCx0YPQtNC10YIg0L/RgNC40L3Rj9GC0L4g0LfQsCDQvdGD0LvQtdCy0L7QtS4iDQogICAgICAgICAgICAgICAgZGVmIGNvcnJlY3Rpb25EYXRlU3RyID0gZ2V0RGVwYXJ0bWVudFJlcG9ydFBlcmlvZChmb3JtRGF0YS5kZXBhcnRtZW50UmVwb3J0UGVyaW9kSWQpPy5jb3JyZWN0aW9uRGF0ZS5mb3JtYXQoImRkLk1NLnl5eXkiKQ0KICAgICAgICAgICAgICAgIGlmIChzaG93TWVzc2FnZXMpIHsNCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oaXNTYWxlID8gTUVTU0FHRV8yX1NBTEUgOiBNRVNTQUdFXzJfUFVSQ0hBU0UsIGRlY2xhcmF0aW9uVHlwZU5hbWVTZWNvbmQsIHVucE5hbWUsIHllYXIsIHBlcmlvZE5hbWUsIGNvcnJlY3Rpb25EYXRlU3RyLCBwZXJpb2ROYW1lKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gZGVjbGFyYXRpb25NYXANCn0NCg0KLy8g0J/QvtC70YPRh9Cw0LXRgiDQuNC3INC00LXQutC70LDRgNCw0YbQuNC4INCw0YLRgNC40LHRg9GCDQpkZWYgZ2V0RGVjbGFyYXRpb25YbWxBdHRyKGRlZiBkZWNsYXJhdGlvbkRhdGEsIGRlZiB0cmVlUGF0aCwgZGVmIGF0dHJOYW1lKSB7DQogICAgLy8g0L/QvtC70YPRh9C10L3QuNC1INC00LDQvdC90YvRhSDQuNC3IHhtbCfQutC4DQogICAgZGVmIHJlYWRlciA9IGRlY2xhcmF0aW9uU2VydmljZS5nZXRYbWxTdHJlYW1SZWFkZXIoZGVjbGFyYXRpb25EYXRhLmlkKQ0KICAgIGlmIChyZWFkZXIgPT0gbnVsbCkgew0KICAgICAgICByZXR1cm4NCiAgICB9DQogICAgZGVmIGVsZW1lbnRzID0gWzpdDQoNCiAgICB0cnl7DQogICAgICAgIHdoaWxlIChyZWFkZXIuaGFzTmV4dCgpKSB7DQogICAgICAgICAgICBpZiAocmVhZGVyLnN0YXJ0RWxlbWVudCkgew0KICAgICAgICAgICAgICAgIGVsZW1lbnRzW3JlYWRlci5uYW1lLmxvY2FsUGFydF0gPSB0cnVlDQogICAgICAgICAgICAgICAgaWYgKGlzQ3VycmVudE5vZGUodHJlZVBhdGgsIGVsZW1lbnRzKSkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0WG1sVmFsdWUocmVhZGVyLCBhdHRyTmFtZSkNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAocmVhZGVyLmVuZEVsZW1lbnQpIHsNCiAgICAgICAgICAgICAgICBlbGVtZW50c1tyZWFkZXIubmFtZS5sb2NhbFBhcnRdID0gZmFsc2UNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJlYWRlci5uZXh0KCkNCiAgICAgICAgfQ0KICAgIH0gZmluYWxseSB7DQogICAgICAgIHJlYWRlci5jbG9zZSgpDQogICAgfQ0KICAgIHJldHVybiBudWxsDQp9DQoNClN0cmluZyBnZXRYbWxWYWx1ZShYTUxTdHJlYW1SZWFkZXIgcmVhZGVyLCBTdHJpbmcgYXR0ck5hbWUpIHsNCiAgICByZXR1cm4gcmVhZGVyPy5nZXRBdHRyaWJ1dGVWYWx1ZShudWxsLCBhdHRyTmFtZSkNCn0NCg0KLyoqDQogKiDQmNGJ0LXRgiDRgtC+0YfQvdC+0LUg0LvQuCDRgdC+0LLQv9Cw0LTQtdC90LjQtSDRg9C30LvQvtCyINC00LXRgNC10LLQsCB4bWwgYyDRgtC10LrRg9GJ0LjQvNC4INC90LXQt9Cw0LrRgNGL0YLRi9C80Lgg0Y3Qu9C10LzQtdC90YLQsNC80LgNCiAqIEBwYXJhbSBub2RlTmFtZXMg0L7QttC40LTQsNC10LzRi9C1INGN0LvQtdC80LXQvdGC0YsgeG1sDQogKiBAcGFyYW0gZWxlbWVudHMg0L3QtdC30LDQutGA0YvRgtGL0LUg0Y3Qu9C10LzQtdC90YLRiw0KICogQHJldHVybg0KICovDQpib29sZWFuIGlzQ3VycmVudE5vZGUoTGlzdDxTdHJpbmc+IG5vZGVOYW1lcywgTWFwPFN0cmluZywgQm9vbGVhbj4gZWxlbWVudHMpIHsNCiAgICBkZWYgdGVtcE5vZGVzID0gbm9kZU5hbWVzICsgJ9Ck0LDQudC7Jw0KICAgIGRlZiBlbnRlcmVkTm9kZXMgPSBlbGVtZW50cy5maW5kQWxsIHsgaXQudmFsdWUgfS5rZXlTZXQoKSAvLyDRg9C30LvRiyDQsiDQutC+0YLQvtGA0YvQtSDQstC+0YjQu9C4LCDQvdC+INC90LUg0LLRi9GI0LvQuCDQtdGJ0LUNCiAgICByZXR1cm4gZW50ZXJlZE5vZGVzLmNvbnRhaW5zQWxsKHRlbXBOb2RlcykgJiYgZW50ZXJlZE5vZGVzLnNpemUoKSA9PSB0ZW1wTm9kZXMuc2l6ZSgpDQp9DQoNCi8vINCQ0LvQs9C+0YDQuNGC0LzRiyDQt9Cw0L/QvtC70L3QtdC90LjRjyDQv9C+0LvQtdC5INGE0L7RgNC80YsNCnZvaWQgY2FsYygpIHsNCiAgICBkZWYgZGF0YVJvd3MgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSkuYWxsQ2FjaGVkDQoNCiAgICAvLyDRg9C00LDQu9GP0LXQvCDRgNCw0YHRgdGH0LjRgtGL0LLQsNC10LzRi9C1INC40YLQvtCz0LgNCiAgICBkYXRhUm93cy5yZW1vdmVBbGwgeyByb3cgLT4NCiAgICAgICAgcm93LmdldEFsaWFzKCkgIT0gbnVsbCAmJiByb3cuZ2V0QWxpYXMoKSAhPSAoJ21lZ2FfdG90YWwnKSAmJiAhcm93LmdldEFsaWFzKCkuc3RhcnRzV2l0aCgnaGVhZF8nKQ0KICAgIH0NCg0KICAgIHVwZGF0ZUluZGV4ZXMoZGF0YVJvd3MpDQoNCiAgICAvLyDRgNCw0YHQv9GA0LXQtNC10LvRj9C10Lwg0YHRgtGA0L7QutC4INC/0L4g0LPRgNGD0L/Qv9Cw0LwNCiAgICBkZWYgc2VjdGlvbk1hcCA9IGFycmFuZ2VSb3dzKGRhdGFSb3dzKQ0KDQogICAgLy8g0YDQsNGB0YfQtdGC0YsNCiAgICBzZWN0aW9uTWFwLmtleVNldCgpLmVhY2ggeyBzZWN0aW9uIC0+DQogICAgICAgIGZvciAocm93IGluIHNlY3Rpb25NYXBbc2VjdGlvbl0pIHsNCiAgICAgICAgICAgIGlmIChyb3cuZ2V0QWxpYXMoKSAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJvdy5yYXRlTmRzID0gcmF0ZU1hcFtzZWN0aW9uXVswXQ0KICAgICAgICB9DQogICAgfQ0KDQogICAgZm9yIChyb3cgaW4gZGF0YVJvd3MpIHsNCiAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpICE9IG51bGwpIHsNCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIH0NCiAgICAgICAgcm93LnN1bSA9IGNhbGNDaGVjazEwKHJvdywgbnVsbCkNCiAgICB9DQoNCiAgICAvLyDQtNC+0LHQsNCy0LjQvCDRgdGC0YDQvtC60Lgg0LzQsNC60LXRgtCwDQogICAgZGF0YVJvd3MuY2xlYXIoKQ0KICAgIGRhdGFSb3dzLmFkZEFsbChmb3JtRGF0YVNlcnZpY2UuZ2V0Rm9ybVRlbXBsYXRlKGZvcm1EYXRhLmZvcm1UeXBlLmlkLCBmb3JtRGF0YS5yZXBvcnRQZXJpb2RJZCkucm93cykNCiAgICB1cGRhdGVJbmRleGVzKGRhdGFSb3dzKQ0KDQogICAgLy8g0KHQvtGA0YLQuNGA0L7QstC60LAg0Lgg0LTQvtCx0LDQstC70LXQvdC40LUg0L3QtdGE0LjQutGB0LjRgNC+0LLQsNC90L3Ri9GFINGB0YLRgNC+0LoNCiAgICBzZWN0aW9uTWFwLmVhY2ggeyBrZXksIHJvd3MgLT4NCiAgICAgICAgcm93cy5zb3J0IHsgcm93IC0+DQogICAgICAgICAgICBnZXRSZWZCb29rVmFsdWUoOCwgcm93LnBlcmlvZCk/LkNPREU/LnN0cmluZ1ZhbHVlID86ICcwMCcNCiAgICAgICAgfQ0KICAgICAgICBkYXRhUm93cy5hZGRBbGwoZ2V0RGF0YVJvdyhkYXRhUm93cywgJ2hlYWRfJyArIGtleSkuZ2V0SW5kZXgoKSwgcm93cykNCiAgICAgICAgdXBkYXRlSW5kZXhlcyhkYXRhUm93cykNCiAgICB9DQoNCiAgICAvLyDRgdC+0LfQtNCw0LXRgiDRgNCw0YHRgdGH0LjRgtGL0LLQsNC10LzRi9C1INC40YLQvtCz0LgNCiAgICBjYWxjVG90YWxzKGRhdGFSb3dzKQ0KICAgIHVwZGF0ZUluZGV4ZXMoZGF0YVJvd3MpDQp9DQoNCmRlZiBjYWxjQ2hlY2sxMChkZWYgcm93LCBkZWYgc3VtKSB7DQogICAgZGVmIGluZGV4ID0gcm93LmdldEluZGV4KCkNCiAgICAvLyDQldCh0JvQmCDCq9CT0YDQsNGE0LAgN8K7INC30LDQv9C+0LvQvdC10L3QsCDQmCDCq9CT0YDQsNGE0LAgOMK7INC90LUg0LfQsNC/0L7Qu9C90LXQvdCwLCDQotCeIMKr0JPRgNCw0YTQsCAxMMK7ID0gwqvQk9GA0LDRhNCwIDfCuw0KICAgIGlmIChyb3cuc3VtTmRzUGx1cyAhPSBudWxsICYmIHJvdy5zdW1OZHNNaW51cyA9PSBudWxsKSB7DQogICAgICAgIGlmIChzdW0gIT0gbnVsbCAmJiBzdW0gIT0gcm93LnN1bU5kc1BsdXMpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDCqyR7Z2V0Q29sdW1uTmFtZShyb3csJ3N1bScpfcK7INC00L7Qu9C20L3QsCDQsdGL0YLRjCDQt9Cw0L/QvtC70L3QtdC90LAg0LfQvdCw0YfQtdC90LjQtdC8INCz0YDQsNGE0Ysg0YEg0YHRg9C80LzQvtC5INC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4ICgtKSDQndCU0KEhIikNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcm93LnN1bU5kc1BsdXMNCiAgICB9DQogICAgLy8g0JXQodCb0JggwqvQk9GA0LDRhNCwIDfCuyDQvdC1INC30LDQv9C+0LvQvdC10L3QsCDQmCDCq9CT0YDQsNGE0LAgOMK7INC30LDQv9C+0LvQvdC10L3QsCwg0KLQniDCq9CT0YDQsNGE0LAgMTDCuyA9IMKr0JPRgNCw0YTQsCA4wrsNCiAgICBpZiAocm93LnN1bU5kc1BsdXMgPT0gbnVsbCAmJiByb3cuc3VtTmRzTWludXMgIT0gbnVsbCkgew0KICAgICAgICBpZiAoc3VtICE9IG51bGwgJiYgc3VtICE9IHJvdy5zdW1OZHNNaW51cykgew0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQk9GA0LDRhNCwIMKrJHtnZXRDb2x1bW5OYW1lKHJvdywnc3VtJyl9wrsg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LPRgNCw0YTRiyDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspINCd0JTQoSEiKQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiByb3cuc3VtTmRzTWludXMNCiAgICB9DQogICAgLy8g0JXQodCb0JggwqvQk9GA0LDRhNCwIDfCuyDQt9Cw0L/QvtC70L3QtdC90LAg0JggwqvQk9GA0LDRhNCwIDjCuyDQt9Cw0L/QvtC70L3QtdC90LAsINCi0J4gwqvQk9GA0LDRhNCwIDEwwrsgPSDCq9CT0YDQsNGE0LAgN8K7ICsgwqvQk9GA0LDRhNCwIDjCuw0KICAgIGlmIChyb3cuc3VtTmRzUGx1cyAhPSBudWxsICYmIHJvdy5zdW1OZHNNaW51cyAhPSBudWxsKSB7DQogICAgICAgIGlmIChzdW0gIT0gbnVsbCAmJiBzdW0gIT0gcm93LnN1bU5kc1BsdXMgKyByb3cuc3VtTmRzTWludXMpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDCqyR7Z2V0Q29sdW1uTmFtZShyb3csJ3N1bScpfcK7INC00L7Qu9C20L3QsCDQsdGL0YLRjCDQt9Cw0L/QvtC70L3QtdC90LAg0YHRg9C80LzQvtC5INC30L3QsNGH0LXQvdC40Lkg0LPRgNCw0YTRiyDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspINC4INCz0YDQsNGE0Ysg0YEg0YHRg9C80LzQvtC5INC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4ICgtKSDQndCU0KEhIikNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcm93LnN1bU5kc1BsdXMgKyByb3cuc3VtTmRzTWludXMNCiAgICB9DQogICAgcmV0dXJuIG51bGwNCn0NCg0KZGVmIGNhbGNUb3RhbHMoZGVmIGRhdGFSb3dzKSB7DQogICAgLy8g0JTQvtCx0LDQstC70LXQvdC40LUg0L/QvtC00LjRgtC+0LPQvtCyICjQmNGC0L7Qs9C+INC30LAg0L3QsNC70L7Qs9C+0LLRi9C5INC/0LXRgNC40L7QtCkNCiAgICBjYWxjUGVyaW9kVG90YWxzKGRhdGFSb3dzKQ0KDQogICAgLy8g0JjRgtC+0LPQviDQv9C+INGA0LDQt9C00LXQu9Cw0LwgMS02DQogICAgZGVmIG1lZ2FUb3RhbCA9IGdldERhdGFSb3coZGF0YVJvd3MsICJtZWdhX3RvdGFsIikNCiAgICBjYWxjTWVnYVRvdGFsKG1lZ2FUb3RhbCwgZGF0YVJvd3MpDQoNCiAgICAvLyDQodGH0LjRgtCw0LXQvCDRgtGA0Lgg0LPRgNGD0L/Qv9GLINGB0YPQv9C10YAt0LjRgtC+0LPQvtCyDQogICAgZGVmIHN1cGVyUm93cyA9IGNhbGNTdXBlclRvdGFscyhkYXRhUm93cykNCiAgICBpZiAoIXN1cGVyUm93cy5pc0VtcHR5KCkpIHsNCiAgICAgICAgZGVmIHB1cmNoYXNlU3VwZXJSb3cgPSBzdXBlclJvd3NbLTFdDQogICAgICAgIGRhdGFSb3dzLmFkZChwdXJjaGFzZVN1cGVyUm93KQ0KICAgICAgICBzdXBlclJvd3MucmVtb3ZlKHB1cmNoYXNlU3VwZXJSb3cpDQogICAgICAgIGRhdGFSb3dzLmFkZEFsbChkYXRhUm93cy5pbmRleE9mKGdldERhdGFSb3coZGF0YVJvd3MsICdoZWFkXzgnKSksIHN1cGVyUm93cykNCiAgICB9DQp9DQoNCnZvaWQgY2FsY01lZ2FUb3RhbChkZWYgbWVnYVRvdGFsLCBkZWYgZGF0YVJvd3MpIHsNCiAgICBtZWdhVG90YWwuc3VtTmRzUGx1cyA9IEJpZ0RlY2ltYWwuWkVSTw0KICAgIGRhdGFSb3dzLmVhY2ggeyByb3cgLT4NCiAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpICE9IG51bGwgJiYgcm93LmdldEFsaWFzKCkgPT1+IC90b3RhbF9bMS02XV8uKi8pIHsNCiAgICAgICAgICAgIC8vINGB0YPQvNC80LjRgNGD0LXQvCDQv9C+IDQt0Lkg0LPRgNCw0YTQtSAoNS3RjyDQv9GD0YHRgtCw0Y8pDQogICAgICAgICAgICBtZWdhVG90YWwuc3VtTmRzUGx1cyArPSAocm93LnN1bU5kc1BsdXMgPzogQmlnRGVjaW1hbC5aRVJPKQ0KICAgICAgICB9DQogICAgfQ0KfQ0KDQovLyDQodGH0LjRgtCw0LXQvCDRgdGD0L/QtdGALdC40YLQvtCz0Lgg0LTQu9GPICLQktGB0LXQs9C+INC30LAg0L3QsNC70L7Qs9C+0LLRi9C5INC/0LXRgNC40L7QtCDQv9C+INC00L7Qvy4g0LvQuNGB0YLRgyDQutC90LjQs9C4INC/0L7QutGD0L/QvtC6L9C/0YDQvtC00LDQtiINCmRlZiBjYWxjU3VwZXJUb3RhbHMoZGVmIGRhdGFSb3dzKSB7DQogICAgZGVmIHNlY3Rpb25zU3VwZXIgPSBbJ3NhbGVfMTgnIDogWycxJywgJzMnLCAnNScsICc2JywgJzcnXSwgJ3NhbGVfMTAnIDogWycyJywgJzQnXSwgJ3B1cmNoYXNlJyA6IFsnOCcsICc5J11dDQogICAgZGVmIHRvdGFsQ29sdW1uc1N1cGVyID0gWydzYWxlXzE4JyA6IHRvdGFsQ29sdW1uczFfNl9TYWxlLCAnc2FsZV8xMCcgOiB0b3RhbENvbHVtbnMxXzZfU2FsZSwgJ3B1cmNoYXNlJyA6IHRvdGFsQ29sdW1uczdfOV9QdXJjaGFzZV0NCg0KICAgIGRlZiBzdXBlclJvd3MgPSBbXQ0KICAgIHNlY3Rpb25zU3VwZXIua2V5U2V0KCkuZWFjaCB7IGtleSAtPg0KICAgICAgICBkZWYgc3ViU2VjdGlvbnMgPSBzZWN0aW9uc1N1cGVyW2tleV0NCiAgICAgICAgZGVmIGNvbHVtbnMgPSB0b3RhbENvbHVtbnNTdXBlcltrZXldIC0gc2tpcENvbHVtbnMNCiAgICAgICAgZGVmIGRlY2xhcmF0aW9uQ29sdW1ucyA9IHRvdGFsQ29sdW1uc1N1cGVyW2tleV0gLSBza2lwQ29sdW1uc0RlY2xhcmF0aW9uDQogICAgICAgIC8vINGE0LjQutGB0LjRgNC+0LLQsNC90L3Ri9C1INGB0YLRgNC+0LrQuCAo0JjRgtC+0LPQviDQt9CwICkNCiAgICAgICAgZGVmIHJvd3MgPSBkYXRhUm93cz8uZmluZEFsbCB7IHJvdyAtPg0KICAgICAgICAgICAgcm93LmdldEFsaWFzKCkgIT0gbnVsbCAmJiByb3cuZ2V0QWxpYXMoKSA9PX4gL3RvdGFsX1ske3N1YlNlY3Rpb25zLmpvaW4oJycpfV1fLiovDQogICAgICAgIH0NCiAgICAgICAgZGVmIHN1bU1hcCA9IFs6XQ0KICAgICAgICByb3dzLmVhY2ggeyByb3cgLT4NCiAgICAgICAgICAgIGRlZiBwZXJpb2ROYW1lID0gcm93LmZpeD8ucmVwbGFjZUFsbCgn0JjRgtC+0LPQviDQt9CwICcsICcnKQ0KICAgICAgICAgICAgZGVmIHBlcmlvZElkID0gZ2V0UmVmQm9va1JlY29yZCg4LCAnTkFNRScsIHBlcmlvZE5hbWUsIGdldFJlcG9ydFBlcmlvZEVuZERhdGUoKSwgLTEsIG51bGwsIGZhbHNlKT8ucmVjb3JkX2lkPy52YWx1ZQ0KICAgICAgICAgICAgaWYgKHN1bU1hcFtwZXJpb2RJZF0gPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIHN1bU1hcFtwZXJpb2RJZF0gPSBbXQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgc3VtTWFwW3BlcmlvZElkXS5hZGQocm93KQ0KICAgICAgICB9DQogICAgICAgIHN1bU1hcC5lYWNoIHsgcGVyaW9kVHlwZUlkLCBzZWN0aW9uUm93cyAtPg0KICAgICAgICAgICAgZGVmIHN1cGVyUm93ID0gZ2V0U3VwZXJUb3RhbFJvdyhrZXksIHBlcmlvZFR5cGVJZCBhcyBMb25nKQ0KICAgICAgICAgICAgY29sdW1ucy5lYWNoIHsgYWxpYXMgLT4NCiAgICAgICAgICAgICAgICBzdXBlclJvd1thbGlhc10gPSBCaWdEZWNpbWFsLlpFUk8NCiAgICAgICAgICAgICAgICBzZWN0aW9uUm93cy5lYWNoIHsgcm93IC0+DQogICAgICAgICAgICAgICAgICAgIHN1cGVyUm93W2FsaWFzXSArPSAocm93W2FsaWFzXSA/OiBCaWdEZWNpbWFsLlpFUk8pDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmIChhbGlhcyBpbiBkZWNsYXJhdGlvbkNvbHVtbnMpIHsNCiAgICAgICAgICAgICAgICAgICAgc3VwZXJSb3dbYWxpYXNdICs9IGdldERlY2xhcmF0aW9uQWRkVmFsdWUocGVyaW9kVHlwZUlkLCBrZXksIGFsaWFzKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHN1cGVyUm93cy5hZGQoc3VwZXJSb3cpDQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHN1cGVyUm93cw0KfQ0KDQpkZWYgZ2V0RGVjbGFyYXRpb25BZGRWYWx1ZShkZWYgcGVyaW9kVHlwZUlkLCBkZWYgcm93QWxpYXMsIGRlZiBjb2x1bW5BbGlhcykgew0KICAgIGRlZiByb3dEZWNsYXJhdGlvbk1hcCA9IFsnc2FsZV8xOCcgOiBkZWNsYXJhdGlvblNhbGVNYXAsICdzYWxlXzEwJyA6IGRlY2xhcmF0aW9uU2FsZU1hcCwgJ3B1cmNoYXNlJyA6IGRlY2xhcmF0aW9uUHVyY2hhc2VNYXBdDQogICAgZGVmIGNvbXBsZXhDYWxjTWFwID0gWydzYWxlXzE4JyA6IFsnc3VtUGx1cyc6IFsoJycgKyBkZWNsYXJhdGlvblR5cGU5c291cmNlcyk6IFtbJ9CU0L7QutGD0LzQtdC90YInLCAn0JrQvdC40LPQsNCf0YDQvtC0J10sICfQodGC0J/RgNC+0LTQkdC10LfQndCU0KExOCddLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCcnICsgZGVjbGFyYXRpb25UeXBlOV8xKTogW1sn0JTQvtC60YPQvNC10L3RgicsICfQmtC90LjQs9Cw0J/RgNC+0LTQlNCbJ10sICfQodGC0J/RgNC+0LTQktGB0J8x0KA5XzE4J11dLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1bU5kc1BsdXMnOiBbKCcnICsgZGVjbGFyYXRpb25UeXBlOXNvdXJjZXMpOiBbWyfQlNC+0LrRg9C80LXQvdGCJywgJ9Ca0L3QuNCz0LDQn9GA0L7QtCddLCAn0KHRg9C80J3QlNCh0JLRgdCa0J/RgDE4J10sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoJycgKyBkZWNsYXJhdGlvblR5cGU5XzEpOiBbWyfQlNC+0LrRg9C80LXQvdGCJywgJ9Ca0L3QuNCz0LDQn9GA0L7QtNCU0JsnXSwgJ9Ch0YPQvNCd0JTQodCS0YHQnzHQoDlfMTgnXV1dLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAnc2FsZV8xMCcgOiBbJ3N1bVBsdXMnOiBbKCcnICsgZGVjbGFyYXRpb25UeXBlOXNvdXJjZXMpOiBbWyfQlNC+0LrRg9C80LXQvdGCJywgJ9Ca0L3QuNCz0LDQn9GA0L7QtCddLCAn0KHRgtCf0YDQvtC00JHQtdC30J3QlNChMTAnXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgnJyArIGRlY2xhcmF0aW9uVHlwZTlfMSk6IFtbJ9CU0L7QutGD0LzQtdC90YInLCAn0JrQvdC40LPQsNCf0YDQvtC00JTQmyddLCAn0KHRgtCf0YDQvtC00JLRgdCfMdCgOV8xMCddXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdW1OZHNQbHVzJzogWygnJyArIGRlY2xhcmF0aW9uVHlwZTlzb3VyY2VzKTogW1sn0JTQvtC60YPQvNC10L3RgicsICfQmtC90LjQs9Cw0J/RgNC+0LQnXSwgJ9Ch0YPQvNCd0JTQodCS0YHQmtCf0YAxMCddLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCcnICsgZGVjbGFyYXRpb25UeXBlOV8xKTogW1sn0JTQvtC60YPQvNC10L3RgicsICfQmtC90LjQs9Cw0J/RgNC+0LTQlNCbJ10sICfQodGD0LzQndCU0KHQktGB0J8x0KA5XzEwJ11dXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ3B1cmNoYXNlJzogWydzdW1OZHNQbHVzJzogWygnJyArIGRlY2xhcmF0aW9uVHlwZThzb3VyY2VzKTogW1sn0JTQvtC60YPQvNC10L3RgicsICfQmtC90LjQs9Cw0J/QvtC60YPQvyddLCAn0KHRg9C80J3QlNCh0JLRgdCa0J/QuiddLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCcnICsgZGVjbGFyYXRpb25UeXBlOF8xKTogW1sn0JTQvtC60YPQvNC10L3RgicsICfQmtC90LjQs9Cw0J/QvtC60YPQv9CU0JsnXSwgJ9Ch0YPQvNCd0JTQodCY0YLQnzHQoDgnXV1dXQ0KICAgIERlY2xhcmF0aW9uRGF0YSBkZWNsYXJhdGlvbiA9IHJvd0RlY2xhcmF0aW9uTWFwW3Jvd0FsaWFzXVtwZXJpb2RUeXBlSWRdDQogICAgaWYgKGRlY2xhcmF0aW9uID09IG51bGwpIHsNCiAgICAgICAgcmV0dXJuIEJpZ0RlY2ltYWwuWkVSTw0KICAgIH0NCiAgICBkZWYgZGVjbGFyYXRpb25UZW1wbGF0ZURhbyA9IGRlY2xhcmF0aW9uU2VydmljZS5kZWNsYXJhdGlvblRlbXBsYXRlRGFvDQogICAgZGVmIGRlY2xhcmF0aW9uVHlwZUlkID0gZGVjbGFyYXRpb25UZW1wbGF0ZURhby5nZXQoZGVjbGFyYXRpb24uZGVjbGFyYXRpb25UZW1wbGF0ZUlkKS50eXBlLmlkIGFzIFN0cmluZw0KICAgIGRlZiBkZWNsVHlwZUF0dHJNYXAgPSBjb21wbGV4Q2FsY01hcFtyb3dBbGlhc11bY29sdW1uQWxpYXNdDQogICAgZGVmIGFkZFZhbHVlU3RyaW5nID0gZ2V0RGVjbGFyYXRpb25YbWxBdHRyKGRlY2xhcmF0aW9uLCBkZWNsVHlwZUF0dHJNYXBbZGVjbGFyYXRpb25UeXBlSWRdWzBdLCBkZWNsVHlwZUF0dHJNYXBbZGVjbGFyYXRpb25UeXBlSWRdWzFdKQ0KICAgIHJldHVybiBhZGRWYWx1ZVN0cmluZyA/IG5ldyBCaWdEZWNpbWFsKGFkZFZhbHVlU3RyaW5nKSA6IEJpZ0RlY2ltYWwuWkVSTw0KfQ0KDQovKiog0YHRh9C40YLQsNC10YIg0LjRgtC+0LPQuCwg0YHQv9C10YbQuNGE0LjRh9C90L4sINGCLtC6LiDQtdGB0YLRjCDQvtCx0YrQtdC00LjQvdC10L3QuNGPINC/0L4g0LPRgNCw0YTQsNC8IDQsNSDQuCA3LDggKi8NCnZvaWQgY2FsY1NwZWNpZmljVG90YWxzKGRlZiBkYXRhUm93cywgZGVmIHRvdGFsUm93LCBkZWYgY29sdW1ucykgew0KICAgIGlmIChjb2x1bW5zID09IG51bGwpDQogICAgICAgIHJldHVybg0KICAgIGRlZiB0ZW1wUm93ID0gZm9ybURhdGEuY3JlYXRlRGF0YVJvdygpDQogICAgY2FsY1RvdGFsU3VtKGRhdGFSb3dzLCB0ZW1wUm93LCBjb2x1bW5zKQ0KICAgIGRlZiBzcGVjaWFsQ29sdW1ucyA9IFsnc3VtUGx1cycsICdzdW1NaW51cycsICdzdW1OZHNQbHVzJywgJ3N1bU5kc01pbnVzJ10NCiAgICBjb2x1bW5zLmVhY2ggeyBhbGlhcyAtPg0KICAgICAgICBpZiAoIXNwZWNpYWxDb2x1bW5zLmNvbnRhaW5zKGFsaWFzKSkgew0KICAgICAgICAgICAgdG90YWxSb3dbYWxpYXNdID0gdGVtcFJvd1thbGlhc10NCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoY29sdW1ucy5jb250YWlucygnc3VtUGx1cycpKSB7DQogICAgICAgIHRvdGFsUm93LnN1bVBsdXMgPSB0ZW1wUm93LnN1bVBsdXMgKyB0ZW1wUm93LnN1bU1pbnVzDQogICAgfQ0KICAgIGlmIChjb2x1bW5zLmNvbnRhaW5zKCdzdW1OZHNQbHVzJykpIHsNCiAgICAgICAgdG90YWxSb3cuc3VtTmRzUGx1cyA9IHRlbXBSb3cuc3VtTmRzUGx1cyArIHRlbXBSb3cuc3VtTmRzTWludXMNCiAgICB9DQp9DQoNCnZvaWQgY2FsY1BlcmlvZFRvdGFscyhMaXN0PERhdGFSb3c8Q2VsbD4+IGRhdGFSb3dzKSB7DQogICAgZGVmIHNlY3Rpb24gPSBudWxsDQogICAgZm9yIChpbnQgaSA9IDA7IGkgPCBkYXRhUm93cy5zaXplKCk7IGkrKykgew0KICAgICAgICBEYXRhUm93PENlbGw+IHJvdyA9IGRhdGFSb3dzLmdldChpKTsNCiAgICAgICAgRGF0YVJvdzxDZWxsPiBuZXh0Um93ID0gbnVsbDsNCiAgICAgICAgaWYgKGkgPCBkYXRhUm93cy5zaXplKCkgLSAxKSB7DQogICAgICAgICAgICBuZXh0Um93ID0gZGF0YVJvd3MuZ2V0KGkgKyAxKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAocm93LmdldEFsaWFzKCkgIT0gbnVsbCkgew0KICAgICAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpLnN0YXJ0c1dpdGgoImhlYWRfIikpIHsNCiAgICAgICAgICAgICAgICBzZWN0aW9uID0gcm93LmdldEFsaWFzKCkucmVwbGFjZUFsbCgiaGVhZF8iLCAnJykNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIGlmIChuZXh0Um93ID09IG51bGwgfHwgaXNEaWZmUm93KHJvdywgbmV4dFJvdywgZ3JvdXBDb2x1bW5zKSkgew0KICAgICAgICAgICAgRGF0YVJvdzxDZWxsPiBhbGlhc2VkUm93ID0gY2FsY0l0b2coaSwgZGF0YVJvd3MsIHNlY3Rpb24sIHJvdy5wZXJpb2QpOw0KICAgICAgICAgICAgZGF0YVJvd3MuYWRkKCsraSwgYWxpYXNlZFJvdyk7DQogICAgICAgIH0NCiAgICB9DQp9DQoNCi8vINCg0LDRgdGH0LXRgiDQv9C+0LTQuNGC0L7Qs9C+0LLQvtCz0L4g0LfQvdCw0YfQtdC90LjRjw0KRGF0YVJvdzxDZWxsPiBjYWxjSXRvZyhkZWYgaW50IGksIGRlZiBMaXN0PERhdGFSb3c8Q2VsbD4+IGRhdGFSb3dzLCBkZWYgc2VjdGlvbiwgZGVmIHBlcmlvZElkKSB7DQogICAgZGVmIG5ld1JvdyA9IGdldFBlcmlvZFRvdGFsUm93KHNlY3Rpb24sIHBlcmlvZElkKQ0KDQogICAgLy8g0KDQsNGB0YfQtdGC0Ysg0L/QvtC00LjRgtC+0LPQvtCy0YvRhSDQt9C90LDRh9C10L3QuNC5DQogICAgZGVmIHJvd3MgPSBbXQ0KICAgIGZvciAoaW50IGogPSBpOyBqID49IDAgJiYgZGF0YVJvd3MuZ2V0KGopLmdldEFsaWFzKCkgPT0gbnVsbDsgai0tKSB7DQogICAgICAgIHJvd3MuYWRkKGRhdGFSb3dzLmdldChqKSkNCiAgICB9DQogICAgZGVmIGNvbHVtbnMNCiAgICBpZiAoc2VjdGlvbiAhPSBudWxsICYmIEludGVnZXIudmFsdWVPZihzZWN0aW9uKSA8IDcpIHsNCiAgICAgICAgY29sdW1ucyA9IHRvdGFsQ29sdW1uczFfNl9TYWxlDQogICAgfSBlbHNlIGlmIChzZWN0aW9uICE9IG51bGwgJiYgSW50ZWdlci52YWx1ZU9mKHNlY3Rpb24pID4gNikgew0KICAgICAgICBjb2x1bW5zID0gdG90YWxDb2x1bW5zN185X1B1cmNoYXNlDQogICAgfQ0KICAgIGNhbGNTcGVjaWZpY1RvdGFscyhyb3dzLCBuZXdSb3csIGNvbHVtbnMpDQogICAgcmV0dXJuIG5ld1Jvdw0KfQ0KDQovKiog0J/QvtC70YPRh9C40YLRjCDQvdC+0LLRg9GOINC40YLQvtCz0L7QstGD0Y4g0YHRgtGA0L7QutGDINGBINC30LDQtNCw0L3QvdGL0LzQuCDRgdGC0LjQu9GP0LzQuC4gKi8NCmRlZiBnZXRTdXBlclRvdGFsUm93KGRlZiBrZXksIGRlZiBwZXJpb2RJZCkgew0KICAgIGRlZiBuZXdSb3cgPSAoZm9ybURhdGFFdmVudCBpbiBbRm9ybURhdGFFdmVudC5JTVBPUlQsIEZvcm1EYXRhRXZlbnQuSU1QT1JUX1RSQU5TUE9SVF9GSUxFXSkgPyBmb3JtRGF0YS5jcmVhdGVTdG9yZU1lc3NhZ2luZ0RhdGFSb3coKSA6IGZvcm1EYXRhLmNyZWF0ZURhdGFSb3coKQ0KICAgIGRlZiByZWZCb29rVmFsdWUgPSBnZXRSZWZCb29rVmFsdWUoOCwgcGVyaW9kSWQpDQogICAgbmV3Um93LmZpeCA9IFN0cmluZy5mb3JtYXQoc2VjdGlvbnNMYWJlbHNba2V5XSwgcmVmQm9va1ZhbHVlPy5OQU1FPy5zdHJpbmdWYWx1ZSA/OiAi0LPRgNCw0YTQsCAyINC90LUg0LfQsNC00LDQvdCwIikNCiAgICBuZXdSb3cuZ2V0Q2VsbCgnZml4JykuY29sU3BhbiA9IDINCiAgICBuZXdSb3cuZ2V0Q2VsbCgnc3VtUGx1cycpLmNvbFNwYW4gPSAyDQogICAgbmV3Um93LmdldENlbGwoJ3N1bU5kc1BsdXMnKS5jb2xTcGFuID0gMg0KICAgIG5ld1Jvdy5zZXRBbGlhcygnc3VwZXJfJyArIGtleSArICdfJyArIHJlZkJvb2tWYWx1ZT8uQ09ERT8uc3RyaW5nVmFsdWUpDQogICAgYWxsQ29sdW1ucy5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLnN0eWxlQWxpYXMgPSAn0JrQvtC90YLRgNC+0LvRjNC90YvQtSDRgdGD0LzQvNGLJw0KICAgIH0NCiAgICByZXR1cm4gbmV3Um93DQp9DQoNCnZvaWQgbG9naWNDaGVjaygpIHsNCiAgICBkZWYgZGF0YVJvd3MgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSkuYWxsQ2FjaGVkDQoNCiAgICBkZWYgaXNBZnRlclNlY3Rpb242ID0gZmFsc2UNCiAgICBkZWYgc2VjdGlvbiA9IG51bGwNCiAgICBmb3IgKGRlZiByb3cgOiBkYXRhUm93cykgew0KICAgICAgICBpZiAocm93LmdldEFsaWFzKCkgIT0gbnVsbCkgew0KICAgICAgICAgICAgaWYgKHJvdy5nZXRBbGlhcygpLnN0YXJ0c1dpdGgoJ2hlYWRfJykpew0KICAgICAgICAgICAgICAgIHNlY3Rpb24gPSByb3cuZ2V0QWxpYXMoKS5yZXBsYWNlQWxsKCdoZWFkXycsICcnKQ0KICAgICAgICAgICAgICAgIGlmIChzZWN0aW9uID09ICc3Jykgew0KICAgICAgICAgICAgICAgICAgICBpc0FmdGVyU2VjdGlvbjYgPSB0cnVlDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgfQ0KICAgICAgICBkZWYgaW5kZXggPSByb3cuZ2V0SW5kZXgoKQ0KDQogICAgICAgIC8vIDEuINCf0YDQvtCy0LXRgNC60LAg0LfQsNC/0L7Qu9C90LXQvdC40Y8g0LPRgNCw0YQNCiAgICAgICAgY2hlY2tOb25FbXB0eUNvbHVtbnMocm93LCBpbmRleCwgbm9uRW1wdHlDb2x1bW5zLCBsb2dnZXIsIHRydWUpDQoNCiAgICAgICAgLy8gMi4g0J/RgNC+0LLQtdGA0LrQsCDQvdCw0LvQvtCz0L7QstC+0LPQviDQv9C10YDQuNC+0LTQsA0KICAgICAgICBpZiAocm93LnBlcmlvZCkgew0KICAgICAgICAgICAgZGVmIHBlcmlvZFR5cGUgPSBnZXRSZWZCb29rVmFsdWUoOCwgcm93LnBlcmlvZCkNCiAgICAgICAgICAgIGlmICghcGVyaW9kTmFtZXMuY29udGFpbnMocGVyaW9kVHlwZT8uTkFNRT8uc3RyaW5nVmFsdWUpKSB7DQogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJHtyb3cuZ2V0SW5kZXgoKX06INCT0YDQsNGE0LAgwqske2dldENvbHVtbk5hbWUoZGF0YVJvd3NbMF0sICdwZXJpb2QnKX3CuyDQt9Cw0L/QvtC70L3QtdC90LAg0L3QtdCy0LXRgNC90L4hINCS0L7Qt9C80L7QttC90YvQtSDQt9C90LDRh9C10L3QuNGPOiDCqyR7cGVyaW9kTmFtZXMuam9pbignwrssIMKrJyl9wrsuIikNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIC8vIDMuINCf0YDQvtCy0LXRgNC60LAg0L3QtdC30LDQv9C+0LvQvdC10L3QvdC+0YHRgtC4INCz0YDQsNGEINGBINGB0YPQvNC80L7QuSDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuA0KICAgICAgICBpZiAoaXNBZnRlclNlY3Rpb242ICYmIGVtcHR5Q29sdW1uc183XzkuZmluZCB7IHJvd1tpdF0gIT0gbnVsbCB9ICE9IG51bGwpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA'

    longString += '0L7QutCwICRpbmRleDog0JPRgNCw0YTRiyDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCssIC0pINC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyAo0YDQsNC30LTQtdC7IDctOSkg0L3QtSDQtNC+0LvQttC90Ysg0LHRi9GC0Ywg0LfQsNC/0L7Qu9C90LXQvdGLISIpDQogICAgICAgIH0NCg0KICAgICAgICAvLyA0LiDQn9GA0L7QstC10YDQutCwINC90LAg0LfQsNC/0L7Qu9C90LXQvdC40LUg0YXQvtGC0Y8g0LHRiyDQvtC00L3QvtC5INC40Lcg0LPRgNCw0YQgwqsrwrssIMKrLcK7INGBINGB0YPQvNC80L7QuSDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuA0KICAgICAgICAvLyA1LiDQn9GA0L7QstC10YDQutCwINC/0L7Qu9C+0LbQuNGC0LXQu9GM0L3QvtGB0YLQuCDRgdGD0LzQvNGLINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4DQogICAgICAgIC8vIDYuINCf0YDQvtCy0LXRgNC60LAg0L7RgtGA0LjRhtCw0YLQtdC70YzQvdC+0YHRgtC4INGB0YPQvNC80Ysg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LgNCiAgICAgICAgaWYgKCFpc0FmdGVyU2VjdGlvbjYpIHsNCiAgICAgICAgICAgIGlmIChyb3cuc3VtUGx1cyA9PSBudWxsICYmIHJvdy5zdW1NaW51cyA9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQlNC+0LvQttC90LAg0LHRi9GC0Ywg0LfQsNC/0L7Qu9C90LXQvdCwINGF0L7RgtGPINCx0Ysg0L7QtNC90LAg0LjQtyDQs9GA0LDRhCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCssIC0pINC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyAo0YDQsNC30LTQtdC7IDEtNikhIikNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChyb3cuc3VtUGx1cyAhPSBudWxsICYmICEocm93LnN1bVBsdXMgPiAwKSkgew0KICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspINC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyAo0YDQsNC30LTQtdC7IDEtNikg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LHQvtC70YzRiNC1IMKrMMK7ISIpDQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAocm93LnN1bU1pbnVzICE9IG51bGwgJiYgIShyb3cuc3VtTWludXMgPCAwKSkgew0KICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKC0pINC90LDQu9C+0LPQvtCy0L7QuSDQsdCw0LfRiyAo0YDQsNC30LTQtdC7IDEtNikg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LzQtdC90YzRiNC1IMKrMMK7ISIpDQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBpZiAocm93LnN1bU5kc1BsdXMgPT0gbnVsbCAmJiByb3cuc3VtTmRzTWludXMgPT0gbnVsbCkgew0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQlNC+0LvQttC90LAg0LHRi9GC0Ywg0LfQsNC/0L7Qu9C90LXQvdCwINGF0L7RgtGPINCx0Ysg0L7QtNC90LAg0LjQtyDQs9GA0LDRhCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCssIC0pINCd0JTQoSAo0YDQsNC30LTQtdC7IDEtOSkhIikNCiAgICAgICAgfQ0KICAgICAgICBpZiAocm93LnN1bU5kc1BsdXMgIT0gbnVsbCAmJiAhKHJvdy5zdW1OZHNQbHVzID4gMCkpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKCspINCd0JTQoSAo0YDQsNC30LTQtdC7IDEtOSkg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LHQvtC70YzRiNC1IMKrMMK7ISIpDQogICAgICAgIH0NCiAgICAgICAgaWYgKHJvdy5zdW1OZHNNaW51cyAhPSBudWxsICYmICEocm93LnN1bU5kc01pbnVzIDwgMCkpIHsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigi0KHRgtGA0L7QutCwICRpbmRleDog0JPRgNCw0YTQsCDRgSDRgdGD0LzQvNC+0Lkg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LggKC0pINCd0JTQoSAo0YDQsNC30LTQtdC7IDEtOSkg0LTQvtC70LbQvdCwINCx0YvRgtGMINC30LDQv9C+0LvQvdC10L3QsCDQt9C90LDRh9C10L3QuNC10Lwg0LzQtdC90YzRiNC1IMKrMMK7ISIpDQogICAgICAgIH0NCg0KICAgICAgICAvLyA3LiDQn9GA0L7QstC10YDQutCwINC90L7QvNC10YDQsCDQsdCw0LvQsNC90YHQvtCy0L7Qs9C+INGB0YfQtdGC0LANCiAgICAgICAgaWYgKHJvdy5udW1iZXJOZHMgIT0gbnVsbCkgew0KICAgICAgICAgICAgZGVmIG51bWJlck5kcyA9IGdldFJlZkJvb2tWYWx1ZSgxMDEsIHJvdy5udW1iZXJOZHMpLkFDQ09VTlQudmFsdWUNCiAgICAgICAgICAgIGRlZiB2YWxpZE51bWJlcnMgPSBudW1iZXJNYXBbc2VjdGlvbl1bMF0NCiAgICAgICAgICAgIGlmIChzZWN0aW9uICE9IG51bGwgJiYgIXZhbGlkTnVtYmVycy5jb250YWlucyhudW1iZXJOZHMpKSB7DQogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQk9GA0LDRhNCwIMKrJHtnZXRDb2x1bW5OYW1lKHJvdywnbnVtYmVyTmRzJyl9wrsg0LfQsNC/0L7Qu9C90LXQvdCwINC90LXQstC10YDQvdC+ISDQktC+0LfQvNC+0LbQvdGL0LUg0LfQvdCw0YfQtdC90LjRjyAo0YDQsNC30LTQtdC7ICR7bnVtYmVyTWFwW3NlY3Rpb25dWzFdfSk6INC/0YPRgdGC0L7QtSDQt9C90LDRh9C10L3QuNC1LCDCqyR7dmFsaWROdW1iZXJzLmpvaW4oJ8K7LCDCqycpfcK7LiIpDQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAvLyA4LiDQn9GA0L7QstC10YDQutCwINGB0YLQsNCy0LrQuCDQndCU0KENCiAgICAgICAgZGVmIHZhbGlkUmF0ZSA9IHJhdGVNYXBbc2VjdGlvbl1bMF0NCiAgICAgICAgaWYgKHJvdy5yYXRlTmRzICYmIHZhbGlkUmF0ZSAhPSByb3cucmF0ZU5kcykgew0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJGluZGV4OiDQk9GA0LDRhNCwIMKrJHtnZXRDb2x1bW5OYW1lKHJvdywncmF0ZU5kcycpfcK7INC30LDQv9C+0LvQvdC10L3QsCDQvdC10LLQtdGA0L3QviEg0JLQvtC30LzQvtC20L3QvtC1INC30L3QsNGH0LXQvdC40LUgKNGA0LDQt9C00LXQuyAke3JhdGVNYXBbc2VjdGlvbl1bMV19KTogwqskdmFsaWRSYXRlwrsuIikNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIDkuINCf0YDQvtCy0LXRgNC60LAg0YHRg9C80LzRiyDQndCU0KEg0L/QviDQtNC+0L/QvtC70L3QuNGC0LXQu9GM0L3Ri9C8INC70LjRgdGC0LDQvCDQutC90LjQs9C4INC/0L7QutGD0L/QvtC6INC4INC/0YDQvtC00LDQtg0KICAgICAgICBpZiAocm93LnN1bSAhPSBudWxsKSB7DQogICAgICAgICAgICBjYWxjQ2hlY2sxMChyb3csIHJvdy5zdW0pDQogICAgICAgIH0NCiAgICB9DQogICAgY2hlY2tGaWxsRGVjbGFyYXRpb25NYXAoZmFsc2UpIC8vINC30LDQv9C+0LvQvdGP0LXQvCDQtNC10LrQu9Cw0YDQsNGG0LjQuC3QuNGB0YLQvtGH0L3QuNC60LgNCiAgICBjb21wYXJlU3BlY2lmaWNUb3RhbFZhbHVlcyhkYXRhUm93cywgYXJyYW5nZVJvd3MoZGF0YVJvd3MpKQ0KDQogICAgLy8gMTUuINCf0YDQvtCy0LXRgNC60LAg0YDQsNC30YDRj9C00L3QvtGB0YLQuCDQuNGC0L7Qs9C+0LLRi9GFINC30L3QsNGH0LXQvdC40LksINC40YHQv9C+0LvRjNC30YPQtdC80YvRhSDQtNC70Y8g0LfQsNC/0L7Qu9C90LXQvdC40Y8g0YHRgtGA0L7QuiDQoNCw0LfQtNC10LvQsCAzINC00LXQutC70LDRgNCw0YbQuNC4INCd0JTQoSwg0YDQsNC30YDRj9C00L3QvtGB0YLRjCDQutC+0YLQvtGA0YvRhSAxNA0KICAgIGRlZiBzaXplID0gMTQNCiAgICBkZWYgcm93cyA9IFtdDQogICAgZGVmIGNoZWNrQ29sdW1ucyA9IHRvdGFsQ29sdW1uczFfNl9TYWxlDQogICAgWyd0b3RhbF8xXycsICd0b3RhbF8yXycsICd0b3RhbF8zXycsICd0b3RhbF80XycsICd0b3RhbF81XycsICd0b3RhbF82XycsICd0b3RhbF84XycsICd0b3RhbF85XyddLmVhY2ggeyBzdWJBbGlhcyAtPg0KICAgICAgICBkZWYgcm93ID0gZGF0YVJvd3MuZmluZCB7IGl0LmdldEFsaWFzKCk/LmNvbnRhaW5zKHN1YkFsaWFzKSB9DQogICAgICAgIGlmIChyb3cpIHsNCiAgICAgICAgICAgIHJvd3MuYWRkKHJvdykNCiAgICAgICAgfQ0KICAgIH0NCiAgICByb3dzLmVhY2ggeyByb3cgLT4NCiAgICAgICAgY2hlY2tDb2x1bW5zLmVhY2ggeyBhbGlhcyAtPg0KICAgICAgICAgICAgQmlnRGVjaW1hbCB2YWx1ZSA9IHJvd1thbGlhc10NCiAgICAgICAgICAgIGlmICghY2hlY2tPdmVyZmxvdyh2YWx1ZSwgc2l6ZSkpIHsNCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoItCh0YLRgNC+0LrQsCAlZDog0J7QutGA0YPQs9C70LXQvdC90L7QtSDQtNC+INGG0LXQu9C+0LPQviDQt9C90LDRh9C10L3QuNC1INCz0YDQsNGE0Ysgwqslc8K7ICglcykg0L/RgNC10LLRi9GI0LDQtdGCINC00L7Qv9GD0YHRgtC40LzRg9GOINGA0LDQt9GA0Y/QtNC90L7RgdGC0YwgJWQhICIgKw0KICAgICAgICAgICAgICAgICAgICAgICAgItCX0L3QsNGH0LXQvdC40LUg0LTQsNC90L3QvtC5INCz0YDQsNGE0Ysg0LjRgdC/0L7Qu9GM0LfRg9C10YLRgdGPINC00LvRjyDQt9Cw0L/QvtC70L3QtdC90LjRjyDRgdGC0YDQvtC60Lgg0KDQsNC30LTQtdC70LAgMyDQtNC10LrQu9Cw0YDQsNGG0LjQuCDQndCU0KEsINGA0LDQt9GA0Y/QtNC90L7RgdGC0Ywg0LrQvtGC0L7RgNC+0LkgJWQuIiwNCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdy5nZXRJbmRleCgpLCBnZXRDb2x1bW5OYW1lKHJvdywgYWxpYXMpLCB2YWx1ZSwgc2l6ZSwgc2l6ZSkNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCn0NCg0Kdm9pZCBjaGVja0RlY2xhcmF0aW9uQWNjZXB0ZWQoKSB7DQogICAgZGVmIGRlY2xhcmF0aW9uVHlwZUlkc01hcCA9IFs0IDogJ9CU0LXQutC70LDRgNCw0YbQuNGPINC/0L4g0J3QlNChICjRgNCw0LfQtNC10LsgMS03KScsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICA3IDogJ9CU0LXQutC70LDRgNCw0YbQuNGPINC/0L4g0J3QlNChICjQsNGD0LTQuNGCLCDRgNCw0LfQtNC10LsgMS03KScsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyMCA6ICfQlNC10LrQu9Cw0YDQsNGG0LjRjyDQv9C+INCd0JTQoSAo0LrQvtGA0L7RgtC60LDRjywg0YDQsNC30LTQtdC7IDEtNyknLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTMgOiAn0JTQtdC60LvQsNGA0LDRhtC40Y8g0L/QviDQndCU0KEgKNGA0LDQt9C00LXQuyA4LjEpJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDE1IDogJ9CU0LXQutC70LDRgNCw0YbQuNGPINC/0L4g0J3QlNChICjRgNCw0LfQtNC10LsgOS4xKSddDQogICAgZGVmIHJlcG9ydFBlcmlvZCA9IGdldFJlcG9ydFBlcmlvZChmb3JtRGF0YS5yZXBvcnRQZXJpb2RJZCkNCiAgICBpZiAoZm9ybURhdGEua2luZCA9PSBGb3JtRGF0YUtpbmQuQ09OU09MSURBVEVEICYmIGZvcm1EYXRhLmRlcGFydG1lbnRJZCA9PSB1bnBJZCAmJiByZXBvcnRQZXJpb2Qub3JkZXIgPT0gNCAmJiByZXBvcnRQZXJpb2RTZXJ2aWNlLmdldENvcnJlY3Rpb25OdW1iZXIoZm9ybURhdGEuZGVwYXJ0bWVudFJlcG9ydFBlcmlvZElkKSAhPSAwKSB7DQogICAgICAgIERlcGFydG1lbnRSZXBvcnRQZXJpb2RGaWx0ZXIgZmlsdGVyID0gbmV3IERlcGFydG1lbnRSZXBvcnRQZXJpb2RGaWx0ZXIoKQ0KICAgICAgICAvLyDQuNGJ0LXQvCDQsiDQutC+0YDRgNC10LrRgtC40YDRg9GO0YnQtdC8INC/0LXRgNC40L7QtNC1DQogICAgICAgIGZpbHRlci5pc0NvcnJlY3Rpb24gPSB0cnVlDQogICAgICAgIGZpbHRlci5kZXBhcnRtZW50SWRMaXN0ID0gW3VucElkXQ0KICAgICAgICBmaWx0ZXIudGF4VHlwZUxpc3QgPSBbVGF4VHlwZS5WQVRdDQogICAgICAgIGZpbHRlci55ZWFyU3RhcnQgPSByZXBvcnRQZXJpb2QudGF4UGVyaW9kLnllYXINCiAgICAgICAgZmlsdGVyLnllYXJFbmQgPSByZXBvcnRQZXJpb2QudGF4UGVyaW9kLnllYXINCiAgICAgICAgZGVmIGRlcGFydG1lbnRSZXBvcnRQZXJpb2RzID0gZ2V0TGlzdEJ5RmlsdGVyKGZpbHRlcikNCiAgICAgICAgYm9vbGVhbiBmb3VuZEFjY2VwdGVkID0gZmFsc2UNCiAgICAgICAgZGVjbGFyYXRpb25UeXBlSWRzTWFwLmVhY2ggeyBkZWNsYXJhdGlvblR5cGVJZCwgdHlwZU5hbWUgLT4NCiAgICAgICAgICAgIGRlcGFydG1lbnRSZXBvcnRQZXJpb2RzLmVhY2ggeyBkcnAgLT4NCiAgICAgICAgICAgICAgICBkZWYgZGVjbGFyYXRpb25zID0gZGVjbGFyYXRpb25TZXJ2aWNlLmZpbmQoZGVjbGFyYXRpb25UeXBlSWQgYXMgSW50ZWdlciwgZHJwLmlkKS5maW5kQWxsIHsgaXQuYWNjZXB0ZWQgfQ0KICAgICAgICAgICAgICAgIGlmICghZGVjbGFyYXRpb25zLmlzRW1wdHkoKSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoIWZvdW5kQWNjZXB0ZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuKCLQodGD0YnQtdGB0YLQstGD0Y7RgiDQv9GA0LjQvdGP0YLRi9C1INGN0LrQt9C10LzQv9C70Y/RgNGLINC00LXQutC70LDRgNCw0YbQuNC5LdC/0YDQuNC10LzQvdC40LrQvtCyOiIpDQogICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEFjY2VwdGVkID0gdHJ1ZQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGRlZiBwZXJpb2QgPSBnZXRSZXBvcnRQZXJpb2QoZHJwLnJlcG9ydFBlcmlvZC5pZCkNCiAgICAgICAgICAgICAgICAgICAgZGVjbGFyYXRpb25zLmVhY2ggeyBkZWNsYXJhdGlvbiAtPg0KICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm4oItCS0LjQtDogwqslc8K7LCDQn9C+0LTRgNCw0LfQtNC10LvQtdC90LjQtTogwqslc8K7LCDQn9C10YDQuNC+0LQ6IMKrJXMsICVzwrssINCU0LDRgtCwINGB0LTQsNGH0Lgg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60Lg6IMKrJXPCuy4iLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlTmFtZSwgZGVwYXJ0bWVudFNlcnZpY2UuZ2V0KGRlY2xhcmF0aW9uLmRlcGFydG1lbnRJZCksIHJlcG9ydFBlcmlvZC50YXhQZXJpb2QueWVhciwgZ2V0UmVmQm9va1ZhbHVlKDgsIHBlcmlvZC5kaWN0VGF4UGVyaW9kSWQpLk5BTUUudmFsdWUsIGRycC5jb3JyZWN0aW9uRGF0ZS5mb3JtYXQoJ2RkLk1NLnl5eXknKSkNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCn0NCg0Kdm9pZCBjb25zb2xpZGF0aW9uKCkgew0KICAgIGRlZiBkYXRhUm93SGVscGVyID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpDQogICAgZGVmIGRhdGFSb3dzID0gZm9ybURhdGFTZXJ2aWNlLmdldEZvcm1UZW1wbGF0ZShmb3JtRGF0YS5mb3JtVHlwZS5pZCwgZm9ybURhdGEucmVwb3J0UGVyaW9kSWQpLnJvd3MNCiAgICB1cGRhdGVJbmRleGVzKGRhdGFSb3dzKQ0KDQogICAgLy8g0YHQvtCx0YDQsNGC0Ywg0LjQtyDQuNGB0YLQvtGH0L3QuNC60L7QsiDRgdGC0YDQvtC60Lgg0Lgg0YDQsNC30LzQtdGB0YLQuNGC0Ywg0YHQvtC+0YLQstC10YLRgdGC0LLRg9GO0YnQuNC8INGA0LDQt9C00LXQu9Cw0LwNCiAgICBkZXBhcnRtZW50Rm9ybVR5cGVTZXJ2aWNlLmdldEZvcm1Tb3VyY2VzKGZvcm1EYXRhRGVwYXJ0bWVudC5pZCwgZm9ybURhdGEuZm9ybVR5cGUuaWQsIGZvcm1EYXRhLmtpbmQsDQogICAgICAgICAgICBnZXRSZXBvcnRQZXJpb2RTdGFydERhdGUoKSwgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpKS5lYWNoIHsNCiAgICAgICAgaWYgKGl0LmZvcm1UeXBlSWQgPT0gZm9ybURhdGEuZm9ybVR5cGUuaWQpIHsNCiAgICAgICAgICAgIGRlZiBzb3VyY2UgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0TGFzdChpdC5mb3JtVHlwZUlkLCBpdC5raW5kLCBpdC5kZXBhcnRtZW50SWQsIGZvcm1EYXRhLnJlcG9ydFBlcmlvZElkLCBmb3JtRGF0YS5wZXJpb2RPcmRlciwgZm9ybURhdGEuY29tcGFyYXRpdmVQZXJpb2RJZCwgZm9ybURhdGEuYWNjcnVpbmcpDQogICAgICAgICAgICBpZiAoc291cmNlICE9IG51bGwgJiYgc291cmNlLnN0YXRlID09IFdvcmtmbG93U3RhdGUuQUNDRVBURUQpIHsNCiAgICAgICAgICAgICAgICBkZWYgc291cmNlRGF0YVJvd3MgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihzb3VyY2UpLmFsbENhY2hlZA0KICAgICAgICAgICAgICAgIC8vINC60L7Qv9C40YDQvtCy0LDQvdC40LUg0LTQsNC90L3Ri9GFINC/0L4g0YDQsNC30LTQtdC70LDQvA0KICAgICAgICAgICAgICAgIHNlY3Rpb25zLmVhY2ggeyBzZWN0aW9uIC0+DQogICAgICAgICAgICAgICAgICAgIGNvcHlSb3dzKHNvdXJjZURhdGFSb3dzLCBkYXRhUm93cywgJ2hlYWRfJyArIHNlY3Rpb24sICdoZWFkXycgKyAoSW50ZWdlci52YWx1ZU9mKHNlY3Rpb24pICsgMSkpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIGRhdGFSb3dIZWxwZXIuc2V0QWxsQ2FjaGVkKGRhdGFSb3dzKQ0KfQ0KDQovKioNCiAqINCa0L7Qv9C40YDQvtCy0LDRgtGMINC30LDQtNCw0L3QvdGL0Lkg0LTQuNCw0L/QvtC30L7QvSDRgdGC0YDQvtC6INC40Lcg0LjRgdGC0L7Rh9C90LjQutCwINCyINC/0YDQuNC10LzQvdC40LouDQogKg0KICogQHBhcmFtIHNvdXJjZURhdGFSb3dzINGB0YLRgNC+0LrQuCDQuNGB0YLQvtGH0L3QuNC60LANCiAqIEBwYXJhbSBkZXN0aW5hdGlvbkRhdGFSb3dzINGB0YLRgNC+0LrQuCDQv9GA0LjQtdC80L3QuNC60LANCiAqIEBwYXJhbSBmcm9tQWxpYXMg0L/RgdC10LLQtNC+0L3QuNC8INGB0YLRgNC+0LrQuCDRgSDQutC+0YLQvtGA0L7QuSDQutC+0L/QuNGA0L7QstCw0YLRjCDRgdGC0YDQvtC60LggKNCd0JUg0LLQutC70Y7Rh9C40YLQtdC70YzQvdC+KQ0KICogQHBhcmFtIHRvQWxpYXMg0L/RgdC10LLQtNC+0L3QuNC8INGB0YLRgNC+0LrQuCDQtNC+INC60L7RgtC+0YDQvtC5INC60L7Qv9C40YDQvtCy0LDRgtGMINGB0YLRgNC+0LrQuCAo0J3QlSDQstC60LvRjtGH0LjRgtC10LvRjNC90L4pLA0KICogICAgICDQsiDQv9GA0LjQtdC80L3QuNC6INGB0YLRgNC+0LrQuCDQstGB0YLQsNCy0LvRj9GO0YLRgdGPINC/0LXRgNC10LQg0YHRgtGA0L7QutC+0Lkg0YEg0Y3RgtC40Lwg0L/RgdC10LLQtNC+0L3QuNC80L7QvA0KICovDQp2b2lkIGNvcHlSb3dzKGRlZiBzb3VyY2VEYXRhUm93cywgZGVmIGRlc3RpbmF0aW9uRGF0YVJvd3MsIGRlZiBmcm9tQWxpYXMsIGRlZiB0b0FsaWFzKSB7DQogICAgaWYgKHRvQWxpYXMgPT0gJ2hlYWRfNycpIHsNCiAgICAgICAgdG9BbGlhcyA9ICdtZWdhX3RvdGFsJw0KICAgIH0NCiAgICBkZWYgZnJvbSA9IGdldERhdGFSb3coc291cmNlRGF0YVJvd3MsIGZyb21BbGlhcykuZ2V0SW5kZXgoKQ0KICAgIGRlZiB0byA9ICh0b0FsaWFzICE9ICdoZWFkXzEwJykgPyAoZ2V0RGF0YVJvdyhzb3VyY2VEYXRhUm93cywgdG9BbGlhcykuZ2V0SW5kZXgoKSAtIDEpIDogc291cmNlRGF0YVJvd3Muc2l6ZSgpDQogICAgaWYgKGZyb20gPj0gdG8pIHsNCiAgICAgICAgcmV0dXJuDQogICAgfQ0KICAgIGRlZiBjb3B5Um93cyA9IHNvdXJjZURhdGFSb3dzLnN1Ykxpc3QoZnJvbSwgdG8pDQogICAgaWYgKHRvQWxpYXMgIT0gJ2hlYWRfMTAnKSB7DQogICAgICAgIGRlc3RpbmF0aW9uRGF0YVJvd3MuYWRkQWxsKGdldERhdGFSb3coZGVzdGluYXRpb25EYXRhUm93cywgdG9BbGlhcykuZ2V0SW5kZXgoKSAtIDEsIGNvcHlSb3dzKQ0KICAgIH0gZWxzZSB7DQogICAgICAgIGRlc3RpbmF0aW9uRGF0YVJvd3MuYWRkQWxsKGNvcHlSb3dzKQ0KICAgIH0NCiAgICAvLyDQv9C+0L/RgNCw0LLQuNGC0Ywg0LjQvdC00LXQutGB0YssINC/0L7RgtC+0LzRgyDRh9GC0L4g0L7QvdC4INC/0L7RgdC70LUg0LLRgdGC0LDQstC60Lgg0L3QtSDQv9C10YDQtdGB0YfQuNGC0YvQstCw0Y7RgtGB0Y8NCiAgICB1cGRhdGVJbmRleGVzKGRlc3RpbmF0aW9uRGF0YVJvd3MpDQp9DQoNCkRhdGFSb3c8Q2VsbD4gZ2V0UGVyaW9kVG90YWxSb3coZGVmIHNlY3Rpb24sIGRlZiBwZXJpb2RJZCkgew0KICAgIGRlZiBuZXdSb3cgPSAoZm9ybURhdGFFdmVudCBpbiBbRm9ybURhdGFFdmVudC5JTVBPUlQsIEZvcm1EYXRhRXZlbnQuSU1QT1JUX1RSQU5TUE9SVF9GSUxFXSkgPyBmb3JtRGF0YS5jcmVhdGVTdG9yZU1lc3NhZ2luZ0RhdGFSb3coKSA6IGZvcm1EYXRhLmNyZWF0ZURhdGFSb3coKQ0KICAgIGRlZiByZWZCb29rVmFsdWUgPSBnZXRSZWZCb29rVmFsdWUoOCwgcGVyaW9kSWQpDQogICAgbmV3Um93LmZpeCA9ICfQmNGC0L7Qs9C+INC30LAgJyArIChyZWZCb29rVmFsdWU/Lk5BTUU/LnN0cmluZ1ZhbHVlID86ICLQs9GA0LDRhNCwIDIg0L3QtSDQt9Cw0LTQsNC90LAiKQ0KICAgIG5ld1Jvdy5zZXRBbGlhcygndG90YWxfJyArIHNlY3Rpb24gKyAnXycgKyByZWZCb29rVmFsdWU/LkNPREU/LnN0cmluZ1ZhbHVlKQ0KICAgIG5ld1Jvdy5nZXRDZWxsKCdmaXgnKS5jb2xTcGFuID0gMg0KICAgIG5ld1Jvdy5nZXRDZWxsKCdzdW1QbHVzJykuY29sU3BhbiA9IDINCiAgICBuZXdSb3cuZ2V0Q2VsbCgnc3VtTmRzUGx1cycpLmNvbFNwYW4gPSAyDQogICAgYWxsQ29sdW1ucy5lYWNoIHsNCiAgICAgICAgbmV3Um93LmdldENlbGwoaXQpLnNldFN0eWxlQWxpYXMoJ9Ca0L7QvdGC0YDQvtC70YzQvdGL0LUg0YHRg9C80LzRiycpDQogICAgfQ0KICAgIHJldHVybiBuZXdSb3cNCn0NCg0KZGVmIGFycmFuZ2VSb3dzKGRhdGFSb3dzKSB7DQogICAgZGVmIHNlY3Rpb25NYXAgPSBbOl0NCiAgICBzZWN0aW9ucy5lYWNoIHsgc2VjdGlvbiAtPg0KICAgICAgICBkZWYgZnJvbUFsaWFzID0gJ2hlYWRfJyArIHNlY3Rpb24NCiAgICAgICAgZGVmIHRvQWxpYXMgPSAnaGVhZF8nICsgKEludGVnZXIudmFsdWVPZihzZWN0aW9uKSArIDEpDQogICAgICAgIGlmICh0b0FsaWFzID09ICdoZWFkXzcnKSB7DQogICAgICAgICAgICB0b0FsaWFzID0gJ21lZ2FfdG90YWwnDQogICAgICAgIH0NCiAgICAgICAgZGVmIGZyb20gPSBnZXREYXRhUm93KGRhdGFSb3dzLCBmcm9tQWxpYXMpLmdldEluZGV4KCkNCiAgICAgICAgZGVmIHRvID0gKHRvQWxpYXMgIT0gJ2hlYWRfMTAnKSA/IChnZXREYXRhUm93KGRhdGFSb3dzLCB0b0FsaWFzKS5nZXRJbmRleCgpIC0gMSkgOiBkYXRhUm93cy5zaXplKCkNCiAgICAgICAgaWYgKGZyb20gPCB0bykgew0KICAgICAgICAgICAgaWYgKHNlY3Rpb25NYXBbc2VjdGlvbl0gPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIHNlY3Rpb25NYXBbc2VjdGlvbl0gPSBbXQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgc2VjdGlvbk1hcFtzZWN0aW9uXS5hZGRBbGwoZGF0YVJvd3Muc3ViTGlzdChmcm9tLCB0bykpDQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHNlY3Rpb25NYXANCn0NCg0KLy8g0KHQvtGA0YLQuNGA0L7QstC60LAg0LPRgNGD0L/QvyDQuCDRgdGC0YDQvtC6DQp2b2lkIHNvcnRGb3JtRGF0YVJvd3MoZGVmIHNhdmVJbkRCID0gdHJ1ZSkgew0KICAgIGRlZiBkYXRhUm93SGVscGVyID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpDQogICAgZGVmIGRhdGFSb3dzID0gZGF0YVJvd0hlbHBlci5hbGxDYWNoZWQNCiAgICBkZWYgY29sdW1ucyA9IHNvcnRDb2x1bW5zICsgKGFsbENvbHVtbnMgLSBzb3J0Q29sdW1ucykNCiAgICAvLyDQodC+0YDRgtC40YDQvtCy0LrQsCAo0LLQvdGD0YLRgNC4INCz0YDRg9C/0L8pDQogICAgcmVmQm9va1NlcnZpY2UuZGF0YVJvd3NEZXJlZmVyZW5jZShsb2dnZXIsIGRhdGFSb3dzLCBmb3JtRGF0YS5nZXRGb3JtQ29sdW1ucygpLmZpbmRBbGwgeyBjb2x1bW5zLmNvbnRhaW5zKGl0LmdldEFsaWFzKCkpfSkNCiAgICBkZWYgbmV3Um93cyA9IFtdDQogICAgZGVmIHRlbXBSb3dzID0gW10NCiAgICBmb3IgKGRlZiByb3cgOiBkYXRhUm93cykgew0KICAgICAgICBpZiAocm93LmdldEFsaWFzKCkgIT0gbnVsbCkgew0KICAgICAgICAgICAgaWYgKCF0ZW1wUm93cy5pc0VtcHR5KCkpIHsNCiAgICAgICAgICAgICAgICBzb3J0Um93cyh0ZW1wUm93cywgY29sdW1ucykNCiAgICAgICAgICAgICAgICBuZXdSb3dzLmFkZEFsbCh0ZW1wUm93cykNCiAgICAgICAgICAgICAgICB0ZW1wUm93cyA9IFtdDQogICAgICAgICAgICB9DQogICAgICAgICAgICBuZXdSb3dzLmFkZChyb3cpDQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICB9DQogICAgICAgIHRlbXBSb3dzLmFkZChyb3cpDQogICAgfQ0KICAgIGlmICghdGVtcFJvd3MuaXNFbXB0eSgpKSB7DQogICAgICAgIHNvcnRSb3dzKHRlbXBSb3dzLCBjb2x1bW5zKQ0KICAgICAgICBuZXdSb3dzLmFkZEFsbCh0ZW1wUm93cykNCiAgICB9DQogICAgZGF0YVJvd0hlbHBlci5zZXRBbGxDYWNoZWQobmV3Um93cykNCg0KICAgIGlmIChzYXZlSW5EQikgew0KICAgICAgICBkYXRhUm93SGVscGVyLnNhdmVTb3J0KCkNCiAgICB9IGVsc2Ugew0KICAgICAgICB1cGRhdGVJbmRleGVzKGRhdGFSb3dzKQ0KICAgIH0NCn0NCg0KQEZpZWxkDQpkZWYgbWVnYVRvdGFsc1BhdHRlcm5zID0gWydzYWxlXzE4JyA6IC/QktCh0JXQk9CeINC/0L4g0LTQvtC/0L7Qu9C90LjRgtC10LvRjNC90L7QvNGDINC70LjRgdGC0YMg0LrQvdC40LPQuCDQv9GA0L7QtNCw0LYg0LfQsCAoLiopINC/0L4g0YHRgtCw0LLQutC1IDE4JS8sDQogICAgICAgICAgICAgICAgICAgICAgICAgICdzYWxlXzEwJyA6IC/QktCh0JXQk9CeINC/0L4g0LTQvtC/0L7Qu9C90LjRgtC10LvRjNC90L7QvNGDINC70LjRgdGC0YMg0LrQvdC40LPQuCDQv9GA0L7QtNCw0LYg0LfQsCAoLiopINC/0L4g0YHRgtCw0LLQutC1IDEwJS8sDQogICAgICAgICAgICAgICAgICAgICAgICAgICdwdXJjaGFzZScgOiAv0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDINC60L3QuNCz0Lgg0L/QvtC60YPQv9C+0Log0LfQsCAoLiopINC/0L4g0YHRgtCw0LLQutC1IDE4JS9dDQoNCnZvaWQgaW1wb3J0RGF0YSgpIHsNCiAgICBkZWYgdG1wUm93ID0gZm9ybURhdGEuY3JlYXRlRGF0YVJvdygpDQogICAgaW50IENPTFVNTl9DT1VOVCA9IDEwDQogICAgaW50IEhFQURFUl9ST1dfQ09VTlQgPSA0DQogICAgU3RyaW5nIFRBQkxFX1NUQVJUX1ZBTFVFID0gZ2V0Q29sdW1uTmFtZSh0bXBSb3csICdyb3dOdW0nKQ0KICAgIFN0cmluZyBUQUJMRV9FTkRfVkFMVUUgPSBudWxsDQogICAgaW50IElOREVYX0ZPUl9TS0lQID0gMQ0KDQogICAgZGVmIGFsbFZhbHVlcyA9IFtdICAgICAgLy8g0LfQvdCw0YfQtdC90LjRjyDRhNC+0YDQvNGLDQogICAgZGVmIGhlYWRlclZhbHVlcyA9IFtdICAgLy8g0LfQvdCw0YfQtdC90LjRjyDRiNCw0L/QutC4DQogICAgZGVmIHBhcmFtc01hcCA9IFsncm93T2Zmc2V0JzogMCwgJ2NvbE9mZnNldCc6IDBdICAvLyDQvNCw0L/QsCDRgSDQv9Cw0YDQsNC80LXRgtGA0LDQvNC4ICjQvtGC0YHRgtGD0L/RiyDRgdCy0LXRgNGF0YMg0Lgg0YHQu9C10LLQsCkNCg0KICAgIGNoZWNrQW5kUmVhZEZpbGUoSW1wb3J0SW5wdXRTdHJlYW0sIFVwbG9hZEZpbGVOYW1lLCBhbGxWYWx1ZXMsIGhlYWRlclZhbHVlcywgVEFCTEVfU1RBUlRfVkFMVUUsIFRBQkxFX0VORF9WQUxVRSwgSEVBREVSX1JPV19DT1VOVCwgcGFyYW1zTWFwKQ0KDQogICAgLy8g0L/RgNC+0LLQtdGA0LrQsCDRiNCw0L/QutC4DQogICAgY2hlY2tIZWFkZXJYbHMoaGVhZGVyVmFsdWVzLCBDT0xVTU5fQ09VTlQsIEhFQURFUl9ST1dfQ09VTlQsIHRtcFJvdykNCiAgICBpZiAobG9nZ2VyLmNvbnRhaW5zTGV2ZWwoTG9nTGV2ZWwuRVJST1IpKSB7DQogICAgICAgIHJldHVybg0KICAgIH0NCiAgICAvLyDQvtGB0LLQvtCx0L7QttC00LXQvdC40LUg0YDQtdGB0YPRgNGB0L7QsiDQtNC70Y8g0Y3QutC+0L3QvtC80LjQuCDQv9Cw0LzRj9GC0LgNCiAgICBoZWFkZXJWYWx1ZXMuY2xlYXIoKQ0KICAgIGhlYWRlclZhbHVlcyA9IG51bGwNCg0KICAgIGRlZiBmaWxlUm93SW5kZXggPSBwYXJhbXNNYXAucm93T2Zmc2V0DQogICAgZGVmIGNvbE9mZnNldCA9IHBhcmFtc01hcC5jb2xPZmZzZXQNCiAgICBwYXJhbXNNYXAuY2xlYXIoKQ0KICAgIHBhcmFtc01hcCA9IG51bGwNCg0KICAgIC8vINC/0L7Qu9GD0YfQuNGC0Ywg0YHRgtGA0L7QutC4INC40Lcg0YjQsNCx0LvQvtC90LANCiAgICBkZWYgZm9ybVRlbXBsYXRlID0gZm9ybURhdGFTZXJ2aWNlLmdldEZvcm1UZW1wbGF0ZShmb3JtRGF0YS5mb3JtVHlwZS5pZCwgZm9ybURhdGEucmVwb3J0UGVyaW9kSWQpDQogICAgZGVmIHRlbXBsYXRlUm93cyA9IGZvcm1UZW1wbGF0ZS5yb3dzDQogICAgZGVmIHZhbHVlc1RvdGFsID0gWyBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfMScpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfMicpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfMycpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfNCcpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfNScpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfNicpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfNycpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfOCcpPy5maXgsDQogICAgICAgICAgICAgICAgICAgICAgICBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfOScpPy5maXgNCiAgICBdDQoNCiAgICBkZWYgcm93SW5kZXggPSAwDQogICAgZGVmIGFsbFZhbHVlc0NvdW50ID0gYWxsVmFsdWVzLnNpemUoKQ0KICAgIGRlZiBzZWN0aW9uTWFwID0gWzpdDQogICAgZGVmIHJvd3MgPSBbXQ0KICAgIGRlZiBzZWN0aW9uSW5kZXggPSBudWxsDQoNCiAgICAvLyDRhNC+0YDQvNC40YDQvtCy0LDQvdC40LUg0YHRgtGA0L7QuiDQvdGEDQogICAgZm9yIChkZWYgaSA9IDA7IGkgPCBhbGxWYWx1ZXNDb3VudDsgaSsrKSB7DQogICAgICAgIHJvd1ZhbHVlcyA9IGFsbFZhbHVlc1swXQ0KICAgICAgICBmaWxlUm93SW5kZXgrKw0KDQogICAgICAgIC8vINCy0YHQtSDRgdGC0YDQvtC60Lgg0L/Rg9GB0YLRi9C1IC0g0LLRi9GF0L7QtA0KICAgICAgICBpZiAoIXJvd1ZhbHVlcykgew0KICAgICAgICAgICAgYWxsVmFsdWVzLnJlbW92ZShyb3dWYWx1ZXMpDQogICAgICAgICAgICByb3dWYWx1ZXMuY2xlYXIoKQ0KICAgICAgICAgICAgYnJlYWsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vINCf0YDQvtC/0YPRgdC6INC40YLQvtCz0L7QstGL0YUg0YHRgtGA0L7Qug0KICAgICAgICAvLyDQtdGB0LvQuCDRjdGC0L4g0L3QsNGH0LDQu9C+INGA0LDQt9C00LXQu9CwLCDRgtC+INC30LDQv9C+0LzQvdC40YLRjCDQtdCz0L4g0L3QsNC30LLQsNC90LjQtSDQuCDQvtCx0YDQsNCx0LDRgtGL0LLQsNGC0Ywg0YHQu9C10LTRg9GO0YnRg9GOINGB0YLRgNC+0LrRgw0KICAgICAgICBTdHJpbmcgZmlyc3RWYWx1ZSA9IHJvd1ZhbHVlc1tJTkRFWF9GT1JfU0tJUF0NCiAgICAgICAgaWYgKHZhbHVlc1RvdGFsLmNvbnRhaW5zKGZpcnN0VmFsdWUpKSB7DQogICAgICAgICAgICBkZWYgcHJldlNlY3Rpb25JbmRleCA9IHNlY3Rpb25JbmRleA0KICAgICAgICAgICAgc2VjdGlvbkluZGV4ID0gZmlyc3RWYWx1ZVswXQ0KICAgICAgICAgICAgaWYgKHByZXZTZWN0aW9uSW5kZXggIT0gbnVsbCAmJiAoSW50ZWdlci52YWx1ZU9mKHByZXZTZWN0aW9uSW5kZXgpICsgMSAhPSBJbnRlZ2VyLnZhbHVlT2Yoc2VjdGlvbkluZGV4KSkpIHsNCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2VydmljZUV4Y2VwdGlvbigi0KHRgtGA0L7QutCwICVkOiDQodGC0YDRg9C60YLRg9GA0LAg0YTQsNC50LvQsCDQvdC1INGB0L7QvtGC0LLQtdGC0YHRgtCy0YPQtdGCINC80LDQutC10YLRgyDQvdCw0LvQvtCz0L7QstC+0Lkg0YTQvtGA0LzRiyIsIGZpbGVSb3dJbmRleCkNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHNlY3Rpb25NYXAucHV0KHNlY3Rpb25JbmRleCwgW10pDQogICAgICAgICAgICByb3dzLmFkZChnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ2hlYWRfJyArIHNlY3Rpb25JbmRleCkpDQogICAgICAgICAgICBhbGxWYWx1ZXMucmVtb3ZlKHJvd1ZhbHVlcykNCiAgICAgICAgICAgIHJvd1ZhbHVlcy5jbGVhcigpDQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICB9IGVsc2UgaWYgKGZpcnN0VmFsdWUuY29udGFpbnMoJ9CY0YLQvtCz0L4g0LfQsCAnKSkgew0KICAgICAgICAgICAgcm93SW5kZXgrKw0KICAgICAgICAgICAgZGVmIHBlcmlvZE5hbWUgPSBmaXJzdFZhbHVlLnJlcGxhY2VBbGwoJ9CY0YLQvtCz0L4g0LfQsCAnLCAnJykNCiAgICAgICAgICAgIGRlZiBwZXJpb2RJZCA9IGdldFJlY29yZElkSW1wb3J0KDgsICdOQU1FJywgcGVyaW9kTmFtZSwgZmlsZVJvd0luZGV4LCAyICsgY29sT2Zmc2V0KQ0KICAgICAgICAgICAgZGVmIHRvdGFsUGVyaW9kID0gZ2V0UGVyaW9kVG90YWxSb3coc2VjdGlvbkluZGV4LCBwZXJpb2RJZCkNCiAgICAgICAgICAgIGZpbGxUb3RhbFJvd0Zyb21YbHModG90YWxQZXJpb2QsIHJvd1ZhbHVlcywgY29sT2Zmc2V0LCBmaWxlUm93SW5kZXgsIHJvd0luZGV4KQ0KICAgICAgICAgICAgcm93cy5hZGQodG90YWxQZXJpb2QpDQogICAgICAgICAgICBhbGxWYWx1ZXMucmVtb3ZlKHJvd1ZhbHVlcykNCiAgICAgICAgICAgIHJvd1ZhbHVlcy5jbGVhcigpDQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICB9IGVsc2UgaWYgKGZpcnN0VmFsdWUgPT0gJ9CS0KHQldCT0J4g0L/QviDRgNCw0LfQtNC10LvQsNC8IDEtNicpIHsNCiAgICAgICAgICAgIGlmIChzZWN0aW9uSW5kZXggIT0gJzYnKSB7DQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFNlcnZpY2VFeGNlcHRpb24oItCh0YLRgNC+0LrQsCAlZDog0KHRgtGA0YPQutGC0YPRgNCwINGE0LDQudC70LAg0L3QtSDRgdC+0L7RgtCy0LXRgtGB0YLQstGD0LXRgiDQvNCw0LrQtdGC0YMg0L3QsNC70L7Qs9C+0LLQvtC5INGE0L7RgNC80YsiLCBmaWxlUm93SW5kZXgpDQogICAgICAgICAgICB9DQogICAgICAgICAgICBkZWYgdG90YWxTZWN0aW9uc18xXzYgPSBnZXREYXRhUm93KHRlbXBsYXRlUm93cywgJ21lZ2FfdG90YWwnKQ0KICAgICAgICAgICAgZmlsbFRvdGFsUm93RnJvbVhscyh0b3RhbFNlY3Rpb25zXzFfNiwgcm93VmFsdWVzLCBjb2xPZmZzZXQsIGZpbGVSb3dJbmRleCwgcm93SW5kZXgpDQogICAgICAgICAgICBzZWN0aW9uTWFwW3NlY3Rpb25JbmRleF0uYWRkKHRvdGFsU2VjdGlvbnNfMV82KQ0KICAgICAgICAgICAgcm93cy5hZGQodG90YWxTZWN0aW9uc18xXzYpDQogICAgICAgICAgICBhbGxWYWx1ZXMucmVtb3ZlKHJvd1ZhbHVlcykNCiAgICAgICAgICAgIHJvd1ZhbHVlcy5jbGVhcigpDQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICB9IGVsc2UgaWYgKGZpcnN0VmFsdWUuc3RhcnRzV2l0aCgi0JLQodCV0JPQniDQv9C+INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdC+0LzRgyDQu9C40YHRgtGDIikpIHsNCiAgICAgICAgICAgIGlmIChzZWN0aW9uSW5kZXggIT0gJzcnKSB7DQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFNlcnZpY2VFeGNlcHRpb24oItCh0YLRgNC+0LrQsCAlZDog0KHRgtGA0YPQutGC0YPRgNCwINGE0LDQudC70LAg0L3QtSDRgdC+0L7RgtCy0LXRgtGB0YLQstGD0LXRgiDQvNCw0LrQtdGC0YMg0L3QsNC70L7Qs9C+0LLQvtC5INGE0L7RgNC80YsiLCBmaWxlUm93SW5kZXgpDQogICAgICAgICAgICB9DQogICAgICAgICAgICBkZWYgZW50cnkgPSBtZWdhVG90YWxzUGF0dGVybnMuZmluZCB7IGtleSwgcGF0dGVybiAtPiBmaXJzdFZhbHVlID09fiBwYXR0ZXJufQ0KICAgICAgICAgICAgaWYgKGVudHJ5ICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICBkZWYgcGVyaW9kTmFtZSA9IGZpcnN0VmFsdWUucmVwbGFjZUFsbChlbnRyeS52YWx1ZSwgIlwkMSIpDQogICAgICAgICAgICAgICAgZGVmIHBlcmlvZElkID0gZ2V0UmVjb3JkSWRJbXBvcnQoOCwgJ05BTUUnLCBwZXJpb2ROYW1lLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0KQ0KICAgICAgICAgICAgICAgIGRlZiB0b3RhbFBlcmlvZCA9IGdldFN1cGVyVG90YWxSb3coZW50cnkua2V5LCBwZXJpb2RJZCkNCiAgICAgICAgICAgICAgICBmaWxsVG90YWxSb3dGcm9tWGxzKHRvdGFsUGVyaW9kLCByb3dWYWx1ZXMsIGNvbE9mZnNldCwgZmlsZVJvd0luZGV4LCByb3dJbmRleCkNCiAgICAgICAgICAgICAgICByb3dzLmFkZCh0b3RhbFBlcmlvZCkNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGFsbFZh'

    longString += 'bHVlcy5yZW1vdmUocm93VmFsdWVzKQ0KICAgICAgICAgICAgcm93VmFsdWVzLmNsZWFyKCkNCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIH0NCg0KICAgICAgICBpZiAoc2VjdGlvbkluZGV4ID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBTZXJ2aWNlRXhjZXB0aW9uKCLQodGC0YDQvtC60LAgJWQ6INCh0YLRgNGD0LrRgtGD0YDQsCDRhNCw0LnQu9CwINC90LUg0YHQvtC+0YLQstC10YLRgdGC0LLRg9C10YIg0LzQsNC60LXRgtGDINC90LDQu9C+0LPQvtCy0L7QuSDRhNC+0YDQvNGLIiwgZmlsZVJvd0luZGV4KQ0KICAgICAgICB9DQoNCiAgICAgICAgLy8g0L/RgNC+0YHRgtCw0Y8g0YHRgtGA0L7QutCwDQogICAgICAgIHJvd0luZGV4KysNCiAgICAgICAgZGVmIG5ld1JvdyA9IGdldE5ld1Jvd0Zyb21YbHMocm93VmFsdWVzLCBjb2xPZmZzZXQsIGZpbGVSb3dJbmRleCwgcm93SW5kZXgsIEludGVnZXIudmFsdWVPZihzZWN0aW9uSW5kZXgpIDwgNykNCiAgICAgICAgc2VjdGlvbk1hcFtzZWN0aW9uSW5kZXhdLmFkZChuZXdSb3cpDQogICAgICAgIHJvd3MuYWRkKG5ld1JvdykNCg0KICAgICAgICAvLyDQvtGB0LLQvtCx0L7QtNC40YLRjCDQvdC10L3Rg9C20L3Ri9C1INC00LDQvdC90YvQtSAtINC40L3QsNGH0LUg0L3QtSDRhdCy0LDRgtC40YIg0L/QsNC80Y/RgtC4DQogICAgICAgIGFsbFZhbHVlcy5yZW1vdmUocm93VmFsdWVzKQ0KICAgICAgICByb3dWYWx1ZXMuY2xlYXIoKQ0KICAgIH0NCg0KICAgIGRlZiBuZXdSb3dzID0gKHNlY3Rpb25NYXAudmFsdWVzKCkuc3VtIHsgaXQgfSA/OiBbXSkNCiAgICBzaG93TWVzc2FnZXMocm93cywgbG9nZ2VyKQ0KICAgIGlmIChsb2dnZXIuY29udGFpbnNMZXZlbChMb2dMZXZlbC5FUlJPUikgfHwgbmV3Um93cyA9PSBudWxsIHx8IG5ld1Jvd3MuaXNFbXB0eSgpKSB7DQogICAgICAgIHJldHVybg0KICAgIH0NCg0KICAgIHVwZGF0ZUluZGV4ZXMocm93cykNCg0KICAgIGNoZWNrRmlsbERlY2xhcmF0aW9uTWFwKGZhbHNlKSAvLyDQt9Cw0L/QvtC70L3Rj9C10Lwg0LTQtdC60LvQsNGA0LDRhtC40Lgt0LjRgdGC0L7Rh9C90LjQutC4DQogICAgLy8g0YHRgNCw0LLQvdC10L3QuNC1INC40YLQvtCz0L7Qsg0KICAgIGNvbXBhcmVTcGVjaWZpY1RvdGFsVmFsdWVzKHJvd3MsIHNlY3Rpb25NYXApDQoNCiAgICBpZiAoIWxvZ2dlci5jb250YWluc0xldmVsKExvZ0xldmVsLkVSUk9SKSkgew0KICAgICAgICBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSkuYWxsQ2FjaGVkID0gcm93cw0KICAgIH0NCn0NCg0KLyoqDQogKiDQn9GA0L7QstC10YDQuNGC0Ywg0YjQsNC/0LrRgyDRgtCw0LHQu9C40YbRiw0KICoNCiAqIEBwYXJhbSBoZWFkZXJSb3dzINGB0YLRgNC+0LrQuCDRiNCw0L/QutC4DQogKiBAcGFyYW0gY29sQ291bnQg0LrQvtC70LjRh9C10YHRgtCy0L4g0LrQvtC70L7QvdC+0Log0LIg0YLQsNCx0LvQuNGG0LUNCiAqIEBwYXJhbSByb3dDb3VudCDQutC+0LvQuNGH0LXRgdGC0LLQviDRgdGC0YDQvtC6INCyINGC0LDQsdC70LjRhtC1DQogKiBAcGFyYW0gdG1wUm93INCy0YHQv9C+0LzQvtCz0LDRgtC10LvRjNC90LDRjyDRgdGC0YDQvtC60LAg0LTQu9GPINC/0L7Qu9GD0YfQtdC90LjRjyDQvdCw0LfQstCw0L3QuNC4INCz0YDQsNGE0L7Qsg0KICovDQp2b2lkIGNoZWNrSGVhZGVyWGxzKGRlZiBoZWFkZXJSb3dzLCBkZWYgY29sQ291bnQsIHJvd0NvdW50LCBkZWYgdG1wUm93KSB7DQogICAgaWYgKGhlYWRlclJvd3MuaXNFbXB0eSgpKSB7DQogICAgICAgIHRocm93IG5ldyBTZXJ2aWNlRXhjZXB0aW9uKFdST05HX0hFQURFUl9ST1dfU0laRSkNCiAgICB9DQogICAgY2hlY2tIZWFkZXJTaXplKGhlYWRlclJvd3NbMF0uc2l6ZSgpLCBoZWFkZXJSb3dzLnNpemUoKSwgY29sQ291bnQsIHJvd0NvdW50KQ0KICAgIC8vIGNoZWNrSGVhZGVyU2l6ZShoZWFkZXJSb3dzLCBjb2xDb3VudCwgcm93Q291bnQpIFRPRE8g0LfQsNC80LXQvdC40YLRjCDQsiAxLjANCiAgICBkZWYgaGVhZGVyTWFwcGluZyA9IFsNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMF1bMF0pOiBnZXRDb2x1bW5OYW1lKHRtcFJvdywgJ3Jvd051bScpXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzBdWzJdKTogJ9CU0LDQvdC90YvQtSDQsdGD0YXQs9Cw0LvRgtC10YDRgdC60L7Qs9C+INGD0YfRkdGC0LAnXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzBdWzldKTogZ2V0Q29sdW1uTmFtZSh0bXBSb3csICdyYXRlTmRzJyldKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMF1bMTBdKTogZ2V0Q29sdW1uTmFtZSh0bXBSb3csICdzdW0nKV0pLA0KDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzFdWzJdKTogJ9CS0LXQu9C40YfQuNC90LAg0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60Lgg0L3QsNC70L7Qs9C+0LLQvtC5INCx0LDQt9GLJ10pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1sxXVs2XSk6ICfQktC10LvQuNGH0LjQvdCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4INCd0JTQoSddKSwNCg0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1syXVsyXSk6ICfQndCw0LvQvtCz0L7QstGL0Lkg0L/QtdGA0LjQvtC0LCDQt9CwINC60L7RgtC+0YDRi9C5INCy0L3QvtGB0LjRgtGB0Y8g0LrQvtGA0YDQtdC60YLQuNGA0L7QstC60LAnXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzJdWzNdKTogJ9C90L7QvNC10YAg0LHQsNC70LDQvdGB0L7QstC+0LPQviDRgdGH0ZHRgtCwJ10pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1syXVs0XSk6ICfQodGD0LzQvNCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4ICgrKSddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMl1bNV0pOiAn0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoLSknXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzJdWzZdKTogJ9C90L7QvNC10YAg0LHQsNC70LDQvdGB0L7QstC+0LPQviDRgdGH0ZHRgtCwJ10pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1syXVs3XSk6ICfQodGD0LzQvNCwINC60L7RgNGA0LXQutGC0LjRgNC+0LLQutC4ICgrKSddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMl1bOF0pOiAn0KHRg9C80LzQsCDQutC+0YDRgNC10LrRgtC40YDQvtCy0LrQuCAoLSknXSksDQoNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbM11bMF0pOiAnMSddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbM11bMl0pOiAnMiddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbM11bM10pOiAnMyddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbM11bNF0pOiAnNCddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbM11bNl0pOiAnNSddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbM11bN10pOiAnNiddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbM11bOV0pOiAnNyddKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbM11bMTBdKTogJzgnXSkNCiAgICBdDQogICAgY2hlY2tIZWFkZXJFcXVhbHMoaGVhZGVyTWFwcGluZywgbG9nZ2VyKQ0KfQ0KDQovKioNCiAqINCf0L7Qu9GD0YfQuNGC0Ywg0L3QvtCy0YPRjiDRgdGC0YDQvtC60YMg0L3RhCDQv9C+INC30L3QsNGH0LXQvdC40Y/QvCDQuNC3INGN0LrRgdC10LvRjy4NCiAqDQogKiBAcGFyYW0gdmFsdWVzINGB0L/QuNGB0L7QuiDRgdGC0YDQvtC6INGB0L4g0LfQvdCw0YfQtdC90LjRj9C80LgNCiAqIEBwYXJhbSBjb2xPZmZzZXQg0L7RgtGB0YLRg9C/INCyINC60L7Qu9C+0L3QutCw0YUNCiAqIEBwYXJhbSBmaWxlUm93SW5kZXgg0L3QvtC80LXRgCDRgdGC0YDQvtC60Lgg0LIg0YLRhA0KICogQHBhcmFtIHJvd0luZGV4INGB0YLRgNC+0LrQsCDQsiDQvdGEDQogKi8NCmRlZiBnZXROZXdSb3dGcm9tWGxzKGRlZiB2YWx1ZXMsIGRlZiBjb2xPZmZzZXQsIGRlZiBmaWxlUm93SW5kZXgsIGRlZiByb3dJbmRleCwgYm9vbGVhbiBpc0dyb3VwXzFfNikgew0KICAgIGRlZiBuZXdSb3cgPSBnZXROZXdSb3coaXNHcm91cF8xXzYpDQogICAgbmV3Um93LnNldEluZGV4KHJvd0luZGV4KQ0KICAgIG5ld1Jvdy5zZXRJbXBvcnRJbmRleChmaWxlUm93SW5kZXgpDQoNCiAgICAvLyDQk9GA0LDRhNCwIDINCiAgICBkZWYgY29sSW5kZXggPSAyDQogICAgbmV3Um93LnBlcmlvZCA9IGdldFJlY29yZElkSW1wb3J0KDgsICdOQU1FJywgdmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCg0KICAgIC8vINCT0YDQsNGE0LAgMw0KICAgIGNvbEluZGV4ID0gMw0KICAgIG5ld1Jvdy5udW1iZXIgPSBnZXRSZWNvcmRJZEltcG9ydCgxMDEsICdBQ0NPVU5UJywgdmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCg0KICAgIC8vINCz0YDQsNGE0LAgNA0KICAgIGNvbEluZGV4ID0gNA0KICAgIG5ld1Jvdy5zdW1QbHVzID0gZ2V0TnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQs9GA0LDRhNCwIDUNCiAgICBjb2xJbmRleCA9IDUNCiAgICBuZXdSb3cuc3VtTWludXMgPSBnZXROdW1iZXIodmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCg0KICAgIC8vINCT0YDQsNGE0LAgNg0KICAgIGNvbEluZGV4ID0gNg0KICAgIG5ld1Jvdy5udW1iZXJOZHMgPSBnZXRSZWNvcmRJZEltcG9ydCgxMDEsICdBQ0NPVU5UJywgdmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCg0KICAgIC8vINCz0YDQsNGE0LAgNw0KICAgIGNvbEluZGV4ID0gNw0KICAgIG5ld1Jvdy5zdW1OZHNQbHVzID0gZ2V0TnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQs9GA0LDRhNCwIDgNCiAgICBjb2xJbmRleCA9IDgNCiAgICBuZXdSb3cuc3VtTmRzTWludXMgPSBnZXROdW1iZXIodmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCg0KICAgIC8vINCz0YDQsNGE0LAgOQ0KICAgIGNvbEluZGV4ID0gOQ0KICAgIG5ld1Jvdy5yYXRlTmRzID0gdmFsdWVzW2NvbEluZGV4XQ0KDQogICAgLy8g0LPRgNCw0YTQsCAxMA0KICAgIGNvbEluZGV4ID0gMTANCiAgICBuZXdSb3cuc3VtID0gZ2V0TnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICByZXR1cm4gbmV3Um93DQp9DQoNCi8qKg0KICog0JfQsNC/0L7Qu9C90LjRgtGMINC90L7QstGD0Y4g0YHRgtGA0L7QutGDINC90YQg0L/QviDQt9C90LDRh9C10L3QuNGP0Lwg0LjQtyDRjdC60YHQtdC70Y8uDQogKg0KICogQHBhcmFtIHRvdGFsUm93INGB0YLRgNC+0LrQsA0KICogQHBhcmFtIHZhbHVlcyDRgdC/0LjRgdC+0Log0YHRgtGA0L7QuiDRgdC+INC30L3QsNGH0LXQvdC40Y/QvNC4DQogKiBAcGFyYW0gY29sT2Zmc2V0INC+0YLRgdGC0YPQvyDQsiDQutC+0LvQvtC90LrQsNGFDQogKiBAcGFyYW0gZmlsZVJvd0luZGV4INC90L7QvNC10YAg0YHRgtGA0L7QutC4INCyINGC0YQNCiAqIEBwYXJhbSByb3dJbmRleCDRgdGC0YDQvtC60LAg0LIg0L3RhA0KICovDQp2b2lkIGZpbGxUb3RhbFJvd0Zyb21YbHMoZGVmIHRvdGFsUm93LCBkZWYgdmFsdWVzLCBkZWYgY29sT2Zmc2V0LCBkZWYgZmlsZVJvd0luZGV4LCBkZWYgcm93SW5kZXgpIHsNCiAgICB0b3RhbFJvdy5zZXRJbmRleChyb3dJbmRleCkNCiAgICB0b3RhbFJvdy5zZXRJbXBvcnRJbmRleChmaWxlUm93SW5kZXgpDQoNCiAgICAvLyDQs9GA0LDRhNCwIDQNCiAgICBjb2xJbmRleCA9IDQNCiAgICB0b3RhbFJvdy5zdW1QbHVzID0gZ2V0TnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQoNCiAgICAvLyDQs9GA0LDRhNCwIDUNCiAgICBjb2xJbmRleCA9IDUNCiAgICB0b3RhbFJvdy5zdW1NaW51cyA9IGdldE51bWJlcih2YWx1ZXNbY29sSW5kZXhdLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0KQ0KDQogICAgLy8g0LPRgNCw0YTQsCA3DQogICAgY29sSW5kZXggPSA3DQogICAgdG90YWxSb3cuc3VtTmRzUGx1cyA9IGdldE51bWJlcih2YWx1ZXNbY29sSW5kZXhdLCBmaWxlUm93SW5kZXgsIGNvbEluZGV4ICsgY29sT2Zmc2V0KQ0KDQogICAgLy8g0LPRgNCw0YTQsCA4DQogICAgY29sSW5kZXggPSA4DQogICAgdG90YWxSb3cuc3VtTmRzTWludXMgPSBnZXROdW1iZXIodmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCkNCg0KICAgIC8vINCz0YDQsNGE0LAgMTANCiAgICBjb2xJbmRleCA9IDEwDQogICAgdG90YWxSb3cuc3VtID0gZ2V0TnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQpDQp9DQoNCnZvaWQgY29tcGFyZVNwZWNpZmljVG90YWxWYWx1ZXMoZGVmIGRhdGFSb3dzLCBkZWYgc2VjdGlvbk1hcCkgew0KICAgIGRlZiBpc0ltcG9ydCA9IGZvcm1EYXRhRXZlbnQgPT0gRm9ybURhdGFFdmVudC5JTVBPUlQNCiAgICBkZWYgbG9nTGV2ZWwgPSBpc0ltcG9ydCA/IExvZ0xldmVsLldBUk5JTkcgOiBMb2dMZXZlbC5FUlJPUg0KICAgIC8vINGB0YfQuNGC0LDQtdC8INC40YLQvtCz0LgNCiAgICBkZWYgY2FsY1Jvd3MgPSBbXQ0KICAgIGNhbGNSb3dzLmFkZEFsbChmb3JtRGF0YVNlcnZpY2UuZ2V0Rm9ybVRlbXBsYXRlKGZvcm1EYXRhLmZvcm1UeXBlLmlkLCBmb3JtRGF0YS5yZXBvcnRQZXJpb2RJZCkucm93cykNCiAgICB1cGRhdGVJbmRleGVzKGNhbGNSb3dzKQ0KICAgIHNlY3Rpb25NYXAuZWFjaCB7IGtleSwgdGVtcFJvd3MgLT4NCiAgICAgICAgY2FsY1Jvd3MuYWRkQWxsKGdldERhdGFSb3coY2FsY1Jvd3MsICdoZWFkXycgKyBrZXkpLmdldEluZGV4KCksIHRlbXBSb3dzLmZpbmRBbGwgeyBpdC5nZXRBbGlhcygpID09IG51bGwgfHwgaXQuZ2V0QWxpYXMoKS5zdGFydHNXaXRoKCd0b3RhbF8nKSB9KQ0KICAgICAgICB1cGRhdGVJbmRleGVzKGNhbGNSb3dzKQ0KICAgIH0NCiAgICBjYWxjUGVyaW9kVG90YWxzKGNhbGNSb3dzKQ0KDQogICAgdXBkYXRlSW5kZXhlcyhkYXRhUm93cykNCg0KICAgIHNlY3Rpb25zLmVhY2ggeyBzZWN0aW9uIC0+DQogICAgICAgIGRlZiBwZXJpb2RUb3RhbHMgPSBkYXRhUm93cy5maW5kQWxsIHsgcm93IC0+IHJvdy5nZXRBbGlhcygpICE9IG51bGwgJiYgcm93LmdldEFsaWFzKCkuc3RhcnRzV2l0aCgidG90YWxfIiArIHNlY3Rpb24pfQ0KICAgICAgICBkZWYgY2FsY1BlcmlvZFRvdGFscyA9IGNhbGNSb3dzLmZpbmRBbGwgeyByb3cgLT4gcm93LmdldEFsaWFzKCkgIT0gbnVsbCAmJiByb3cuZ2V0QWxpYXMoKS5zdGFydHNXaXRoKCJ0b3RhbF8iICsgc2VjdGlvbil9DQogICAgICAgIGRlZiBmcm9tQWxpYXMgPSAnaGVhZF8nICsgc2VjdGlvbg0KICAgICAgICBkZWYgdG9BbGlhcyA9ICdoZWFkXycgKyAoSW50ZWdlci52YWx1ZU9mKHNlY3Rpb24pICsgMSkNCiAgICAgICAgZGVmIGZyb20gPSBnZXREYXRhUm93KGRhdGFSb3dzLCBmcm9tQWxpYXMpLmdldEluZGV4KCkNCiAgICAgICAgZGVmIHRvID0gKHRvQWxpYXMgIT0gJ2hlYWRfMTAnKSA/IChnZXREYXRhUm93KGRhdGFSb3dzLCB0b0FsaWFzKS5nZXRJbmRleCgpIC0gMSkgOiBkYXRhUm93cy5zaXplKCkNCiAgICAgICAgZGVmIHNlY3Rpb25Sb3dzID0gZGF0YVJvd3Muc3ViTGlzdChmcm9tLCB0bykuZmluZEFsbHsgcm93IC0+IHJvdy5nZXRBbGlhcygpID09IG51bGwgfHwgcm93LmdldEFsaWFzKCkuc3RhcnRzV2l0aCgidG90YWxfIikgfQ0KICAgICAgICBjaGVja0l0b2dSb3dzKHNlY3Rpb25Sb3dzLCBjYWxjUGVyaW9kVG90YWxzLCBwZXJpb2RUb3RhbHMsIG5ldyBHcm91cFN0cmluZygpIHsNCiAgICAgICAgICAgIEBPdmVycmlkZQ0KICAgICAgICAgICAgU3RyaW5nIGdldFN0cmluZyhEYXRhUm93PENlbGw+IHJvdykgew0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRSZWZCb29rVmFsdWUoOCwgcm93LnBlcmlvZCk/Lk5BTUU/LnN0cmluZ1ZhbHVlDQogICAgICAgICAgICB9DQogICAgICAgIH0sIG5ldyBDaGVja0dyb3VwU3VtKCkgew0KICAgICAgICAgICAgQE92ZXJyaWRlDQogICAgICAgICAgICBTdHJpbmcgY2hlY2soRGF0YVJvdzxDZWxsPiByb3cxLCBEYXRhUm93PENlbGw+IHJvdzIpIHsNCiAgICAgICAgICAgICAgICBkZWYgY29sdW1ucw0KICAgICAgICAgICAgICAgIGlmIChJbnRlZ2VyLnZhbHVlT2Yoc2VjdGlvbikgPCA3KSB7DQogICAgICAgICAgICAgICAgICAgIGNvbHVtbnMgPSB0b3RhbENvbHVtbnMxXzZfU2FsZSAtIHNraXBDb2x1bW5zDQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChJbnRlZ2VyLnZhbHVlT2Yoc2VjdGlvbikgPiA2KSB7DQogICAgICAgICAgICAgICAgICAgIGNvbHVtbnMgPSB0b3RhbENvbHVtbnM3XzlfUHVyY2hhc2UgLSBza2lwQ29sdW1ucw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBmb3IgKGRlZiBjb2x1bW4gOiBjb2x1bW5zKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChyb3cxW2NvbHVtbl0gIT0gcm93Mltjb2x1bW5dKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29sdW1uTmFtZShyb3cxLCBjb2x1bW4pDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSkNCiAgICB9DQogICAgLy8NCiAgICBkZWYgbWVnYVRvdGFsID0gZ2V0RGF0YVJvdyhkYXRhUm93cywgIm1lZ2FfdG90YWwiKQ0KICAgIGRlZiBjb21wYXJlTWVnYVRvdGFsID0gZ2V0RGF0YVJvdyhjYWxjUm93cywgIm1lZ2FfdG90YWwiKQ0KICAgIC8vINGA0LDRgdGB0YfQuNGC0YvQstCw0LXQvCDQuNGC0L7QsyDQv9C+IDEtNiDQvdCwINC+0YHQvdC+0LLQtSDQuNGB0YXQvtC00L3Ri9GFINC00LDQvdC90YvRhQ0KICAgIGNhbGNNZWdhVG90YWwoY29tcGFyZU1lZ2FUb3RhbCwgZGF0YVJvd3MpDQogICAgZGVmIGNvbHVtbnMgPSB0b3RhbENvbHVtbnNNZWdhIC0gc2tpcENvbHVtbnMNCiAgICBpZiAoaXNJbXBvcnQpIHsNCiAgICAgICAgY29tcGFyZVRvdGFsVmFsdWVzKG1lZ2FUb3RhbCwgY29tcGFyZU1lZ2FUb3RhbCwgY29sdW1ucywgbG9nZ2VyLCBmYWxzZSkNCiAgICB9IGVsc2Ugew0KICAgICAgICBjb2x1bW5zLmVhY2ggeyBhbGlhcyAtPg0KICAgICAgICAgICAgZGVmIHZhbHVlID0gbWVnYVRvdGFsW2FsaWFzXSA/OiBCaWdEZWNpbWFsLlpFUk8NCiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBjb21wYXJlTWVnYVRvdGFsW2FsaWFzXSkgew0KICAgICAgICAgICAgICAgIGxvZ2dlci5sb2cobG9nTGV2ZWwsICLQodGC0YDQvtC60LAgJHttZWdhVG90YWwuZ2V0SW5kZXgoKX06ICIgKyBXUk9OR19UT1RBTCwgZmFsc2UsIGdldENvbHVtbk5hbWUobWVnYVRvdGFsLCBhbGlhcykpDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBkZWYgY29tcGFyZVN1cGVyUm93cyA9IGNhbGNTdXBlclRvdGFscyhkYXRhUm93cykNCiAgICBkZWYgc3VwZXJSb3dzID0gZGF0YVJvd3MuZmluZEFsbCB7IHJvdyAtPiByb3cuZ2V0QWxpYXMoKSAhPSBudWxsICYmIHJvdy5nZXRBbGlhcygpLnN0YXJ0c1dpdGgoInN1cGVyXyIpIH0NCiAgICBzdXBlclJvd3MuZWFjaCB7IHN1cGVyUm93IC0+DQogICAgICAgIC8vINGA0LDRgdGB0YfQuNGC0LDQvdC90LDRjyDRgdGC0YDQvtC60LAg0YEg0YLQsNC60LjQvCDQttC1INCw0LvQuNCw0YHQvtC8DQogICAgICAgIGRlZiBjYWxjUm93ID0gY29tcGFyZVN1cGVyUm93cy5maW5kIHsgcm93IC0+DQogICAgICAgICAgICByb3cuZ2V0QWxpYXMoKSA9PSBzdXBlclJvdy5nZXRBbGlhcygpDQogICAgICAgIH0NCiAgICAgICAgaWYgKGNhbGNSb3cgPT0gbnVsbCkgew0KICAgICAgICAgICAgcm93TG9nKGxvZ2dlciwgc3VwZXJSb3csIFN0cmluZy5mb3JtYXQoItCh0YLRgNC+0LrQsCAlZDog0KHRgtGA0L7QutCwINC40YLQvtCz0LAg0L3QtSDQvtGC0L3QvtGB0LjRgtGB0Y8g0Log0LrQsNC60L7QuS3Qu9C40LHQviDQs9GA0YPQv9C/0LUhIiwgc3VwZXJSb3cuZ2V0SW5kZXgoKSksIGxvZ0xldmVsKQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgZGVmIGNvbXBhcmVDb2x1bW5zID0gKHN1cGVyUm93LmdldEFsaWFzKCkuc3RhcnRzV2l0aCgnc3VwZXJfc2FsZScpID8gdG90YWxDb2x1bW5zMV82X1NhbGUgOiB0b3RhbENvbHVtbnM3XzlfUHVyY2hhc2UpIC0gc2tpcENvbHVtbnMNCiAgICAgICAgICAgIGlmIChpc0ltcG9ydCkgew0KICAgICAgICAgICAgICAgIGNvbXBhcmVUb3RhbFZhbHVlcyhzdXBlclJvdywgY2FsY1JvdywgY29tcGFyZUNvbHVtbnMsIGxvZ2dlciwgIWlzSW1wb3J0KQ0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBjb21wYXJlQ29sdW1ucy5lYWNoIHsgYWxpYXMgLT4NCiAgICAgICAgICAgICAgICAgICAgZGVmIHZhbHVlID0gc3VwZXJSb3dbYWxpYXNdID86IEJpZ0RlY2ltYWwuWkVSTw0KICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT0gY2FsY1Jvd1thbGlhc10pIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5sb2cobG9nTGV2ZWwsICLQodGC0YDQvtC60LAgJHtzdXBlclJvdy5nZXRJbmRleCgpfTogIiArIFdST05HX1RPVEFMLCBmYWxzZSwgZ2V0Q29sdW1uTmFtZShzdXBlclJvdywgYWxpYXMpKQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY29tcGFyZVN1cGVyUm93cy5yZW1vdmUoY2FsY1JvdykNCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoIWNvbXBhcmVTdXBlclJvd3MuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbXBhcmVTdXBlclJvd3MuZWFjaCB7IGNhbGNSb3cgLT4NCiAgICAgICAgICAgIGRlZiBmaXJzdFZhbHVlID0gY2FsY1Jvdy5maXgNCiAgICAgICAgICAgIGRlZiBlbnRyeSA9IG1lZ2FUb3RhbHNQYXR0ZXJucy5maW5kIHsga2V5LCBwYXR0ZXJuIC0+IGZpcnN0VmFsdWUgPT1+IHBhdHRlcm59DQogICAgICAgICAgICBpZiAoZW50cnkgIT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIGRlZiBwZXJpb2ROYW1lID0gZmlyc3RWYWx1ZS5yZXBsYWNlQWxsKGVudHJ5LnZhbHVlLCAiXCQxIikNCiAgICAgICAgICAgICAgICBsb2dnZXIubG9nKGxvZ0xldmVsLCAi0JPRgNGD0L/Qv9CwINGB0YLRgNC+0Logwqslc8K7INC90LUg0LjQvNC10LXRgiDRgdGC0YDQvtC60Lggwqslc8K7ISIsIGZhbHNlLCBwZXJpb2ROYW1lLCBmaXJzdFZhbHVlKQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KfQ0KDQovLyDQstGL0L3QtdGBINC80LXRgtC+0LQg0LIg0YHQutGA0LjQv9GCINC00LvRjyDQv9GA0LDQstC60Lgg0L/RgNC+0LLQtdGA0L7Qug0Kdm9pZCBjaGVja0l0b2dSb3dzKGRlZiBkYXRhUm93cywgZGVmIHRlc3RJdG9nUm93cywgZGVmIGl0b2dSb3dzLCBHcm91cFN0cmluZyBncm91cFN0cmluZywgQ2hlY2tHcm91cFN1bSBjaGVja0dyb3VwU3VtKSB7DQogICAgZGVmIGxvZ0xldmVsID0gZm9ybURhdGFFdmVudCA9PSBGb3JtRGF0YUV2ZW50LklNUE9SVCA/IExvZ0xldmVsLldBUk5JTkcgOiBMb2dMZXZlbC5FUlJPUg0KICAgIC8vINGB0YfQuNGC0LDQtdGCINC60L7Qu9C40YfQtdGB0YLQstC+INGA0LXQsNC70YzQvdGL0YUg0LPRgNGD0L/QvyDQtNCw0L3QvdGL0YUNCiAgICBkZWYgZ3JvdXBDb3VudCA9IDANCiAgICAvLyDQmNGC0L7Qs9C+0LLRi9C1INGB0YLRgNC+0LrQuCDQsdGL0LvQuCDRg9C00LDQu9C10L3Riw0KICAgIC8vINCd0LXQuNGC0L7Qs9C+0LLRi9C1INGB0YLRgNC+0LrQuCDQsdGL0LvQuCDRg9C00LDQu9C10L3Riw0KICAgIGZvciAoaW50IGkgPSAwOyBpIDwgZGF0YVJvd3Muc2l6ZSgpOyBpKyspIHsNCiAgICAgICAgRGF0YVJvdzxDZWxsPiByb3cgPSBkYXRhUm93cy5nZXQoaSk7DQogICAgICAgIC8vINGB0YLRgNC+0LrQsCDQuNC70Lgg0LjRgtC+0LMg0LTRgNGD0LPQvtC5INCz0YDRg9C/0L/RiyDQv9C+0YHQu9C1INGB0YLRgNC+0LrQuCDQsdC10Lcg0L/QvtC00LjRgtC+0LPQsCDQvNC10LbQtNGDINC90LjQvNC4DQogICAgICAgIGlmIChpID4gMCkgew0KICAgICAgICAgICAgZGVmIHByZXZSb3cgPSBkYXRhUm93cy5nZXQoaSAtIDEpDQogICAgICAgICAgICBpZiAocHJldlJvdy5nZXRBbGlhcygpID09IG51bGwgJiYgY29tcGFyZUdyb3VwKHByZXZSb3csIHJvdykpIHsNCiAgICAgICAgICAgICAgICBpdG9nUm93cy5hZGQoZ3JvdXBDb3VudCwgbnVsbCkNCiAgICAgICAgICAgICAgICBncm91cENvdW50KysNCiAgICAgICAgICAgICAgICBTdHJpbmcgZ3JvdXBDb2xzID0gZ3JvdXBTdHJpbmcuZ2V0U3RyaW5nKHByZXZSb3cpOw0KICAgICAgICAgICAgICAgIGlmIChncm91cENvbHMgIT0gbnVsbCkgew0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIubG9nKGxvZ0xldmVsLCAi0JPRgNGD0L/Qv9CwIMKrJXPCuyDQvdC1INC40LzQtdC10YIg0YHRgtGA0L7QutC4INC40YLQvtCz0LAhIiwgZmFsc2UsIGdyb3VwQ29scyk7IC8vINC40YLQvtCz0LAgKNC90LUgINC/0L7QtNC40YLQvtCz0LApDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmIChyb3cuZ2V0QWxpYXMoKSAhPSBudWxsKSB7DQogICAgICAgICAgICAvLyDQuNGC0L7QsyDQv9C+0YHQu9C1INC40YLQvtCz0LAgKNC40LvQuCDQv9C+0YHQu9C1INGB0YLRgNC+0LrQuCDQuNC3INC00YDRg9Cz0L7QuSDQs9GA0YPQv9C/0YspDQogICAgICAgICAgICBpZiAoaSA8IDEgfHwgZGF0YVJvd3MuZ2V0KGkgLSAxKS5nZXRBbGlhcygpICE9IG51bGwgfHwgY29tcGFyZUdyb3VwKGRhdGFSb3dzLmdldChpIC0gMSksIHJvdykpIHsNCiAgICAgICAgICAgICAgICByb3dMb2cobG9nZ2VyLCByb3csIFN0cmluZy5mb3JtYXQoItCh0YLRgNC+0LrQsCAlZDog0KHRgtGA0L7QutCwINC40YLQvtCz0LAg0L3QtSDQvtGC0L3QvtGB0LjRgtGB0Y8g0Log0LrQsNC60L7QuS3Qu9C40LHQviDQs9GA0YPQv9C/0LUhIiwgcm93LmdldEluZGV4KCkpLCBsb2dMZXZlbCk7IC8vINC40YLQvtCz0LAgKNC90LUgINC/0L7QtNC40YLQvtCz0LApDQogICAgICAgICAgICAgICAgLy8g0YPQtNCw0LvRj9C10Lwg0LjQtyDQv9GA0L7QstC10YDRj9C10LzRi9GFINC40YLQvtCz0L7QsiDRgdGC0YDQvtC60YMg0LHQtdC3INC/0L7QtNGH0LjQvdC10L3QvdGL0YUg0YHRgtGA0L7Qug0KICAgICAgICAgICAgICAgIGl0b2dSb3dzLnJlbW92ZShyb3cpDQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGdyb3VwQ291bnQrKw0KICAgICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgLy8g0L3QtdGE0LjQutGB0LjRgNC+0LLQsNC90L3QsNGPINGB0YLRgNC+0LrQsCDQuCDQvtGC0YHRg9GC0YHRgtCy0YPQtdGCINC/0L7RgdC70LXQtNC90LjQuSDQuNGC0L7Qsw0KICAgICAgICAgICAgaWYgKGkgPT0gZGF0YVJvd3Muc2l6ZSgpIC0gMSkgew0KICAgICAgICAgICAgICAgIGl0b2dSb3dzLmFkZChncm91cENvdW50LCBudWxsKQ0KICAgICAgICAgICAgICAgIGdyb3VwQ291bnQrKw0KICAgICAgICAgICAgICAgIFN0cmluZyBncm91cENvbHMgPSBncm91cFN0cmluZy5nZXRTdHJpbmcocm93KTsNCiAgICAgICAgICAgICAgICBpZiAoZ3JvdXBDb2xzICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICAgICAgcm93TG9nKGxvZ2dlciwgcm93LCBTdHJpbmcuZm9ybWF0KCLQk9GA0YPQv9C/0LAgwqslc8K7INC90LUg0LjQvNC10LXRgiDRgdGC0YDQvtC60Lgg0LjRgtC+0LPQsCEiLCBncm91cENvbHMpLCBsb2dMZXZlbCk7IC8vINC40YLQvtCz0LAgKNC90LUgINC/0L7QtNC40YLQvtCz0LApDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIGlmICh0ZXN0SXRvZ1Jvd3Muc2l6ZSgpID09IGl0b2dSb3dzLnNpemUoKSkgew0KICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IHRlc3RJdG9nUm93cy5zaXplKCk7IGkrKykgew0KICAgICAgICAgICAgRGF0YVJvdzxDZWxsPiB0ZXN0SXRvZ1JvdyA9IHRlc3RJdG9nUm93cy5nZXQoaSk7DQogICAgICAgICAgICBEYXRhUm93PENlbGw+IHJlYWxJdG9nUm93ID0gaXRvZ1Jvd3MuZ2V0KGkpOw0KICAgICAgICAgICAgaWYgKHJlYWxJdG9nUm93ID09IG51bGwpIHsNCiAgICAgICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaW50IHJvd0luZGV4ID0gZGF0YVJvd3MuaW5kZXhPZihyZWFsSXRvZ1JvdykgLSAxDQogICAgICAgICAgICBkZWYgcm93ID0gZGF0YVJvd3MuZ2V0KHJvd0luZGV4KQ0KICAgICAgICAgICAgU3RyaW5nIGdyb3VwQ29scyA9IGdyb3VwU3RyaW5nLmdldFN0cmluZyhyb3cpOw0KICAgICAgICAgICAgaWYgKGdyb3VwQ29scyAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgU3RyaW5nIGNoZWNrU3RyID0gY2hlY2tHcm91cFN1bS5jaGVjayh0ZXN0SXRvZ1JvdywgcmVhbEl0b2dSb3cpOw0KICAgICAgICAgICAgICAgIGlmIChjaGVja1N0ciAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgICAgIHJvd0xvZyhsb2dnZXIsIHJlYWxJdG9nUm93LCBTdHJpbmcuZm9ybWF0KEdST1VQX1dST05HX0lUT0dfU1VNLCByZWFsSXRvZ1Jvdy5nZXRJbmRleCgpLCBncm91cENvbHMsIGNoZWNrU3RyKSwgbG9nTGV2ZWwpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KYm9vbGVhbiBjb21wYXJlR3JvdXAoZGVmIHJvd0EsIGRlZiByb3dCKSB7DQogICAgZGVmIHBlcmlvZEEgPSAocm93QS5nZXRBbGlhcygpICE9IG51bGwpID8gcm93QS5maXg/LnJlcGxhY2UoJ9CY0YLQvtCz0L4g0LfQsCAnLCcnKSA6IGdldFZhbHVlc0J5R3JvdXBDb2x1bW4ocm93QSkNCiAgICBkZWYgcGVyaW9kQiA9IChyb3dCLmdldEFsaWFzKCkgIT0gbnVsbCkgPyByb3dCLmZpeD8ucmVwbGFjZSgn0JjRgtC+0LPQviDQt9CwICcsJycpIDogZ2V0VmFsdWVzQnlHcm91cENvbHVtbihyb3dCKQ0KICAgIHJldHVybiBwZXJpb2RBICE9IHBlcmlvZEINCn0NCg0KLy8g0JLQvtC30LLRgNCw0YnQsNC10YIg0YHRgtGA0L7QutGDINGB0L4g0LfQvdCw0YfQtdC90LjRj9C80Lgg0L/QvtC70LXQuSDRgdGC0YDQvtC60Lgg0L/QviDQutC+0YLQvtGA0YvQvCDQuNC00LXRgiDQs9GA0YPQv9C/0LjRgNC+0LLQutCwDQpTdHJpbmcgZ2V0VmFsdWVzQnlHcm91cENvbHVtbihEYXRhUm93IHJvdykgew0KICAgIGRlZiB2YWx1ZQ0KICAgIC8vINCz0YDQsNGE0LAgMTINCiAgICBpZiAocm93Py5wZXJpb2QpIHsNCiAgICAgICAgdmFsdWUgPSBnZXRSZWZCb29rVmFsdWUoOCwgcm93LnBlcmlvZCk/Lk5BTUU/LnN0cmluZ1ZhbHVlDQogICAgfQ0KICAgIHJldHVybiB2YWx1ZQ0KfQ0KDQpARmllbGQNCmRlZiBtYXBwZXINCg0KZGVmIGdldERSUE1hcHBlcigpIHsNCiAgICBpZiAobWFwcGVyID09IG51bGwpIHsNCiAgICAgICAgbWFwcGVyID0gbmV3IFJvd01hcHBlcjxEZXBhcnRtZW50UmVwb3J0UGVyaW9kPigpIHsNCiAgICAgICAgICAgIEBPdmVycmlkZQ0KICAgICAgICAgICAgcHVibGljIERlcGFydG1lbnRSZXBvcnRQZXJpb2QgbWFwUm93KFJlc3VsdFNldCBycywgaW50IGluZGV4KSB0aHJvd3MgU1FMRXhjZXB0aW9uIHsNCiAgICAgICAgICAgICAgICBEZXBhcnRtZW50UmVwb3J0UGVyaW9kIGRlcGFydG1lbnRSZXBvcnRQZXJpb2QgPSBuZXcgRGVwYXJ0bWVudFJlcG9ydFBlcmlvZCgpOw0KICAgICAgICAgICAgICAgIGRlcGFydG1lbnRSZXBvcnRQZXJpb2Quc2V0SWQoU3FsVXRpbHMuZ2V0SW50ZWdlcihycywgImlkIikpOw0KICAgICAgICAgICAgICAgIGRlcGFydG1lbnRSZXBvcnRQZXJpb2Quc2V0RGVwYXJ0bWVudElkKFNxbFV0aWxzLmdldEludGVnZXIocnMsICJkZXBhcnRtZW50X2lkIikpOw0KICAgICAgICAgICAgICAgIGRlcGFydG1lbnRSZXBvcnRQZXJpb2Quc2V0UmVwb3J0UGVyaW9kKGdldFJlcG9ydFBlcmlvZChTcWxVdGlscy5nZXRJbnRlZ2VyKHJzLCAicmVwb3J0X3BlcmlvZF9pZCIpKSk7DQogICAgICAgICAgICAgICAgZGVwYXJ0bWVudFJlcG9ydFBlcmlvZC5zZXRBY3RpdmUoIVNxbFV0aWxzLmdldEludGVnZXIocnMsICJpc19hY3RpdmUiKS5lcXVhbHMoMCkpOw0KICAgICAgICAgICAgICAgIGRlcGFydG1lbnRSZXBvcnRQZXJpb2Quc2V0QmFsYW5jZSghU3FsVXRpbHMuZ2V0SW50ZWdlcihycywgImlzX2JhbGFuY2VfcGVyaW9kIikuZXF1YWxzKDApKTsNCiAgICAgICAgICAgICAgICBkZXBhcnRtZW50UmVwb3J0UGVyaW9kLnNldENvcnJlY3Rpb25EYXRlKHJzLmdldERhdGUoImNvcnJlY3Rpb25fZGF0ZSIpKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gZGVwYXJ0bWVudFJlcG9ydFBlcmlvZDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gbWFwcGVyDQp9DQoNCmRlZiBEZXBhcnRtZW50UmVwb3J0UGVyaW9kIGdldExhc3REZXBhcnRtZW50UmVwb3J0UGVyaW9kKGRlZiBkZXBhcnRtZW50SWQsIGRlZiByZXBvcnRQZXJpb2RJZCkgew0KICAgIGRlZiBkZWNsYXJhdGlvblRlbXBsYXRlRGFvID0gZGVjbGFyYXRpb25TZXJ2aWNlLmRlY2xhcmF0aW9uVGVtcGxhdGVEYW8NCiAgICByZXR1cm4gZGVjbGFyYXRpb25UZW1wbGF0ZURhby5nZXRKZGJjVGVtcGxhdGUoKS5xdWVyeUZvck9iamVjdCgic2VsZWN0IGRycC5pZCwgZHJwLmRlcGFydG1lbnRfaWQsIGRycC5yZXBvcnRfcGVyaW9kX2lkLCAiICsNCiAgICAgICAgICAgICJkcnAuaXNfYWN0aXZlLCBkcnAuaXNfYmFsYW5jZV9wZXJpb2QsIGRycC5jb3JyZWN0aW9uX2RhdGUgIiArDQogICAgICAgICAgICAiZnJvbSAiICsNCiAgICAgICAgICAgICJkZXBhcnRtZW50X3JlcG9ydF9wZXJpb2QgZHJwLCAiICsNCiAgICAgICAgICAgICIoc2VsZWN0IG1heChjb3JyZWN0aW9uX2RhdGUpIGFzIGNvcnJlY3Rpb25fZGF0ZSwgZGVwYXJ0bWVudF9pZCwgcmVwb3J0X3BlcmlvZF9pZCAiICsNCiAgICAgICAgICAgICJmcm9tIGRlcGFydG1lbnRfcmVwb3J0X3BlcmlvZCAiICsNCiAgICAgICAgICAgICJ3aGVyZSBkZXBhcnRtZW50X2lkID0gPyBhbmQgcmVwb3J0X3BlcmlvZF9pZCA9ID8gIiArDQogICAgICAgICAgICAiZ3JvdXAgYnkgZGVwYXJ0bWVudF9pZCwgcmVwb3J0X3BlcmlvZF9pZCkgbSAiICsNCiAgICAgICAgICAgICJ3aGVyZSBkcnAuZGVwYXJ0bWVudF9pZCA9IG0uZGVwYXJ0bWVudF9pZCAiICsNCiAgICAgICAgICAgICJhbmQgZHJwLnJlcG9ydF9wZXJpb2RfaWQgPSBtLnJlcG9ydF9wZXJpb2RfaWQgIiArDQogICAgICAgICAgICAiYW5kIChkcnAuY29ycmVjdGlvbl9kYXRlID0gbS5jb3JyZWN0aW9uX2RhdGUgb3IgKG0uY29ycmVjdGlvbl9kYXRlIGlzIG51bGwgIiArDQogICAgICAgICAgICAiYW5kIGRycC5jb3JyZWN0aW9uX2RhdGUgaXMgbnVsbCkpIiwNCiAgICAgICAgICAgIFtkZXBhcnRtZW50SWQsIHJlcG9ydFBlcmlvZElkXSBhcyBPYmplY3RbXSwgZ2V0RFJQTWFwcGVyKCkpOw0KfQ0KDQpkZWYgTGlzdDxEZXBhcnRtZW50UmVwb3J0UGVyaW9kPiBnZXRMaXN0QnlGaWx0ZXIoRGVwYXJ0bWVudFJlcG9ydFBlcmlvZEZpbHRlciBmaWx0ZXIpIHsNCiAgICBkZWYgZGVjbGFyYXRpb25UZW1wbGF0ZURhbyA9IGRlY2xhcmF0aW9uU2VydmljZS5kZWNsYXJhdGlvblRlbXBsYXRlRGFvDQogICAgU3RyaW5nIFFVRVJZX1RFTVBMQVRFX0NPTVBPU0lURV9TT1JUID0gInNlbGVjdCBkcnAuaWQsIGRycC5kZXBhcnRtZW50X2lkLCBkcnAucmVwb3J0X3BlcmlvZF9pZCwgZHJwLmlzX2FjdGl2ZSwgZHJwLmlzX2JhbGFuY2VfcGVyaW9kLCBkcnAuY29ycmVjdGlvbl9kYXRlIFxuIiArDQogICAgICAgICAgICAiICAgICAgICAgIGZyb20gXG4iICsNCiAgICAgICAgICAgICIgICAgICAgICAgZGVwYXJ0bWVudF9yZXBvcnRfcGVyaW9kIGRycCBcbiIgKw0KICAgICAgICAgICAgIiAgICAgICAgICBqb2luIHJlcG9ydF9wZXJpb2QgcnAgb24gZHJwLnJlcG9ydF9wZXJpb2RfaWQgPSBycC5pZCBcbiIgKw0KICAgICAgICAgICAgIiAgICAgICAgICBqb2luIHRheF9wZXJpb2QgdHAgb24gcnAudGF4X3BlcmlvZF9pZCA9IHRwLmlkIFxuIiArDQogICAgICAgICAgICAiICAgICAgICAgICAgJXMgXG4iICsNCiAgICAgICAgICAgICIgICAgICAgICAgICBvcmRlciBieSB0cC55ZWFyLCBkcnAuQ09SUkVDVElPTl9EQVRFIE5VTExTIEZJUlNUIjsNCiAgICByZXR1cm4gZGVjbGFyYXRpb25UZW1wbGF0ZURhby5nZXROYW1lZFBhcmFtZXRlckpkYmNUZW1wbGF0ZSgpLnF1ZXJ5KFN0cmluZy5mb3JtYXQoUVVFUllfVEVNUExBVEVfQ09NUE9TSVRFX1NPUlQsIGdldEZpbHRlclN0cmluZyhmaWx0ZXIpKSwNCiAgICAgICAgICAgIG5ldyBIYXNoTWFwPFN0cmluZywgT2JqZWN0PigyKSB7ew0KICAgICAgICAgICAgICAgIHB1dCgieWVhclN0YXJ0IiwgZmlsdGVyLmdldFllYXJTdGFydCgpKTsNCiAgICAgICAgICAgICAgICBwdXQoInllYXJFbmQiLCBmaWx0ZXIuZ2V0WWVhckVuZCgpKTsNCiAgICAgICAgICAgIH19LCBnZXREUlBNYXBwZXIoKSk7DQp9DQoNCmRlZiBTdHJpbmcgZ2V0RmlsdGVy'

    longString += 'U3RyaW5nKERlcGFydG1lbnRSZXBvcnRQZXJpb2RGaWx0ZXIgZmlsdGVyKSB7DQogICAgaWYgKGZpbHRlciA9PSBudWxsKSB7DQogICAgICAgIHJldHVybiAiIjsNCiAgICB9DQogICAgTGlzdDxTdHJpbmc+IGNhdXNlTGlzdCA9IG5ldyBMaW5rZWRMaXN0PFN0cmluZz4oKTsNCiAgICBpZiAoZmlsdGVyLmlzQ29ycmVjdGlvbigpICE9IG51bGwpIHsNCiAgICAgICAgY2F1c2VMaXN0LmFkZCgiZHJwLmNvcnJlY3Rpb25fZGF0ZSBpcyAiICsgKGZpbHRlci5pc0NvcnJlY3Rpb24oKSA/ICIgbm90ICIgOiAiIikgKyAiIG51bGwiKTsNCiAgICB9DQogICAgaWYgKGZpbHRlci5pc0JhbGFuY2UoKSAhPSBudWxsKSB7DQogICAgICAgIGNhdXNlTGlzdC5hZGQoImRycC5pc19iYWxhbmNlX3BlcmlvZCAiICsgKGZpbHRlci5pc0JhbGFuY2UoKSA/ICI8PiIgOiAiPSIpICsgIiAwIik7DQogICAgfQ0KICAgIGlmIChmaWx0ZXIuaXNBY3RpdmUoKSAhPSBudWxsKSB7DQogICAgICAgIGNhdXNlTGlzdC5hZGQoImRycC5pc19hY3RpdmUgIiArIChmaWx0ZXIuaXNBY3RpdmUoKSA/ICI8PiIgOiAiPSIpICsgIiAwIik7DQogICAgfQ0KICAgIGlmIChmaWx0ZXIuZ2V0Q29ycmVjdGlvbkRhdGUoKSAhPSBudWxsKSB7DQogICAgICAgIGNhdXNlTGlzdC5hZGQoImRycC5jb3JyZWN0aW9uX2RhdGUgPSB0b19kYXRlKCciICsNCiAgICAgICAgICAgICAgICBmaWx0ZXIuZ2V0Q29ycmVjdGlvbkRhdGUoKS5mb3JtYXQoJ2RkLk1NLnl5eXknKSArDQogICAgICAgICAgICAgICAgIicsICdERC5NTS5ZWVlZJykiKTsNCiAgICB9DQogICAgaWYgKGZpbHRlci5nZXREZXBhcnRtZW50SWRMaXN0KCkgIT0gbnVsbCkgew0KICAgICAgICBjYXVzZUxpc3QuYWRkKFNxbFV0aWxzLnRyYW5zZm9ybVRvU3FsSW5TdGF0ZW1lbnQoImRycC5kZXBhcnRtZW50X2lkIiwNCiAgICAgICAgICAgICAgICBmaWx0ZXIuZ2V0RGVwYXJ0bWVudElkTGlzdCgpKSk7DQogICAgfQ0KICAgIGlmIChmaWx0ZXIuZ2V0UmVwb3J0UGVyaW9kSWRMaXN0KCkgIT0gbnVsbCkgew0KICAgICAgICBjYXVzZUxpc3QuYWRkKFNxbFV0aWxzLnRyYW5zZm9ybVRvU3FsSW5TdGF0ZW1lbnQoImRycC5yZXBvcnRfcGVyaW9kX2lkIiwNCiAgICAgICAgICAgICAgICBmaWx0ZXIuZ2V0UmVwb3J0UGVyaW9kSWRMaXN0KCkpKTsNCiAgICB9DQogICAgaWYgKGZpbHRlci5nZXRUYXhUeXBlTGlzdCgpICE9IG51bGwpIHsNCiAgICAgICAgY2F1c2VMaXN0LmFkZCgidHAudGF4X3R5cGUgaW4gIiArDQogICAgICAgICAgICAgICAgU3FsVXRpbHMudHJhbnNmb3JtVGF4VHlwZVRvU3FsSW5TdGF0ZW1lbnQoZmlsdGVyLmdldFRheFR5cGVMaXN0KCkpKTsNCiAgICB9DQogICAgaWYgKGZpbHRlci5nZXRZZWFyU3RhcnQoKSAhPSBudWxsIHx8IGZpbHRlci5nZXRZZWFyRW5kKCkgIT0gbnVsbCl7DQogICAgICAgIGNhdXNlTGlzdC5hZGQoIig6eWVhclN0YXJ0IGlzIG51bGwgb3IgdHAueWVhciA+PSA6eWVhclN0YXJ0KSBhbmQgKDp5ZWFyRW5kIGlzIG51bGwgb3IgdHAueWVhciA8PSA6eWVhckVuZCkiKTsNCiAgICB9DQogICAgaWYgKGNhdXNlTGlzdC5pc0VtcHR5KCkpIHsNCiAgICAgICAgcmV0dXJuICIiOw0KICAgIH0NCiAgICByZXR1cm4gIiB3aGVyZSAiICsgU3RyaW5nVXRpbHMuam9pbihjYXVzZUxpc3QsICIgYW5kICIpOw0KfQ0KDQovLyDQn9GA0LXQtNGA0LDRgdGH0LXRgtC90YvQtSDQv9GA0L7QstC10YDQutC4DQpkZWYgcHJlQ2FsY0NoZWNrKCkgew0KICAgIGRlZiBkYXRhUm93cyA9IGZvcm1EYXRhU2VydmljZS5nZXREYXRhUm93SGVscGVyKGZvcm1EYXRhKS5hbGxDYWNoZWQNCg0KICAgIC8vINCf0YDQtdC00YDQsNGB0YfQtdGC0L3QsNGPINC/0YDQvtCy0LXRgNC60LAgMi4g0J/RgNC+0LLQtdGA0LrQsCDQvdCw0LvQvtCz0L7QstC+0LPQviDQv9C10YDQuNC+0LTQsA0KICAgIGRlZiBlcnJvck51bWJlcnMgPSBbXQ0KICAgIGZvciAoZGVmIHJvdyA6IGRhdGFSb3dzKSB7DQogICAgICAgIGlmIChyb3cuZ2V0QWxpYXMoKSkgew0KICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgfQ0KICAgICAgICBkZWYgcGVyaW9kTmFtZSA9IGdldFJlZkJvb2tWYWx1ZSg4LCByb3cucGVyaW9kKT8uTkFNRT8udmFsdWUNCiAgICAgICAgaWYgKCFwZXJpb2ROYW1lcy5jb250YWlucyhwZXJpb2ROYW1lKSkgew0KICAgICAgICAgICAgZXJyb3JOdW1iZXJzLmFkZChyb3cuZ2V0SW5kZXgoKSkNCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoIWVycm9yTnVtYmVycy5pc0VtcHR5KCkpIHsNCiAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LggJXM6INCT0YDQsNGE0LAgwqslc8K7INC30LDQv9C+0LvQvdC10L3QsCDQvdC10LLQtdGA0L3QviEg0JLQvtC30LzQvtC20L3Ri9C1INC30L3QsNGH0LXQvdC40Y86IMKrJXPCuy4iLA0KICAgICAgICAgICAgICAgIGVycm9yTnVtYmVycy5qb2luKCcsICcpLCBnZXRDb2x1bW5OYW1lKGRhdGFSb3dzWzBdLCAncGVyaW9kJyksIHBlcmlvZE5hbWVzLmpvaW4oJ8K7LCDCqycpKQ0KICAgIH0NCn0NCg0KZGVmIGNoZWNrT3ZlcmZsb3coQmlnRGVjaW1hbCB2YWx1ZSwgaW50IHNpemUpIHsNCiAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgICAgICByZXR1cm4gdHJ1ZQ0KICAgIH0NCiAgICBCaWdEZWNpbWFsIG92ZXJwb3dlciA9IG5ldyBCaWdEZWNpbWFsKCIxRSIgKyBzaXplKQ0KICAgIGlmICh2YWx1ZS5hYnMoKS5jb21wYXJlVG8ob3ZlcnBvd2VyKSAhPSAtMSkgew0KICAgICAgICByZXR1cm4gZmFsc2UNCiAgICB9DQogICAgcmV0dXJuIHRydWUNCn0NCg0KQEZpZWxkDQpkZWYgcmVwb3J0UGVyaW9kTWFwID0gWzpdDQoNCmRlZiBnZXRSZXBvcnRQZXJpb2QoZGVmIGlkKSB7DQogICAgaWYgKHJlcG9ydFBlcmlvZE1hcFtpZF0gPT0gbnVsbCkgew0KICAgICAgICByZXBvcnRQZXJpb2RNYXBbaWRdID0gcmVwb3J0UGVyaW9kU2VydmljZS5nZXQoaWQpDQogICAgfQ0KICAgIHJldHVybiByZXBvcnRQZXJpb2RNYXBbaWRdDQp9DQoNCkBGaWVsZA0KZGVmIGRlcGFydG1lbnRSZXBvcnRQZXJpb2RNYXAgPSBbOl0NCg0KRGVwYXJ0bWVudFJlcG9ydFBlcmlvZCBnZXREZXBhcnRtZW50UmVwb3J0UGVyaW9kKGRlZiBpZCkgew0KICAgIGlmIChkZXBhcnRtZW50UmVwb3J0UGVyaW9kTWFwW2lkXSA9PSBudWxsKSB7DQogICAgICAgIGRlcGFydG1lbnRSZXBvcnRQZXJpb2RNYXBbaWRdID0gZGVwYXJ0bWVudFJlcG9ydFBlcmlvZFNlcnZpY2UuZ2V0KGlkKQ0KICAgIH0NCiAgICByZXR1cm4gZGVwYXJ0bWVudFJlcG9ydFBlcmlvZE1hcFtpZF0NCn0='

    addLongText(form_template_id, longString, 'SCRIPT')
    logger.info('Обновлен скрипт макета "(724.1.1) Корректировка сумм НДС и налоговых вычетов за прошедшие налоговые периоды".')

} catch (Exception ex) {
    logger.error("Error: ${ex.getLocalizedMessage()}. Все действия, выполненные скриптом, были отменены")
}

def void addLongText(def form_template_id, String longString, String alias) {
    final int MAX_LENGTH = 2000
    namedParameterJdbcTemplate.update("UPDATE FORM_TEMPLATE SET $alias = null where id = $form_template_id", [:])
    int start = 0
    longString = new String(longString.decodeBase64(), "UTF-8")
    while (start < longString.length()) {
        int end = (start + MAX_LENGTH) < longString.length() ? (start + MAX_LENGTH) : longString.length()
        String text = longString.substring(start, end)
        namedParameterJdbcTemplate.update('UPDATE FORM_TEMPLATE SET ' + alias + ' = ' + alias + ' || :text where id = ' +form_template_id, ['text' : text])
        start += MAX_LENGTH
    }
}