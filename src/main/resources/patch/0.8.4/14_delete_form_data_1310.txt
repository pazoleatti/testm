import groovy.transform.Field
import org.springframework.jndi.JndiTemplate

import javax.sql.DataSource

/**
 Удаляет таблицу для хранения НФ и шаблон версии. Не использовать для удаления макета!
 # Инструкция:
 1) Вставить текст данного скрипта на странице, соответствующей ссылке с окончанием:
 .../gwtapp/#!scriptExecution
 2) Нажать "Выполнить".

 */

@Field
def dataSourceName = 'jdbc/TaxAccDS-nonXA'

@Field
def form_template_id = 1310

try {
    def template = new JndiTemplate()
    def DataSource dataSource = template.lookup(dataSourceName)
    def connection = dataSource.connection

    def stmt = connection.createStatement()
    def result = namedParameterJdbcTemplate.queryForObject("SELECT count(TABLE_NAME) FROM USER_TABLES WHERE TABLE_NAME = 'FORM_DATA_$form_template_id'", [:], Integer.class)
    if (result == 0) {
        logger.info("Таблица FORM_DATA_$form_template_id НФ уже удалена!")
    } else {
        stmt.executeQuery("DROP TABLE FORM_DATA_$form_template_id")
        logger.info("Таблица FORM_DATA_$form_template_id НФ успешно удалена!")
    }
    result = namedParameterJdbcTemplate.queryForObject("SELECT count(*) FROM FORM_TEMPLATE WHERE id = $form_template_id", [:], Integer.class)
    if (result == 0) {
        logger.info("Версия макета НФ с id = $form_template_id отсутствует!")
    } else {
        stmt.executeQuery("DELETE from FORM_TEMPLATE where id = $form_template_id")
        logger.info("Версия макета с id = $form_template_id НФ успешно удалена!")
    }
} catch (Exception ex) {
    logger.error("Error: ${ex.getLocalizedMessage()}")
}