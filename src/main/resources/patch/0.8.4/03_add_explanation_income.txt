import com.aplana.sbrf.taxaccounting.model.Column
import com.aplana.sbrf.taxaccounting.model.ColumnType
import com.aplana.sbrf.taxaccounting.model.FormStyle
import com.aplana.sbrf.taxaccounting.model.FormTemplate
import com.aplana.sbrf.taxaccounting.model.FormType
import org.apache.commons.io.IOUtils

/**
 Создает макет НФ, кроме таблицы для хранения данных
 # Инструкция:
 Вставить текст данного скрипта на странице, соответствующей ссылке с окончанием:
 .../gwtapp/#!scriptExecution
 Нажать "Выполнить".

 */

boolean createType = true
boolean createTemplate = true
boolean addColumns = true
boolean addStyles = true
boolean addDataRows = true
boolean addDataHeaders = true
boolean addScript = true

try {
    // id типа формы, имя типа формы, вид налога(I, T, V, D, P, E), включать в ИФРС(флаг), имя ИФРС
    FormType formType = new FormType()
    formType.setId(851)
    formType.setName('Таблица 1. Пояснение отклонений от ОФР в простом регистре налогового учёта «Доходы»')
    formType.setTaxType(TaxType.INCOME)
    formType.setIsIfrs(false)
    formType.setIfrsName('')
    formType.setCode('')
    // id шаблона формы, имя шаблона короткое, имя шаблона полное, год версии, ежемесячность(флаг), код
    FormTemplate formTemplate = new FormTemplate()
    formTemplate.setId(851)
    formTemplate.setFixedRows(false)
    formTemplate.setName('Таблица 1. Пояснение отклонений от ОФР в простом регистре налогового учёта «Доходы»')
    formTemplate.setFullName('Таблица 1. Пояснение отклонений от ОФР в простом регистре налогового учёта «Доходы»')
    formTemplate.setVersion(Date.parse('dd.MM.yyyy', '01.01.2016'))
    formTemplate.setMonthly(false)
    formTemplate.setHeader('')
    formTemplate.setComparative(false)
    formTemplate.setAccruing(false)
    formTemplate.setUpdating(false)

    def form_type_id = formType.id
    def form_template_id = formTemplate.id

    def rs = namedParameterJdbcTemplate.queryForObject("SELECT count(id) from FORM_TYPE where id = $form_type_id", [:], Integer.class)
    if (rs == 1) {
        logger.info("Макет НФ с данным id = $form_type_id уже существует в системе!")
        if (createType) {
            return
        }
    }

    rs = namedParameterJdbcTemplate.queryForObject("SELECT count(id) from FORM_TEMPLATE where id = $form_template_id", [:], Integer.class)
    if (rs == 1) {
        logger.info("Версия макета НФ с данным id = $form_template_id уже существует в системе!")
        if (createTemplate) {
            return
        }
    }

    addTypeTemplate(formType, formTemplate, createType, createTemplate)

    List<Column> formColumns = new ArrayList<>()
	def referenceColumnMap = [:]

    //Добавление колонок
    // NAME, ALIAS, TYPE, WIDTH, PRECISION, MAX_LENGTH, CHECKING, ATTRIBUTE_ID, FORMAT, FILTER, PARENT_COLUMN_ID, ATTRIBUTE_ID2, NUMERATION_ROW
    if (addColumns) {
        def Column formColumn = new AutoNumerationColumn()
        formColumn.setOrder(1)
        formColumn.setName('№ пп.')
        formColumn.setAlias('rowNum')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Автонумеруемая графа')})
        formColumn.setWidth(5)
        formColumn.setChecking(false)
        formColumn.setNumerationType(NumerationType.getById(0))
        formColumns.add(formColumn)

        formColumn = new RefBookColumn()
        formColumn.setOrder(2)
        formColumn.setName('КНУ')
        formColumn.setAlias('code')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Справочник')})
        formColumn.setWidth(10)
        formColumn.setChecking(false)
        formColumn.setRefBookAttributeId(140)
        formColumn.setRefBookAttributeId2(null)
        formColumn.setNameAttributeId(140)
        formColumn.setFilter('' ?: null)
        formColumns.add(formColumn)

        formColumn = new ReferenceColumn()
        formColumn.setOrder(3)
        formColumn.setName('Символ ОФР')
        formColumn.setAlias('symbol')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Зависимая графа')})
        formColumn.setWidth(15)
        formColumn.setChecking(false)
        formColumn.setParentAlias('symbol')
        formColumn.setRefBookAttributeId(144)
        formColumn.setRefBookAttributeId2(null)
        referenceColumnMap['symbol'] = 'code'
        formColumns.add(formColumn)

        formColumn = new NumericColumn()
        formColumn.setOrder(4)
        formColumn.setName('Сумма отклонения данных в РНУ-4 с данными бухгалтерского учёта')
        formColumn.setAlias('sum')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Число')})
        formColumn.setWidth(10)
        formColumn.setChecking(false)
        formColumn.setPrecision(2)
        formColumn.setMaxLength(17)
        formColumns.add(formColumn)

        formColumn = new StringColumn()
        formColumn.setOrder(5)
        formColumn.setName('Пояснение')
        formColumn.setAlias('explanation')
        formColumn.setColumnType(ColumnType.find{ it.title.equals('Строка')})
        formColumn.setWidth(10)
        formColumn.setChecking(false)
        formColumn.setMaxLength(255)
        formColumn.setPrevLength(0)
        formColumns.add(formColumn)


        formTemplate.getColumns().addAll(formColumns)
        columnDaoImpl.createFormColumns(formColumns, formTemplate)

	  	referenceColumnMap.each { alias, parentAlias ->
			def column = formColumns.find{ it.alias == alias }
			if (column != null) {
				column.setParentAlias(parentAlias)
			} else {
				logger.error("Родительская колонка с псевдонимом $parentAlias не обнаружена!")
			}
		}

        if (!referenceColumnMap.isEmpty()) {
            columnDaoImpl.updateFormColumns(formColumns, formTemplate)
        }

        logger.info("К версии макета добавлены колонки")
    }

    List<FormStyle> formStyles = new ArrayList<>()

    if (addStyles) {
        def FormStyle formStyle = new FormStyle()
        formStyle.setAlias('Редактируемая')
        formStyle.setBackColor(Color.getById(3))
        formStyle.setBold(false)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Корректировка-добавлено')
        formStyle.setBackColor(Color.getById(12))
        formStyle.setBold(false)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Корректировка-удалено')
        formStyle.setBackColor(Color.getById(8))
        formStyle.setBold(false)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Корректировка-без изменений')
        formStyle.setBackColor(Color.getById(6))
        formStyle.setBold(false)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Корректировка-изменено')
        formStyle.setBackColor(Color.getById(4))
        formStyle.setBold(true)
        formStyle.setFontColor(Color.getById(10))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Контрольные суммы')
        formStyle.setBackColor(Color.getById(2))
        formStyle.setBold(true)
        formStyle.setFontColor(Color.getById(0))
        formStyle.setItalic(false)
        formStyles.add(formStyle)

        formStyle = new FormStyle()
        formStyle.setAlias('Автозаполняемая')
        formStyle.setBackColor(Color.getById(4))
        formStyle.setBold(true)
        formStyle.setFontColor(Color.getById(13))
        formStyle.setItalic(false)
        formStyles.add(formStyle)


        formTemplate.getStyles().addAll(formStyles)
        formStyleDaoImpl.saveFormStyles(formTemplate)
        logger.info("К версии макета добавлены стили")
    }

    String longString = ''

    if (addDataRows) {
        longString += 'PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48cm93cy8+'

        addLongText(form_template_id, longString, 'DATA_ROWS')
        logger.info("К версии макета добавлены фиксированные строки")
    }

    longString = ''
    if (addDataHeaders) {
        longString += 'PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjxyb3dzPg0KICAgIDxyb3cgYWxpYXM9IiI+DQogICAgICAgIDxjZWxsIGFsaWFzPSJyb3dOdW0iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLihJYg0L/Qvy4iLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImNvZGUiIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQmtCd0KMiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InN5bWJvbCIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCh0LjQvNCy0L7QuyDQntCk0KAiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InN1bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9ItCh0YPQvNC80LAg0L7RgtC60LvQvtC90LXQvdC40Y8g0LTQsNC90L3Ri9GFINCyINCg0J3Qoy00INGBINC00LDQvdC90YvQvNC4INCx0YPRhdCz0LDQu9GC0LXRgNGB0LrQvtCz0L4g0YPRh9GR0YLQsCIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iZXhwbGFuYXRpb24iIGNvbFNwYW49IjEiIHJvd1NwYW49IjEiIHZhbHVlPSLQn9C+0Y/RgdC90LXQvdC40LUiLz4NCiAgICA8L3Jvdz4NCiAgICA8cm93IGFsaWFzPSIiPg0KICAgICAgICA8Y2VsbCBhbGlhcz0icm93TnVtIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0iMSIvPg0KICAgICAgICA8Y2VsbCBhbGlhcz0iY29kZSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IjIiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InN5bWJvbCIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IjMiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9InN1bSIgY29sU3Bhbj0iMSIgcm93U3Bhbj0iMSIgdmFsdWU9IjQiLz4NCiAgICAgICAgPGNlbGwgYWxpYXM9ImV4cGxhbmF0aW9uIiBjb2xTcGFuPSIxIiByb3dTcGFuPSIxIiB2YWx1ZT0iNSIvPg0KICAgIDwvcm93Pg0KPC9yb3dzPg=='

        addLongText(form_template_id, longString, 'DATA_HEADERS')
        logger.info("К версии макета добавлен заголовок")
    }

    longString = ''
    if (addScript) {
        longString += 'cGFja2FnZSBmb3JtX3RlbXBsYXRlLmluY29tZS5leHBsYW5hdGlvbl9pbmNvbWUudjIwMTYNCg0KaW1wb3J0IGF1LmNvbS5ieXRlY29kZS5vcGVuY3N2LkNTVlJlYWRlcg0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLkZvcm1EYXRhRXZlbnQNCmltcG9ydCBjb20uYXBsYW5hLnNicmYudGF4YWNjb3VudGluZy5tb2RlbC5leGNlcHRpb24uU2VydmljZUV4Y2VwdGlvbg0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLmxvZy5Mb2dMZXZlbA0KaW1wb3J0IGNvbS5hcGxhbmEuc2JyZi50YXhhY2NvdW50aW5nLm1vZGVsLnV0aWwuU3RyaW5nVXRpbHMNCmltcG9ydCBncm9vdnkudHJhbnNmb3JtLkZpZWxkDQoNCi8qKg0KICog0KLQsNCx0LvQuNGG0LAgMS4g0J/QvtGP0YHQvdC10L3QuNC1INC+0YLQutC70L7QvdC10L3QuNC5INC+0YIg0J7QpNCgINCyINC/0YDQvtGB0YLQvtC8INGA0LXQs9C40YHRgtGA0LUg0L3QsNC70L7Qs9C+0LLQvtCz0L4g0YPRh9GR0YLQsCDCq9CU0L7RhdC+0LTRi8K7DQogKiBmb3JtVGVtcGxhdGVJZD04NTENCiAqLw0KDQovLyDQs9GA0LDRhNCwIDEgLSByb3dOdW0NCi8vINCz0YDQsNGE0LAgMiAtIGNvZGUNCi8vINCz0YDQsNGE0LAgMyAtIHN5bWJvbA0KLy8g0LPRgNCw0YTQsCA0IC0gc3VtDQovLyDQs9GA0LDRhNCwIDUgLSBleHBsYW5hdGlvbg0KDQpzd2l0Y2ggKGZvcm1EYXRhRXZlbnQpIHsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ1JFQVRFOg0KICAgICAgICBmb3JtRGF0YVNlcnZpY2UuY2hlY2tVbmlxdWUoZm9ybURhdGEsIGxvZ2dlcikNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ0FMQ1VMQVRFOg0KICAgICAgICBjYWxjKCkNCiAgICAgICAgbG9naWNDaGVjaygpDQogICAgICAgIGZvcm1EYXRhU2VydmljZS5zYXZlQ2FjaGVkRGF0YVJvd3MoZm9ybURhdGEsIGxvZ2dlcikNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ0hFQ0s6DQogICAgICAgIGxvZ2ljQ2hlY2soKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5BRERfUk9XOg0KICAgICAgICBmb3JtRGF0YVNlcnZpY2UuYWRkUm93KGZvcm1EYXRhLCBjdXJyZW50RGF0YVJvdywgZWRpdGFibGVDb2x1bW5zLCAoYWxsQ29sdW1ucyAtIGVkaXRhYmxlQ29sdW1ucykpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LkRFTEVURV9ST1c6DQogICAgICAgIGlmIChjdXJyZW50RGF0YVJvdyAhPSBudWxsICYmIGN1cnJlbnREYXRhUm93LmdldEFsaWFzKCkgPT0gbnVsbCkgew0KICAgICAgICAgICAgZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpLmRlbGV0ZShjdXJyZW50RGF0YVJvdykNCiAgICAgICAgfQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX0NSRUFURURfVE9fUFJFUEFSRUQ6ICAvLyDQn9C+0LTQs9C+0YLQvtCy0LjRgtGMINC40LcgItCh0L7Qt9C00LDQvdCwIg0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX0NSRUFURURfVE9fQVBQUk9WRUQ6ICAvLyDQo9GC0LLQtdGA0LTQuNGC0Ywg0LjQtyAi0KHQvtC30LTQsNC90LAiDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfQ1JFQVRFRF9UT19BQ0NFUFRFRDogIC8vINCf0YDQuNC90Y/RgtGMINC40LcgItCh0L7Qt9C00LDQvdCwIg0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX1BSRVBBUkVEX1RPX0FQUFJPVkVEOiAvLyDQo9GC0LLQtdGA0LTQuNGC0Ywg0LjQtyAi0J/QvtC00LPQvtGC0L7QstC70LXQvdCwIg0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5NT1ZFX1BSRVBBUkVEX1RPX0FDQ0VQVEVEOiAvLyDQn9GA0LjQvdGP0YLRjCDQuNC3ICLQn9C+0LTQs9C+0YLQvtCy0LvQtdC90LAiDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50Lk1PVkVfQVBQUk9WRURfVE9fQUNDRVBURUQ6IC8vINCf0YDQuNC90Y/RgtGMINC40LcgItCj0YLQstC10YDQttC00LXQvdCwIg0KICAgICAgICBsb2dpY0NoZWNrKCkNCiAgICAgICAgYnJlYWsNCiAgICBjYXNlIEZvcm1EYXRhRXZlbnQuQ09NUE9TRToNCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLmNvbnNvbGlkYXRpb25TaW1wbGUoZm9ybURhdGEsIGxvZ2dlciwgdXNlckluZm8pDQogICAgICAgIGNhbGMoKQ0KICAgICAgICBsb2dpY0NoZWNrKCkNCiAgICAgICAgZm9ybURhdGFTZXJ2aWNlLnNhdmVDYWNoZWREYXRhUm93cyhmb3JtRGF0YSwgbG9nZ2VyKQ0KICAgICAgICBicmVhaw0KICAgIGNhc2UgRm9ybURhdGFFdmVudC5JTVBPUlQ6DQogICAgICAgIGltcG9ydERhdGEoKQ0KICAgICAgICBmb3JtRGF0YVNlcnZpY2Uuc2F2ZUNhY2hlZERhdGFSb3dzKGZvcm1EYXRhLCBsb2dnZXIpDQogICAgICAgIGJyZWFrDQogICAgY2FzZSBGb3JtRGF0YUV2ZW50LlNPUlRfUk9XUzoNCiAgICAgICAgc29ydEZvcm1EYXRhUm93cygpDQogICAgICAgIGJyZWFrDQp9DQoNCi8vLy8g0JrRjdGI0Lgg0Lgg0LrQvtC90YHRgtCw0L3RgtGLDQpARmllbGQNCmRlZiBwcm92aWRlckNhY2hlID0gWzpdDQpARmllbGQNCmRlZiByZWNvcmRDYWNoZSA9IFs6XQ0KQEZpZWxkDQpkZWYgcmVmQm9va0NhY2hlID0gWzpdDQoNCkBGaWVsZA0KZGVmIGFsbENvbHVtbnMgPSBbJ3Jvd051bScsICdjb2RlJywgJ3N5bWJvbCcsICdzdW0nLCAnZXhwbGFuYXRpb24nXQ0KDQovLyDQoNC10LTQsNC60YLQuNGA0YPQtdC80YvQtSDQsNGC0YDQuNCx0YPRgtGLDQpARmllbGQNCmRlZiBlZGl0YWJsZUNvbHVtbnMgPSBbJ2NvZGUnLCAnc3VtJywgJ2V4cGxhbmF0aW9uJ10NCg0KLy8g0J/RgNC+0LLQtdGA0Y/QtdC80YvQtSDQvdCwINC/0YPRgdGC0YvQtSDQt9C90LDRh9C10L3QuNGPINCw0YLRgNC40LHRg9GC0YsNCkBGaWVsZA0KZGVmIG5vbkVtcHR5Q29sdW1ucyA9IFsnY29kZScsICdzdW0nXQ0KDQpARmllbGQNCmRlZiBzdGFydERhdGUgPSBudWxsDQoNCkBGaWVsZA0KZGVmIGVuZERhdGUgPSBudWxsDQoNCi8vINCg0LDQt9GL0LzQtdC90L7QstCw0L3QuNC1INC30LDQv9C40YHQuCDRgdC/0YDQsNCy0L7Rh9C90LjQutCwDQpkZWYgZ2V0UmVmQm9va1ZhbHVlKGRlZiBsb25nIHJlZkJvb2tJZCwgZGVmIExvbmcgcmVjb3JkSWQpIHsNCiAgICByZXR1cm4gZm9ybURhdGFTZXJ2aWNlLmdldFJlZkJvb2tWYWx1ZShyZWZCb29rSWQsIHJlY29yZElkLCByZWZCb29rQ2FjaGUpDQp9DQoNCmRlZiBnZXRSZXBvcnRQZXJpb2RTdGFydERhdGUoKSB7DQogICAgaWYgKHN0YXJ0RGF0ZSA9PSBudWxsKSB7DQogICAgICAgIHN0YXJ0RGF0ZSA9IHJlcG9ydFBlcmlvZFNlcnZpY2UuZ2V0Q2FsZW5kYXJTdGFydERhdGUoZm9ybURhdGEucmVwb3J0UGVyaW9kSWQpLnRpbWUNCiAgICB9DQogICAgcmV0dXJuIHN0YXJ0RGF0ZQ0KfQ0KDQpkZWYgZ2V0UmVwb3J0UGVyaW9kRW5kRGF0ZSgpIHsNCiAgICBpZiAoZW5kRGF0ZSA9PSBudWxsKSB7DQogICAgICAgIGVuZERhdGUgPSByZXBvcnRQZXJpb2RTZXJ2aWNlLmdldEVuZERhdGUoZm9ybURhdGEucmVwb3J0UGVyaW9kSWQpLnRpbWUNCiAgICB9DQogICAgcmV0dXJuIGVuZERhdGUNCn0NCg0KLy8g0J/QvtC40YHQuiDQt9Cw0L/QuNGB0Lgg0LIg0YHQv9GA0LDQstC+0YfQvdC40LrQtSDQv9C+INC30L3QsNGH0LXQvdC40Y4gKNC00LvRjyDQuNC80L/QvtGA0YLQsCkNCmRlZiBnZXRSZWNvcmRJbXBvcnQoZGVmIExvbmcgcmVmQm9va0lkLCBkZWYgU3RyaW5nIGFsaWFzLCBkZWYgU3RyaW5nIHZhbHVlLCBkZWYgaW50IHJvd0luZGV4LCBkZWYgaW50IGNvbEluZGV4LA0KICAgICAgICAgICAgICAgICAgICBkZWYgYm9vbGVhbiByZXF1aXJlZCA9IHRydWUpIHsNCiAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSA9PSAnJykgew0KICAgICAgICByZXR1cm4gbnVsbA0KICAgIH0NCiAgICByZXR1cm4gZm9ybURhdGFTZXJ2aWNlLmdldFJlZkJvb2tSZWNvcmRJbXBvcnQocmVmQm9va0lkLCByZWNvcmRDYWNoZSwgcHJvdmlkZXJDYWNoZSwgcmVmQm9va0NhY2hlLCBhbGlhcywgdmFsdWUsDQogICAgICAgICAgICBnZXRSZXBvcnRQZXJpb2RFbmREYXRlKCksIHJvd0luZGV4LCBjb2xJbmRleCwgbG9nZ2VyLCByZXF1aXJlZCkNCn0NCg0KLy8g0J/QvtC70YPRh9C40YLRjCDQvdC+0LLRg9GOINGB0YLRgNC+0LrRgyDRgSDQt9Cw0LTQsNC90L3Ri9C80Lgg0YHRgtC40LvRj9C80LgNCmRlZiBnZXROZXdSb3coKSB7DQogICAgZGVmIHJvdyA9IChmb3JtRGF0YUV2ZW50IGluIFtGb3JtRGF0YUV2ZW50LklNUE9SVCwgRm9ybURhdGFFdmVudC5JTVBPUlRfVFJBTlNQT1JUX0ZJTEVdKSA/IGZvcm1EYXRhLmNyZWF0ZVN0b3JlTWVzc2FnaW5nRGF0YVJvdygpIDogZm9ybURhdGEuY3JlYXRlRGF0YVJvdygpDQogICAgZWRpdGFibGVDb2x1bW5zLmVhY2ggew0KICAgICAgICByb3cuZ2V0Q2VsbChpdCkuZWRpdGFibGUgPSB0cnVlDQogICAgICAgIHJvdy5nZXRDZWxsKGl0KS5zZXRTdHlsZUFsaWFzKCfQoNC10LTQsNC60YLQuNGA0YPQtdC80LDRjycpDQogICAgfQ0KICAgIChhbGxDb2x1bW5zIC0gZWRpdGFibGVDb2x1bW5zKS5lYWNoIHsNCiAgICAgICAgcm93LmdldENlbGwoaXQpLnNldFN0eWxlQWxpYXMoJ9CQ0LLRgtC+0LfQsNC/0L7Qu9C90Y/QtdC80LDRjycpDQogICAgfQ0KICAgIHJldHVybiByb3cNCn0NCg0Kdm9pZCBjYWxjKCkgew0KICAgIC8vINGA0LDRgdGH0LXRgtC+0LIg0L3QtdGCDQp9DQoNCnZvaWQgbG9naWNDaGVjaygpIHsNCiAgICBkZWYgZGF0YVJvd3MgPSBmb3JtRGF0YVNlcnZpY2UuZ2V0RGF0YVJvd0hlbHBlcihmb3JtRGF0YSkuYWxsQ2FjaGVkDQoNCiAgICBkZWYgY29kZU1hcCA9IFs6XQ0KICAgIGZvciAoZGVmIHJvdyA6IGRhdGFSb3dzKSB7DQogICAgICAgIC8vIDEuINCe0LHRj9C30LDRgtC10LvRjNC90L7RgdGC0Ywg0LfQsNC/0L7Qu9C90LXQvdC40Y8g0L/QvtC70LXQuQ0KICAgICAgICBjaGVja05vbkVtcHR5Q29sdW1ucyhyb3csIHJvdy5nZXRJbmRleCgpLCBub25FbXB0eUNvbHVtbnMsIGxvZ2dlciwgdHJ1ZSkNCg0KICAgICAgICAvLyAyLiDQn9GA0L7QstC10YDQutCwINGD0L3QuNC60LDQu9GM0L3QvtGB0YLQuCDQt9C90LDRh9C10L3QuNGPINC/0L7Qu9GPIDINCiAgICAgICAgaWYgKHJvdy5jb2RlKSB7DQogICAgICAgICAgICBkZWYgY29kZSA9IGdldFJlZkJvb2tWYWx1ZSgyOCwgcm93LmNvZGUpPy5DT0RFLnZhbHVlDQogICAgICAgICAgICBpZiAoY29kZU1hcFtjb2RlXSA9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgY29kZU1hcFtjb2RlXSA9IFtdDQogICAgICAgICAgICB9DQogICAgICAgICAgICBjb2RlTWFwW2NvZGVdLmFkZChyb3cpDQogICAgICAgIH0NCg0KICAgICAgICAvLyAzLiDQn9GA0L7QstC10YDQutCwINGB0YPQvNC80Ysg0L7RgtC60LvQvtC90LXQvdC40LkNCiAgICAgICAgaWYgKHJvdy5zdW0gIT0gbnVsbCAmJiAhKHJvdy5zdW0gPiBCaWdEZWNpbWFsLlpFUk8pKSB7DQogICAgICAgICAgICBsb2dnZXIuZXJyb3IoItCh0YLRgNC+0LrQsCAke3Jvdy5nZXRJbmRleCgpfTog0JfQvdCw0YfQtdC90LjQtSDQs9GA0LDRhNGLIMKrJHtnZXRDb2x1bW5OYW1lKHJvdywgJ3N1bScpfcK7INC00L7Qu9C20L3QviDQsdGL0YLRjCDQsdC+0LvRjNGI0LUgwqswwrshIikNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIC8vIDIuINCf0YDQvtCy0LXRgNC60LAg0YPQvdC40LrQsNC70YzQvdC+0YHRgtC4INC30L3QsNGH0LXQvdC40Y8g0L/QvtC70Y8gMg0KICAgIGNvZGVNYXAuZWFjaCB7IGNvZGUsIHJvd3MgLT4NCiAgICAgICAgaWYgKHJvd3Muc2l6ZSgpID4gMSkgew0KICAgICAgICAgICAgZGVmIHJvd051bWJlcnMgPSByb3dzLmNvbGxlY3QgeyBpdC5nZXRJbmRleCgpIH0uam9pbignLCAnKQ0KICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCLQodGC0YDQvtC60LAgJHJvd051bWJlcnM6INCX0L3QsNGH0LXQvdC40LUg0LPRgNCw0YTRiyDCqyR7Z2V0Q29sdW1uTmFtZShyb3dzWzBdLCAnY29kZScpfcK7INC90LUg0YPQvdC40LrQsNC70YzQvdC+ISIpDQogICAgICAgIH0NCiAgICB9DQp9DQoNCi8vINCh0L7RgNGC0LjRgNC+0LLQutCwINCz0YDRg9C/0L8g0Lgg0YHRgtGA0L7Qug0Kdm9pZCBzb3J0Rm9ybURhdGFSb3dzKCkgew0KICAgIGRlZiBkYXRhUm93SGVscGVyID0gZm9ybURhdGFTZXJ2aWNlLmdldERhdGFSb3dIZWxwZXIoZm9ybURhdGEpDQogICAgZGVmIGRhdGFSb3dzID0gZGF0YVJvd0hlbHBlci5hbGxDYWNoZWQNCiAgICBzb3J0Um93cyhyZWZCb29rU2VydmljZSwgbG9nZ2VyLCBkYXRhUm93cywgbnVsbCwgbnVsbCwgbnVsbCkNCiAgICBkYXRhUm93SGVscGVyLnNhdmVTb3J0KCkNCn0NCg0Kdm9pZCBpbXBvcnREYXRhKCkgew0KICAgIGRlZiB0bXBSb3cgPSBmb3JtRGF0YS5jcmVhdGVEYXRhUm93KCkNCiAgICBpbnQgQ09MVU1OX0NPVU5UID0gNQ0KICAgIGludCBIRUFERVJfUk9XX0NPVU5UID0gMw0KICAgIFN0cmluZyBUQUJMRV9TVEFSVF9WQUxVRSA9IGdldENvbHVtbk5hbWUodG1wUm93LCAncm93TnVtJykNCiAgICBTdHJpbmcgVEFCTEVfRU5EX1ZBTFVFID0gbnVsbA0KDQogICAgZGVmIGFsbFZhbHVlcyA9IFtdICAgICAgLy8g0LfQvdCw0YfQtdC90LjRjyDRhNC+0YDQvNGLDQogICAgZGVmIGhlYWRlclZhbHVlcyA9IFtdICAgLy8g0LfQvdCw0YfQtdC90LjRjyDRiNCw0L/QutC4DQogICAgZGVmIHBhcmFtc01hcCA9IFsncm93T2Zmc2V0JyA6IDAsICdjb2xPZmZzZXQnIDogMF0gIC8vINC80LDQv9CwINGBINC/0LDRgNCw0LzQtdGC0YDQsNC80LggKNC+0YLRgdGC0YPQv9GLINGB0LLQtdGA0YXRgyDQuCDRgdC70LXQstCwKQ0KDQogICAgY2hlY2tBbmRSZWFkRmlsZShJbXBvcnRJbnB1dFN0cmVhbSwgVXBsb2FkRmlsZU5hbWUsIGFsbFZhbHVlcywgaGVhZGVyVmFsdWVzLCBUQUJMRV9TVEFSVF9WQUxVRSwgVEFCTEVfRU5EX1ZBTFVFLCBIRUFERVJfUk9XX0NPVU5ULCBwYXJhbXNNYXApDQoNCiAgICAvLyDQv9GA0L7QstC10YDQutCwINGI0LDQv9C60LgNCiAgICBjaGVja0hlYWRlclhscyhoZWFkZXJWYWx1ZXMsIENPTFVNTl9DT1VOVCwgSEVBREVSX1JPV19DT1VOVCwgdG1wUm93KQ0KICAgIGlmIChsb2dnZXIuY29udGFpbnNMZXZlbChMb2dMZXZlbC5FUlJPUikpIHsNCiAgICAgICAgcmV0dXJuDQogICAgfQ0KICAgIC8vINC+0YHQstC+0LHQvtC20LTQtdC90LjQtSDRgNC10YHRg9GA0YHQvtCyINC00LvRjyDRjdC60L7QvdC+0LzQuNC4INC/0LDQvNGP0YLQuA0KICAgIGhlYWRlclZhbHVlcy5jbGVhcigpDQogICAgaGVhZGVyVmFsdWVzID0gbnVsbA0KDQogICAgZGVmIGZpbGVSb3dJbmRleCA9IHBhcmFtc01hcC5yb3dPZmZzZXQNCiAgICBkZWYgY29sT2Zmc2V0ID0gcGFyYW1zTWFwLmNvbE9mZnNldA0KICAgIHBhcmFtc01hcC5jbGVhcigpDQogICAgcGFyYW1zTWFwID0gbnVsbA0KDQogICAgZGVmIHJvd0luZGV4ID0gMA0KICAgIGRlZiByb3dzID0gW10NCiAgICBkZWYgYWxsVmFsdWVzQ291bnQgPSBhbGxWYWx1ZXMuc2l6ZSgpDQoNCiAgICAvLyDRhNC+0YDQvNC40YDQvtCy0LDQvdC40LUg0YHRgtGA0L7QuiDQvdGEDQogICAgZm9yIChkZWYgaSA9IDA7IGkgPCBhbGxWYWx1ZXNDb3VudDsgaSsrKSB7DQogICAgICAgIHJvd1ZhbHVlcyA9IGFsbFZhbHVlc1swXQ0KICAgICAgICBmaWxlUm93SW5kZXgrKw0KICAgICAgICAvLyDQstGB0LUg0YHRgtGA0L7QutC4INC/0YPRgdGC0YvQtSAtINCy0YvRhdC+0LQNCiAgICAgICAgaWYgKCFyb3dWYWx1ZXMpIHsNCiAgICAgICAgICAgIGFsbFZhbHVlcy5yZW1vdmUocm93VmFsdWVzKQ0KICAgICAgICAgICAgcm93VmFsdWVzLmNsZWFyKCkNCiAgICAgICAgICAgIGJyZWFrDQogICAgICAgIH0NCiAgICAgICAgLy8g0L/RgNC+0YHRgtCw0Y8g0YHRgtGA0L7QutCwDQogICAgICAgIHJvd0luZGV4KysNCiAgICAgICAgZGVmIG5ld1JvdyA9IGdldE5ld1Jvd0Zyb21YbHMocm93VmFsdWVzLCBjb2xPZmZzZXQsIGZpbGVSb3dJbmRleCwgcm93SW5kZXgpDQogICAgICAgIHJvd3MuYWRkKG5ld1JvdykNCiAgICAgICAgLy8g0L7RgdCy0L7QsdC+0LTQuNGC0Ywg0L3QtdC90YPQttC90YvQtSDQtNCw0L3QvdGL0LUgLSDQuNC90LDRh9C1INC90LUg0YXQstCw0YLQuNGCINC/0LDQvNGP0YLQuA0KICAgICAgICBhbGxWYWx1ZXMucmVtb3ZlKHJvd1ZhbHVlcykNCiAgICAgICAgcm93VmFsdWVzLmNsZWFyKCkNCiAgICB9DQoNCiAgICBzaG93TWVzc2FnZXMocm93cywgbG9nZ2VyKQ0KICAgIGlmICghbG9nZ2VyLmNvbnRhaW5zTGV2ZWwoTG9nTGV2ZWwuRVJST1IpKSB7DQogICAgICAgIGZvcm1EYXRhU2VydmljZS5nZXREYXRhUm93SGVscGVyKGZvcm1EYXRhKS5hbGxDYWNoZWQgPSByb3dzDQogICAgfQ0KfQ0KDQovKioNCiAqINCf0YDQvtCy0LXRgNC40YLRjCDRiNCw0L/QutGDINGC0LDQsdC70LjRhtGLDQogKg0KICogQHBhcmFtIGhlYWRlclJvd3Mg0YHRgtGA0L7QutC4INGI0LDQv9C60LgNCiAqIEBwYXJhbSBjb2xDb3VudCDQutC+0LvQuNGH0LXRgdGC0LLQviDQutC+0LvQvtC90L7QuiDQsiDRgtCw0LHQu9C40YbQtQ0KICogQHBhcmFtIHJvd0NvdW50INC60L7Qu9C40YfQtdGB0YLQstC+INGB0YLRgNC+0Log0LIg0YLQsNCx0LvQuNGG0LUNCiAqIEBwYXJhbSB0bXBSb3cg0LLRgdC/0L7QvNC+0LPQsNGC0LXQu9GM0L3QsNGPINGB0YLRgNC+0LrQsCDQtNC70Y8g0L/QvtC70YPRh9C10L3QuNGPINC90LDQt9Cy0LDQvdC40Lgg0LPRgNCw0YTQvtCyDQogKi8NCnZvaWQgY2hlY2tIZWFkZXJYbHMoZGVmIGhlYWRlclJvd3MsIGRlZiBjb2xDb3VudCwgcm93Q291bnQsIGRlZiB0bXBSb3cpIHsNCiAgICBpZiAoaGVhZGVyUm93cy5pc0VtcHR5KCkpIHsNCiAgICAgICAgdGhyb3cgbmV3IFNlcnZpY2VFeGNlcHRpb24oV1JPTkdfSEVBREVSX1JPV19TSVpFKQ0KICAgIH0NCiAgICBjaGVja0hlYWRlclNpemUoaGVhZGVyUm93c1swXS5zaXplKCksIGhlYWRlclJvd3Muc2l6ZSgpLCBjb2xDb3VudCwgcm93Q291bnQpDQogICAgZGVmIGhlYWRlck1hcHBpbmcgPSBbDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzBdWzBdKTogZ2V0Q29sdW1uTmFtZSh0bXBSb3csICdyb3dOdW0nKV0pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1swXVsxXSk6IGdldENvbHVtbk5hbWUodG1wUm93LCAnY29kZScpXSksDQogICAgICAgICAgICAoWyhoZWFkZXJSb3dzWzBdWzJdKTogZ2V0Q29sdW1uTmFtZSh0bXBSb3csICdzeW1ib2wnKV0pLA0KICAgICAgICAgICAgKFsoaGVhZGVyUm93c1swXVszXSk6IGdldENvbHVtbk5hbWUodG1wUm93LCAnc3VtJyldKSwNCiAgICAgICAgICAgIChbKGhlYWRlclJvd3NbMF1bNF0pOiBnZXRDb2x1bW5OYW1lKHRtcFJvdywgJ2V4cGxhbmF0aW9uJyldKSwNCiAgICBdDQogICAgKDEuLjUpLmVhY2ggeyBpbmRleCAtPg0KICAgICAgICBoZWFkZXJNYXBwaW5nLmFkZCgoWyhoZWFkZXJSb3dzWzFdW2luZGV4IC0gMV0pOiBpbmRleC50b1N0cmluZygpXSkpDQogICAgfQ0KICAgIGNoZWNrSGVhZGVyRXF1YWxzKGhlYWRlck1hcHBpbmcsIGxvZ2dlcikNCn0NCg0KLyoqDQogKiDQn9C+0LvRg9GH0LjRgtGMINC90L7QstGD0Y4g0YHRgtGA0L7QutGDINC90YQg0L/QviDQt9C90LDRh9C10L3QuNGP0Lwg0LjQtyDRjdC60YHQtdC70Y8uDQogKg0KICogQHBhcmFtIHZhbHVlcyDRgdC/0LjRgdC+0Log0YHRgtGA0L7QuiDRgdC+INC30L3QsNGH0LXQvdC40Y/QvNC4DQogKiBAcGFyYW0gY29sT2Zmc2V0INC+0YLRgdGC0YPQvyDQsiDQutC+0LvQvtC90LrQsNGFDQogKiBAcGFyYW0gZmlsZVJvd0luZGV4INC90L7QvNC10YAg0YHRgtGA0L7QutC4INCyINGC0YQNCiAqIEBwYXJhbSByb3dJbmRleCDRgdGC0YDQvtC60LAg0LIg0L3RhA0KICovDQpkZWYgZ2V0TmV3Um93RnJvbVhscyhkZWYgdmFsdWVzLCBkZWYgY29sT2Zmc2V0LCBkZWYgZmlsZVJvd0luZGV4LCBkZWYgcm93SW5kZXgpIHsNCiAgICBkZWYgbmV3Um93ID0gZ2V0TmV3Um93KCkNCiAgICBuZXdSb3cuc2V0SW5kZXgocm93SW5kZXgpDQogICAgbmV3Um93LnNldEltcG9ydEluZGV4KGZpbGVSb3dJbmRleCkNCiAgICBkZWYgY29sSW5kZXgNCg0KICAgIC8vINCz0YDQsNGE0LAgMiAtIGNvZGUgICAgICAgLSDQsNGC0YDQuNCx0YPRgiAxNDAgLSBDT0RFLCDRgdC/0YDQsNCy0L7Rh9C90LjQuiAyOA0KICAgIC8vINCz0YDQsNGE0LAgMyAtIHN5bWJvbCAgICAgICAtINC30LDQstC40YHQuNGCINC+0YIg0LPRgNCw0YTRiyAyIC0g0LDRgtGA0LjQsdGD0YIgMTQ0IC0gT1BVLCDRgdC/0YDQsNCy0L7Rh9C90LjQuiAyOA0KDQogICAgLy8g0LPRgNCw0YTQsCAyDQogICAgY29sSW5kZXggPSAyDQogICAgZGVmIG1hcCA9IGdldFJlY29yZEltcG9ydCgyOEwsICdDT0RFJywgdmFsdWVzW2NvbEluZGV4XSwgZmlsZVJvd0luZGV4LCBjb2xJbmRleCArIGNvbE9mZnNldCwgZmFsc2UpDQogICAgbmV3Um93LmNvZGUgPSBtYXA/LnJlY29yZF9pZD8udmFsdWUNCg0KICAgIC8vINCz0YDQsNGE0LAgMw0KICAgIGNvbEluZGV4ID0gMw0KICAgIGlmIChtYXAgIT0gbnVsbCkgew0KICAgICAgICBmb3JtRGF0YVNlcnZpY2UuY2hlY2tSZWZlcmVuY2VWYWx1ZSgyOCwgdmFsdWVzW2NvbEluZGV4XSwgbWFwLk9QVT8uc3RyaW5nVmFsdWUsIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQsIGxvZ2dlciwgZmFsc2UpDQogICAgfQ0KDQogICAgLy8g0LPRgNCw0YTQsCA0DQogICAgY29sSW5kZXggPSA0DQogICAgbmV3Um93LnN1bSA9IHBhcnNlTnVtYmVyKHZhbHVlc1tjb2xJbmRleF0sIGZpbGVSb3dJbmRleCwgY29sSW5kZXggKyBjb2xPZmZzZXQsIGxvZ2dlciwgdHJ1ZSkNCg0KICAgIC8vINCz0YDQsNGE0LAgNQ0KICAgIGNvbEluZGV4ID0gOQ0KICAgIG5ld1Jvdy5leHBsYW5hdGlvbiA9IHZhbHVlc1tjb2xJbmRleF0NCg0KICAgIHJldHVybiBuZXdSb3cNCn0='

        addLongText(form_template_id, longString, 'SCRIPT')
        logger.info("К версии макета добавлен скрипт")
    }

} catch (Exception ex) {
    logger.error("Error: ${ex.getLocalizedMessage()}. Все изменения откатаны")
}

def void addTypeTemplate(FormType formType, FormTemplate formTemplate, boolean createType, boolean createTemplate) {
    def form_type_id = formType.id ?: ""
    def form_type_name = formType.name ?: ""
    def form_type_tax_type = formType.taxType.code ?: ""
    def form_type_is_ifrs = formType.isIfrs ? 1 : 0
    def form_type_ifrs_name = formType.ifrsName ?: ""
    def form_type_ifrs_code = formType.code ?: ""

    def form_template_id = formTemplate.id ?: ""
    def form_template_is_fixed_rows = formTemplate.isFixedRows() ? 1 : 0
    def form_template_name = formTemplate.name ?: ""
    def form_template_fullname = formTemplate.fullName ?: ""
    def form_template_version = formTemplate.version.format("dd.MM.yy")
    def form_template_monthly = formTemplate.isMonthly() ? 1 : 0
    def form_template_comparative = formTemplate.isComparative() ? 1 : 0
    def form_template_header = formTemplate.header ?: ""
    def form_template_accruing = formTemplate.isAccruing() ? 1 : 0
    def form_template_updating = formTemplate.isUpdating() ? 1 : 0

    String formTypeSql = "INSERT INTO FORM_TYPE (ID, NAME, TAX_TYPE, STATUS, IS_IFRS, IFRS_NAME, CODE) VALUES " +
            "('$form_type_id', '$form_type_name', '$form_type_tax_type', '0', '$form_type_is_ifrs', '$form_type_ifrs_name', '$form_type_ifrs_code')"
    if (createType) {
        namedParameterJdbcTemplate.update(formTypeSql, [:])
        logger.info("Создан тип НФ с id = $form_type_id без версии макета, колонок, стилей, заголовка, фиксированных строк и скрипта")
    }

    String formTemplateSql = "INSERT INTO FORM_TEMPLATE (ID, TYPE_ID, FIXED_ROWS, NAME, FULLNAME, VERSION, STATUS, MONTHLY, HEADER, COMPARATIVE, ACCRUING, UPDATING) VALUES " +
            "($form_template_id, '$form_type_id', '$form_template_is_fixed_rows', '$form_template_name', '$form_template_fullname', TO_DATE('$form_template_version', 'DD.MM.RR'), '1', '$form_template_monthly', '$form_template_header', '$form_template_comparative', '$form_template_accruing', '$form_template_updating')"
    if (createTemplate) {
        namedParameterJdbcTemplate.update(formTemplateSql, [:])
        logger.info("Создан тип НФ с id = $form_template_id для версии макета с id = $form_type_id, но без колонок, стилей, заголовка, фиксированных строк и скрипта")
    }
}

def void addLongText (def form_template_id, String longString, String alias) {
    final int MAX_LENGTH = 2000
    namedParameterJdbcTemplate.update("UPDATE FORM_TEMPLATE SET $alias = null where id = $form_template_id", [:])
    int start = 0
    longString = new String(longString.decodeBase64(), "UTF-8")
    while (start < longString.length()) {
        int end = (start + MAX_LENGTH) < longString.length() ? (start + MAX_LENGTH) : longString.length()
        String text = longString.substring(start, end)
       namedParameterJdbcTemplate.update('UPDATE FORM_TEMPLATE SET ' + alias + ' = ' + alias + ' || :text where id = ' +form_template_id, ['text' : text])
        start += MAX_LENGTH
    }
}