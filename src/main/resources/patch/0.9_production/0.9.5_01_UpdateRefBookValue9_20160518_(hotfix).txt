/*
Изменения для атрибута "Наименования организации" в справочнике "Организации-участники контролируемых сделок"
1. Преобразование кавычек-елочек к машинописным
2. Устранение лишних пробелов
*/
import javax.sql.DataSource

try {
		def connection = dataSource.connection
		def stmt = connection.createStatement()
		
		def diagQuery = stmt.executeQuery("""
						select record_id, string_value from ref_book_value where attribute_id = 32 and (string_value <> trim (string_value) or string_value <> translate(string_value, '«»', '""'))
						""")
	  	while (diagQuery.next()) {
		  logger.info("record_id = ${diagQuery.getInt(1)}; name = '${diagQuery.getString(2)}'" 
					 )
	  	}
		
		def result = stmt.executeUpdate("""			
					update ref_book_value set string_value = translate(string_value, '«»', '""') where attribute_id = 32 and translate(string_value, '«»', '""') <> string_value
				""")
				
		logger.info("Translate quotes: ${result} row(s) updated") 
		
		result = stmt.executeUpdate("""			
					update ref_book_value set string_value = trim(string_value) where attribute_id = 32 and trim(string_value) <> string_value
				""")
		logger.info("Trim: ${result} row(s) updated") 		
		
	    connection.close()		
	  	}		
												
catch (Exception ex) {
		logger.error("Ошибка: ${ex}")
	}
