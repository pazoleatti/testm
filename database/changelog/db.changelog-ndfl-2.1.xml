<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<changeSet id="ndfl-2.1-rnurgaleev-1" author="rnurgaleev">
        <modifyDataType
			tableName="notification"
            columnName="id"
            newDataType="number(18)"
            />
    </changeSet>
		
	<changeSet id="ndfl-2.1-rnurgaleev-2" author="rnurgaleev">
		<createTable 
            remarks="Настройки задач планировщика"
            tableName="configuration_scheduler">
			<column name="id" type="number(9)" remarks="Идентификатор задачи">
				<constraints nullable="false"/>
			</column>
			<column name="task_name" type="varchar2(200 char)" remarks="Название">
				<constraints nullable="false"/>
			</column>
			<column name="schedule" type="varchar2(100 char)" remarks="Расписание">
			</column>
			<column name="active" type="number(1)" remarks="Признак активности">
				<constraints nullable="false"/>
			</column>
			<column name="modification_date" type="date" remarks="Дата редактирования">
				<constraints nullable="false"/>
			</column>
			<column name="last_fire_date" type="date" remarks="Дата последнего запуска">
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-3" author="rnurgaleev">
		<createTable 
            remarks="Параметры задач планировщика"
            tableName="configuration_scheduler_param">
			<column name="id" type="number(9)" remarks="Идентификатор параметра">
				<constraints nullable="false"/>
			</column>
			<column name="param_name" type="varchar2(200 char)">
				<constraints nullable="false"/>
			</column>
			<column name="task_id" type="number(9)" remarks="Ссылка на задачу планировщика">
				<constraints nullable="false"/>
			</column>
			<column name="ord" type="number(9)" remarks="Порядок следования">
				<constraints nullable="false"/>
			</column>
			<column name="type" type="number(1)" remarks="Тип параметра(1 - Строка, 2 - Целое число, 3 - Число с плавающей запятой)">
				<constraints nullable="false"/>
			</column>
			<column name="value" type="varchar2(200 char)" remarks="Значение">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="ndfl-2.1-rnurgaleev-4" author="rnurgaleev">
		<createTable 
            remarks="Асинхронные задачи"
            tableName="async_task">
			<column name="id" type="number(18)" remarks="Идентификатор задачи">
				<constraints nullable="false"/>
			</column>
			<column name="type_id" type="number(18)" remarks="Ссылка на тип задачи">
				<constraints nullable="false"/>
			</column>
			<column name="create_date" type="timestamp" remarks="Дата создания задачи" defaultValueComputed="CURRENT_TIMESTAMP">
			</column>
			<column name="start_process_date" type="timestamp" remarks="Дата начала выполнения задачи">
			</column>
			<column name="node" type="varchar2(500)" remarks="Название узла, на котором выполняется задача">
			</column>
			<column name="balancing_variant" type="number(1)" remarks="Тип очереди, в которую помещена задача. 1 - короткие, 2 - длинные">
				<constraints nullable="false"/>
			</column>
			<column name="serialized_params" type="blob" remarks="Сериализованные параметры, которые нужны для выполнения задачи">
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-5" author="rnurgaleev">
		<createTable 
            tableName="decl_template_event_script">
			<column name="id" type="number(19)">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_decl_template_event_script"/>
			</column>
			<column name="declaration_template_id" type="number(19)">
				<constraints nullable="false" foreignKeyName="fk_dec_temp_event_scr_dec_temp" references="declaration_template(id)"/>
			</column>
			<column name="event_id" type="number(19)">
				<constraints nullable="false" foreignKeyName="fk_dec_temp_event_id" references="event(id)"/>
			</column>
			<column name="script" type="clob">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-6" author="rnurgaleev">
		<addUniqueConstraint tableName="decl_template_event_script"
                             columnNames="declaration_template_id, event_id"
                             constraintName="uc_dec_temp_even_dec_temp_even"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-7" author="rnurgaleev">
		<addPrimaryKey 
            columnNames="id"
            constraintName="CONF_SCHEDULER_PK"
            tableName="configuration_scheduler"/>
	</changeSet>

	<changeSet id="ndfl-2.1-rnurgaleev-8" author="rnurgaleev">
		<addPrimaryKey 
            columnNames="id"
            constraintName="CONF_SCHEDULER_PARAM_PK"
            tableName="configuration_scheduler_param"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-9" author="rnurgaleev">
		<addPrimaryKey 
            columnNames="id"
            constraintName="ASYNC_TASK_PK"
            tableName="async_task"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-10" author="rnurgaleev">
		<addForeignKeyConstraint baseColumnNames="task_id"
            baseTableName="configuration_scheduler_param"
            constraintName="conf_scheduler_param_fk_conf"
            onDelete="CASCADE"
            referencedColumnNames="id"
            referencedTableName="configuration_scheduler"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-11" author="rnurgaleev">
		<addForeignKeyConstraint baseColumnNames="type_id"
            baseTableName="async_task"
            constraintName="async_task_fk_type"
            referencedColumnNames="id"
            referencedTableName="async_task_type"/>
	</changeSet>

	<changeSet id="ndfl-2.1-rnurgaleev-12" author="rnurgaleev">
        <sql>
            alter table configuration_scheduler add constraint conf_scheduler_chk_active check(active in (0, 1));
        </sql>
    </changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-13" author="rnurgaleev">
        <sql>
            alter table configuration_scheduler_param add constraint conf_scheduler_param_chk_type check(type in (1, 2, 3));
        </sql>
    </changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-14" author="rnurgaleev">
		<dropColumn
            columnName="dev_mode"
            tableName="async_task_type"/>
	</changeSet>

	<changeSet id="ndfl-2.1-rnurgaleev-15" author="rnurgaleev">
		<renameColumn
            newColumnName="handler_bean"
            oldColumnName="handler_jndi"
            remarks="Имя spring бина-обработчика задачи"
            tableName="async_task_type"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-16" author="rnurgaleev">
		<addColumn
            tableName="configuration">
			<column name="value2" type="varchar2(2048 char)"/>
		</addColumn>
	</changeSet>

	<changeSet id="ndfl-2.1-rnurgaleev-17" author="rnurgaleev">
		<sql>
            update configuration set value2=value;
        </sql>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-18" author="rnurgaleev">
		<dropColumn
            columnName="value"
            tableName="configuration"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-19" author="rnurgaleev">
		<renameColumn
            newColumnName="value"
            oldColumnName="value2"
            tableName="configuration"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-20" author="rnurgaleev">
        <modifyDataType
			tableName="declaration_type"
            columnName="id"
            newDataType="number(18)"
            />
    </changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-21" author="rnurgaleev">
        <modifyDataType
			tableName="department_declaration_type"
            columnName="DECLARATION_TYPE_ID"
            newDataType="number(18)"
            />
    </changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-22" author="rnurgaleev">
        <modifyDataType
			tableName="declaration_template"
            columnName="DECLARATION_TYPE_ID"
            newDataType="number(18)"
            />
    </changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-23" author="rnurgaleev">
        <modifyDataType
			tableName="ref_book_asnu"
            columnName="id"
            newDataType="number(18)"
            />
    </changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-24" author="rnurgaleev">
		<sql splitStatements="false">
			begin
				for rec in (select table_name from user_tables where table_name like 'RASCHSV_%')
				loop
					for rec2 in (select constraint_name from user_constraints WHERE table_name=rec.table_name and constraint_type='R')
					loop
						execute immediate 'ALTER TABLE '||rec.table_name||' DROP CONSTRAINT '||rec2.constraint_name;
					end loop;
				end loop;
				
				for rec in (select table_name from user_tables where table_name like 'RASCHSV_%')
				loop
					execute immediate 'DROP TABLE '||rec.table_name;
				end loop;
			end;
        </sql>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-25" author="rnurgaleev">
		<sql splitStatements="false">
			begin
				for rec in (select constraint_name from user_constraints where constraint_type='P' and table_name like 'FORM_%')
				loop
					for rec2 in (select constraint_name, table_name from user_constraints WHERE r_constraint_name=rec.constraint_name and constraint_type='R')
					loop
						execute immediate 'ALTER TABLE '||rec2.table_name||' DROP CONSTRAINT '||rec2.constraint_name;
					end loop;
				end loop;

				for rec in (select table_name from user_tables where table_name like 'FORM_%')
				loop
					execute immediate 'DROP TABLE '||rec.table_name;
				end loop;
			end;
        </sql>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-26" author="rnurgaleev">
		<dropTable cascadeConstraints="true"
            tableName="IFRS_DATA"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-27" author="rnurgaleev">
		<dropTable cascadeConstraints="true"
            tableName="DEPARTMENT_CHANGE"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-28" author="rnurgaleev">
		<createSequence
            incrementBy="100"
            sequenceName="seq_async_task"
            startValue="100000"/>
	</changeSet>

	<changeSet id="ndfl-2.1-rnurgaleev-29" author="rnurgaleev">
		<createSequence
            incrementBy="1"
            sequenceName="seq_decl_template_event_script"
            startValue="1"/>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-30" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
				 endDelimiter=""
                 path="/scripts/DEP_REP_PER_BEFORE_DELETE.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-31" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
				 endDelimiter=""
                 path="/scripts/DEP_REP_PER_BEFORE_INS_UPD.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-32" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
				 endDelimiter=""
                 path="/scripts/person_pkg.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>		
	
	<changeSet id="ndfl-2.1-rnurgaleev-33" author="rnurgaleev">
		<delete
            tableName="ref_book_attribute">
			<where>ref_book_id in (select id from ref_book where table_name in ('REF_BOOK_FOND','REF_BOOK_FOND_DETAIL'))</where>
		</delete>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-34" author="rnurgaleev">
		<delete
            tableName="ref_book">
			<where>table_name in ('REF_BOOK_FOND','REF_BOOK_FOND_DETAIL')</where>
		</delete>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-35" author="rnurgaleev">
		<delete
            tableName="report_period">
			<where>tax_period_id in (select id from tax_period where tax_type='F')</where>
		</delete>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-36" author="rnurgaleev">
		<delete
            tableName="tax_period">
			<where>tax_type='F'</where>
		</delete>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-37" author="rnurgaleev">
		<delete
            tableName="tax_type">
			<where>id='F'</where>
		</delete>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-38" author="rnurgaleev">
		<delete
            tableName="async_task_type">
			<where>id in (103, 104, 105, 106, 107, 110, 111, 112, 113, 114, 115, 123, 124, 125, 126, 127, 128, 129)</where>
		</delete>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-39" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="XlsxGeneratorAsyncTask"/>
			<where>id = 5</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-40" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="XmlGeneratorAsyncTask"/>
			<where>id = 6</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-41" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="PdfGeneratorAsyncTask"/>
			<where>id = 7</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-42" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="CsvAuditArchiveGeneratorAsyncTask"/>
			<where>id = 10</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-43" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="CsvAuditGeneratorAsyncTask"/>
			<where>id = 11</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-44" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="LoadAllTransportDataAsyncTask"/>
			<where>id = 13</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-45" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="CheckDeclarationAsyncTask"/>
			<where>id = 14</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-46" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="AcceptDeclarationAsyncTask"/>
			<where>id = 15</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-47" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="ExcelReportRefBookAsyncTask"/>
			<where>id = 23</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-48" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="CsvReportRefBookAsyncTask"/>
			<where>id = 24</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-49" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="SpecificReportRefBookAsyncTask"/>
			<where>id = 25</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-50" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="SpecificReportDeclarationDataAsyncTask"/>
			<where>id = 26</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-51" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="UploadRefBookAsyncTask"/>
			<where>id = 27</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-52" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="CreateFormsAsyncTask"/>
			<where>id = 28</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-53" author="rnurgaleev">
		<update
            tableName="async_task_type">
			<column name="handler_bean" value="CreateReportsAsyncTask"/>
			<where>id = 29</where>
		</update>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-54" author="rnurgaleev">
		<insert tableName="CONFIGURATION_SCHEDULER">
            <column name="id" value="1"/>
            <column name="task_name" value="CLEAR_BLOB_DATA"/>
			<column name="schedule" value="0 15 22 * * ?"/>
			<column name="active" value="1"/>
			<column name="modification_date" valueDate="sysdate"/>
			<column name="last_fire_date" valueDate="sysdate"/>
        </insert>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-55" author="rnurgaleev">
		<insert tableName="CONFIGURATION_SCHEDULER">
            <column name="id" value="2"/>
            <column name="task_name" value="CLEAR_LOCK_DATA"/>
			<column name="schedule" value="0 10 22 * * ?"/>
			<column name="active" value="1"/>
			<column name="modification_date" valueDate="sysdate"/>
			<column name="last_fire_date" valueDate="sysdate"/>
        </insert>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-56" author="rnurgaleev">
		<insert tableName="CONFIGURATION_SCHEDULER">
            <column name="id" value="3"/>
            <column name="task_name" value="CLEAR_TEMP_DIR"/>
			<column name="schedule" value="0 5 22 * * ?"/>
			<column name="active" value="1"/>
			<column name="modification_date" valueDate="sysdate"/>
			<column name="last_fire_date" valueDate="sysdate"/>
        </insert>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-57" author="rnurgaleev">
		<insert tableName="CONFIGURATION_SCHEDULER">
            <column name="id" value="4"/>
            <column name="task_name" value="ASYNC_TASK_MONITORING"/>
			<column name="schedule" value="0/5 * * * * ?"/>
			<column name="active" value="1"/>
			<column name="modification_date" valueDate="sysdate"/>
			<column name="last_fire_date" valueDate="sysdate"/>
        </insert>
	</changeSet>
	
	<changeSet id="ndfl-2.1-rnurgaleev-58" author="rnurgaleev">
		<insert tableName="configuration_scheduler_param">
            <column name="id" value="20"/>
            <column name="param_name" value="Время жизни блокировки (секунд)"/>
			<column name="task_id" value="2"/>
			<column name="ord" value="1"/>
			<column name="type" value="2"/>
			<column name="value" value="172800"/>
        </insert>
	</changeSet>
</databaseChangeLog>