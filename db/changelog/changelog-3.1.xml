<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="3.1-dnovikov-1" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 102</where>
        </update>
    </changeSet>
    <changeSet id="3.1-dnovikov-2" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 104</where>
        </update>
    </changeSet>

    <changeSet id="3.1-dnovikov-3" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>declaration_type_id = 103</where>
        </update>
    </changeSet>

    <changeSet id="3.1-dnovikov-4" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>declaration_type_id = 103</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-0" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.1/refbook/declaration_type.groovy"/>
            <where>id in (select script_id from ref_book r where r.id = 207)</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-1" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <changeSet id="3.1-dnovikov-5" author="dnovikov">
        <update tableName="async_task_type">
            <column name="name" value="Формирование уведомления о задолженности"/>
            <where>id = 35</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-2" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-4982 Уведомление об отсутствии пары КПП/ОКТМО в справочнике "Настройки подразделений" -->
	<changeSet id="3.1-rnurgaleev-0" author="rnurgaleev">
        <sql>
            update ref_book_ndfl_detail a set oktmo=(select max(id) from ref_book_oktmo where code=(select code from ref_book_oktmo where id=a.oktmo) and status=0)
			where oktmo in (select id from ref_book_oktmo where status=2);
        </sql>
    </changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-4947 "Дата окончания актуальности" для "Кодов видов вычета" = 221 не соответствует постановке -->
	<changeSet id="3.1-rnurgaleev-1" author="rnurgaleev">
        <sql>
			update ref_book_deduction_type set version=to_date('26.12.16','DD.MM.YY')
			where code in ('221')
			and version=to_date('25.12.16','DD.MM.YY');
		</sql>
    </changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-4984 Уведомление об отсутствии пары "Код дохода"/"Признак дохода" в справочнике "Виды дохода" -->
	<changeSet id="3.1-rnurgaleev-2" author="rnurgaleev">
        <sql>
			merge into ref_book_income_kind a using
			(select (select id from (select id,version from ref_book_income_type where code='1011' and status=0 order by version desc) where rownum=1) as income_type_id,
			'00' as mark, '-' as name,
			to_date('01.01.2017','DD.MM.YYYY') as version from dual
			) b
			on (a.income_type_id=b.income_type_id and a.mark=b.mark)
			when not matched then
			insert (id, income_type_id, mark, name, version, record_id)
			values (seq_ref_book_record.nextval, b.income_type_id, b.mark, b.name, b.version, seq_ref_book_record.nextval);
		</sql>
    </changeSet>

    <changeSet id="3.1-ytrofimov-3" author="ytrofimov">
        <sql>
            update ref_book_attribute set visible = 1 where ref_book_id = 902 and lower(alias) = 'duplicate_record_id'
        </sql>
    </changeSet>
    <changeSet id="3.1-apronin-1" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 106</where>
        </update>
    </changeSet>

    <!-- ВНИМАНИЕ  changeSet id="3.1-ytrofimov-4" не добавлять в патч!!!-->
    <changeSet id="3.1-ytrofimov-4" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/report.jrxml"/>
            <where>id in (select jrxml from declaration_template dt where dt.id = 101)</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-2" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 106</where>
        </update>
    </changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-5066 Изучить причины высокого потребления памяти СУБД при консолидации НФ -->
	<changeSet id="3.1-rnurgaleev-3" author="rnurgaleev">
        <sql>
			create global temporary table tmp_cons_data(
				operation_id varchar2(100 char),
				asnu_id number(18),
				inp varchar2(25 char),
				year number(4),
				period_code varchar2(2 char),
				correction_date date)
			on commit delete rows;
		</sql>
    </changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-4984 Уведомление об отсутствии пары "Код дохода"/"Признак дохода" в справочнике "Виды дохода" -->
	<changeSet id="3.1-rnurgaleev-4" author="rnurgaleev">
        <sql>
			update ref_book_income_kind b
				set record_id=(select max(record_id) from ref_book_income_kind a
					where exists(select 1 from ref_book_income_type where id=a.income_type_id and code='1011')
					and a.version=to_date('01.01.2016','DD.MM.YYYY')
					and a.mark='00' and a.status=0)
			where exists(select 1 from ref_book_income_type where id=b.income_type_id and code='1011') and b.version=to_date('01.01.2017','DD.MM.YYYY')
			and b.mark='00' and b.status=0;
		</sql>
    </changeSet>

    <changeSet id="3.1-dnovikov-6" author="dnovikov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-3" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 104</where>
        </update>
    </changeSet>
    <changeSet id="3.1-apronin-4" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 106</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-5" author="apronin">
        <insert tableName="blob_data">
            <column name="id" value="4b85f92c-7fd0-4d67-834d-e61g34684336"/>
            <column name="name" value="report.xlsx"/>
            <column name="data" valueBlobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/report.xlsx"/>
            <column name="creation_date" valueDate="2018-07-10"/>
        </insert>
    </changeSet>

    <changeSet id="3.1-apronin-6" author="apronin">
        <insert tableName="declaration_template_file">
            <column name="DECLARATION_TEMPLATE_ID" value="100"/>
            <column name="BLOB_DATA_ID" value="4b85f92c-7fd0-4d67-834d-e61g34684336"/>
        </insert>
    </changeSet>

    <changeSet id="3.1-apronin-7" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-8" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-9" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-5" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-6" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-7" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-8" author="ytrofimov">
        <insert tableName="declaration_template_file">
            <column name="DECLARATION_TEMPLATE_ID" value="101"/>
            <column name="BLOB_DATA_ID" value="4b85f92c-7fd0-4d67-834d-e61g34684336"/>
        </insert>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 101</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5088 Реализовать изменения в форматах чисел в шаблонах файлов Excel-->
    <changeSet id="3.1-ytrofimov-8" author="ytrofimov">
        <insert tableName="declaration_template_file">
            <column name="DECLARATION_TEMPLATE_ID" value="101"/>
            <column name="BLOB_DATA_ID" value="4b85f92c-7fd0-4d67-834d-e61g34684336"/>
        </insert>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 101</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5088 Реализовать изменения в форматах чисел в шаблонах файлов Excel-->
    <changeSet id="3.1-ytrofimov-9" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="JRXML" value=""/>
            <where>declaration_type_id = 100</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="JRXML" value=""/>
            <where>declaration_type_id = 101</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5088 Реализовать изменения в форматах чисел в шаблонах файлов Excel-->
    <changeSet id="3.1-ytrofimov-10" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 101</where>
        </update>
    </changeSet>


    <changeSet id="3.1-dnovikov-7" author="dnovikov">
        <insert tableName="CONFIGURATION">
            <column name="code" value="REPORT_PERIOD_YEAR_MIN"/>
            <column name="department_id" value="0"/>
            <column name="value" value="2003"/>
        </insert>
    </changeSet>

    <changeSet id="3.1-dnovikov-8" author="dnovikov">
        <insert tableName="CONFIGURATION">
            <column name="code" value="REPORT_PERIOD_YEAR_MAX"/>
            <column name="department_id" value="0"/>
            <column name="value" value="2100"/>
        </insert>
    </changeSet>

    <changeSet id="3.1-ytrofimov-11" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 3</where>
        </update>
    </changeSet>
</databaseChangeLog>