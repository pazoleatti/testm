<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="3.1-dnovikov-1" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 102</where>
        </update>
    </changeSet>
    <changeSet id="3.1-dnovikov-2" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 104</where>
        </update>
    </changeSet>

    <changeSet id="3.1-dnovikov-3" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>declaration_type_id = 103</where>
        </update>
    </changeSet>

    <changeSet id="3.1-dnovikov-4" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>declaration_type_id = 103</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-0" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.1/refbook/declaration_type.groovy"/>
            <where>id in (select script_id from ref_book r where r.id = 207)</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-1" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <changeSet id="3.1-dnovikov-5" author="dnovikov">
        <update tableName="async_task_type">
            <column name="name" value="Формирование уведомления о задолженности"/>
            <where>id = 35</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-2" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-4982 Уведомление об отсутствии пары КПП/ОКТМО в справочнике "Настройки подразделений" -->
	<changeSet id="3.1-rnurgaleev-0" author="rnurgaleev">
        <sql>
            update ref_book_ndfl_detail a set oktmo=(select max(id) from ref_book_oktmo where code=(select code from ref_book_oktmo where id=a.oktmo) and status=0)
			where oktmo in (select id from ref_book_oktmo where status=2);
        </sql>
    </changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-4947 "Дата окончания актуальности" для "Кодов видов вычета" = 221 не соответствует постановке -->
	<changeSet id="3.1-rnurgaleev-1" author="rnurgaleev">
        <sql>
			update ref_book_deduction_type set version=to_date('26.12.16','DD.MM.YY')
			where code in ('221')
			and version=to_date('25.12.16','DD.MM.YY');
		</sql>
    </changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-4984 Уведомление об отсутствии пары "Код дохода"/"Признак дохода" в справочнике "Виды дохода" -->
	<changeSet id="3.1-rnurgaleev-2" author="rnurgaleev">
        <sql>
			merge into ref_book_income_kind a using
			(select (select id from (select id,version from ref_book_income_type where code='1011' and status=0 order by version desc) where rownum=1) as income_type_id,
			'00' as mark, '-' as name,
			to_date('01.01.2017','DD.MM.YYYY') as version from dual
			) b
			on (a.income_type_id=b.income_type_id and a.mark=b.mark)
			when not matched then
			insert (id, income_type_id, mark, name, version, record_id)
			values (seq_ref_book_record.nextval, b.income_type_id, b.mark, b.name, b.version, seq_ref_book_record.nextval);
		</sql>
    </changeSet>

    <changeSet id="3.1-ytrofimov-3" author="ytrofimov">
        <sql>
            update ref_book_attribute set visible = 1 where ref_book_id = 902 and lower(alias) = 'duplicate_record_id'
        </sql>
    </changeSet>
    <changeSet id="3.1-apronin-1" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 106</where>
        </update>
    </changeSet>

    <!-- ВНИМАНИЕ  changeSet id="3.1-ytrofimov-4" не добавлять в патч!!!-->
    <changeSet id="3.1-ytrofimov-4" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/report.jrxml"/>
            <where>id in (select jrxml from declaration_template dt where dt.id = 101)</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-2" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 106</where>
        </update>
    </changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-5066 Изучить причины высокого потребления памяти СУБД при консолидации НФ -->
	<changeSet id="3.1-rnurgaleev-3" author="rnurgaleev">
        <sql>
			create global temporary table tmp_cons_data(
				operation_id varchar2(100 char),
				asnu_id number(18),
				inp varchar2(25 char),
				year number(4),
				period_code varchar2(2 char),
				correction_date date)
			on commit delete rows;
		</sql>
    </changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-4984 Уведомление об отсутствии пары "Код дохода"/"Признак дохода" в справочнике "Виды дохода" -->
	<changeSet id="3.1-rnurgaleev-4" author="rnurgaleev">
        <sql>
			update ref_book_income_kind b
				set record_id=(select max(record_id) from ref_book_income_kind a
					where exists(select 1 from ref_book_income_type where id=a.income_type_id and code='1011')
					and a.version=to_date('01.01.2016','DD.MM.YYYY')
					and a.mark='00' and a.status=0)
			where exists(select 1 from ref_book_income_type where id=b.income_type_id and code='1011') and b.version=to_date('01.01.2017','DD.MM.YYYY')
			and b.mark='00' and b.status=0;
		</sql>
    </changeSet>

    <changeSet id="3.1-dnovikov-6" author="dnovikov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-3" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 104</where>
        </update>
    </changeSet>
    <changeSet id="3.1-apronin-4" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 106</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-5" author="apronin">
        <insert tableName="blob_data">
            <column name="id" value="4b85f92c-7fd0-4d67-834d-e61g34684336"/>
            <column name="name" value="report.xlsx"/>
            <column name="data" valueBlobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/report.xlsx"/>
            <column name="creation_date" valueDate="2018-07-10"/>
        </insert>
    </changeSet>

    <changeSet id="3.1-apronin-6" author="apronin">
        <insert tableName="declaration_template_file">
            <column name="DECLARATION_TEMPLATE_ID" value="100"/>
            <column name="BLOB_DATA_ID" value="4b85f92c-7fd0-4d67-834d-e61g34684336"/>
        </insert>
    </changeSet>

    <changeSet id="3.1-apronin-7" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-8" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.1-apronin-9" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-5" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-6" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-7" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <changeSet id="3.1-ytrofimov-8" author="ytrofimov">
        <insert tableName="declaration_template_file">
            <column name="DECLARATION_TEMPLATE_ID" value="101"/>
            <column name="BLOB_DATA_ID" value="4b85f92c-7fd0-4d67-834d-e61g34684336"/>
        </insert>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 101</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5088 Реализовать изменения в форматах чисел в шаблонах файлов Excel-->
    <changeSet id="3.1-ytrofimov-8" author="ytrofimov">
        <insert tableName="declaration_template_file">
            <column name="DECLARATION_TEMPLATE_ID" value="101"/>
            <column name="BLOB_DATA_ID" value="4b85f92c-7fd0-4d67-834d-e61g34684336"/>
        </insert>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 101</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5088 Реализовать изменения в форматах чисел в шаблонах файлов Excel-->
    <changeSet id="3.1-ytrofimov-9" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="JRXML" value=""/>
            <where>declaration_type_id = 100</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="JRXML" value=""/>
            <where>declaration_type_id = 101</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5088 Реализовать изменения в форматах чисел в шаблонах файлов Excel-->
    <changeSet id="3.1-ytrofimov-10" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 101</where>
        </update>
    </changeSet>


    <changeSet id="3.1-dnovikov-7" author="dnovikov">
        <insert tableName="CONFIGURATION">
            <column name="code" value="REPORT_PERIOD_YEAR_MIN"/>
            <column name="department_id" value="0"/>
            <column name="value" value="2003"/>
        </insert>
    </changeSet>

    <changeSet id="3.1-dnovikov-8" author="dnovikov">
        <insert tableName="CONFIGURATION">
            <column name="code" value="REPORT_PERIOD_YEAR_MAX"/>
            <column name="department_id" value="0"/>
            <column name="value" value="2100"/>
        </insert>
    </changeSet>

    <changeSet id="3.1-ytrofimov-11" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5245 Изменить возможные значения поля format из справочника ref_book_attribute -->
    <changeSet id="3.1-akorobko-0" author="akorobko">
        <sql>
            alter table ref_book_attribute drop constraint REF_BOOK_ATTRIBUTE_CHK_FORMAT;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5245 Изменить возможные значения поля format из справочника ref_book_attribute -->
    <changeSet id="3.1-akorobko-1" author="akorobko">
        <sql>
            alter table ref_book_attribute add constraint REF_BOOK_ATTRIBUTE_CHK_FORMAT CHECK (format in (0,1,2,3,4,5,6,7)) ENABLE;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5245 Изменить возможные значения поля format из справочника ref_book_attribute -->
    <changeSet id="3.1-akorobko-2" author="akorobko">
        <sql>
            comment on column ref_book_attribute.format is 'Формат. (Для дат: 0 - "", 1 - "dd.MM.yyyy", 2 - "MM.yyyy", 3 - "MMMM yyyy", 4 - "yyyy", 5 - "dd.MM", 7 - "dd.MM.yyyy HH:mm:ss"; Для чисел: 6 - чекбокс)';
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5245 Изменить возможные значения поля format из справочника ref_book_attribute -->
    <changeSet id="3.1-akorobko-3" author="akorobko">
        <sql>
            update ref_book_attribute set format=7 where id=9083;
        </sql>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5315 Не присваивается АСНУ при первичной загрузке ФЛ -->
    <changeSet id="3.1-apronin-10" author="apronin">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.1/refbook/person.groovy"/>
            <where>id in (select script_id from ref_book r where r.id = 904)</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5271 Добавить фатальную ошибку при проверке ПНФ, если авансовые платежи указаны для налогоплательщика,статус которого не равен 6 -->
    <changeSet id="3.1-apronin-11" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5134 Реализовать изменения в алгоритме проверки допустимости имен и фамилий -->
    <changeSet id="3.1-snazin-0" author="snazin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfll_check.groovy"/>
            <where>id in (8, 12)</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5315 Не присваивается АСНУ при первичной загрузке ФЛ -->
    <changeSet id="3.1-apronin-10" author="apronin">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.1/refbook/person.groovy"/>
            <where>id in (select script_id from ref_book r where r.id = 904)</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5271 Добавить фатальную ошибку при проверке ПНФ, если авансовые платежи указаны для налогоплательщика,статус которого не равен 6 -->
    <changeSet id="3.1-apronin-11" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-4" author="akorobko">
        <sql>
            drop sequence SEQ_DEPARTMENT;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-5" author="akorobko">
        <sql>
            drop sequence SEQ_DEPARTMENT_FORM_TYPE;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-6" author="akorobko">
        <sql>
            drop sequence SEQ_FORM_COLUMN;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-7" author="akorobko">
        <sql>
            drop sequence SEQ_FORM_DATA;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-8" author="akorobko">
        <sql>
            drop sequence SEQ_FORM_DATA_NNN;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-9" author="akorobko">
        <sql>
            drop sequence SEQ_FORM_DATA_SIGNER;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-10" author="akorobko">
        <sql>
            drop sequence SEQ_FORM_SEARCH_RESULT;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-11" author="akorobko">
        <sql>
            drop sequence SEQ_FORM_STYLE;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-12" author="akorobko">
        <sql>
            drop sequence SEQ_FORM_TEMPLATE;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-13" author="akorobko">
        <sql>
            drop sequence SEQ_FORM_TYPE;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-14" author="akorobko">
        <sql>
            drop sequence SEQ_LOG_ENTRY;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-15" author="akorobko">
        <sql>
            drop sequence SEQ_LOG_QUERY;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-16" author="akorobko">
        <sql>
            drop sequence SEQ_LOG_QUERY_SESSION;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-17" author="akorobko">
        <sql>
            drop sequence SEQ_SEC_USER;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-18" author="akorobko">
        <sql>
            drop sequence SEQ_SEC_USER_ASNU_ID;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-19" author="akorobko">
        <sql>
            drop sequence SEQ_TASK_CONTEXT;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-20" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_KOL_LIC_TIP;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-21" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_OBYAZ_PLAT_SV;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-22" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_OSS_VNM;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-23" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_PERS_SV_STRAH_LIC;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-24" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_PRAV_TARIF3_1_427;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-25" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_PRAV_TARIF5_1_427;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-26" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_PRAV_TARIF7_1_427;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-27" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_RASH_OSS_ZAK;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-28" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_RASH_OSS_ZAK_RASH;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-29" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_RASH_VYPL;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-30" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SVED_OBUCH;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-31" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SVNP_PODPISANT;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-32" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SV_OPS_OMS;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-33" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SV_OPS_OMS_RASCH;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-34" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SV_PRIM_TARIF1_422;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-35" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SV_PRIM_TARIF2_425;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-36" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SV_PRIM_TARIF9_427;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-37" author="akorobko">
        <sql>
           drop sequence SEQ_RASCHSV_SV_REESTR_MDO;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-38" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SV_SUM_1TIP;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-39" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SV_VYPL;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-40" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_SV_VYPL_MK;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-41" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_UPL_PER;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-42" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_UPL_PREV_OSS;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-43" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_UPL_SV_PREV;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-44" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_VYPL_FIN_FB;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-45" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_VYPL_PRICHINA;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-46" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_VYPL_SV_DOP;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5294 Убрать неиспользуемые последовательности в БД -->
    <changeSet id="3.1-akorobko-47" author="akorobko">
        <sql>
            drop sequence SEQ_RASCHSV_VYPL_SV_DOP_MT;
        </sql>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5134 Реализовать изменения в алгоритме проверки допустимости имен и фамилий -->
    <changeSet id="3.1-snazin-1" author="snazin">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.1/refbook/person.groovy"/>
            <where>id in (select script_id from ref_book r where r.id = 904)</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5245 Изменить возможные значения поля format из справочника ref_book_attribute -->
    <changeSet id="3.1-akorobko-48" author="akorobko">
        <sql>
            update ref_book_attribute set format=7 where id=9083;
        </sql>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5330 -->
    <changeSet id="3.1-dnovikov-9" author="dnovikov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.1/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <!-- В скрипте 3.1-snazin-0 указан путь к файлу не в той папке, нужно из templates-3.1 -->
    <changeSet id="3.1-snazin-2" author="snazin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates-3.1/ndfl/report_2ndfl_1/v2016/report_2ndfll_check.groovy"/>
            <where>id in (8, 12)</where>
        </update>
    </changeSet>

    <!-- У файлов скриптов были ошибочные названия -->
    <changeSet id="3.1-snazin-3" author="snazin">
        <update tableName="blob_data">
            <column name="name" value="id_doc.groovy"/>
            <where>id = '375ba56a-2509-11e7-93ae-92361f002671'</where>
        </update>
        <update tableName="blob_data">
            <column name="name" value="person.groovy"/>
            <where>id = '884b9f2e-1678-4d69-9652-b036bba2f728'</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5334 Создание недостающих связей между новыми подразделениями и периодами -->
    <changeSet id="3.1-akorobko-49" author="akorobko">
        <sql>
	insert into department_report_period(id,department_id,report_period_id,is_active,correction_date)
	select seq_department_report_period.nextval,id,report_period_id,is_active,correction_date from (
	select d_child.id,drp_parent.report_period_id,drp_parent.is_active,drp_parent.correction_date from department_child_view dcv
	join department d_parent on dcv.parent_id=d_parent.id and d_parent.type=2
	join department_report_period drp_parent on drp_parent.department_id=d_parent.id
	join department d_child on dcv.id=d_child.id
	where not exists (select * from department_report_period drp_child
			where drp_child.department_id=d_child.id and drp_child.report_period_id=drp_parent.report_period_id and
				(drp_child.correction_date=drp_parent.correction_date or (drp_child.correction_date is null and drp_parent.correction_date is null)))
	order by d_child.id,drp_parent.report_period_id,drp_parent.correction_date nulls first) a
        </sql>
    </changeSet>

    <changeSet id="3.1-dnovikov-10" author="dnovikov">
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_LAST_NAME"/>
            <column name="department_id" value="0"/>
            <column name="value" value="5"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_FIRST_NAME"/>
            <column name="department_id" value="0"/>
            <column name="value" value="10"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_MIDDLE_NAME"/>
            <column name="department_id" value="0"/>
            <column name="value" value="5"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_BIRTHDAY"/>
            <column name="department_id" value="0"/>
            <column name="value" value="10"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_CITIZENSHIP"/>
            <column name="department_id" value="0"/>
            <column name="value" value="1"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_INP"/>
            <column name="department_id" value="0"/>
            <column name="value" value="15"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_INN"/>
            <column name="department_id" value="0"/>
            <column name="value" value="10"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_INN_FOREIGN"/>
            <column name="department_id" value="0"/>
            <column name="value" value="10"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_SNILS"/>
            <column name="department_id" value="0"/>
            <column name="value" value="15"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_TAX_PAYER_STATUS"/>
            <column name="department_id" value="0"/>
            <column name="value" value="1"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_DUL"/>
            <column name="department_id" value="0"/>
            <column name="value" value="10"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_ADDRESS"/>
            <column name="department_id" value="0"/>
            <column name="value" value="1"/>
        </insert>
        <insert tableName="CONFIGURATION">
            <column name="code" value="WEIGHT_ADDRESS_INO"/>
            <column name="department_id" value="0"/>
            <column name="value" value="1"/>
        </insert>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5346 Добавление новых полей к справочнику физ. лиц -->
    <changeSet id="3.1-snazin-4" author="snazin">
        <addColumn tableName="ref_book_person">
            <column name="report_doc"
                    type="number(18)"
                    remarks="Ссылка на ДУЛ, который должен включаться в отчетность">
                <constraints references="ref_book_id_doc(id)"
                             foreignKeyName="fk_ref_book_person_report_doc"/>
            </column>
        </addColumn>
        <addColumn tableName="ref_book_person">
            <column name="vip"
                    type="number(1)"
                    defaultValueNumeric="0"
                    remarks="Признак, показывающий, является ли ФЛ VIP-ом (0 - Не VIP, 1 - VIP)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- https://conf.aplana.com/pages/viewpage.action?pageId=40019337 "На что обратить внимание", пункт 2.а -->
    <changeSet id="3.1-snazin-5" author="snazin">
        <sql>
            update ref_book_person
            set status = old_status
            where (old_id is not null) and (old_status is not null) and (status = -1)
        </sql>
        <sql>
            update ref_book_person
            set old_id = record_id
            where old_id is null
        </sql>
        <rollback>
            <sql>
                update ref_book_person
                set old_id = null
                where old_id = record_id
            </sql>
            <sql>
                update ref_book_person
                set status = -1
                where (old_id is not null) and (status = old_status)
            </sql>
        </rollback>
    </changeSet>

    <!-- https://conf.aplana.com/pages/viewpage.action?pageId=40019337 "На что обратить внимание", пункт 2.b -->
    <changeSet id="3.1-snazin-6" author="snazin">
        <comment>Выставлено inc_rep = 0, если в нём значение, отличное от (0, 1). Добавлено ограничение на это поле.</comment>
        <update tableName="ref_book_id_doc">
            <column name="inc_rep" value="0"/>
            <where>(inc_rep &lt; 0) or (inc_rep &gt; 1)</where>
        </update>
        <sql>
            alter table ref_book_id_doc
            add constraint chk_ref_book_id_doc_inc_rep check (inc_rep in (0, 1))
        </sql>
    </changeSet>

    <!-- https://conf.aplana.com/pages/viewpage.action?pageId=40019337 "На что обратить внимание", пункт 2.b -->
    <changeSet id="3.1-snazin-7" author="snazin">
        <comment>Если для одного ФЛ было несколько ДУЛ с inc_rep = 1, оставляем только на одном последнем</comment>
        <sql>
            update ref_book_id_doc
            set inc_rep = 0
            where id in (
                select id
                from (
                    select
                        r.id,
                        r.inc_rep,
                        row_number() over (partition by person_id order by inc_rep desc, version desc, id desc) as rn,
                        sum(inc_rep) over (partition by person_id) as inc_rep_sm
                    from ref_book_id_doc r
                )
                where inc_rep_sm > 1 and rn > 1 and inc_rep > 0
            )
        </sql>
    </changeSet>

    <!-- https://conf.aplana.com/pages/viewpage.action?pageId=40019337 "На что обратить внимание", пункт 2.b -->
    <changeSet id="3.1-snazin-8" author="snazin">
        <comment>Заполнено поле report_doc в таблице ref_book_person данными из ref_book_id_doc</comment>
        <sql>
            update ref_book_person person
            set person.report_doc = (
                select doc.id
                from ref_book_id_doc doc
                where (doc.person_id = person.id) and (doc.inc_rep = 1)
            )
            where exists (
                select 1
                from ref_book_id_doc doc
                where (doc.person_id = person.id) and (doc.inc_rep = 1)
            )
        </sql>
    </changeSet>
</databaseChangeLog>