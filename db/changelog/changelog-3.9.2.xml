<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <!-- https://jira.aplana.com/browse/SBRFNDFL-8418 Добавить поля "Учитывать КПП/ОКТМО" -->
    <changeSet id="3.9.2-adudenko-1" author="adudenko" >
        <sql>
            alter table department_config add related_kpp varchar2(9 char);
            alter table department_config add related_oktmo_id varchar2(11 char);
            comment on column department_config.related_kpp is 'Поле для формирования настройки подразделения Учитывать в КПП/ОКТМО';
            comment on column department_config.related_oktmo_id is 'Поле для формирования настройки подразделения Учитывать в КПП/ОКТМО';
        </sql>
    </changeSet>

    <!-- https://jira.aplana.com/projects/SBRFNDFL/issues/SBRFNDFL-8281 Реализовать проверку на необходимость формирования ОНФ если настройка подразделения закрыта -->
    <changeSet id="3.9.2-mchernyakov-1" author="mchernyakov" runAlways="true">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.9.2/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>declaration_type_id = 103</where>
        </update>
    </changeSet>
    <changeSet id="3.9.2-mchernyakov-2" author="mchernyakov" runAlways="true">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.9.2/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 102</where>
        </update>
    </changeSet>
    <changeSet id="3.9.2-mchernyakov-3" author="mchernyakov" runAlways="true">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.9.2/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 104</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-8461 Поправить алгоритм загрузки выгрузки настройки подразделений -->
    <changeSet id="3.9.2-adudenko-2" author="adudenko" runAlways="true">
        <update tableName="blob_data">
            <column name="data"
                    valueBlobFile="templates-3.9.2/refbook/department_configs.groovy"/>
            <where>id = (select script_id from ref_book r where r.id = 951)</where>
        </update>
    </changeSet>

</databaseChangeLog>
