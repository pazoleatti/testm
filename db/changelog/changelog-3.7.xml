<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<changeSet id="3.7-dnovikov-1" author="dnovikov" runAlways="true">
		<update tableName="blob_data">
			<column name="data"
					valueBlobFile="templates-3.7/refbook/department_configs.groovy"/>
			<where>id = (select script_id from ref_book r where r.id = 951)</where>
		</update>
	</changeSet>

	<changeSet id="3.7-dnovikov-2" author="dnovikov" runAlways="true">
		<update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
			<column name="script" valueClobFile="templates-3.7/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
			<where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
		</update>
	</changeSet>

    <changeSet id="3.7-dnovikov-3" author="dnovikov" runAlways="true">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.7/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

	<changeSet id="3.7-dnovikov-4" author="dnovikov" runAlways="true">
		<update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
			<column name="script" valueClobFile="templates-3.7/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
			<where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 7</where>
		</update>
	</changeSet>

	<changeSet id="3.7-dnovikov-5" author="dnovikov" runAlways="true">
		<update tableName="DECLARATION_TEMPLATE">
			<column name="CREATE_SCRIPT" valueClobFile="templates-3.7/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
			<where>declaration_type_id = 102</where>
		</update>
		<update tableName="DECLARATION_TEMPLATE">
			<column name="CREATE_SCRIPT" valueClobFile="templates-3.7/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
			<where>declaration_type_id = 104</where>
		</update>
		<update tableName="DECLARATION_TEMPLATE">
			<column name="CREATE_SCRIPT" valueClobFile="templates-3.7/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
			<where>declaration_type_id = 103</where>
		</update>
	</changeSet>

    <changeSet id="3.7-dnovikov-6" author="dnovikov" runAlways="true">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.7/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
    </changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-7159 Реализовать перенос пустых значений из Реестра ФЛ в Раздел 1 РНУ при обновлении данных ФЛ-->
	<changeSet id="3.7-ytrofimov-1" author="ytrofimov" runAlways="true">
		<update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
			<column name="script" valueClobFile="templates-3.7/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_update_persons_data.groovy"/>
			<where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 11</where>
		</update>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-7159 Реализовать перенос пустых значений из Реестра ФЛ в Раздел 1 РНУ при обновлении данных ФЛ-->
	<changeSet id="3.7-ytrofimov-2" author="ytrofimov" runAlways="true">
		<update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
			<column name="script" valueClobFile="templates-3.7/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_update_persons_data.groovy"/>
			<where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 11</where>
		</update>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-5679 - рефакторинг настроек подразделений, новая таблица-->
	<changeSet id="3.7-dnovikov-7" author="dnovikov">
		<sql>
			CREATE TABLE department_config_test (
				ID                  NUMBER(18) NOT NULL,
				KPP                 VARCHAR2(9 CHAR) NOT NULL,
				OKTMO_ID            NUMBER(18,0) NOT NULL,
				start_date          DATE NOT NULL,
				end_date          	DATE,
				DEPARTMENT_ID       NUMBER(18) NOT NULL,
				TAX_ORGAN_CODE      VARCHAR2(4 CHAR) NOT NULL,
				TAX_ORGAN_CODE_MID  VARCHAR2(4 CHAR),
				present_place_id    NUMBER(18,0) NOT NULL,
				NAME                VARCHAR2(1000 CHAR),
				PHONE               VARCHAR2(20 CHAR),
				reorganization_id   NUMBER(18,0),
				REORG_INN           VARCHAR2(12 CHAR),
				REORG_KPP           VARCHAR2(9 CHAR),
				SIGNATORY_ID        NUMBER(18,0) NOT NULL,
				SIGNATORY_SURNAME   VARCHAR2(60 CHAR),
				SIGNATORY_FIRSTNAME VARCHAR2(60 CHAR),
				SIGNATORY_LASTNAME  VARCHAR2(60 CHAR),
				APPROVE_DOC_NAME    VARCHAR2(120 CHAR),
				APPROVE_ORG_NAME    VARCHAR2(1000 CHAR)
			);
			COMMENT ON TABLE department_config_test IS 'Настройки подразделений';
			COMMENT ON COLUMN department_config_test.ID IS 'Уникальный идентификатор';
			COMMENT ON COLUMN department_config_test.KPP IS 'КПП';
			COMMENT ON COLUMN department_config_test.OKTMO_ID IS 'ОКТМО';
			COMMENT ON COLUMN department_config_test.start_date IS 'Дата начала действия настройки';
			COMMENT ON COLUMN department_config_test.end_date IS 'Дата окончания действия настройки';
			COMMENT ON COLUMN department_config_test.DEPARTMENT_ID IS 'Код обособленного подразделения';
			COMMENT ON COLUMN department_config_test.TAX_ORGAN_CODE IS 'Код налогового органа конечного';
			COMMENT ON COLUMN department_config_test.TAX_ORGAN_CODE_MID IS 'Код налогового органа промежуточного';
			COMMENT ON COLUMN department_config_test.present_place_id IS 'Место, по которому представляется документ.';
			COMMENT ON COLUMN department_config_test.NAME IS 'Наименование для титульного листа';
			COMMENT ON COLUMN department_config_test.PHONE IS 'Номер контактного телефона';
			COMMENT ON COLUMN department_config_test.reorganization_id IS 'Код формы реорганизации и ликвидации';
			COMMENT ON COLUMN department_config_test.REORG_INN IS 'ИНН реорганизованного обособленного подразделения';
			COMMENT ON COLUMN department_config_test.REORG_KPP IS 'КПП реорганизованного обособленного подразделения';
			COMMENT ON COLUMN department_config_test.SIGNATORY_ID IS 'признак лица, подписавшего документ';
			COMMENT ON COLUMN department_config_test.SIGNATORY_SURNAME IS 'Фамилия подписанта';
			COMMENT ON COLUMN department_config_test.SIGNATORY_FIRSTNAME IS 'Имя подписанта';
			COMMENT ON COLUMN department_config_test.SIGNATORY_LASTNAME IS 'Отчество подписанта';
			COMMENT ON COLUMN department_config_test.APPROVE_DOC_NAME IS 'Наименование документа, подтверждающего полномочия';
			COMMENT ON COLUMN department_config_test.APPROVE_ORG_NAME IS 'Наименование организации-представителя налогоплательщика';

			alter table department_config_test add constraint dep_conf_pk primary key (id);
			alter table department_config_test add constraint dep_conf_kpp_oktmo_st_date_uk unique (kpp, oktmo_id, start_date);
			alter table department_config_test add constraint dep_conf_oktmo_fk FOREIGN KEY (oktmo_id) REFERENCES REF_BOOK_OKTMO (ID);
			alter table department_config_test add constraint dep_conf_dep_fk FOREIGN KEY (DEPARTMENT_ID) REFERENCES DEPARTMENT (ID);
			alter table department_config_test add constraint dep_conf_present_place_fk FOREIGN KEY (present_place_id) REFERENCES REF_BOOK_PRESENT_PLACE (ID);
			alter table department_config_test add constraint dep_conf_reorg_fk FOREIGN KEY (reorganization_id) REFERENCES REF_BOOK_REORGANIZATION (ID);
			alter table department_config_test add constraint dep_conf_sign_mark_fk FOREIGN KEY (SIGNATORY_ID) REFERENCES REF_BOOK_SIGNATORY_MARK (ID);
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-5679 - рефакторинг настроек подразделений, перекидываем данные в новую таблицу-->
	<changeSet id="3.7-dnovikov-8" author="dnovikov">
		<sql>
			insert into department_config_test
			select id, kpp, oktmo oktmo_id, version start_date, end_date, department_id, TAX_ORGAN_CODE, TAX_ORGAN_CODE_MID, present_place present_place_id, NAME, PHONE,
			REORG_FORM_CODE reorganization_id, REORG_INN, REORG_KPP, SIGNATORY_ID, SIGNATORY_SURNAME, SIGNATORY_FIRSTNAME, SIGNATORY_LASTNAME, APPROVE_DOC_NAME, APPROVE_ORG_NAME
			from (
				select * from (
					select rbnd.*, lead(version) over(partition by rbnd.record_id order by version) - interval '1' DAY end_date
					from ref_book_ndfl_detail rbnd
					where status != -1
				) where status = 0
			);
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-5679 - рефакторинг настроек подразделений, сиквенс-->
	<changeSet id="3.7-dnovikov-9" author="dnovikov">
		<sql splitStatements="false">
			declare
				max_id number;
			begin
				select max(id) into max_id from department_config_test;
				execute immediate 'create sequence seq_department_config start with ' || (max_id + 1);
			end;
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-5679 - рефакторинг настроек подразделений, индексы-->
	<changeSet id="3.7-dnovikov-10" author="dnovikov">
		<sql>
			create unique index dep_conf_kpp_ok_st_end_uidx on department_config_test(kpp, oktmo_id, start_date, end_date);
			create index dep_conf_dep_st_end_idx on department_config_test(department_id, start_date, end_date);
			create index dep_conf_dep_kpp_ok_st_end_idx on department_config_test(department_id, kpp, oktmo_id, start_date, end_date);
		</sql>
	</changeSet>

	<changeSet id="3.7-ytrofimov-5" author="ytrofimov" runAlways="true">
		<update tableName="DECLARATION_TEMPLATE">
			<column name="CREATE_SCRIPT" valueClobFile="templates-3.7/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
			<where>declaration_type_id = 100</where>
		</update>
	</changeSet>

	<changeSet id="3.7-ytrofimov-6" author="ytrofimov">
		<update tableName="BLOB_DATA">
			<column name="data"
					valueBlobFile="templates-3.4/refbook/declaration_type.groovy"/>
			<where>id in (select script_id from ref_book r where r.id = 207)</where>
		</update>
	</changeSet>

	<changeSet id="3.7-ytrofimov-7" author="ytrofimov" runAlways="true">
		<update tableName="DECLARATION_TEMPLATE">
			<column name="CREATE_SCRIPT" valueClobFile="templates-3.7/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
			<where>declaration_type_id = 101</where>
		</update>
	</changeSet>

	<changeSet id="3.7-ytrofimov-8" author="ytrofimov" runAlways="true">
		<update tableName="BLOB_DATA">
			<column name="data"
					valueBlobFile="templates-3.7/refbook/declaration_type.groovy"/>
			<where>id in (select script_id from ref_book r where r.id = 207)</where>
		</update>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6590 - удалил старый отчет-->
	<changeSet id="3.7-dnovikov-11" author="dnovikov">
		<sql>
			delete from async_task_type where id = 35;
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6590 - удалил скрипт для старого отчета-->
	<changeSet id="3.7-dnovikov-12" author="dnovikov">
		<sql>
			delete from DECL_TEMPLATE_EVENT_SCRIPT where id = 18;
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-7164 - Новая ассинхронная задача отправить ЭД в ЭДО-->
	<changeSet id="3.7-dnovikov-13" author="dnovikov">
		<insert tableName="async_task_type">
			<column name="id" value="10"/>
			<column name="name" value="Отправка ЭД в ЭДО"/>
			<column name="handler_bean" value="SendEdoAsyncTask"/>
		</insert>
	</changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-7575 -->
	<changeSet id="3.7-ishevchuk-1" author="ishevchuk">
		<update tableName="blob_data">
			<column name="data" valueBlobFile="templates-3.7/ndfl/primary_rnu_ndfl/v2016/excel_template_dec.xlsx"/>
			<where>id='3b4eb6e0-3ce3-48ba-b8e5-0b9c9174b5fe'</where>
		</update>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-7373 - Переименовать таблицу настроек подразделений и поправить вьюху-->
	<changeSet id="3.7-dnovikov-14" author="dnovikov">
		<sql>
			drop table REF_BOOK_NDFL_OLD;
		</sql>
	</changeSet>
	<changeSet id="3.7-dnovikov-15" author="dnovikov">
		<sql>
			drop synonym department_config;
		</sql>
	</changeSet>
	<changeSet id="3.7-dnovikov-16" author="dnovikov">
		<sql>
			drop view vw_department_config;
		</sql>
	</changeSet>
	<changeSet id="3.7-dnovikov-17" author="dnovikov">
		<sql>
			rename REF_BOOK_NDFL_DETAIL to REF_BOOK_NDFL_DETAIL_OLD;
		</sql>
	</changeSet>
	<changeSet id="3.7-dnovikov-18" author="dnovikov">
		<sql>
			CREATE OR REPLACE FORCE VIEW VW_DEPART_KPP_OKTMO (DEP_ID, DEP_NAME, KPP, OKTMO) AS
			select dep.id dep_id, dep.name dep_name, dc.kpp, oktmo.code oktmo
			from department dep
			join department_config dc on dc.department_id = dep.id
			join ref_book_oktmo oktmo on oktmo.id = dc.oktmo_id;
		</sql>
	</changeSet>
	<changeSet id="3.7-dnovikov-19" author="dnovikov">
		<sql>
			rename department_config_test to department_config;
		</sql>
	</changeSet>
	<changeSet id="3.7-ishevchuk-2" author="ishevchuk">
		<update tableName="BLOB_DATA">
			<column name="data"
					valueBlobFile="templates-3.7/ndfl/report_6ndfl/v2016/UU_OTCH_1_087_00_05_07_01.xsd"/>
			<where>id in (select bd.id from declaration_template_file dtf left join blob_data bd on dtf.BLOB_DATA_ID = bd.ID where dtf.DECLARATION_TEMPLATE_ID = 103 and bd.NAME = 'UU_OTCH_1_087_00_05_07_01.xsd')</where>
		</update>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-7092 - Ссылка на протокол операций в истории изменений-->
	<changeSet id="3.7-dnovikov-20" author="dnovikov">
		<sql>
			alter table log_business add log_id varchar2(36 byte);
			alter table log_business add constraint log_business_fk_log_id foreign key (log_id) references log (id) on delete cascade;
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-7092 - Изменения событий-->
	<changeSet id="3.7-dnovikov-21" author="dnovikov">
		<sql>
			update event set name = 'Создание' where id = 1;
			update event set name = 'Удаление' where id = 2;
			update event set name = 'Проверка' where id = 5;
			update event set name = 'Обновление данных ФЛ' where id = 11;
			update event set name = 'Изменение состояния ЭД' where id = 26;
			update event set name = 'Возврат в Создана' where id = 106;
			update event set name = 'Проверка' where id = 107;
			update event set name = 'Принятие' where id = 109;
			update event set name = 'Импорт из файла Excel' where id = 401;
			update event set name = 'Загрузка файла ответа ФНС' where id = 10002;
			insert into event(id, name) values(10003, 'Идентификация ФЛ');
			insert into event(id, name) values(10004, 'Консолидация');
			insert into event(id, name) values(10005, 'Создание из ТФ xml');
			insert into event(id, name) values(10006, 'Редактирование строки РНУ НДФЛ');
			insert into event(id, name) values(10007, 'Массовое редактирование дат');
			insert into event(id, name) values(10008, 'Отправка в ЭДО');
			insert into event(id, name) values(10009, 'Выгрузка для отправки в ФНС');
		</sql>
	</changeSet>

</databaseChangeLog>