<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <!--https://jira.aplana.com/browse/SBRFNDFL-5492 удалил справочник "Настройки асинхронных задач"-->
    <changeSet id="3.2-dnovikov-1" author="dnovikov">
        <delete tableName="ref_book_attribute">
            <where>ref_book_id = 401</where>
        </delete>
        <delete tableName="ref_book">
            <where>id = 401</where>
        </delete>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5492 удалил справочник "Настройки почты"-->
    <changeSet id="3.2-dnovikov-2" author="dnovikov">
        <delete tableName="ref_book_attribute">
            <where>ref_book_id = 400</where>
        </delete>
        <delete tableName="ref_book">
            <where>id = 400</where>
        </delete>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5491 Удалить провайдер вертикальных справочников RefBookUniversal-->
    <changeSet id="3.2-dnovikov-3" author="dnovikov">
        <sql>
            drop table ref_book_value;
        </sql>
        <sql>
            drop table ref_book_record;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5717 удалил справочник "Конфигурационные параметры"-->
    <changeSet id="3.2-dnovikov-4" author="dnovikov">
        <delete tableName="ref_book_attribute">
            <where>ref_book_id = 105</where>
        </delete>
        <delete tableName="ref_book">
            <where>id = 105</where>
        </delete>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5717 удалил справочник "Конфигурационные параметры"-->
    <changeSet id="3.2-dnovikov-5" author="dnovikov">
        <sql>
            update ref_book set script_id = null where id = 30
        </sql>
    </changeSet>

    <changeSet id="3.2-dnovikov-6" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.2/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 102</where>
        </update>
    </changeSet>
    <changeSet id="3.2-dnovikov-7" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.2/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 104</where>
        </update>
    </changeSet>

    <changeSet id="3.2-dnovikov-8" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.2/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 102</where>
        </update>
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.2/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 104</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5692 -->
    <changeSet id="3.2-ytrofimov-0" author="ytrofimov">
        <sql>
            alter table
            ref_book_person
            add
            (
            "START_DATE" DATE,
            "END_DATE" DATE
            );
        </sql>
        <sql>
            comment on column "REF_BOOK_PERSON"."START_DATE" is 'Дата начала действия';
            comment on column "REF_BOOK_PERSON"."END_DATE" is 'Дата окончания действия';
            commit;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5692 -->
    <changeSet id="3.2-ytrofimov-1" author="ytrofimov">
        <sql>
            alter table
            ref_book_person
            add
            (
            "REGION_CODE" VARCHAR2(2 CHAR),
            "POSTAL_CODE" VARCHAR2(6 CHAR),
            "DISTRICT" VARCHAR2(500 CHAR),
            "CITY" VARCHAR2(500 CHAR),
            "LOCALITY" VARCHAR2(500 CHAR),
            "STREET" VARCHAR2(500 CHAR),
            "HOUSE" VARCHAR2(20 CHAR),
            "BUILD" VARCHAR2(20 CHAR),
            "APPARTMENT" VARCHAR2(20 CHAR),
            "COUNTRY_ID" NUMBER(18,0),
            "ADDRESS_FOREIGN" VARCHAR2(255 CHAR)
            );
        </sql>
        <sql>
            COMMENT ON COLUMN "REF_BOOK_PERSON"."REGION_CODE" IS 'Код региона';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."POSTAL_CODE" IS 'Почтовый индекс';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."DISTRICT" IS 'Район';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."CITY" IS 'Город';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."LOCALITY" IS 'Населенный пункт (село, поселок)';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."STREET" IS 'Улица (проспект, переулок)';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."HOUSE" IS 'Номер дома (владения)';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."BUILD" IS 'Номер корпуса (строения)';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."APPARTMENT" IS 'Номер квартиры';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."COUNTRY_ID" IS 'Страна проживания';
            COMMENT ON COLUMN "REF_BOOK_PERSON"."ADDRESS_FOREIGN" IS 'Адрес за пределами Российской Федерации';
            commit;
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5692 -->
    <changeSet id="3.2-ytrofimov-2" author="ytrofimov">
        <sql>
            alter table
            REF_BOOK_ID_DOC
            drop
            (
            RECORD_ID,
            VERSION,
            STATUS,
            DUPLICATE_RECORD_ID
            );
        </sql>
        <sql>
            alter table
            REF_BOOK_ID_TAX_PAYER
            drop
            (
            RECORD_ID,
            VERSION,
            STATUS
            );
        </sql>
        <sql>
            alter table
            REF_BOOK_PERSON_TB
            drop
            (
            RECORD_ID,
            VERSION,
            STATUS
            );
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5692 -->
    <changeSet id="3.2-ytrofimov-3" author="ytrofimov">
        <sql>
            alter table
            REF_BOOK_PERSON
            drop
            (
            VERSION,
            STATUS
            );
        </sql>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5692 -->
    <changeSet id="3.2-ytrofimov-4" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.2/refbook/person.groovy"/>
            <where>id in (select script_id from ref_book r where r.id = 904)</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5692 -->
    <changeSet id="3.2-ytrofimov-5" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.2/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5692 -->
    <changeSet id="3.2-ytrofimov-6" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.2/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5692 -->
    <changeSet id="3.2-ytrofimov-7" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.2/ndfl/consolidated_rnu_ndfl/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.2/ndfl/consolidated_rnu_ndfl/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.2/ndfl/consolidated_rnu_ndfl/consolidated_rnu_ndfl_update_persons_data.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 11</where>
        </update>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5792 Изменение процедур по идентификации для новой структуры хранения реестра ФЛ-->
    <changeSet id="3.2-amandzyak-1" author="amandzyak">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/person_pkg_body12.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5792 Изменение процедур по идентификации для новой структуры хранения реестра ФЛ-->
    <changeSet id="3.2-amandzyak-2" author="amandzyak">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/person_pkg7.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-5792 Изменение процедур по идентификации для новой структуры хранения реестра ФЛ-->
    <changeSet id="3.2-amandzyak-3" author="amandzyak">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/person_pkg_body13.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

</databaseChangeLog>