<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<!--https://jira.aplana.com/browse/SBRFNDFL-6265 Реализовать изменения порядка сортировки в отчете "Детализация..."-->
	<changeSet id="3.5-dnovikov-1" author="dnovikov" runAlways="true">
		<update tableName="DECLARATION_TEMPLATE">
			<column name="CREATE_SCRIPT" valueClobFile="templates-3.5/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
			<where>declaration_type_id = 100</where>
		</update>
		<update tableName="DECLARATION_TEMPLATE">
			<column name="CREATE_SCRIPT" valueClobFile="templates-3.5/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
			<where>declaration_type_id = 101</where>
		</update>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6451 Реализовать установку блокировок на формы источники в процессе выполнения консолидации-->
	<changeSet id="3.5-ytrofimov-1" author="ytrofimov" runAlways="true">
		<update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
			<column name="script" valueClobFile="templates-3.5/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
			<where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
		</update>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6452 Реализовать изменение определения настроек подразделений ТБ при консолидации-->
	<changeSet id="3.5-dnovikov-2" author="dnovikov">
		<sql>
			create view department_config as
			select * from (
			    select rbnd.*, lead(version) over(partition by rbnd.record_id order by version) - interval '1' DAY version_end
			    from ref_book_ndfl_detail rbnd
			    where status != -1
			) where status = 0;
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6368 "null - (null) null" в сообщении на событие изменения ДУЛ в отчётности через Идентификацию-->
	<changeSet id="3.5-dnovikov-3" author="dnovikov" runAlways="true">
		<update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
			<column name="script" valueClobFile="templates-3.5/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
			<where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 3</where>
		</update>
	</changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-5767 Поле "Адрес" справки о доходах ФЛ заполняется значением "null" -->
    <changeSet id="3.5-snazin-1" author="snazin">
        <update tableName="blob_data">
            <column name="data" valueBlobFile="templates-3.5/ndfl/report_2ndfl_1/v2016/report_2ndfl.jrxml"/>
            <where>
                id in (
                    select blob_data_id
                    from declaration_subreport
                    where declaration_template_id = 102 and alias = 'report_2ndfl1'
                )
            </where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-6376 Два одинаковых типа задания "Выгрузка отчетности" во вкладке "Параметры асинхронных заданий" -->
	<changeSet id="3.5-ishevchuk-1" author="ishevchuk">
		<delete tableName="async_task_type">
            <where>id = 29</where>
		</delete>
	</changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-6527 Новое значение не указано при редактировании ПНФ с помощью ТФ Excel -->
	<changeSet id="3.5-ishevchuk-2" author="ishevchuk" runAlways="true">
		<update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
			<column name="script" valueClobFile="templates-3.5/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
			<where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 7</where>
		</update>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6552 Сортировка РНУ реализована не по постановке-->
	<changeSet id="3.5-ytrofimov-2" author="ytrofimov">
		<addColumn tableName="ndfl_person_income">
			<column name="operation_date" type="date"/>
			<column name="action_date" type="date" />
			<column name="row_type" type="number(3,0)">
				<constraints checkConstraint="row_type in (100, 200, 300)" />
			</column>
		</addColumn>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6552 Сортировка РНУ реализована не по постановке-->
	<changeSet id="3.5-ytrofimov-3" author="ytrofimov">
		<sql splitStatements="false">
			begin
			execute immediate 'comment on column ndfl_person_income.operation_date is ''Поле, используемое для сортировки Раздела 2  Хранит дату первого начисления в рамках этой операции (набора строк формы с одинаковым ID операции)''';
			execute immediate 'comment on column ndfl_person_income.action_date is ''Поле, используемое для сортировки Раздела 2  Показывает дату действия, отражаемого в этой строке.''';
			execute immediate 'comment on column ndfl_person_income.row_type is ''Поле, используемое для сортировки Раздела 2''';
			end;
		</sql>
	</changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-6543 Ошибка исполнения [36] при проверке ПНФ с параметром Раздел1.гражданство = "000" -->
	<changeSet id="3.5-ishevchuk-3" author="ishevchuk" runAlways="true">
		<update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
			<column name="script" valueClobFile="templates-3.5/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
			<where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
		</update>
	</changeSet>

	<!-- https://jira.aplana.com/browse/SBRFNDFL-6483 Реализовать возможность массового редактирования данных ПНФ (для коррекции проблем SAP) -->
	<changeSet id="3.5-snazin-2" author="snazin">
        <comment>Добавлен Общий параметр с ограничением числа редактируемых строк НФ</comment>
		<insert tableName="configuration">
            <column name="code" value="DECLARATION_ROWS_BULK_EDIT_MAX_COUNT"/>
            <column name="department_id" value="0"/>
            <column name="value" value="200"/>
        </insert>
	</changeSet>

    <!--https://jira.aplana.com/browse/SBRFNDFL-6593 - Скрипт для заполнения полей сортировки-->
    <changeSet id="3.5-amandzyak-1" author="amandzyak">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/update-ndfl_person_income.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

	<changeSet id="3.5-dnovikov-4" author="dnovikov">
		<sql>
			alter table declaration_data add negative_income number(20,2);
			comment on column declaration_data.negative_income is 'Нераспределенный отрицательный Доход';
		</sql>
	</changeSet>

	<changeSet id="3.5-dnovikov-5" author="dnovikov">
		<sql>
			alter table declaration_data add negative_tax number(20,2);
			comment on column declaration_data.negative_tax is 'Нераспределенный отрицательный Налог';
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6513 новые атрибуты формы для нераспределенных отрицательных сумм-->
	<changeSet id="3.5-dnovikov-6" author="dnovikov">
		<sql>
			alter table declaration_data add negative_sums_sign number(1);
			comment on column declaration_data.negative_sums_sign is 'Признак нераспределенных сумм (0 - из текущей формы, 1 - из предыдущей формы)';
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6452 вьюха настроек подразделений-->
	<changeSet id="3.5-dnovikov-7" author="dnovikov">
		<sql>
			RENAME department_config TO vw_department_config;
		</sql>
	</changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-6452 вьюха настроек подразделений-->
	<changeSet id="3.5-dnovikov-8" author="dnovikov">
		<sql>
			CREATE SYNONYM department_config FOR vw_department_config;
		</sql>
	</changeSet>

</databaseChangeLog>