<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="3.0-apronin" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4464 -->
    <changeSet id="3.0-apronin-1" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-0" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-1" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-3" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_update_persons_data.groovy"/>
            <where>id=15</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-4" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>id=1</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-5" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-6" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>id=6</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-7" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_update_persons_data.groovy"/>
            <where>id=15</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4158 -->
    <changeSet id="3.0-dloshkarev-1" author="dloshkarev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-4655 Реализовать хранимую процедуру удаления из справочника физлиц -->
	<changeSet id="3.0-rnurgaleev-0" author="rnurgaleev">
        <sql splitStatements="false">
            create or replace 
			procedure DeleteRefBookPerson(p_person_id number)
			is
			  v_address number;
			begin
			  delete from REF_BOOK_ID_TAX_PAYER where person_id=p_person_id;
			  
			  delete from REF_BOOK_ID_DOC where person_id=p_person_id;
			  
			  select address into v_address from REF_BOOK_PERSON where id=p_person_id;
			  
			  delete from REF_BOOK_PERSON where id=p_person_id;
			  
			  if v_address is not null then
				delete from REF_BOOK_ADDRESS where id=v_address;
			  end if;

			end DeleteRefBookPerson;
        </sql>
    </changeSet>

    <changeSet id="3.0-ytrofimov-8" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-9" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_update_persons_data.groovy"/>
            <where>id=15</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-4733 Не отображается "0" в копейках для сумм в форме 6-НДФЛ -->
    <changeSet id="3.0-rnurgaleev-1" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates/ndfl/report_6ndfl/v2016/report.jrxml"/>
            <where>id in (select jrxml from declaration_template dt where dt.id = 103)</where>
        </update>
    </changeSet>

    <!-- Перенос правок из 2.2.2 - Начало -->
    <!-- https://jira.aplana.com/browse/SBRFNDFL-4605 -->
    <changeSet id="3.0-dloshkarev-2" author="dloshkarev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>
    <!--
        https://jira.aplana.com/browse/SBRFNDFL-4608
        https://jira.aplana.com/browse/SBRFNDFL-4689
    -->
    <changeSet id="3.0-dloshkarev-3" author="dloshkarev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>
    <!--
        https://jira.aplana.com/browse/SBRFNDFL-4561
        https://jira.aplana.com/browse/SBRFNDFL-4589
    -->
    <changeSet id="3.0-dloshkarev-4" author="dloshkarev">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 7</where>
        </update>
    </changeSet>
    <!-- Перенос правок из 2.2.2 - Конец -->

    <changeSet id="3.0-dnovikov-0" author="dnovikov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
    </changeSet>


	<!--https://jira.aplana.com/browse/SBRFNDFL-4659 Добавить в БД патч изменение имен xsd файлов для макетов -->
	<changeSet id="3.0-rnurgaleev-2" author="rnurgaleev">
        <sql>
            update blob_data set name='РНУ_НДФЛ_new6.3.xsd' where id in (select xsd from declaration_template where id=100);
			update blob_data set name='NO_NDFL2_1_399_00_05_04_02.xsd' where id in (select xsd from declaration_template where id in (102,104));
			update blob_data set name='NO_NDFL6_1_152_00_05_02_02.xsd' where id in (select xsd from declaration_template where id=103);
        </sql>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4759 -->
    <changeSet id="3.0-apronin-2" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-10" author="ytrofimov">
        <insert tableName="CONFIGURATION">
            <column name="code" value="CONSOLIDATION_DATA_SELECTION_DEPTH"/>
            <column name="department_id" value="0"/>
            <column name="value" value="3"/>
        </insert>
    </changeSet>

    <changeSet id="3.0-ytrofimov-11" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <changeSet id="3.0-apronin-3" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4749 -->
    <changeSet id="3.0-apronin-4" author="apronin">
        <update tableName="blob_data">
            <column name="data" valueBlobFile="templates/ndfl/primary_rnu_ndfl/v2016/excel_template_dec.xlsx"/>
			<where>id='3b4eb6e0-3ce3-48ba-b8e5-0b9c9174b5fe'</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-12" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-13" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-14" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/report_kpp_oktmo.jrxml"/>
            <where>id in (select jrxml from declaration_template dt where dt.id = 101)</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4648 -->
    <changeSet id="3.0-dloshkarev-5" author="dloshkarev">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4747 -->
    <changeSet id="3.0-dloshkarev-6" author="dloshkarev">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
    </changeSet>
    <changeSet id="3.0-dloshkarev-7" author="dloshkarev">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>id=6</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-15" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id in (select script_id from ref_book r where r.id = 207)</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-16" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <changeSet id="3.0-dnovikov-1" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 102</where>
        </update>
    </changeSet>
    <changeSet id="3.0-dnovikov-2" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>declaration_type_id = 104</where>
        </update>
    </changeSet>

    <changeSet id="3.0-dnovikov-3" author="dnovikov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>declaration_type_id = 103</where>
        </update>
    </changeSet>

    <changeSet id="3.0-dnovikov-4" author="dnovikov">
        <addColumn tableName="DECLARATION_DATA">
            <column name="adjust_negative_values" type="number(1)"
                    remarks="Признак, показывающий необходимость корректировки отрицательных значений"
                    defaultValueComputed="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="3.0-dnovikov-5" author="dnovikov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id=(select script_id from ref_book where id = 207)</where>
        </update>
    </changeSet>

    <changeSet id="3.0-dnovikov-6" author="dnovikov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <changeSet id="3.0-dnovikov-7" author="dnovikov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 5</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-17" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-4625 Изменить записи справочников Коды доходов, Кодов вычетов и Видов доходов -->
	<changeSet id="3.0-rnurgaleev-3" author="rnurgaleev">
        <sql>
			update ref_book_income_type set name='Проценты (за исключением процентов по облигациям с ипотечным покрытием, эмитированным до 01.01.2007, доходов в виде процентов, получаемых по вкладам в банках, и доходов, получаемых при погашении векселя), включая дисконт, полученный по долговому обязательству любого вида'
			where code='1011' and version=to_date('01.01.2016','DD.MM.YYYY') and status=0;
			
            insert into ref_book_income_type (id, record_id, version, status, code, name)
			values(seq_ref_book_record.nextval, (select max(record_id) from ref_book_income_type where code='1011'), to_date('01.01.2017','DD.MM.YYYY'), 0, '1011','Проценты (за исключением процентов по облигациям с ипотечным покрытием, эмитированным до 01.01.2007, доходов в виде процентов, получаемых по вкладам в банках, и доходов, получаемых при погашении векселя), включая дисконт, полученный по долговому обязательству любого вида, за исключением сумм дохода в виде процента (купона), получаемого налогоплательщиком по обращающимся облигациям российских организаций, номинированным в рублях и эмитированным после 1 января 2017 года');
			
			update ref_book_income_type set version=to_date('01.01.2016','DD.MM.YYYY') where code in ('2002','2003');
			
			update ref_book_income_type set version=to_date('01.01.2017','DD.MM.YYYY') where code in ('2013','2014','2301','2611','3023');
			
			merge into ref_book_income_kind a using
			(select (select id from (select id,version from ref_book_income_type where code='1544' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'01' as mark, 'Начисление дохода при выводе денежных средств с брокерского счёта' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1544' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'02' as mark, 'Начисление дохода при выводе ценных бумаг с торгового раздела счёта депо' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1544' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'03' as mark, 'Начисление дохода при расторжении договора брокерского обслуживания' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1544' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'04' as mark, 'Начисление дохода по окончанию налогового периода за который начислен доход' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1546' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'01' as mark, 'Начисление дохода при выводе денежных средств с брокерского счёта' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1546' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'02' as mark, 'Начисление дохода при выводе ценных бумаг с торгового раздела счёта депо' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1546' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'03' as mark, 'Начисление дохода при расторжении договора брокерского обслуживания' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1546' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'04' as mark, 'Начисление дохода по окончанию налогового периода за который начислен доход' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1548' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'01' as mark, 'Начисление дохода при выводе денежных средств с брокерского счёта' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1548' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'02' as mark, 'Начисление дохода при выводе ценных бумаг с торгового раздела счёта депо' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1548' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'03' as mark, 'Начисление дохода при расторжении договора брокерского обслуживания' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='1548' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'04' as mark, 'Начисление дохода по окончанию налогового периода за который начислен доход' as name, 
			to_date('26.12.2016','DD.MM.YYYY') as version from dual
			union all
			select (select id from (select id,version from ref_book_income_type where code='4800' and status=0 order by version desc) where rownum=1) as income_type_id, 
			'00' as mark, '-' as name, 
			to_date('01.01.2016','DD.MM.YYYY') as version from dual
			) b
			on (a.income_type_id=b.income_type_id and a.mark=b.mark)
			when not matched then
				insert (id, income_type_id, mark, name, version, record_id)
				values (seq_ref_book_record.nextval, b.income_type_id, b.mark, b.name, b.version, seq_ref_book_record.nextval);
				
			update ref_book_deduction_type set version=to_date('01.01.2017','DD.MM.YYYY') where code='619';
		</sql>
    </changeSet>

</databaseChangeLog>