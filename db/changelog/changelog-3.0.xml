<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="3.0-apronin" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4464 -->
    <changeSet id="3.0-apronin-1" author="apronin">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-0" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-1" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-3" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_update_persons_data.groovy"/>
            <where>id=15</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-4" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>id=1</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-5" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-6" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>id=6</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-7" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_update_persons_data.groovy"/>
            <where>id=15</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4158 -->
    <changeSet id="3.0-dloshkarev-1" author="dloshkarev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-4655 Реализовать хранимую процедуру удаления из справочника физлиц -->
	<changeSet id="3.0-rnurgaleev-0" author="rnurgaleev">
        <sql splitStatements="false">
            create or replace 
			procedure DeleteRefBookPerson(p_person_id number)
			is
			  v_address number;
			begin
			  delete from REF_BOOK_ID_TAX_PAYER where person_id=p_person_id;
			  
			  delete from REF_BOOK_ID_DOC where person_id=p_person_id;
			  
			  select address into v_address from REF_BOOK_PERSON where id=p_person_id;
			  
			  delete from REF_BOOK_PERSON where id=p_person_id;
			  
			  if v_address is not null then
				delete from REF_BOOK_ADDRESS where id=v_address;
			  end if;

			end DeleteRefBookPerson;
        </sql>
    </changeSet>

    <changeSet id="3.0-ytrofimov-8" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>id=14</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-9" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_update_persons_data.groovy"/>
            <where>id=15</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-4733 Не отображается "0" в копейках для сумм в форме 6-НДФЛ -->
    <changeSet id="3.0-rnurgaleev-1" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates/ndfl/report_6ndfl/v2016/report.jrxml"/>
            <where>id in (select jrxml from declaration_template dt where dt.id = 103)</where>
        </update>
    </changeSet>

    <!-- Перенос правок из 2.2.2 - Начало -->
    <!-- https://jira.aplana.com/browse/SBRFNDFL-4605 -->
    <changeSet id="3.0-dloshkarev-2" author="dloshkarev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>
    <!--
        https://jira.aplana.com/browse/SBRFNDFL-4608
        https://jira.aplana.com/browse/SBRFNDFL-4689
    -->
    <changeSet id="3.0-dloshkarev-3" author="dloshkarev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>
    <!--
        https://jira.aplana.com/browse/SBRFNDFL-4561
        https://jira.aplana.com/browse/SBRFNDFL-4589
    -->
    <changeSet id="3.0-dloshkarev-4" author="dloshkarev">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 7</where>
        </update>
    </changeSet>
    <!-- Перенос правок из 2.2.2 - Конец -->

    <changeSet id="3.0-dnovikov-0" author="dnovikov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 5</where>
        </update>
    </changeSet>


	<!--https://jira.aplana.com/browse/SBRFNDFL-4659 Добавить в БД патч изменение имен xsd файлов для макетов -->
	<changeSet id="3.0-rnurgaleev-2" author="rnurgaleev">
        <sql>
            update blob_data set name='РНУ_НДФЛ_new6.3.xsd' where id in (select xsd from declaration_template where id=100);
			update blob_data set name='NO_NDFL2_1_399_00_05_04_02.xsd' where id in (select xsd from declaration_template where id in (102,104));
			update blob_data set name='NO_NDFL6_1_152_00_05_02_02.xsd' where id in (select xsd from declaration_template where id=103);
        </sql>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4759 -->
    <changeSet id="3.0-apronin-2" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-10" author="ytrofimov">
        <insert tableName="CONFIGURATION">
            <column name="code" value="CONSOLIDATION_DATA_SELECTION_DEPTH"/>
            <column name="department_id" value="0"/>
            <column name="value" value="3"/>
        </insert>
    </changeSet>

    <changeSet id="3.0-ytrofimov-11" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <changeSet id="3.0-apronin-3" author="apronin">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-4749 -->
    <changeSet id="3.0-apronin-4" author="apronin">
        <update tableName="blob_data">
            <column name="data" valueBlobFile="templates/ndfl/primary_rnu_ndfl/v2016/excel_template_dec.xlsx"/>
            <where name="id" value="3b4eb6e0-3ce3-48ba-b8e5-0b9c9174b5fe"/>
        </update>
    </changeSet>

    <changeSet id="3.0-ytrofimov-12" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 101 and EVENT_ID = 3</where>
        </update>
    </changeSet>
</databaseChangeLog>