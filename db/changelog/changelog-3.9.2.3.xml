<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="3.9.2.3-avoynov-1" author="avoynov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates-3.9.2.3/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>declaration_type_id = 100</where>
        </update>
    </changeSet>

    <changeSet id="3.9.2.3-skononova-1" author="skononova" runAlways="true">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/person_pkg_body18.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>
    <changeSet id="3.9.2.3-adudenko-1" author="adudenko">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.9.2.3/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_import.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 7</where>
        </update>
    </changeSet>

    <changeSet id="3.9.2.3-adudenko-2" author="adudenko">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates-3.9.2.3/refbook/person.groovy"/>
            <where>id in (select script_id from ref_book r where r.id = 904)</where>
        </update>
    </changeSet>

    <changeSet id="3.3.9.2.3-ytrofimov-1" author="ytrofimov" runAlways="true">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates-3.9.2.3/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>DECLARATION_TEMPLATE_ID = 100 and EVENT_ID = 3</where>
        </update>
    </changeSet>

    <changeSet id="3.9.2.3-skononova-2" author="skononova">
	<sql>
	update ndfl_person 
	    set inp= upper(inp), snils=upper(snils), last_name=upper(last_name), 
		first_name = upper(first_name), middle_name = upper(middle_name), 
		inn_np = upper (inn_np), inn_foreign = upper (inn_foreign), 
		id_doc_number = upper (id_doc_number),
		area = upper (area), city = upper (city), locality = upper (locality), street = upper (street), 
		house = upper (house), building = upper (building), flat = upper (flat), ADDRESS = upper(ADDRESS);
        update ref_book_person
	    set last_name=upper (last_name), first_name = upper (first_name),
		middle_name = upper (middle_name), inn = upper (inn), inn_foreign = upper (inn_foreign),
		snils = upper (snils), district = upper (district), city = upper (city), 
		locality = upper (locality), street = upper (street), house = upper (house), 
		build = upper (build),appartment = upper (appartment), address_foreign = upper (address_foreign);

	update ref_book_id_doc set doc_number = upper (doc_number);

	update  ref_book_id_tax_payer set inp=upper (inp);

	</sql>	
    </changeSet>

    <changeSet id="3.9.2.3-skononova-3" author="skononova">
	<sql>
	    drop index SRCH_FULL_REF_PERS_DUBLE;
	    drop index SRCH_REF_BOOK_PERSON_INN;
	    drop index SRCH_REF_BOOK_PERSON_INN_F;
	    drop index SRCH_REF_BOOK_PERSON_SNILS;
	    drop index SRCH_REF_PERSON_NAME_BRTHD;
	    drop index SRCH_REF_BOOK_ID_DOC_TP_NUM;	
	    drop index SRCH_REFB_TAX_PAYER_INP_ASNU;

	</sql>	
	<sql>
	  CREATE INDEX "SRCH_FULL_REF_PERS_DUBLE" ON "REF_BOOK_PERSON" (REPLACE((NVL("LAST_NAME",'empty')),' ',''), REPLACE((NVL("FIRST_NAME",'empty')),' ',''), REPLACE((NVL("MIDDLE_NAME",'empty')),' ',''), "BIRTH_DATE", REPLACE(REPLACE(NVL("SNILS",'empty'),' ',''),'-',''), REPLACE(NVL("INN",'empty'),' ',''), REPLACE(NVL("INN_FOREIGN",'empty'),' ','')) ;

	  CREATE INDEX "SRCH_REF_BOOK_PERSON_INN" ON "REF_BOOK_PERSON" (REPLACE("INN",' ','')) ;

	  CREATE INDEX "SRCH_REF_BOOK_PERSON_INN_F" ON "REF_BOOK_PERSON" (REPLACE("INN_FOREIGN",' ','')) ;

	  CREATE INDEX "SRCH_REF_BOOK_PERSON_SNILS" ON "REF_BOOK_PERSON" (REPLACE(REPLACE("SNILS",' ',''),'-','')) ;

	  CREATE INDEX "SRCH_REF_PERSON_NAME_BRTHD" ON "REF_BOOK_PERSON" (REPLACE(("LAST_NAME"),' ',''), REPLACE(("FIRST_NAME"),' ',''), REPLACE(("MIDDLE_NAME"),' ',''), "BIRTH_DATE") ;

	  CREATE INDEX "SRCH_REF_BOOK_ID_DOC_TP_NUM" ON "REF_BOOK_ID_DOC" ("DOC_ID", REPLACE(("DOC_NUMBER"),' ','')) ;

	  CREATE INDEX "SRCH_REFB_TAX_PAYER_INP_ASNU" ON "REF_BOOK_ID_TAX_PAYER" ("AS_NU", ("INP")); 		
	</sql>
    </changeSet>


</databaseChangeLog>
