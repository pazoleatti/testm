<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="2.1-rnurgaleev-1" author="rnurgaleev">
        <modifyDataType
                tableName="notification"
                columnName="id"
                newDataType="number(18)"
        />
    </changeSet>

    <changeSet id="2.1-rnurgaleev-2" author="rnurgaleev">
        <createTable
                remarks="Настройки задач планировщика"
                tableName="configuration_scheduler">
            <column name="id" type="number(9)" remarks="Идентификатор задачи">
                <constraints nullable="false"/>
            </column>
            <column name="task_name" type="varchar2(200 char)" remarks="Название">
                <constraints nullable="false"/>
            </column>
            <column name="schedule" type="varchar2(100 char)" remarks="Расписание">
            </column>
            <column name="active" type="number(1)" remarks="Признак активности">
                <constraints nullable="false"/>
            </column>
            <column name="modification_date" type="date" remarks="Дата редактирования">
                <constraints nullable="false"/>
            </column>
            <column name="last_fire_date" type="date" remarks="Дата последнего запуска">
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-3" author="rnurgaleev">
        <createTable
                remarks="Параметры задач планировщика"
                tableName="configuration_scheduler_param">
            <column name="id" type="number(9)" remarks="Идентификатор параметра">
                <constraints nullable="false"/>
            </column>
            <column name="param_name" type="varchar2(200 char)">
                <constraints nullable="false"/>
            </column>
            <column name="task_id" type="number(9)" remarks="Ссылка на задачу планировщика">
                <constraints nullable="false"/>
            </column>
            <column name="ord" type="number(9)" remarks="Порядок следования">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="number(1)"
                    remarks="Тип параметра(1 - Строка, 2 - Целое число, 3 - Число с плавающей запятой)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar2(200 char)" remarks="Значение">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-4" author="rnurgaleev">
        <createTable
                remarks="Асинхронные задачи"
                tableName="async_task">
            <column name="id" type="number(18)" remarks="Идентификатор задачи">
                <constraints nullable="false"/>
            </column>
            <column name="type_id" type="number(18)" remarks="Ссылка на тип задачи">
                <constraints nullable="false"/>
            </column>
            <column name="create_date" type="timestamp" remarks="Дата создания задачи"
                    defaultValueComputed="CURRENT_TIMESTAMP">
            </column>
            <column name="start_process_date" type="timestamp" remarks="Дата начала выполнения задачи">
            </column>
            <column name="node" type="varchar2(500)" remarks="Название узла, на котором выполняется задача">
            </column>
            <column name="balancing_variant" type="number(1)"
                    remarks="Тип очереди, в которую помещена задача. 1 - короткие, 2 - длинные">
                <constraints nullable="false"/>
            </column>
            <column name="serialized_params" type="blob"
                    remarks="Сериализованные параметры, которые нужны для выполнения задачи">
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-5" author="rnurgaleev">
        <createTable
                tableName="decl_template_event_script">
            <column name="id" type="number(19)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_decl_template_event_script"/>
            </column>
            <column name="declaration_template_id" type="number(19)">
                <constraints nullable="false" foreignKeyName="fk_dec_temp_event_scr_dec_temp"
                             references="declaration_template(id)"/>
            </column>
            <column name="event_id" type="number(19)">
                <constraints nullable="false" foreignKeyName="fk_dec_temp_event_id" references="event(id)"/>
            </column>
            <column name="script" type="clob">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-6" author="rnurgaleev">
        <addUniqueConstraint tableName="decl_template_event_script"
                             columnNames="declaration_template_id, event_id"
                             constraintName="uc_dec_temp_even_dec_temp_even"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-7" author="rnurgaleev">
        <addPrimaryKey
                columnNames="id"
                constraintName="CONF_SCHEDULER_PK"
                tableName="configuration_scheduler"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-8" author="rnurgaleev">
        <addPrimaryKey
                columnNames="id"
                constraintName="CONF_SCHEDULER_PARAM_PK"
                tableName="configuration_scheduler_param"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-9" author="rnurgaleev">
        <addPrimaryKey
                columnNames="id"
                constraintName="ASYNC_TASK_PK"
                tableName="async_task"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-10" author="rnurgaleev">
        <addForeignKeyConstraint baseColumnNames="task_id"
                                 baseTableName="configuration_scheduler_param"
                                 constraintName="conf_scheduler_param_fk_conf"
                                 onDelete="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="configuration_scheduler"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-11" author="rnurgaleev">
        <addForeignKeyConstraint baseColumnNames="type_id"
                                 baseTableName="async_task"
                                 constraintName="async_task_fk_type"
                                 referencedColumnNames="id"
                                 referencedTableName="async_task_type"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-12" author="rnurgaleev">
        <sql>
            alter table configuration_scheduler add constraint conf_scheduler_chk_active check(active in (0, 1));
        </sql>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-13" author="rnurgaleev">
        <sql>
            alter table configuration_scheduler_param add constraint conf_scheduler_param_chk_type check(type in (1, 2,
            3));
        </sql>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-14" author="rnurgaleev">
        <dropColumn
                columnName="dev_mode"
                tableName="async_task_type"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-15" author="rnurgaleev">
        <renameColumn
                newColumnName="handler_bean"
                oldColumnName="handler_jndi"
                remarks="Имя spring бина-обработчика задачи"
                tableName="async_task_type"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-16" author="rnurgaleev">
        <addColumn
                tableName="configuration">
            <column name="value2" type="varchar2(2048 char)"/>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-17" author="rnurgaleev">
        <sql>
            update configuration set value2=value;
        </sql>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-18" author="rnurgaleev">
        <dropColumn
                columnName="value"
                tableName="configuration"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-19" author="rnurgaleev">
        <renameColumn
                newColumnName="value"
                oldColumnName="value2"
                tableName="configuration"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-20" author="rnurgaleev">
        <modifyDataType
                tableName="declaration_type"
                columnName="id"
                newDataType="number(18)"
        />
    </changeSet>

    <changeSet id="2.1-rnurgaleev-21" author="rnurgaleev">
        <modifyDataType
                tableName="department_declaration_type"
                columnName="DECLARATION_TYPE_ID"
                newDataType="number(18)"
        />
    </changeSet>

    <changeSet id="2.1-rnurgaleev-22" author="rnurgaleev">
        <modifyDataType
                tableName="declaration_template"
                columnName="DECLARATION_TYPE_ID"
                newDataType="number(18)"
        />
    </changeSet>

    <changeSet id="2.1-rnurgaleev-23" author="rnurgaleev">
        <modifyDataType
                tableName="ref_book_asnu"
                columnName="id"
                newDataType="number(18)"
        />
    </changeSet>

    <changeSet id="2.1-rnurgaleev-24" author="rnurgaleev">
        <sql splitStatements="false">
            begin
            for rec in (select table_name from user_tables where table_name like 'RASCHSV_%')
            loop
            for rec2 in (select constraint_name from user_constraints WHERE table_name=rec.table_name and
            constraint_type='R')
            loop
            execute immediate 'ALTER TABLE '||rec.table_name||' DROP CONSTRAINT '||rec2.constraint_name;
            end loop;
            end loop;

            for rec in (select table_name from user_tables where table_name like 'RASCHSV_%')
            loop
            execute immediate 'DROP TABLE '||rec.table_name;
            end loop;
            end;
        </sql>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-25" author="rnurgaleev">
        <sql splitStatements="false">
            begin
            for rec in (select constraint_name from user_constraints where constraint_type='P' and table_name like
            'FORM_%')
            loop
            for rec2 in (select constraint_name, table_name from user_constraints WHERE
            r_constraint_name=rec.constraint_name and constraint_type='R')
            loop
            execute immediate 'ALTER TABLE '||rec2.table_name||' DROP CONSTRAINT '||rec2.constraint_name;
            end loop;
            end loop;

            for rec in (select table_name from user_tables where table_name like 'FORM_%')
            loop
            execute immediate 'DROP TABLE '||rec.table_name;
            end loop;
            end;
        </sql>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-26" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="IFRS_DATA"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-27" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="DEPARTMENT_CHANGE"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-28" author="rnurgaleev">
        <createSequence
                incrementBy="100"
                sequenceName="seq_async_task"
                startValue="100000"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-29" author="rnurgaleev">
        <createSequence
                incrementBy="1"
                sequenceName="seq_decl_template_event_script"
                startValue="1"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-30" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/DEP_REP_PER_BEFORE_DELETE.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-31" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/DEP_REP_PER_BEFORE_INS_UPD.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-32" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/person_pkg.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-33" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/person_pkg_body.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-34" author="rnurgaleev">
        <delete
                tableName="ref_book_attribute">
            <where>ref_book_id in (select id from ref_book where table_name in
                ('REF_BOOK_FOND','REF_BOOK_FOND_DETAIL'))
            </where>
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-35" author="rnurgaleev">
        <delete
                tableName="ref_book">
            <where>table_name in ('REF_BOOK_FOND','REF_BOOK_FOND_DETAIL')</where>
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-36" author="rnurgaleev">
        <delete
                tableName="report_period">
            <where>tax_period_id in (select id from tax_period where tax_type='F')</where>
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-37" author="rnurgaleev">
        <delete
                tableName="tax_period">
            <where>tax_type='F'</where>
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-38" author="rnurgaleev">
        <delete
                tableName="tax_type">
            <where>id='F'</where>
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-39" author="rnurgaleev">
        <delete
                tableName="async_task_type">
            <where>id in (103, 104, 105, 106, 107, 110, 111, 112, 113, 114, 115, 123, 124, 125, 126, 127, 128, 129)
            </where>
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-40" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="XlsxGeneratorAsyncTask"/>
            <where>id = 5</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-41" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="XmlGeneratorAsyncTask"/>
            <where>id = 6</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-42" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="PdfGeneratorAsyncTask"/>
            <where>id = 7</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-43" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="CsvAuditArchiveGeneratorAsyncTask"/>
            <where>id = 10</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-44" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="CsvAuditGeneratorAsyncTask"/>
            <where>id = 11</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-45" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="LoadAllTransportDataAsyncTask"/>
            <where>id = 13</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-46" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="CheckDeclarationAsyncTask"/>
            <where>id = 14</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-47" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="AcceptDeclarationAsyncTask"/>
            <where>id = 15</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-48" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="ExcelReportRefBookAsyncTask"/>
            <where>id = 23</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-49" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="CsvReportRefBookAsyncTask"/>
            <where>id = 24</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-50" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="SpecificReportRefBookAsyncTask"/>
            <where>id = 25</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-51" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="SpecificReportDeclarationDataAsyncTask"/>
            <where>id = 26</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-52" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="UploadRefBookAsyncTask"/>
            <where>id = 27</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-53" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="CreateFormsAsyncTask"/>
            <where>id = 28</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-54" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="handler_bean" value="CreateReportsAsyncTask"/>
            <where>id = 29</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-55" author="rnurgaleev">
        <insert tableName="CONFIGURATION_SCHEDULER">
            <column name="id" value="1"/>
            <column name="task_name" value="Очистка файлового хранилища"/>
            <column name="schedule" value="0 15 22 * * ?"/>
            <column name="active" value="1"/>
            <column name="modification_date" valueDate="sysdate"/>
            <column name="last_fire_date" valueDate="sysdate"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-56" author="rnurgaleev">
        <insert tableName="CONFIGURATION_SCHEDULER">
            <column name="id" value="2"/>
            <column name="task_name" value="Удаление истекших блокировок"/>
            <column name="schedule" value="0 10 22 * * ?"/>
            <column name="active" value="1"/>
            <column name="modification_date" valueDate="sysdate"/>
            <column name="last_fire_date" valueDate="sysdate"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-57" author="rnurgaleev">
        <insert tableName="CONFIGURATION_SCHEDULER">
            <column name="id" value="3"/>
            <column name="task_name" value="Очистка хранилища временных файлов"/>
            <column name="schedule" value="0 5 22 * * ?"/>
            <column name="active" value="1"/>
            <column name="modification_date" valueDate="sysdate"/>
            <column name="last_fire_date" valueDate="sysdate"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-58" author="rnurgaleev">
        <insert tableName="CONFIGURATION_SCHEDULER">
            <column name="id" value="4"/>
            <column name="task_name" value="Мониторинг асинхронных задач"/>
            <column name="schedule" value="0/5 * * * * ?"/>
            <column name="active" value="1"/>
            <column name="modification_date" valueDate="sysdate"/>
            <column name="last_fire_date" valueDate="sysdate"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-59" author="rnurgaleev">
        <insert tableName="configuration_scheduler_param">
            <column name="id" value="20"/>
            <column name="param_name" value="Время жизни блокировки (секунд)"/>
            <column name="task_id" value="2"/>
            <column name="ord" value="1"/>
            <column name="type" value="2"/>
            <column name="value" value="172800"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-60" author="rnurgaleev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-61" author="rnurgaleev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>id=101</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-62" author="rnurgaleev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>id=102</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-63" author="rnurgaleev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>id=103</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-64" author="rnurgaleev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>id=104</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-65" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="1"/>
            <column name="declaration_template_id" value="100"/>
            <column name="event_id" value="3"/>
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-66" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="2"/>
            <column name="declaration_template_id" value="100"/>
            <column name="event_id" value="5"/>
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-67" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="3"/>
            <column name="declaration_template_id" value="100"/>
            <column name="event_id" value="106"/>
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-68" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="4"/>
            <column name="declaration_template_id" value="100"/>
            <column name="event_id" value="105"/>
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_created_to_accepted.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-69" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="5"/>
            <column name="declaration_template_id" value="101"/>
            <column name="event_id" value="3"/>
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-70" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="6"/>
            <column name="declaration_template_id" value="101"/>
            <column name="event_id" value="5"/>
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-71" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="7"/>
            <column name="declaration_template_id" value="101"/>
            <column name="event_id" value="105"/>
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_move_created_to_accepted.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-72" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="8"/>
            <column name="declaration_template_id" value="102"/>
            <column name="event_id" value="5"/>
            <column name="script" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfll_check.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-73" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="9"/>
            <column name="declaration_template_id" value="102"/>
            <column name="event_id" value="105"/>
            <column name="script"
                    valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl_move_created_to_accepted.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-74" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="10"/>
            <column name="declaration_template_id" value="103"/>
            <column name="event_id" value="5"/>
            <column name="script" valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl_check.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-75" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="11"/>
            <column name="declaration_template_id" value="103"/>
            <column name="event_id" value="105"/>
            <column name="script"
                    valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl_move_created_to_accepted.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-76" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="12"/>
            <column name="declaration_template_id" value="104"/>
            <column name="event_id" value="5"/>
            <column name="script" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfll_check.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-77" author="rnurgaleev">
        <insert tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="id" value="13"/>
            <column name="declaration_template_id" value="104"/>
            <column name="event_id" value="105"/>
            <column name="script"
                    valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl_move_created_to_accepted.groovy"/>
        </insert>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-78" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/classificator_country.groovy"/>
            <where>id='ce397da5-cf59-457f-9e91-2a31a478b510'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-79" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/classificator_oktmo.groovy"/>
            <where>id='3ec53b66-624d-45cd-aa17-f046e3a1f1fc'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-80" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/classificator_okved.groovy"/>
            <where>id='99034f20-18c3-11e5-b60b-1697f925ec7b'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-81" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-82" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/department.groovy"/>
            <where>id='4e387483-0330-4e05-ad46-e9b03a3b025d'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-83" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/fias.groovy"/>
            <where>id='39327388-9684-4fd5-a522-c40a21680156'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-84" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/id_doc.groovy"/>
            <where>id='375ba56a-2509-11e7-93ae-92361f002671'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-85" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/person.groovy"/>
            <where>id='884b9f2e-1678-4d69-9652-b036bba2f728'</where>
        </update>
    </changeSet>

    <!--SBRFNDFL-2142-->
    <changeSet id="2.1-rnurgaleev-86" author="rnurgaleev">
        <update
                tableName="ref_book">
            <column name="is_versioned" value="0"/>
            <where>table_name='REPORT_PERIOD_TYPE'</where>
        </update>
    </changeSet>

    <!--SBRFNDFL-2059-->
    <changeSet id="2.1-rnurgaleev-87" author="rnurgaleev">
        <delete
                tableName="role_event">
            <where>event_id in (4, 10, 11, 101, 102, 103, 104, 110, 111, 112, 203, 204, 205, 206, 207, 208, 209, 210,
                303, 302, 601)
            </where>
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-88" author="rnurgaleev">
        <delete
                tableName="event">
            <where>id in (4, 10, 11, 101, 102, 103, 104, 110, 111, 112, 203, 204, 205, 206, 207, 208, 209, 210, 303,
                302, 601)
            </where>
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-89" author="rnurgaleev">
        <createView
                replaceIfExists="true"
                viewName="DEPARTMENT_CHILD_VIEW">select cast(connect_by_root id as number(9,0)) id, parent_id,
            (connect_by_root id)||'|'||parent_id view_rowid from department connect by prior parent_id = id
            order by parent_id, id
        </createView>
    </changeSet>

    <!--SBRFNDFL-2077-->
    <changeSet id="2.1-rnurgaleev-90" author="rnurgaleev">
        <dropColumn columnName="is_balance_period"
                    tableName="department_report_period"/>
    </changeSet>

    <!--SBRFNDFL-2316-->
    <changeSet id="2.1-rnurgaleev-91" author="rnurgaleev">
        <createView
                replaceIfExists="true"
                viewName="DEPARTMENT_FULLPATH">WITH dep_with (id, parent_id, shortname) AS
            (
            SELECT
            dp.id,
            dp.parent_id,
            dp.shortname
            FROM department dp
            WHERE dp.parent_id IS NULL
            UNION ALL
            SELECT
            dp.id,
            dp.parent_id,
            dep_with.shortname ||'/'|| + nvl(dp.shortname,dp.name)
            FROM dep_with dep_with
            INNER JOIN department dp ON dp.parent_id = dep_with.id
            )
            select id, shortname from dep_with
            order by id
        </createView>
    </changeSet>

    <!--SBRFNDFL-2314-->
    <changeSet id="2.1-rnurgaleev-92" author="rnurgaleev">
        <delete
                tableName="async_task">
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-93" author="rnurgaleev">
        <renameColumn
                newColumnName="queue"
                oldColumnName="balancing_variant"
                tableName="async_task"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-94" author="rnurgaleev">
        <addColumn tableName="async_task">
            <column name="user_id" type="number(9)" remarks="Идентификатор пользователя, запустившего задачу">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-95" author="rnurgaleev">
        <addColumn tableName="async_task">
            <column name="state" type="number(6)" remarks="Статус выполнения задачи" defaultValue="1">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-96" author="rnurgaleev">
        <addColumn tableName="async_task">
            <column name="state_date" type="timestamp" remarks="Дата последнего изменения статуса"
                    defaultValueComputed="CURRENT_TIMESTAMP"/>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-97" author="rnurgaleev">
        <addColumn tableName="async_task">
            <column name="priority_node" type="varchar2(500)"
                    remarks="Узел, которому принудительно будет назначена задача"/>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-98" author="rnurgaleev">
        <addColumn tableName="async_task">
            <column name="description" type="varchar2(400)" remarks="Описание задачи"/>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-99" author="rnurgaleev">
        <delete
                tableName="lock_data_subscribers">
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-100" author="rnurgaleev">
        <dropForeignKeyConstraint baseTableName="lock_data_subscribers" constraintName="lock_data_subscr_fk_lock_data"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-101" author="rnurgaleev">
        <dropPrimaryKey
                constraintName="lock_data_subscribers_pk"
                tableName="lock_data_subscribers"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-102" author="rnurgaleev">
        <renameTable
                newTableName="async_task_subscribers"
                oldTableName="lock_data_subscribers"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-103" author="rnurgaleev">
        <dropColumn
                columnName="lock_key"
                tableName="async_task_subscribers"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-104" author="rnurgaleev">
        <addColumn tableName="async_task_subscribers">
            <column name="async_task_id" type="number(18)"
                    remarks="Идентификатор задачи, после завершения которой, будет выполнено оповещение">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-105" author="rnurgaleev">
        <createIndex
                indexName="idx_async_t_subscr"
                tableName="async_task_subscribers">
            <column name="async_task_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-106" author="rnurgaleev">
        <addPrimaryKey
                columnNames="async_task_id, user_id"
                constraintName="async_task_subscribers_pk"
                tableName="async_task_subscribers"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-107" author="rnurgaleev">
        <addForeignKeyConstraint baseColumnNames="async_task_id"
                                 baseTableName="async_task_subscribers"
                                 constraintName="async_t_subscr_fk_async_task"
                                 onDelete="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="async_task"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-108" author="rnurgaleev">
        <dropIndex indexName="lock_data_subscr_fk_sec_user"
                   tableName="async_task_subscribers"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-109" author="rnurgaleev">
        <dropForeignKeyConstraint baseTableName="async_task_subscribers" constraintName="lock_data_subscr_fk_sec_user"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-110" author="rnurgaleev">
        <addForeignKeyConstraint baseColumnNames="user_id"
                                 baseTableName="async_task_subscribers"
                                 constraintName="async_t_subscr_fk_sec_user"
                                 onDelete="CASCADE"
                                 referencedColumnNames="id"
                                 referencedTableName="sec_user"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-111" author="rnurgaleev">
        <delete
                tableName="lock_data">
        </delete>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-112" author="rnurgaleev">
        <dropColumn
                columnName="state"
                tableName="lock_data"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-113" author="rnurgaleev">
        <dropColumn
                columnName="state_date"
                tableName="lock_data"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-114" author="rnurgaleev">
        <dropColumn
                columnName="queue"
                tableName="lock_data"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-115" author="rnurgaleev">
        <dropColumn
                columnName="server_node"
                tableName="lock_data"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-116" author="rnurgaleev">
        <dropPrimaryKey
                constraintName="lock_data_pk"
                tableName="lock_data"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-117" author="rnurgaleev">
        <addColumn tableName="lock_data">
            <column name="task_id" type="number(18)" remarks="Ссылка на асинхронную задачу, связанную с блокировкой"/>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-118" author="rnurgaleev">
        <addColumn tableName="lock_data">
            <column name="id" type="number(18)" remarks="Идентификатор блокировки">
                <constraints nullable="false" primaryKey="true" primaryKeyName="lock_data_pk"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-119" author="rnurgaleev">
        <createSequence
                incrementBy="1"
                sequenceName=" seq_lock_data"
                startValue="1"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-120" author="rnurgaleev">
        <addUniqueConstraint tableName="lock_data"
                             columnNames="key"
                             constraintName="lock_data_uniq_key"/>
    </changeSet>

    <changeSet id="2.1-ytrofimov-1" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/fias.groovy"/>
            <where>id='39327388-9684-4fd5-a522-c40a21680156'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-121" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/fias_pkg_body.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-122" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/fias_pkg_body2.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-123" author="rnurgaleev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="2.1-rnurgaleev-124" author="rnurgaleev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>id=101</where>
        </update>
    </changeSet>

    <changeSet id="2.1-dloshkarev-1" author="dloshkarev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>id=102</where>
        </update>
    </changeSet>

    <changeSet id="2.1-dloshkarev-2" author="dloshkarev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>id=103</where>
        </update>
    </changeSet>

    <changeSet id="2.1-dloshkarev-3" author="dloshkarev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_2ndfl_2/v2016/report_2ndfl_2.groovy"/>
            <where>id=104</where>
        </update>
    </changeSet>

    <!-- SBRFNDFL-2364 Локальный запуск скриптов справочников -->
    <changeSet id="2.1-ytrofimov-2" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/classificator_country.groovy"/>
            <where>id='ce397da5-cf59-457f-9e91-2a31a478b510'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-3" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/classificator_oktmo.groovy"/>
            <where>id='3ec53b66-624d-45cd-aa17-f046e3a1f1fc'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-4" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/classificator_okved.groovy"/>
            <where>id='99034f20-18c3-11e5-b60b-1697f925ec7b'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-5" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-6" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/department.groovy"/>
            <where>id='4e387483-0330-4e05-ad46-e9b03a3b025d'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-7" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/fias.groovy"/>
            <where>id='39327388-9684-4fd5-a522-c40a21680156'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-8" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/id_doc.groovy"/>
            <where>id='375ba56a-2509-11e7-93ae-92361f002671'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-9" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/person.groovy"/>
            <where>id='884b9f2e-1678-4d69-9652-b036bba2f728'</where>
        </update>
    </changeSet>

    <!-- SBRFNDFL-2080 НДФЛ. Реализовать выгрузку отчетных форм, выбранных пользователем, в состоянии "Принята"  -->
    <changeSet id="2.1-ytrofimov-10" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>id=102</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-11" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>id=103</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-12" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>id=104</where>
        </update>
    </changeSet>

    <changeSet id="2.1-aokunev-1" author="aokunev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

	<!--SBRFNDFL-2371-->
	<changeSet id="2.1-rnurgaleev-125" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="COLOR"/>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-126" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="DEPARTMENT_FORM_TYPE_PERFORMER"/>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-127" author="rnurgaleev">
        <dropForeignKeyConstraint baseTableName="declaration_source" constraintName="DECL_SOURCE_FK_DEPT_FORMTYPE"/>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-128" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="DEPARTMENT_FORM_TYPE"/>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-129" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="LOG_CLOB_QUERY"/>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-130" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="ROLE_EVENT"/>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-131" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="STATE_CHANGE"/>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-132" author="rnurgaleev">
        <dropTable cascadeConstraints="true"
                   tableName="TASK_CONTEXT"/>
    </changeSet>

    <!-- SBRFNDFL-1205 НДФЛ. Формирование отчета "РНУ НДФЛ по всем ФЛ". Ошибка при открытии xls, если в отчете нет ФЛ  -->
    <changeSet id="2.1-ytrofimov-13" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-14" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>id=101</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-15" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-16" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/fias.groovy"/>
            <where>id='39327388-9684-4fd5-a522-c40a21680156'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-17" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>id=6</where>
        </update>
    </changeSet>

    <changeSet id="2.1-dloshkarev-4" author="dloshkarev">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-2404 -->
    <changeSet id="2.1-ytrofimov-18" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-19" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>id=1</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-20" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-21" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
            <where>id=3</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-22" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_created_to_accepted.groovy"/>
            <where>id=4</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-23" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>id=101</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-24" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>id=5</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-25" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>id=6</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-26" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_move_created_to_accepted.groovy"/>
            <where>id=7</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-27" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>id=102</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-28" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl_move_created_to_accepted.groovy"/>
            <where>id=9</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-29" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl_check.groovy"/>
            <where>id=10</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-30" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl_move_created_to_accepted.groovy"/>
            <where>id=11</where>
        </update>
    </changeSet>
    <!-- https://jira.aplana.com/browse/SBRFNDFL-2405 -->
    <changeSet id="2.1-vlednev-1" author="vlednev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-2189 (удаление модуля script-support) -->
    <changeSet id="2.1-ytrofimov-31" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl.groovy"/>
            <where>id=100</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-32" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>id=1</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-33" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-34" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_accepted_to_created.groovy"/>
            <where>id=3</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-35" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_move_created_to_accepted.groovy"/>
            <where>id=4</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-36" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl.groovy"/>
            <where>id=101</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-37" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>id=5</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-38" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>id=6</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-39" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_move_created_to_accepted.groovy"/>
            <where>id=7</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-40" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>id=102</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-41" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfll_check.groovy"/>
            <where>id=8</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-42" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl_move_created_to_accepted.groovy"/>
            <where>id=9</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-43" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="create_script" valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.groovy"/>
            <where>id=104</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-44" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfll_check.groovy"/>
            <where>id=12</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-45" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl_move_created_to_accepted.groovy"/>
            <where>id=13</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-46" author="ytrofimov">
        <update tableName="DECLARATION_TEMPLATE">
            <column name="CREATE_SCRIPT" valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl.groovy"/>
            <where>id=103</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-47" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl_check.groovy"/>
            <where>id=10</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-48" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/report_6ndfl/v2016/report_6ndfl_move_created_to_accepted.groovy"/>
            <where>id=11</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-49" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-50" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/department.groovy"/>
            <where>id='4e387483-0330-4e05-ad46-e9b03a3b025d'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-51" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/fias.groovy"/>
            <where>id='39327388-9684-4fd5-a522-c40a21680156'</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-52" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/person.groovy"/>
            <where>id='884b9f2e-1678-4d69-9652-b036bba2f728'</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-2296 -->
    <changeSet id="2.1-AFateev-1" author="AFateev">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/declaration_type.groovy"/>
            <where>id='352adf59-372b-4020-98fe-8960dd5bc972'</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-2253 Проверка реквизитов. Ложное срабатывание проверки ИНП и даты рождения (Исправлено для КНФ) -->
    <changeSet id="2.1-ytrofimov-53" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>id=6</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-2395 Сумма аванса не учитывается при проверке первичной формы -->
    <changeSet id="2.1-ytrofimov-54" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
    </changeSet>

    <changeSet id="2.1-ytrofimov-55" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_check.groovy"/>
            <where>id=6</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-2036 Не формируется сообщение об ошибке при проверке срока перечисления НДФЛ в бюджет -->
    <changeSet id="2.1-vlednev-2" author="vlednev">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script" valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_check.groovy"/>
            <where>id=2</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-2495 Добавить изменения в БД для ASYNC_TASK_TYPE-->
	 <changeSet id="2.1-rnurgaleev-133" author="rnurgaleev">
        <update
                tableName="async_task_type">
            <column name="name" value="Обработка справочника из каталога загрузки"/>
            <where>id = 13</where>
        </update>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-134" author="rnurgaleev">
        <insert tableName="async_task_type">
            <column name="id" value="12"/>
            <column name="name" value="Обработка ТФ налоговой формы"/>
            <column name="handler_bean" value="LoadTransportFileAsyncTask"/>
            <column name="short_queue_limit" value="10000"/>
            <column name="limit_kind" value="Размер файла (Кбайт)"/>
        </insert>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-2015 НДФЛ: Добавление текстового блока в печатное предстваление формы 2-НДФЛ-->
	<changeSet id="2.1-rnurgaleev-135" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates/ndfl/report_2ndfl_1/v2016/report_2ndfl.jrxml"/>
            <where>id in ('047f207c-113e-488d-8390-9afc248a3bc8','04d9b114-1782-4d09-ad88-729e5605c6ff')</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-2414 НДФЛ: Добавление текстового блока в печатное предстваление формы 6-НДФЛ-->
	<changeSet id="2.1-rnurgaleev-136" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates/ndfl/report_6ndfl/v2016/report.jrxml"/>
            <where>id in ('41303bf7-9765-463f-a34b-f0a280bfa7bf')</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-1892 Добавить дату подписи в печ форму 6-НДФЛ-->
	<changeSet id="2.1-rnurgaleev-137" author="rnurgaleev">
        <update tableName="BLOB_DATA">
            <column name="data"
                    valueBlobFile="templates/ndfl/report_6ndfl/v2016/report.jrxml"/>
            <where>id in ('41303bf7-9765-463f-a34b-f0a280bfa7bf')</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-2054 Статическая компиляция скрипта groovy для ФИАС-->
    <changeSet id="2.1-ytrofimov-56" author="ytrofimov">
        <update tableName="BLOB_DATA">
            <column name="data" valueBlobFile="templates/refbook/fias.groovy"/>
            <where>id='39327388-9684-4fd5-a522-c40a21680156'</where>
        </update>
    </changeSet>

	<changeSet id="2.1-rnurgaleev-138" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/fias_pkg_body3.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

	<changeSet id="2.1-rnurgaleev-139" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/fias_pkg3.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

	<changeSet id="2.1-rnurgaleev-140" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/fias_pkg_body4.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

	<changeSet id="2.1-rnurgaleev-141" author="rnurgaleev">
        <sql splitStatements="false">
            BEGIN
				DBMS_SCHEDULER.SET_ATTRIBUTE (
				name         =>  'REFRESH_FIAS_VIEWS',
				attribute    =>  'job_action',
				value        =>
'BEGIN
  DBMS_MVIEW.REFRESH(list=>''MV_FIAS_CITY_ACT'',method => ''C'', atomic_refresh => FALSE);
  DBMS_MVIEW.REFRESH(list=>''MV_FIAS_AREA_ACT'',method => ''C'', atomic_refresh => FALSE);
  DBMS_MVIEW.REFRESH(list=>''MV_FIAS_LOCALITY_ACT'',method => ''C'', atomic_refresh => FALSE);
  DBMS_MVIEW.REFRESH(list=>''MV_FIAS_STREET_ACT'',method => ''C'', atomic_refresh => FALSE);
END;'
				);
			END;
        </sql>
    </changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-2502 Разобраться с реализованным алгоритмом проверки адреса на соответствие его ФИАС-у-->
	<changeSet id="2.1-rnurgaleev-142" author="rnurgaleev">
        <sql splitStatements="false">
            declare
				v_count number;
			begin
				select count(1) into v_count from user_mviews where mview_name='MV_FIAS_AREA_ACT';
				if v_count>0 then
					execute immediate 'DROP MATERIALIZED VIEW MV_FIAS_AREA_ACT';
				end if;

				select count(1) into v_count from user_mviews where mview_name='MV_FIAS_AREA_ACT';
				if v_count=0 then
					execute immediate 'CREATE MATERIALIZED VIEW MV_FIAS_AREA_ACT (ID, AOID, FORMALNAME, SHORTNAME, REGIONCODE, LIVESTATUS, CURRSTATUS, AOLEVEL, POSTALCODE, PARENTGUID, FNAME, FTYPE, HAS_CHILD)
    NOLOGGING
    BUILD IMMEDIATE
    USING INDEX
    REFRESH COMPLETE ON DEMAND
    USING DEFAULT LOCAL ROLLBACK SEGMENT
    USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
    AS select distinct f.*,
       replace(lower(f.formalname),'' '','''') fname,
       trim(lower(f.shortname)) ftype,
       nvl2(c.id,1,0) has_child
  from fias_addrobj f left join fias_addrobj c on (c.parentguid=f.aoid and c.currstatus=0)
  where f.currstatus=0
   and (f.aolevel=3 or
        f.aolevel=1 /*and replace(lower(f.formalname),'' '','''') not in (''москва'',''санкт-петербург'',''севастополь'',''байконур'')*/
        )';
					execute immediate 'CREATE INDEX IDX_MV_FIAS_AREA_AOID ON MV_FIAS_AREA_ACT (AOID)';
					execute immediate 'CREATE INDEX IDX_MV_FIAS_AREA_FNAME ON MV_FIAS_AREA_ACT (FNAME)';
					execute immediate 'CREATE INDEX IDX_MV_FIAS_AREA_PGUID ON MV_FIAS_AREA_ACT (PARENTGUID)';
					execute immediate 'CREATE INDEX SRCH_MV_FIAS_AREA_REG_FN_TP ON MV_FIAS_AREA_ACT (REGIONCODE, FNAME, FTYPE, HAS_CHILD)';
					execute immediate 'CREATE UNIQUE INDEX PK_MV_FIAS_AREA_ACT ON MV_FIAS_AREA_ACT (ID)';

					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.ID IS ''Уникальный идентификатор''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.AOID IS ''Идентификатор объекта''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.FORMALNAME IS ''Формализованное наименование''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.SHORTNAME IS ''Тип адресного объекта''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.REGIONCODE IS ''Код региона''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.LIVESTATUS IS ''Статус актуальности ФИАС: 1 - актуальная, 0 - устаревшая''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.CURRSTATUS IS ''Статус актуальности КЛАДР: 0 - актуальная, ..''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.AOLEVEL IS ''Уровень объекта''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.POSTALCODE IS ''Почтовый индекс''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.PARENTGUID IS ''Идентификатор родительского объекта''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.FNAME IS ''Наименование, адаптированное для проверки адреса (строчными буквами, без пробелов)''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.FTYPE IS ''Тип, адаптированный для проверки адреса (строчными буквами, без пробелов)''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_AREA_ACT.HAS_CHILD IS ''Наличие дочерних элементов''';
					execute immediate 'COMMENT ON MATERIALIZED VIEW MV_FIAS_AREA_ACT  IS ''Актуальные районы из справочника ФИАС''';
				end if;

				select count(1) into v_count from user_mviews where mview_name='MV_FIAS_CITY_ACT';
				if v_count>0 then
					execute immediate 'DROP MATERIALIZED VIEW MV_FIAS_CITY_ACT';
				end if;

				select count(1) into v_count from user_mviews where mview_name='MV_FIAS_CITY_ACT';
				if v_count=0 then
					execute immediate 'CREATE MATERIALIZED VIEW MV_FIAS_CITY_ACT (ID, AOID, FORMALNAME, SHORTNAME, REGIONCODE, LIVESTATUS, CURRSTATUS, AOLEVEL, POSTALCODE, PARENTGUID, FNAME, FTYPE, HAS_CHILD)
    NOLOGGING
    BUILD IMMEDIATE
    USING INDEX
    REFRESH COMPLETE ON DEMAND
    USING DEFAULT LOCAL ROLLBACK SEGMENT
    USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE
    AS select distinct f.*,
       replace(lower(f.formalname),'' '','''') fname,
       trim(lower(f.shortname)) ftype,
        nvl2(c.id,1,0) has_child
  from fias_addrobj f left join fias_addrobj c on (c.parentguid=f.aoid and c.currstatus=0)
  where f.currstatus=0
   and (f.aolevel=4 /*or
        f.aolevel=1 and replace(lower(f.formalname),'' '','''') in (''москва'',''санкт-петербург'',''севастополь'',''байконур'')*/
       )';

					execute immediate 'CREATE UNIQUE INDEX PK_MV_FIAS_CITY_ACT ON MV_FIAS_CITY_ACT (ID)';
					execute immediate 'CREATE INDEX IDX_MV_FIAS_CITY_AOID ON MV_FIAS_CITY_ACT (AOID)';
					execute immediate 'CREATE INDEX IDX_MV_FIAS_CITY_FNAME ON MV_FIAS_CITY_ACT (FNAME) ';
					execute immediate 'CREATE INDEX IDX_MV_FIAS_CITY_PGUID ON MV_FIAS_CITY_ACT (PARENTGUID) ';
					execute immediate 'CREATE INDEX SRCH_MV_FIAS_CITY_REG_FN_TP ON MV_FIAS_CITY_ACT (REGIONCODE, FNAME, FTYPE, HAS_CHILD)';

					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.ID IS ''Уникальный идентификатор''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.AOID IS ''Идентификатор объекта''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.FORMALNAME IS ''Формализованное наименование''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.SHORTNAME IS ''Тип адресного объекта''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.REGIONCODE IS ''Код региона''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.LIVESTATUS IS ''Статус актуальности ФИАС: 1 - актуальная, 0 - устаревшая''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.CURRSTATUS IS ''Статус актуальности КЛАДР: 0 - актуальная, ..''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.AOLEVEL IS ''Уровень объекта''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.POSTALCODE IS ''Почтовый индекс''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.PARENTGUID IS ''Идентификатор родительского объекта''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.FNAME IS ''Наименование, адаптированное для проверки адреса (строчными буквами, без пробелов)''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.FTYPE IS ''Тип, адаптированный для проверки адреса (строчными буквами, без пробелов)''';
					execute immediate 'COMMENT ON COLUMN MV_FIAS_CITY_ACT.HAS_CHILD IS ''Наличие дочерних элементов''';
					execute immediate 'COMMENT ON MATERIALIZED VIEW MV_FIAS_CITY_ACT  IS ''Актуальные города из справочника ФИАС''';
				end if;
			end;
        </sql>
    </changeSet>

	<changeSet id="2.1-rnurgaleev-143" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/fias_pkg_body5.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

	<changeSet id="2.1-rnurgaleev-144" author="rnurgaleev">
        <sqlFile dbms="oracle"
                 encoding="utf8"
                 endDelimiter=""
                 path="/scripts/fias_pkg_body6.sql"
                 relativeToChangelogFile="true"
                 splitStatements="false"/>
    </changeSet>

	<!--https://jira.aplana.com/browse/SBRFNDFL-2570  Отображать "Идентификатор ФЛ" в справочнике "Идентификаторы налогоплательщиков" вместо Фамилии-->
	<changeSet id="2.1-rnurgaleev-145" author="rnurgaleev">
        <sql>
            update ref_book_attribute set attribute_id = (select id from ref_book_attribute where ref_book_id = 904 and alias = 'RECORD_ID') where ref_book_id = 905 and alias = 'PERSON_ID';
        </sql>
    </changeSet>


    <!-- https://jira.aplana.com/browse/SBRFNDFL-2541 Ошибка исполнения [23]: Format specifier 's' при расчете консолидированной формы в корректирующем периоде-->
    <changeSet id="2.1-ytrofimov-57" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/consolidated_rnu_ndfl/v2016/consolidated_rnu_ndfl_calculate.groovy"/>
            <where>id=5</where>
        </update>
    </changeSet>

    <!-- https://jira.aplana.com/browse/SBRFNDFL-2579 Неправильный идентификатор физического лица при создании записи в справочнике-->
    <changeSet id="2.1-ytrofimov-58" author="ytrofimov">
        <update tableName="DECL_TEMPLATE_EVENT_SCRIPT">
            <column name="script"
                    valueClobFile="templates/ndfl/primary_rnu_ndfl/v2016/primary_rnu_ndfl_calculate.groovy"/>
            <where>id=1</where>
        </update>
    </changeSet>
	
	<!--https://jira.aplana.com/browse/SBRFNDFL-2634 Добавить поле manually_created в declaration_data-->
	<changeSet id="2.1-rnurgaleev-146" author="rnurgaleev">
        <addColumn tableName="declaration_data">
            <column name="manually_created" type="number(1)" defaultValue="0" remarks="Создана вручную (0-нет, 1-да)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
	
	<changeSet id="2.1-rnurgaleev-147" author="rnurgaleev">
        <sql>
            alter table declaration_data add constraint decl_data_chk_man_created check(manually_created in (0, 1));
        </sql>
    </changeSet>
</databaseChangeLog>